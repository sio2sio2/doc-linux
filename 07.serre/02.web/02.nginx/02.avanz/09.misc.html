

<!DOCTYPE html>

<html lang="es" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>7.2.2.2.10. Otros aspectos &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/classic.css?v=2bf1fcf8" />
    <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
    
    <script src="../../../../_static/documentation_options.js?v=a621b78a"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/translations.js?v=f85f4cfb"></script>
    
    <link rel="index" title="Índice" href="../../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../../search.html" />
    <link rel="next" title="7.2.2.3. Recetas" href="../03.misc/index.html" />
    <link rel="prev" title="7.2.2.2.9. Multiplexación" href="08.multiplex.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="../03.misc/index.html" title="7.2.2.3. Recetas"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="08.multiplex.html" title="7.2.2.2.9. Multiplexación"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">7. </span>Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">7.2. </span>Web</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" ><span class="section-number">7.2.2. </span>nginx</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="index.html" accesskey="U"><span class="section-number">7.2.2.2. </span>Configuración</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7.2.2.2.10. </span>Otros aspectos</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="otros-aspectos">
<h1><span class="section-number">7.2.2.2.10. </span>Otros aspectos<a class="headerlink" href="#otros-aspectos" title="Link to this heading">¶</a></h1>
<section id="definicion-mediante-mapeo">
<span id="nginx-map"></span><h2><span class="section-number">7.2.2.2.10.1. </span>Definición mediante mapeo<a class="headerlink" href="#definicion-mediante-mapeo" title="Link to this heading">¶</a></h2>
<p>Si requerimos definir una variable dependiendo del valor de otra, disponemos de
la directiva <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_map_module.html#map">map</a>:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">map</span><span class="w"> </span><span class="nv">$host</span><span class="w"> </span><span class="nv">$dominio</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">hostnames</span><span class="p">;</span>

<span class="w">   </span><span class="kn">default</span><span class="w">              </span><span class="s">&quot;desconocido&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="kn">*.example.net</span><span class="w">        </span><span class="s">&quot;example&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="kn">*.dominio.org</span><span class="w">        </span><span class="s">&quot;dominio&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="kn">~[^.]+\.otro\.[^.]+</span><span class="w">  </span><span class="s">&quot;otro&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>En este caso, se define la variable <code class="docutils literal notranslate"><span class="pre">$dominio</span></code> a partir de los valores de la
variable <code class="docutils literal notranslate"><span class="pre">$host</span></code>. Se comprueba si el valor de esta última concuerda con
alguna entrada de la izquierda y, si es así, se asigna el valor de la columna
derecha correspondiente. Si no hay concordancia, se usa la entrada <em>default</em>.
Además, se puede incluir la palabra <kbd class="kbd docutils literal notranslate">hostnames</kbd> para expresar que lo
contenido son nombres de máquina y que se entienda la notación con asterisco.
Si la lista es larga, puede usarse <code class="docutils literal notranslate"><span class="pre">include</span></code>:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">map</span><span class="w"> </span><span class="nv">$host</span><span class="w"> </span><span class="nv">$dominio</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">hostnames</span><span class="p">;</span>

<span class="w">   </span><span class="kn">include</span><span class="w"> </span><span class="s">dominios.txt</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>y en el fichero <code class="file docutils literal notranslate"><span class="pre">/etc/nginx/dominios.txt</span></code> escribir la lista de dos
columnas.</p>
<p>Otro ejemplo (meramente ilustrativo porque para ello ya existe el módulo
<a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_referer_module.html">ngx_http_referer</a>) es el de
comprobar si el <em>referer</em> es válido:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">map</span><span class="w"> </span><span class="nv">$http_referer</span><span class="w"> </span><span class="nv">$invalid_referer</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">default</span><span class="w">                 </span><span class="mi">1</span><span class="p">;</span>

<span class="w">   </span><span class="c1"># Dominios con los que se considera válido el referer.</span>
<span class="w">   </span><span class="kn">&quot;~www.example.net&quot;</span><span class="w">      </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="kn">&quot;~example.net&quot;</span><span class="w">          </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="compresion">
<span id="nginx-comp"></span><h2><span class="section-number">7.2.2.2.10.2. </span>Compresión<a class="headerlink" href="#compresion" title="Link to this heading">¶</a></h2>
<p>Es muy recomendable, para ahorrar ancho de banda configurar el servidor para que
comprima aquellos ficheros cuyo ratio de compresión es alto. La configuración
predeterminada sólo comprime los documentos <abbr title="HyperText Markup Language">HTML</abbr>, así que creamos un fichero
de <a class="reference download internal" download="" href="../../../../_downloads/5b0d187a922b87c0cabc8ac97e090f05/gzip.conf"><code class="xref download docutils literal notranslate"><span class="pre">configuración</span> <span class="pre">adicional</span></code></a> como
<code class="file docutils literal notranslate"><span class="pre">/etc/nginx/conf.d/gzip.conf</span></code>:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configuración de la compresión</span>
<span class="k">gzip_comp_level</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<span class="k">gzip_static</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<span class="k">gzip_vary</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<span class="k">gzip_http_version</span><span class="w"> </span><span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
<span class="k">gzip_min_length</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
<span class="k">gzip_types</span><span class="w"> </span><span class="s">text/plain</span><span class="w"> </span><span class="s">text/css</span><span class="w"> </span><span class="s">text/xml</span><span class="w"> </span><span class="s">text/javascript</span><span class="w"> </span><span class="s">image/svg+xml</span>
<span class="w">           </span><span class="s">application/json</span><span class="w"> </span><span class="s">application/javascript</span><span class="w"> </span><span class="s">application/xhtml+xml</span><span class="w"> </span><span class="s">application/xml+rss</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="depuracion">
<span id="nginx-debug"></span><h2><span class="section-number">7.2.2.2.10.3. </span>Depuración<a class="headerlink" href="#depuracion" title="Link to this heading">¶</a></h2>
<p>Es obvio que depurar el funcionamiento del servidor pasa por mirar los ficheros
de registro. Sin embargo, si realizamos en la configuración <a class="reference internal" href="04.rewrite.html#ngx-rewrite"><span class="std std-ref">reescrituras
internas</span></a>, podremos comprobar que estas no dejan rastro en los
<em>logs</em>, ya que su registro está deshabilitado. Para habilitarlo podemos añadir
fichero <code class="file docutils literal notranslate"><span class="pre">/etc/nginx/conf.d/rewrite.conf</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>cat<span class="w"> </span>&gt;<span class="w"> </span>/etc/nginx/conf.d/rewrite.conf
<span class="go">rewrite_log on;</span>
</pre></div>
</div>
<p>pero esto no es suficiente, ya que se registran en el registro de errores con
nivel <em>notice</em>, mientras que el nivel predeterminado es <em>error</em>.
Consecuentemente, habrá que retocar la directiva <code class="docutils literal notranslate"><span class="pre">error_log</span></code> que corresponda
para cambiar el nivel. Por ejemplo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">error_log  /var/log/nginx/error.log notice;</span>
</pre></div>
</div>
</section>
<section id="servicio-tras-proxy">
<span id="nginx-tras-proxy"></span><h2><span class="section-number">7.2.2.2.10.4. </span>Servicio tras <em>proxy</em><a class="headerlink" href="#servicio-tras-proxy" title="Link to this heading">¶</a></h2>
<p>Cuando un <a class="reference internal" href="../../../05.proxies/03.reverse.html#proxy-inverso"><span class="std std-ref">proxy inverso</span></a> intermedia interceptando la
comunicación entre clientes y servidor, puede actuar de <a class="reference internal" href="../../../05.proxies/03.reverse/02.transparencia.html#proxy-transparente"><span class="std std-ref">modo transparente</span></a> (en cuyo caso nuestro <strong class="program">nginx</strong> será incapaz de
reconocerlo) o no. Es en este segundo caso en el que el
el <a class="reference internal" href="../../../05.proxies/03.reverse/03.web.html#proxy-web-inverso"><span class="std std-ref">proxy web inverso</span></a> produce distorsiones en la
comunicación que debemos tener en cuenta al configurar el servidor <em>web</em>:</p>
<ol class="loweralpha simple">
<li><p>El <em>proxy</em> captura la petición del cliente y la reproduce hacia el servidor lo
que supone que la comunicación que recibe el servidor no proceda del cliente
original, sino del <em>proxy</em>.</p></li>
<li><p>Puede darse el caso de que en las comunicaciones cifradas, el extremo de
cifrado se traslade del servidor al <em>proxy</em>, a fin de que este entienda la
comunicación  <abbr title="HyperText Transfer Protocol">HTTP</abbr> y pueda hacer el trabajo que tenga encomendado (cacheo,
balanceo, etc.). En ese caso, el servidor recibirá una conexión no segura,
pero es conveniente que sepa que originariamente era segura.</p></li>
</ol>
<p>Tenga presente que tratar estas cabeceras en el servidor, no es sólo necesario
para el correcto funcionakiento del servidor, sino también para el correcto
funcionamiento de las aplicaciones que éste ejecute.  Por ejemplo, las
aplicaciones escritas en <abbr title="PHP Hypertext Preprocessor">PHP</abbr> consultan la dirección remota a través de
<code class="docutils literal notranslate"><span class="pre">$_SERVER[&quot;ADDRESS&quot;]</span></code> y si está activo el protocolo seguro a través de
<code class="docutils literal notranslate"><span class="pre">$_SERVER[&quot;HTTPS&quot;]</span></code>. Por tanto, configurar bien el servidor para que ejecute
aplicaciones <abbr title="PHP Hypertext Preprocessor">PHP</abbr> implica que ambos parámetros que pasa el servidor <em>web</em> al
intérprete tengan los valores adecuados.</p>
<section id="cliente-original">
<span id="nginx-clientip"></span><h3><span class="section-number">7.2.2.2.10.4.1. </span>Cliente original<a class="headerlink" href="#cliente-original" title="Link to this heading">¶</a></h3>
<p>Un <em>proxy</em> intermedio que no actúe de forma transparente, hará creer al servidor
web que todas las peticiones las recibe de él. En consecuencia, cualquier
decisión que queramos tomar en función de quién sea quien nos haga la petición
(p.e. si la petición es de un cliente local o uno remoto), será imposible.</p>
<p>Para soslayar este inconveniente los <em>proxies</em> pueblan la cabecera
<a class="reference internal" href="../../01.desc/03.cabecera.html#xforwardedfor"><span class="std std-ref">X-Forwarded-For</span></a>, de manera que el servidor pueda
recalcular la dirección que identifica al cliente original y definir la variable
<a class="reference external" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#var_remote_addr">$remote_addr</a>, en vez de usar la <abbr title="Internet Protocol">IP</abbr> de la conexión (que será la del
<em>proxy</em>). Para que <strong class="program">nginx</strong> sea capaz de aprovechar la información de
esta cabecera puede crearse un fichero con contenido semejante a éste que
aprovecha el módulo <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html">ngx_http_realip_module</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>/etc/nginx/conf.d/realip.conf
<span class="go">set_real_ip_from 127.0.0.1;</span>
<span class="go">set_real_ip_from 10.0.0.0/8;</span>
<span class="go">real_ip_recursive on;</span>
<span class="go">real_ip_header X-Forwarded-For;</span>
</pre></div>
</div>
<p>La directiva <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html#real_ip_header">real_ip_header</a>
permite indicar cuál es el nombre del campo a analizar, <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html#set_real_ip_from">set_real_ip_from</a>
las redes y direcciones en que consideramos que hay <em>proxies</em> que alteran la
<abbr title="Internet Protocol">IP</abbr> original; y <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html#real_ip_recursive">real_ip_recursive</a>
puede tener dos valores que alteran de distinto modo la <abbr title="Internet Protocol">IP</abbr> del cliente (o sea,
<a class="reference external" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#var_remote_addr">$remote_addr</a>)
cuando la detectada originalmente coincide con alguna de las recogidas en
<a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html#set_real_ip_from">set_real_ip_from</a>:</p>
<ul class="simple">
<li><p><em>off</em> provoca que se tome incondicionalmente la última incluida en el campo
referido por <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html#real_ip_header">real_ip_header</a>.</p></li>
<li><p><em>on</em>, que se tome la última que no esté incluida en las referidas por
<a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html#set_real_ip_from">set_real_ip_from</a>.</p></li>
</ul>
<p>Para ilustrarlo supongamos este esquema:</p>
<img alt="../../../../_images/proxies.png" src="../../../../_images/proxies.png" />
<p>que genera la siguiente cabecera <code class="docutils literal notranslate"><span class="pre">X-Forwarded-For</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>X-Forwarded-For: 80.35.60.114 123.12.21.34 10.35.2.3
</pre></div>
</div>
<p>y una dirección <abbr title="Internet Protocol">IP</abbr> para el cliente que vale <em>127.0.0.1</em> originalmente, ya que
el <em>proxy</em> que recibe la comunicación en nuestro servidor (<strong class="program">haproxy</strong>)
se comunica con <strong class="program">nginx</strong> a través de la interfaz de <em>loopback</em>. En este
caso, debido a la configuración anterior en <code class="file docutils literal notranslate"><span class="pre">conf.d/realip.conf</span></code> y a que
la <abbr title="Internet Protocol">IP</abbr> original del cliente está incluida en <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html#real_ip_recursive">real_ip_recursive</a>:</p>
<ul class="simple">
<li><p>Si <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html#real_ip_recursive">real_ip_recursive</a> está deshabilitado, <a class="reference external" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#var_remote_addr">$remote_addr</a> valdrá
<em>10.35.2.3</em>, esto es, la última <abbr title="Internet Protocol">IP</abbr> de <code class="docutils literal notranslate"><span class="pre">X-Forwarded-For</span></code>.</p></li>
<li><p>Si está habilitado, <a class="reference external" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#var_remote_addr">$remote_addr</a> valdrá <em>123.12.21.34</em>, ya que éste es
el último valor de <code class="docutils literal notranslate"><span class="pre">X-Forwarded-For</span></code> que no está incluido en las directivas
<a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html#set_real_ip_from">set_real_ip_from</a>.</p></li>
</ul>
</section>
<section id="protocolo-original">
<h3><span class="section-number">7.2.2.2.10.4.2. </span>Protocolo original<a class="headerlink" href="#protocolo-original" title="Link to this heading">¶</a></h3>
<p>Para que el <em>proxy</em> declare el protocolo (<abbr title="HyperText Transfer Protocol">HTTP</abbr>s) con el que recibió la
petición se suele usar otra cabecera, <em>X-Forwarded-Proto</em>, con valor <em>https</em> si
el protocolo original era <abbr title="HyperText Transfer Protocol">HTTP</abbr>s. Para tenerlo en cuenta en nuestro servidor
podemos incluir esta configuración:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/nginx/conf.d/https.conf</span>
<span class="k">map</span><span class="w"> </span><span class="nv">$http_x_forwarded_proto</span><span class="w"> </span><span class="nv">$_https</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">default</span><span class="w">  </span><span class="nv">$https</span><span class="p">;</span>
<span class="w">   </span><span class="kn">https</span><span class="w">    </span><span class="no">on</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>que permite conocer la naturalza original del protocolo usando la variable de
usuario <kbd class="kbd docutils literal notranslate">$_https</kbd> en vez de la original <kbd class="kbd docutils literal notranslate">$https</kbd>. Ahora, basta con
usar <kbd class="kbd docutils literal notranslate">$_https</kbd> allí donde usábamos antes <kbd class="kbd docutils literal notranslate">$https</kbd>:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">listen</span><span class="w">   </span><span class="mi">80</span><span class="p">;</span>

<span class="w">   </span><span class="kn">server_name</span><span class="w"> </span><span class="s">_</span><span class="p">;</span>

<span class="w">   </span><span class="kn">root</span><span class="w"> </span><span class="s">/srv/www</span><span class="p">;</span>
<span class="w">   </span><span class="kn">try_files</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nv">$uri/</span><span class="w"> </span><span class="p">=</span><span class="mi">404</span><span class="p">;</span>

<span class="w">   </span><span class="c1"># Necesario si queremos redirigir el tráfico seguro a no seguro</span>
<span class="w">   </span><span class="kn">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$_https</span><span class="w"> </span><span class="s">!=</span><span class="w"> </span><span class="s">&quot;on&quot;)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kn">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="s">https://</span><span class="nv">$host$uri$is_args$args</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Además, si el sitio es dinámico y usa <abbr title="PHP Hypertext Preprocessor">PHP</abbr>, debemos hacérselo al intérprete
añadiendo otro bloque a la configuración:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">\.php$</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">include</span><span class="w"> </span><span class="s">snippets/fastcgi-php.conf</span><span class="p">;</span>
<span class="hll"><span class="w">   </span><span class="kn">fastcgi_param</span><span class="w">  </span><span class="s">HTTPS</span><span class="w">  </span><span class="nv">$_https</span><span class="w"> </span><span class="s">if_not_empty</span><span class="p">;</span>
</span><span class="w">   </span><span class="kn">fastcgi_pass</span><span class="w"> </span><span class="s">php</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="pagina-de-mantenimiento">
<h2><span class="section-number">7.2.2.2.10.5. </span>Página de mantenimiento<a class="headerlink" href="#pagina-de-mantenimiento" title="Link to this heading">¶</a></h2>
<p>En ocasiones, podemos requerir ocultar temporalmente uno o varios de los sitios
web que nuestro servidor aloja. Podemos optar por distintas estrategias, pero
una muy cómoda es configurar <strong class="command">nginx</strong> de modo que:</p>
<ol class="loweralpha simple">
<li><p>No se requiere alterar la configuración del servidor para habilitar o
deshabilitar la situación de mantenimiento.</p></li>
<li><p>Si en <code class="file docutils literal notranslate"><span class="pre">/srv/www/enobras</span></code>, creamos el archivo <code class="file docutils literal notranslate"><span class="pre">enabled</span></code>, todos los
sitios que alojemos pasarán a encontrarse en mantemiento y se mostrará una
página que informe de ello.</p></li>
<li><p>Si deseamos poner en mantemiento un sitio particular, entonces debemos crear
el archivo <code class="file docutils literal notranslate"><span class="pre">enabled-nombresitio</span></code>. Por ejemplo, para mostrar la página de
mantenimiento exclusivamente para el sitio <em>info.example.net</em>, debemos crear
el archivo <code class="file docutils literal notranslate"><span class="pre">enabled-info</span></code>.</p></li>
</ol>
<p>Para lograr este comportamiento debemos:</p>
<ol class="arabic">
<li><p>Crear el directorio <code class="file docutils literal notranslate"><span class="pre">/srv/www/enobras</span></code> con una página de mantenimiento
apropiada (p.e. <a class="reference download internal" download="" href="../../../../_downloads/630e362f9cfbcbae8fa57aec03d390c7/mantenimiento.html"><code class="xref download docutils literal notranslate"><span class="pre">ésta</span></code></a>).</p></li>
<li><p>Crear el <em>snippet</em> <a class="reference download internal" download="" href="../../../../_downloads/c887e027546d9098e198d63d9f179b39/mantenimiento.conf"><code class="xref download docutils literal notranslate"><span class="pre">mantenimiento.conf</span></code></a>:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">set</span><span class="w"> </span><span class="nv">$enobras</span><span class="w"> </span><span class="s">&quot;/srv/www/mantenimiento/enobras&quot;</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="s">(-f</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$enobras-$host&quot;</span><span class="s">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">set</span><span class="w"> </span><span class="nv">$mantenimiento</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span><span class="w"> </span><span class="s">(-f</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$enobras&quot;</span><span class="s">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">set</span><span class="w"> </span><span class="nv">$mantenimiento</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1"># Pero hay que evitar la redirección cuando</span>
<span class="c1"># se intenta el desafío HTML del protocolo ACME.</span>
<span class="k">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$uri</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">&quot;/.well-known/&quot;)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">set</span><span class="w"> </span><span class="nv">$mantenimiento</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$mantenimiento</span><span class="s">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">return</span><span class="w"> </span><span class="mi">503</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">error_page</span><span class="w"> </span><span class="mi">503</span><span class="w"> </span><span class="s">@mantenimiento</span><span class="p">;</span>

<span class="k">location</span><span class="w"> </span><span class="s">/enobras</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">internal</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">location</span><span class="w"> </span><span class="s">@mantenimiento</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">root</span><span class="w"> </span><span class="s">/srv/www/enobras</span><span class="p">;</span>
<span class="w">   </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">^</span><span class="w"> </span><span class="s">/mantenimiento.html</span><span class="w"> </span><span class="s">break</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Por hacer</p>
<p>La configuración con <abbr title="Internet Protocol">IP</abbr>s que burlan el mantenimiento que se
aconseja a continuación no está probada.</p>
</div>
<p>Listo. Ahora bien, si el mantenimiento exige hacer cambios sobre la página que
requieren el acceso a la aplicación, la página de mantenimiento nos impedirá
también a nosotros acceder y, por tanto, hacer y probar los cambios. Una
solución es habilitar una serie de direcciones <abbr title="Internet Protocol">IP</abbr> desde las que habilitar el
mantenimiento no tendrá efecto. Para ello necesitamos el módulo <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_geo_module.html">geo</a> de
<strong class="program">nginx</strong>. El módulo puede ayudar a identificar los grupos de direcciones
<abbr title="Internet Protocol">IP</abbr> que queremos que burlen el mantenimiento. Para ello, debe crearse:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/nginx/conf.d/adminip.conf</span>
<span class="k">geo</span><span class="w"> </span><span class="nv">$adminip</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">default</span><span class="w">           </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="kn">127.0.0.0/8</span><span class="w">       </span><span class="mi">1</span><span class="p">;</span>
<span class="w">   </span><span class="kn">10.0.0.0/8</span><span class="w">        </span><span class="mi">1</span><span class="p">;</span>
<span class="w">   </span><span class="kn">172.16.0.0/12</span><span class="w">     </span><span class="mi">1</span><span class="p">;</span>
<span class="w">   </span><span class="kn">192.188.0.0/16</span><span class="w">    </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>que identifica a los clientes que se conectan desde direcciones locales<a class="footnote-reference brackets" href="#id5" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>:
hecho lo cual, podemos modificar <code class="file docutils literal notranslate"><span class="pre">mantenimiento.conf</span></code> para que, cuando la
<abbr title="Internet Protocol">IP</abbr> del cliente sea una de ellas, no tenga efecto el estado de mantemiento:</p>
<blockquote>
<div><div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">set</span><span class="w"> </span><span class="nv">$enobras</span><span class="w"> </span><span class="s">&quot;/srv/www/mantenimiento/enobras&quot;</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="s">(-f</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$enobras-$host&quot;</span><span class="s">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">set</span><span class="w"> </span><span class="nv">$mantenimiento</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span><span class="w"> </span><span class="s">(-f</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$enobras&quot;</span><span class="s">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">set</span><span class="w"> </span><span class="nv">$mantenimiento</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1"># Pero hay que evitar la redirección cuando</span>
<span class="c1"># se intenta el desafío HTML del protocolo ACME.</span>
<span class="k">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$uri</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">&quot;/.well-known/&quot;)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">set</span><span class="w"> </span><span class="nv">$mantenimiento</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="hll"><span class="c1"># o cuando se accede desde una IP administrativa</span>
</span><span class="hll"><span class="k">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$adminip</span><span class="s">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">   </span><span class="kn">set</span><span class="w"> </span><span class="nv">$mantenimiento</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span class="hll"><span class="p">}</span>
</span><span class="k">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$mantenimiento</span><span class="s">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">return</span><span class="w"> </span><span class="mi">503</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">error_page</span><span class="w"> </span><span class="mi">503</span><span class="w"> </span><span class="s">@mantenimiento</span><span class="p">;</span>

<span class="k">location</span><span class="w"> </span><span class="s">/enobras</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">internal</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">location</span><span class="w"> </span><span class="s">@mantenimiento</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">root</span><span class="w"> </span><span class="s">/srv/www/enobras</span><span class="p">;</span>
<span class="w">   </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">^</span><span class="w"> </span><span class="s">/mantenimiento.html</span><span class="w"> </span><span class="s">break</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>El módulo <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_geo_module.html">geo</a> no está compilado estáticamente en el ejecutable,
por lo que deberá comprobar si con su sabor de <strong class="program">nginx</strong> tiene
instalado el paquete <a class="extlink-deb reference external" href="https://packages.debian.org/stable/libnginx-mod-http-geoip">libnginx-mod-http-geoip</a>.</p>
</div>
</section>
<section id="registros-con-systemd">
<span id="nginx-systemd"></span><h2><span class="section-number">7.2.2.2.10.6. </span>Registros con systemd<a class="headerlink" href="#registros-con-systemd" title="Link to this heading">¶</a></h2>
<p><strong class="program">nginx</strong> escribe directamente sus registros en el fichero que indiquemos
en las directivas <a class="reference internal" href="../01.conf.html#nginx-logs"><span class="std std-ref">access_log y error_log</span></a>. Ahora bien,
también da la posibilidad de pasárselos al gestor de registros
(<strong class="program">systemd</strong> en las versiones modernas de <em>debian</em>) y que éste se
encargue. Para ello podemos crear el siguiente fichero:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>/etc/nginx/conf.d/logging.conf
<span class="go">log_format  journald  &#39;$host[$remote_addr] - $request - $status $body_bytes_sent &quot;$http_user_agent&quot;&#39;;</span>
<span class="go">access_log  syslog:server=unix:/dev/log,facility=local7,severity=info,nohostname journald;</span>
<span class="go">error_log   syslog:server=unix:/dev/log,facility=local7,severity=error,nohostname;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Además, habra qué comentar las directivas correspondientes
presentes en <code class="file docutils literal notranslate"><span class="pre">/etc/nginx/nginx.conf</span></code>, porque de lo contrario seguirán
escribiéndose registros en los ficheros ahí definidos:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="c1">##</span>
<span class="c1"># Logging settings</span>
<span class="c1">##</span>

<span class="c1">#access_log /var/log/nginx/access.log;</span>
<span class="c1">#error_log /var/log/nginx/access.log;</span>
</pre></div>
</div>
</div>
<p>De este modo, los registros de acceso y error aparecerían al ejecutar:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>journalctl<span class="w"> </span>-u<span class="w"> </span>nginx
</pre></div>
</div>
<p>Para los de acceso se ha redefinido el formato, a fin de que aparezca el nombre
del dominio al que se accede (por si manejamos varios dominios virtuales) y no
la hora y fecha, ya que de esto último se encarga el propio gestor.
Desgraciadamente para los de error no es posible.</p>
<p>Si además queremos que los registros en su formato tradicional no se apunten
en <code class="file docutils literal notranslate"><span class="pre">/var/log/syslog</span></code>, sino en otro fichero, entonces debemos crear el
fichero <code class="file docutils literal notranslate"><span class="pre">/etc/rsyslog.d/nginx.conf</span></code> con el siguiente contenido:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>cat<span class="w"> </span>&gt;<span class="w"> </span>/etc/rsyslog.d/nginx.conf
<span class="go">local7.=info    /var/log/nginx/access.log</span>
<span class="go">local7.err      /var/log/nginx/error.log</span>
<span class="go">local7.*        &amp;</span>
<span class="gp"># </span>invoke-rc.d<span class="w"> </span>rsyslog<span class="w"> </span>restart
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Como las líneas contienen el nombre del dominio, los registros de
acceso es posible separarlos en distintos archivos dependiendo tal nombre.
Véase <a class="reference external" href="http://www.rsyslog.com/doc/v8-stable/configuration/filters.html">cómo escribir las reglas para rsyslog</a></p>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Como hemos colocado los registros dentro de <code class="file docutils literal notranslate"><span class="pre">/var/log/nginx</span></code> que
es donde <em>debian</em> espera encontrar los logs de <strong class="program">nginx</strong>, no tenemos
que preocuparnos de las rotaciones, ya que existe
<code class="file docutils literal notranslate"><span class="pre">/etc/logrotate.d/nginx</span></code> que se encarga de ello.</p>
</div>
</section>
<section id="cache-de-paquetes">
<span id="nginx-debcache"></span><h2><span class="section-number">7.2.2.2.10.7. </span>Caché de paquetes<a class="headerlink" href="#cache-de-paquetes" title="Link to this heading">¶</a></h2>
<p>Cuando se requiere actualizar muchos ordenadores de la red local, la descarga de
paquetes puedo suponer un gran tráfico de red. Una solución para evitarlo crear
un repositorio completo, pero por lo general sólo se instalan una ínfima parte
de los paquetes de la distribución con que descargamos y sincronizamos muchos
paquetes que no son totalmente inútiles.</p>
<p>Una solución alternativa es crear un <em>proxy</em><a class="footnote-reference brackets" href="#id6" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> caché para almacenar los
paquetes de descargados; asi sólo la primera instación requerirá descargarlos de
internet y las siguientes se limitarán a obtenerlos del <em>proxy</em>.
<strong class="program">nginx</strong> nos permite hacerlo como por otro lado nos lo permitiría
<a class="reference internal" href="../../../05.proxies/02.web.html#squid"><span class="std std-ref">squid</span></a>).</p>
<p>La idea es modificar el fichero <code class="file docutils literal notranslate"><span class="pre">sources.list</span></code> de manera que las líneas
que se escriben así:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">deb http://ftp.fr.debian.org/debian/ stretch  main</span>
</pre></div>
</div>
<p>pasen a estar escritas así:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">deb http://debian-cache.example.net/ftp.fr.debian.org/debian/ stretch  main</span>
</pre></div>
</div>
<p>es decir, la línea es igual pero insertando el nombre de nuestro <em>proxy</em> al
nombre de la máquina del reposito de <em>debian</em>. De este modo, el gestor de
paquetes contactará con nuestro <strong class="program">nginx</strong> y éste será capaz de conocer
cuál es el repositorio y la ruta al recurso, simplemente transformando el primer
directorio en el nombre del repositorio.</p>
<p>Para ello lo primero es crear un directorio de almacenamiento para las
descargas:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/var/cache/nginx
<span class="gp"># </span>chown<span class="w"> </span>www-data<span class="w"> </span>/var/cache/nginx
</pre></div>
</div>
<p>Y ahora definir cómo es esta caché en <code class="file docutils literal notranslate"><span class="pre">/etc/nginx/conf.d/cache.conf</span></code>:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">proxy_cache_path</span><span class="w"> </span><span class="s">/var/cache/nginx/debcache</span>
<span class="w">                 </span><span class="s">levels=1:2</span>
<span class="w">                 </span><span class="s">keys_zone=debcache:8m</span>
<span class="w">                 </span><span class="s">max_size=500m</span>
<span class="w">                 </span><span class="s">inactive=14d</span>
<span class="w">                 </span><span class="s">use_temp_path=off</span><span class="p">;</span>
</pre></div>
</div>
<p>cuyo contenido supone que:</p>
<ul class="simple">
<li><p>Almacenaremos todos los datos en <code class="file docutils literal notranslate"><span class="pre">/var/cache/nginx/debcache</span></code>.</p></li>
<li><p>La caché la podremos referir luego como <em>debcache</em>.</p></li>
<li><p>Dispondrá de un tamaño máximo de 500 MB. Si se supera este tamaño, para
respetar este límite, se empezarán a eliminar contenidos empezando por
aquellos cuyo tiempo de acceso es más antiguo.</p></li>
<li><p>Los contenidos permanecerán 14 días almacenados. Superado este tiempo, se
eliminarán.</p></li>
</ul>
<p>Por último debemos crear el dominio virtual (que hemos llamado
<em>debian-cache.example.net</em>) con <a class="reference download internal" download="" href="../../../../_downloads/695f4f6e58814bc5706987003c50aa46/site-cache"><code class="xref download docutils literal notranslate"><span class="pre">esta</span> <span class="pre">configuracion</span></code></a>:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">listen</span><span class="w">  </span><span class="mi">80</span><span class="p">;</span>
<span class="w">   </span><span class="kn">server_name</span><span class="w">   </span><span class="s">debian-cache.example.net</span><span class="p">;</span>
<span class="w">   </span><span class="kn">server_tokens</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">^/(?P&lt;servidor&gt;[^/]+).*$</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kn">rewrite</span><span class="w">  </span><span class="s">^/[^/]+(.*)</span>$<span class="w"> </span><span class="nv">$1</span><span class="w"> </span><span class="s">break</span><span class="p">;</span>

<span class="w">      </span><span class="kn">proxy_pass</span><span class="w">  </span><span class="s">http://</span><span class="nv">$servidor</span><span class="p">;</span>
<span class="w">      </span><span class="kn">resolver</span><span class="w"> </span><span class="mi">8</span><span class="s">.8.8.8</span><span class="p">;</span><span class="w">  </span><span class="c1"># U otro servidor DNS más apropiado.</span>
<span class="w">      </span><span class="kn">proxy_http_version</span><span class="w"> </span><span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
<span class="w">      </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w">      </span><span class="nv">$servidor</span><span class="p">;</span>
<span class="w">      </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w"> </span><span class="nv">$remote_addr</span><span class="p">;</span>

<span class="w">      </span><span class="kn">proxy_cache</span><span class="w"> </span><span class="s">debcache</span><span class="p">;</span>
<span class="w">      </span><span class="kn">proxy_cache_valid</span><span class="w"> </span><span class="s">8h</span><span class="p">;</span>
<span class="w">      </span><span class="kn">proxy_cache_valid</span><span class="w"> </span><span class="mi">404</span><span class="w"> </span><span class="mi">10m</span><span class="p">;</span>
<span class="w">      </span><span class="kn">proxy_cache_use_stale</span><span class="w"> </span><span class="s">error</span><span class="w"> </span><span class="s">timeout</span><span class="w"> </span><span class="s">updating</span><span class="w"> </span><span class="s">http_500</span><span class="w"> </span><span class="s">http_502</span><span class="w"> </span><span class="s">http_503</span><span class="w"> </span><span class="s">http_504</span><span class="p">;</span>
<span class="w">      </span><span class="kn">proxy_cache_lock</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>

<span class="w">      </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">\.deb$</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kn">rewrite</span><span class="w">  </span><span class="s">^/[^/]+(.*)</span>$<span class="w"> </span><span class="nv">$1</span><span class="w"> </span><span class="s">break</span><span class="p">;</span>
<span class="w">         </span><span class="kn">proxy_pass</span><span class="w">  </span><span class="s">http://</span><span class="nv">$servidor</span><span class="p">;</span>

<span class="w">         </span><span class="kn">proxy_cache_valid</span><span class="w"> </span><span class="s">14d</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Actúa como <em>proxy</em> entre el repositorio de <em>debian</em> y el cliente usando la
caché. Ahora bien, almacenar durante mucho tiempo la lista de paquetes no
es muy recomendable, porque si un paquete se actualiza en el repositorio, pero
nuestra lista no, el cliente intentará obtener una versión antigua del paquete y
se encontrará con un error <strong>404</strong>. Por ello configuramos del siguiente modo:</p>
<ul class="simple">
<li><p>Los ficheros cacheados que no son paquetes <em>debian</em> se considerarán inválidos
después de 8 horas, o sea, una jornada de trabajo. Si se detectan muchos
errores <strong>404</strong> como consecuencia de la desincronización con el repositorio,
se puede disminuir este tiempo a costa de que sean necesarias más
actualizaciones remotas de las listas de paquetes el mismo día.</p></li>
<li><p>Los paquetes, en cambio, se consideran válidos durante 14 días. A diferencia
del caso anterior que un paquete cacheado se vuelva obsoleto, no supone un
error, ya que el cliente descargará el nuevo paquete. La única desventaja es
que cachearemos la versión antigua y la nueva y ocuparemos espacio de disco
innecesariamente.</p></li>
</ul>
</section>
<section id="testeo-del-rendimiento">
<h2><span class="section-number">7.2.2.2.10.8. </span>Testeo del rendimiento<a class="headerlink" href="#testeo-del-rendimiento" title="Link to this heading">¶</a></h2>
<div class="admonition-todo admonition" id="id4">
<p class="admonition-title">Por hacer</p>
<p>Mostrar el uso de apachebench (p.e. tal como explica <a class="reference external" href="https://easyengine.io/tutorials/benchmark/apachebench/">aquí</a>)</p>
</div>
<p class="rubric">Notas al pie</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id5" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">1</a><span class="fn-bracket">]</span></span>
<p>Podríamos, claro está, incluir también alguna dirección publica propia
desde la que nos solemos conectar al servidor para administrarlo.</p>
</aside>
<aside class="footnote brackets" id="id6" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">2</a><span class="fn-bracket">]</span></span>
<p>Aunque es mucho mas sencillo, si no necesitamos instalar <strong class="program">nginx</strong> por
otra razón, usar <a class="reference external" href="https://www.tecmint.com/apt-cache-server-in-ubuntu/">apt-cacher-ng</a>.</p>
</aside>
</aside>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../../../index.html">Tabla de contenido</a></h3>
    <ul>
<li><a class="reference internal" href="#">7.2.2.2.10. Otros aspectos</a><ul>
<li><a class="reference internal" href="#definicion-mediante-mapeo">7.2.2.2.10.1. Definición mediante mapeo</a></li>
<li><a class="reference internal" href="#compresion">7.2.2.2.10.2. Compresión</a></li>
<li><a class="reference internal" href="#depuracion">7.2.2.2.10.3. Depuración</a></li>
<li><a class="reference internal" href="#servicio-tras-proxy">7.2.2.2.10.4. Servicio tras <em>proxy</em></a><ul>
<li><a class="reference internal" href="#cliente-original">7.2.2.2.10.4.1. Cliente original</a></li>
<li><a class="reference internal" href="#protocolo-original">7.2.2.2.10.4.2. Protocolo original</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pagina-de-mantenimiento">7.2.2.2.10.5. Página de mantenimiento</a></li>
<li><a class="reference internal" href="#registros-con-systemd">7.2.2.2.10.6. Registros con systemd</a></li>
<li><a class="reference internal" href="#cache-de-paquetes">7.2.2.2.10.7. Caché de paquetes</a></li>
<li><a class="reference internal" href="#testeo-del-rendimiento">7.2.2.2.10.8. Testeo del rendimiento</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Tema anterior</h4>
    <p class="topless"><a href="08.multiplex.html"
                          title="capítulo anterior"><span class="section-number">7.2.2.2.9. </span>Multiplexación</a></p>
  </div>
  <div>
    <h4>Próximo tema</h4>
    <p class="topless"><a href="../03.misc/index.html"
                          title="próximo capítulo"><span class="section-number">7.2.2.3. </span>Recetas</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/07.serre/02.web/02.nginx/02.avanz/09.misc.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Ir a" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="../03.misc/index.html" title="7.2.2.3. Recetas"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="08.multiplex.html" title="7.2.2.2.9. Multiplexación"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">7. </span>Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">7.2. </span>Web</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" ><span class="section-number">7.2.2. </span>nginx</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="index.html" ><span class="section-number">7.2.2.2. </span>Configuración</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7.2.2.2.10. </span>Otros aspectos</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright CC BY 4.0, 2016-2025, José Miguel Sánchez Alés.
      Creado usando <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>