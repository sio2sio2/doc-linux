

<!DOCTYPE html>

<html lang="es" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>9.1.3.3. Correo electrónico &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css?v=2bf1fcf8" />
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    
    <script src="../../../_static/documentation_options.js?v=a621b78a"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/translations.js?v=f85f4cfb"></script>
    
    <link rel="index" title="Índice" href="../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../search.html" />
    <link rel="next" title="9.1.3.4. Protocolos seguros de red" href="04.ssl.html" />
    <link rel="prev" title="9.1.3.2. Firma de documentos" href="02.pdf.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="04.ssl.html" title="9.1.3.4. Protocolos seguros de red"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="02.pdf.html" title="9.1.3.2. Firma de documentos"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" ><span class="section-number">9. </span>Apéndices</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" ><span class="section-number">9.1. </span>Criptografía</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../03.aplicaciones.html" accesskey="U"><span class="section-number">9.1.3. </span>Aplicaciones de la criptografía</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">9.1.3.3. </span>Correo electrónico</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="correo-electronico">
<span id="email-seguro"></span><h1><span class="section-number">9.1.3.3. </span>Correo electrónico<a class="headerlink" href="#correo-electronico" title="Link to this heading">¶</a></h1>
<p>Los mecanimos de cifrado y firma electrónica se implementan en los mensajes de
correo electrónico a través de dos estándares, cuya principal diferencia es la
infraestructura sobre la que se sustenta la confianza en las claves de cifrado:</p>
<ul class="simple">
<li><p>Open<abbr title="Pretty Good Privacy">PGP</abbr> (<span class="target" id="index-0"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc3156.html"><strong>RFC 3156</strong></a>), en el que cada usuario genera sus propias claves y
se establece una <a class="reference internal" href="01.certdig.html#web-trust-strat"><span class="std std-ref">red de confianza</span></a> totalmente
descentralizada. Los certificados <abbr title="Pretty Good Privacy">PGP</abbr> incluyen como datos identificativos el
nombre del propietario y su dirección de correo electrónico.</p></li>
<li><p><abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> (<span class="target" id="index-1"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc8551.html"><strong>RFC 8551</strong></a>), en el que se usa la estructura jerárquica <abbr title="Public Key Infraestructure">PKI</abbr> de
certificados X.509, que se explicó al hablar del <a class="reference internal" href="01.certdig.html#cert-digital"><span class="std std-ref">certificado digital</span></a>.</p></li>
</ul>
<p>Por lo demás, los estándares son similares en la estrategia que usan para
firmar o cifrar el cuerpo del mensaje (no los campos de cabecera<a class="footnote-reference brackets" href="#id8" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>):</p>
<dl>
<dt><strong>Firma</strong></dt><dd><p>Al firmar un mensaje se añade un campo <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> <kbd class="kbd docutils literal notranslate">multipart/signed</kbd> a la
cabecera:</p>
<div class="highlight-email notranslate"><div class="highlight"><pre><span></span><span class="nt">Content-Type:</span><span class="w"> </span><span class="nl">multipart</span><span class="dl">/</span><span class="nl">signed</span>;<span class="w"> </span><span class="na">protocol</span><span class="o">=</span><span class="s">&quot;application/x-pkcs7-signature&quot;</span>;
<span class="w">    </span><span class="na">micalg</span><span class="o">=</span><span class="s">sha-256</span>;<span class="w"> </span><span class="na">boundary</span><span class="o">=</span><span class="s">&quot;XXXXX&quot;</span>
</pre></div>
</div>
<p>donde:</p>
<ul class="simple">
<li><p><kbd class="kbd docutils literal notranslate">protocol</kbd> especifica qué estándar se usa (en este caso, <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr>).</p></li>
<li><p><kbd class="kbd docutils literal notranslate">micalg</kbd>, el <a class="reference internal" href="../02.algo.html#hash"><span class="std std-ref">algoritmo de resumen</span></a> utilizado.</p></li>
<li><p><kbd class="kbd docutils literal notranslate">boundary</kbd>, como en cualquier otro <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr>, permite identificar las distintas partes.</p></li>
</ul>
<p>Y el cuerpo del mensaje se estructura en dos partes:</p>
<ol class="arabic simple">
<li><p>La primera contiene el mensaje original, el cual puede a su vez estar
constituido por múltiples partes <abbr title="Multipurpose Internet Mail Extensions">MIME</abbr> (p.e. porque el mensaje
contuviera adjuntos).</p></li>
<li><p>La segunda constituye la firma sobre la parte anterior:</p></li>
</ol>
<div class="highlight-email notranslate"><div class="highlight"><pre><span></span><span class="nt">From:</span><span class="w"> </span><span class="nl">yo@micasa.com</span>
<span class="nt">To:</span><span class="w"> </span><span class="nl">tu@tucasa.com</span>
<span class="nt">Content-Type:</span><span class="w"> </span><span class="nl">multipart</span><span class="dl">/</span><span class="nl">signed</span>;<span class="w"> </span><span class="na">protocol</span><span class="o">=</span><span class="s">&quot;application/x-pkcs7-signature&quot;</span>;
<span class="w">    </span><span class="na">micalg</span><span class="o">=</span><span class="s">sha-256</span>;<span class="w"> </span><span class="na">boundary</span><span class="o">=</span><span class="s">&quot;XXXXX&quot;</span>
<span class="nt">Subject:</span><span class="w"> </span>Un<span class="w"> </span>mensaje<span class="w"> </span>firmado

<span class="dl">--XXXXX</span>
<span class="x">Content-Type: text/plain; charset=utf-8</span>
<span class="x">Content-Disposition: inline</span>
<span class="x">Content-Transfer-Encoding: quoted-printable</span>

<span class="x">Este es el texto del mensaje que se firma...</span>
<span class="x">...</span>
<span class="x">... Mucho más texto ...</span>
<span class="x">...</span>

<span class="dl">--XXXXX</span>
<span class="x">Content-Type: application/x-pkcs7-signature</span>
<span class="x">Content-Disposition: attachment; filename=&quot;smime.p7s&quot;</span>
<span class="x">Content-Transfer-Encoding: base64</span>

<span class="x">LA.FIRMA.EN.SI.TAL.VEZ.LA.CLAVE</span>

<span class="dl">--XXXXX</span>
</pre></div>
</div>
<p>La firma se construye resumiendo la primera parte con una función de <em>hash</em>
(<abbr title="sechure Hash Algorithm">SHA</abbr>-256 en nuestro ejemplo) y cifrándola con la clave privada del
emisor. El contenido de esta segunda parte, sin embargo, puede contener,
además de la propia firma, el certificado público del emisor.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La primera parte es <em>inline</em> mientras que la segunda parte adopta
la forma de un adjunto de nombre <code class="file docutils literal notranslate"><span class="pre">smime.p7s</span></code>. Esto implica que un
cliente que no entienda la firma, muestre el texto del mensaje normalmente
y presente la firma como un adjunto a descargar.</p>
</div>
</dd>
<dt><strong>Cifrado</strong></dt><dd><p>El cifrado de un mensaje consiste en cifrar el cuerpo del mensaje del
siguiente modo:</p>
<ul class="simple">
<li><p>Muy comúnmente se comprime el cuerpo lo que reduce su tamaño y, además,
disminuye la existencia de patrones que hagan menos seguro el cifrado.</p></li>
<li><p>Se genera una clave simétrica (p.e. <abbr title="Advanced Encryption Standard">AES</abbr>) y se cifra el cuerpo con ella.</p></li>
<li><p>Se cifra la clave anterior con la clave pública del destinatario a fin de
que sólo el destinario tenga acceso a ella y por tanto a descifrar el
mensaje. Si hay varios destinatarios, se adjutan copias de la clave
simétrica cifradas con sendas claves públicas.</p></li>
</ul>
</dd>
</dl>
<p>Los mensajes de correo pueden estar cifrados y firmados lo cual implica hacer
primero una acción y luego la otra. Lo habitual es que los <abbr title="Mail User Agent">MUA</abbr> firmen primero
y cifren después el mensaje firmado.</p>
<section id="s-mime">
<span id="smime"></span><h2><span class="section-number">9.1.3.3.1. </span><abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr><a class="headerlink" href="#s-mime" title="Link to this heading">¶</a></h2>
<p>Open<abbr title="Secure Socket Layer">SSL</abbr> tiene una suborden (<kbd class="kbd docutils literal notranslate">smime</kbd>) que implementa este estándar y nos
sirve para probar cómo funciona. Incluye además otra (<kbd class="kbd docutils literal notranslate">cms</kbd>) que proporciona
más opciones que la anterior, pero sirve para el mismo fin.</p>
<p class="rubric">Firma</p>
<p>Ya hemos visto que <strong>firmar</strong> un mensaje de correo consiste en firmar el
contenido de la primera parte del <kbd class="kbd docutils literal notranslate">multipart/signed</kbd> (lo que antes de
haberse firmado el correo constituía el cuerpo del mensaje) y añadirlo como
contenido de la segunda parte en forma de adjunto (cuyo nombre en el ejemplo es
<code class="file docutils literal notranslate"><span class="pre">smime.p7s</span></code>). Podemos emular estas acciones con <a class="reference internal" href="../02.algo.html#openssl"><span class="std std-ref">openssl</span></a>
tomando un archivo (que hará el papel de primera parte):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>smime<span class="w"> </span>-sign<span class="w"> </span>-in<span class="w"> </span>fichero.txt<span class="w"> </span>-signer<span class="w"> </span>micert.pem<span class="w"> </span>-out<span class="w"> </span>fichero.eml
</pre></div>
</div>
<p>done <code class="file docutils literal notranslate"><span class="pre">micert.pem</span></code> es un archivo <abbr title="Private Enhanced Mail">PEM</abbr> con el certificado y la clave
privada del firmante<a class="footnote-reference brackets" href="#id9" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>. El archivo resultante <code class="file docutils literal notranslate"><span class="pre">fichero.eml</span></code> adopta el
aspecto de un correo electrónico <kbd class="kbd docutils literal notranslate">multipart/signed</kbd> como el mostrado más
arriba. Si quisiéramos obtener exclusivamente la firma, y no todo el mensaje,
podríamos hacer con la salida anterior:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>smime<span class="w"> </span>-pk7out<span class="w"> </span>-in<span class="w"> </span>fichero.eml<span class="w"> </span>-out<span class="w"> </span>smime.p7s
</pre></div>
</div>
<p>o bien haber cambiando el formato de salida de la primera orden (que por
defecto es <kbd class="kbd docutils literal notranslate">SMIME</kbd>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>smime<span class="w"> </span>-sign<span class="w"> </span>-in<span class="w"> </span>fichero.txt<span class="w"> </span>-signer<span class="w"> </span>micert.pem<span class="w"> </span>-outform<span class="w"> </span>pem<span class="w"> </span>-out<span class="w"> </span>smime.p7s
</pre></div>
</div>
<p>La firma, generada así, contiene, además del <em>resumen</em> y la clave simétrica
cifrados (recuérdense los <a class="reference internal" href="../02.algo.html#firma-digital"><span class="std std-ref">conceptos sobre firma digital</span></a>), el certificado del firmante, por si el destinatario
careciera de ella. No contendrá, no osbtante, certificados intermedios aunque
<code class="file docutils literal notranslate"><span class="pre">micert.pem</span></code> los incluyera<a class="footnote-reference brackets" href="#id10" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>.</p>
<p>Obtenida la firma podemos verificarla:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>smime<span class="w"> </span>-verify<span class="w"> </span>-in<span class="w"> </span>fichero.eml
</pre></div>
</div>
<p>aunque la verificación fallará si falta algún certificado intermedio. Para
subsanarlo puede añadirse a la orden anterior la opción <kbd class="kbd docutils literal notranslate">-noverify</kbd>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>smime<span class="w"> </span>-verify<span class="w"> </span>-in<span class="w"> </span>fichero.eml<span class="w"> </span>-noverify
</pre></div>
</div>
<p>o incluir los certificados intermedios en un archivo y referirlo con <kbd class="kbd docutils literal notranslate">-CAfile</kbd>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>smime<span class="w"> </span>-verify<span class="w"> </span>-in<span class="w"> </span>fichero.eml<span class="w"> </span>-CAfile<span class="w"> </span>ca-certs.pem
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Si se intenta verificar la firma usando <code class="file docutils literal notranslate"><span class="pre">smime.p7s</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>smime<span class="w"> </span>-verify<span class="w"> </span>-in<span class="w"> </span>smime.p7s<span class="w"> </span>-inform<span class="w"> </span>pem<span class="w"> </span>-noverify<span class="w"> </span>-content<span class="w"> </span>fichero.txt
</pre></div>
</div>
<p>la verificación fallará como consecuencia de que el estándar <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> antes de calcular
el resumen modifica los cambios de línea (en <em>UNIX</em> habitualmente «<kbd class="kbd docutils literal notranslate">\n</kbd>») a la forma
canónica «<kbd class="kbd docutils literal notranslate">\r\n</kbd>». Podemos solucionarlo o incluyendo la opción <kbd class="kbd docutils literal notranslate">-binary</kbd> al generar
la firma para evitar la modificación:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>smime<span class="w"> </span>-sign<span class="w"> </span>-binary<span class="w"> </span>-in<span class="w"> </span>fichero.txt<span class="w"> </span>-signer<span class="w"> </span>micert.pem<span class="w"> </span>-outform<span class="w"> </span>pem<span class="w"> </span>-out<span class="w"> </span>smime.p7s
</pre></div>
</div>
<p>o modificando al vuelo <code class="file docutils literal notranslate"><span class="pre">fichero.txt</span></code> para que presente tales cambios de línea al hacer la verificación:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>smime<span class="w"> </span>-verify<span class="w"> </span>-in<span class="w"> </span>smime.p7s<span class="w"> </span>-inform<span class="w"> </span>pem<span class="w"> </span>-noverify<span class="w"> </span>-content<span class="w"> </span>&lt;<span class="o">(</span>sed<span class="w"> </span><span class="s1">&#39;s:$:^M:&#39;</span><span class="w"> </span>fichero.txt<span class="o">)</span>
</pre></div>
</div>
</div>
<p>Otra acción útil que puede hacerse sobre <code class="file docutils literal notranslate"><span class="pre">smime.p7s</span></code> es rescatar los certificados de usuario
que contenga:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>pkcs7<span class="w"> </span>-in<span class="w"> </span>smime.p7s<span class="w"> </span>-print_certs<span class="w"> </span>-out<span class="w"> </span>certs.pem
</pre></div>
</div>
<p class="rubric">Cifrado</p>
<p>Para cifrar un archivo (en un mensaje de correo se cifraría el cuerpo del
mensaje) la orden es esta:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>smime<span class="w"> </span>-encrypt<span class="w"> </span>-in<span class="w"> </span>fichero.txt<span class="w"> </span>-aes256<span class="w"> </span>-out<span class="w"> </span>fichero.eml<span class="w"> </span>pubkey.pem
</pre></div>
</div>
<p>donde <code class="file docutils literal notranslate"><span class="pre">cert.pem</span></code> contiene la clave pública del destinatario del archivo
cifrado. Si se quiere cifrar para más destinatarios habrä que añadir archivos
<abbr title="Private Enhanced Mail">PEM</abbr> adicionales a la orden, ya que es inútil añadirlos dentro de un mismo
archivo <abbr title="Private Enhanced Mail">PEM</abbr>. Obsérvese, además, que se incluye la opción <kbd class="kbd docutils literal notranslate">-aes256</kbd> para
indicar que se use cifrado <abbr title="Advanced Encryption Standard">AES</abbr>. Este cifrado es simétrico, porque, como ya se
ha explicado al explicar el cifrado de mensajes de correo, el archivo se cifra
con una clave simétrica generada <em>ad hoc</em> y es esta clave simétrica la que se
cifra con las claves públicas de los destinatarios.</p>
<p>El archivo resultante de esta orden tiene forma de mensaje de correo:</p>
<div class="highlight-email notranslate"><div class="highlight"><pre><span></span><span class="nt">MIME-Version:</span><span class="w"> </span>1.0
<span class="nt">Content-Disposition:</span><span class="w"> </span>attachment;<span class="w"> </span>filename=&quot;<span class="nf">smime.p7m</span>&quot;
<span class="nt">Content-Type:</span><span class="w"> </span><span class="nl">application</span><span class="dl">/</span><span class="nl">x-pkcs7-mime</span>;<span class="w"> </span><span class="na">smime-type</span><span class="o">=</span><span class="s">enveloped-data</span>;
<span class="w">   </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;smime.p7m&quot;</span>
<span class="nt">Content-Transfer-Encoding:</span><span class="w"> </span><span class="no">base64</span>

<span class="x">MENSAJE.CIFRADO.CODIFICADO.EN.BASE64</span>
</pre></div>
</div>
<p>y, de hecho, si añadiera sus campos de cabecera típicos (<kbd class="kbd docutils literal notranslate">Subject</kbd>,
<kbd class="kbd docutils literal notranslate">From</kbd>, etc.) sería un mensaje válido para ser enviado mediante <abbr title="Simple Mail Transfer Protocol">SMTP</abbr>. Por
esta razón, si el mensaje se consulta a través de un <abbr title="Mail User Agent">MUA</abbr> sin soporte para
mensajes cifrados, se observará un mensaje sin contenido visible, pero con un
adjunto llamado <code class="file docutils literal notranslate"><span class="pre">smime.p7m</span></code>.</p>
<p>Para obtener este adjunto directamente, prescindiendo del formato <em>SMIME</em>,
podríamos haber hecho:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>smime<span class="w"> </span>-encrypt<span class="w"> </span>-in<span class="w"> </span>fichero.txt<span class="w"> </span>-aes256<span class="w"> </span>-out<span class="w"> </span>smime.p7m<span class="w"> </span>-outform<span class="w"> </span>pem<span class="w"> </span>pubkey.pem
</pre></div>
</div>
<p>De este archivo de salida (o el <code class="file docutils literal notranslate"><span class="pre">.eml</span></code>) se puede extraer el contenido
original descifrando con el certificado completo (incluyendo la clave privada)
del destinatario:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>smime<span class="w"> </span>-decrypt<span class="w"> </span>-in<span class="w"> </span>smime.p7m<span class="w"> </span>-inform<span class="w"> </span>pem<span class="w"> </span>-recip<span class="w"> </span>cert.pem
<span class="go">El contenido original perfectamente descifrado</span>
</pre></div>
</div>
<p>aunque, si se tienen por separado certificado y clave privada, puede indicarse
ésta mediante la opción <kbd class="kbd docutils literal notranslate">-inkey</kbd>.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Los archivos <abbr title="Public-Key Cryptography Standards">PKCS</abbr> #7 generados con las órdenes de este epígrafe
pueden bichearse con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>cms<span class="w"> </span>-cmsout<span class="w"> </span>-print<span class="w"> </span>-in<span class="w"> </span>smime.p7m<span class="w"> </span>-inform<span class="w"> </span>pem
</pre></div>
</div>
</div>
</section>
<section id="gnupg">
<span id="openpgp"></span><span id="id4"></span><h2><span class="section-number">9.1.3.3.2. </span>Open<abbr title="Pretty Good Privacy">PGP</abbr><a class="headerlink" href="#gnupg" title="Link to this heading">¶</a></h2>
<p>Para ilustrar este estándar usaremos <abbr title="GNU Provacy Guard">GnuPG</abbr>, aunque lo habitual es que los
agentes de correo (<abbr title="Mail User Agent">MUA</abbr>) como <a class="reference internal" href="../../../07.serre/03.mail/04-misc/02-cliente/05-mua.html#mutt"><span class="std std-ref">mutt</span></a> o <a class="reference external" href="https://www.thunderbird.net">Thunderbird</a>, hagan uso del
estándar de manera sencilla, o incluso podemos llegar a usarlo con determinados
servicios de <em>webmail</em> y la extensión adecuada del navegador.  Por ejemplo, en
<a class="reference external" href="https://www.chromium.org">Chromium</a> existe la extensión <a class="reference external" href="https://www.mailvelope.com/en">Mailenvelope</a> que permite el cifrado de mensajes
para los principales sitios de webmail (<a class="reference external" href="https://gmail.google.com">Gmail</a>, <a class="reference external" href="https://mail.yahoo.com">Yahoo</a>, <a class="reference external" href="https://www.outlook.com">Outlook</a>, etc.).</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>En <em>Windows</em> <a class="reference external" href="https://www.gpg4win.org/">GPG4Win</a> permite hacer gráficamente las operaciones que
aquí mostraremos para <em>Linux</em>, añade <em>plugins</em> para algunas aplicaciones
como <strong class="program">Outlook</strong> y <strong class="program">Explorer</strong> e incluye además un gestor de
certificados X.509 (aunque es este el tipo de certificados que soporta el
gestor nativo de <em>Windows</em>).</p>
</div>
<section id="instalacion">
<h3><span class="section-number">9.1.3.3.2.1. </span>Instalación<a class="headerlink" href="#instalacion" title="Link to this heading">¶</a></h3>
<p>La instalación es sumamente sencilla:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>gnupg
</pre></div>
</div>
<p>Como configuración podemos usar la siguiente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir<span class="w"> </span>-m<span class="w"> </span><span class="m">700</span><span class="w"> </span>~/.gnupg
<span class="gp">$ </span>cat<span class="w"> </span>&gt;<span class="w"> </span>~/.gnupg/gpg.conf
<span class="gp">#</span>keyserver<span class="w"> </span>hkps://sks-keyservers.net:443
<span class="go">keyserver hkp://pool.sks-keyservers.net</span>
<span class="go">no-greeting</span>
<span class="go">armor</span>

<span class="go">personal-digest-preferences SHA512</span>
<span class="go">cert-digest-algo SHA512</span>
<span class="go">default-preference-list SHA512 SHA384 SHA256 SHA224 AES256 AES192 AES CAST5 ZLIB BZIP2 ZIP Uncompressed</span>
<span class="go">personal-cipher-preferences AES256 TWOFISH CAMELLIA256 3DES</span>
</pre></div>
</div>
<p>Con la que seleccionamos cuáles son nuestros algoritmos de cifrado y <em>hash</em>
preferidos. Además, con <kbd class="kbd docutils literal notranslate">armor</kbd> guardamos el texto cifrado como caracteres
imprimibles.</p>
<p>Si ejecutamos la orden:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--version
</pre></div>
</div>
<p>podremos consultar cuáles son los algoritmos de cifrado, <em>hash</em> y compresión que
usa el programa.</p>
</section>
<section id="cifrado-simetrico">
<span id="gnupg-cif-sim"></span><h3><span class="section-number">9.1.3.3.2.2. </span>Cifrado simétrico<a class="headerlink" href="#cifrado-simetrico" title="Link to this heading">¶</a></h3>
<p>Antes de entrar realmente en harina, podemos usar <abbr title="GNU Provacy Guard">GnuPG</abbr> para hacer cifrado
simétrico:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;Hola, caracola!!!&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/tmp/saludo.txt
<span class="gp">$ </span>gpg<span class="w"> </span>-c<span class="w"> </span>/tmp/saludo.txt
</pre></div>
</div>
<p>La orden genera el fichero cifrado <code class="file docutils literal notranslate"><span class="pre">/tmp/saludo.txt.asc</span></code> con esta pinta<a class="footnote-reference brackets" href="#id11" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">-----BEGIN PGP MESSAGE-----</span>

<span class="go">jA0ECQMCgmqtVcUnh0H80lAB2H6YjrKdXR2P2I9a0JRDKpoQhEJc//dnzA550ged</span>
<span class="go">Q2DYgVpYgaL3Se26CAwii54xhZfUijWnGg7pPSKc7Zd81TLvQm75MA6IbsDPGHEN</span>
<span class="go">eQ==</span>
<span class="go">=5YjK</span>
<span class="go">-----END PGP MESSAGE-----</span>
</pre></div>
</div>
<p>El fichero podría haberse enviado a otro fichero usando la opción <code class="docutils literal notranslate"><span class="pre">--output</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>-c<span class="w"> </span>-o<span class="w"> </span>/tmp/otrofichero.asc<span class="w"> </span>/tmp/saludo.txt
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Si se usa como nombre de fichero <kbd class="kbd docutils literal notranslate">-</kbd>, la salida será la estándar.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>El formato del fichero cifrado sigue el estándar marcado por
Open<abbr title="Pretty Good Privacy">PGP</abbr>, pero también podríamos haber generado un fichero cifrado que use
caracteres no imprimibles habiendo añadido <code class="docutils literal notranslate"><span class="pre">--no-armor</span></code>. En este caso, la
extensión añadida es <code class="docutils literal notranslate"><span class="pre">.gpg</span></code> en vez de <code class="docutils literal notranslate"><span class="pre">.asc</span></code>.</p>
</div>
<p>Si hemos ejecutado las ordenes anteriores, habremos comprobado que se pide de
forma interactiva la clave simétrica de cifrado. Si queremos ejecutar la orden
de forma no interactiva podemos hacer lo siguiente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--batch<span class="w"> </span>--passphrase<span class="w"> </span><span class="s1">&#39;contraseñadificil&#39;</span><span class="w"> </span>-c<span class="w"> </span>/tmp/saludo.txt
</pre></div>
</div>
<p>o bien:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">printf</span><span class="w"> </span><span class="s1">&#39;contraseñadificil&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>gpg<span class="w"> </span>--batch<span class="w"> </span>--passphrase-fd<span class="w"> </span><span class="m">0</span><span class="w"> </span>-c<span class="w"> </span>/tmp/saludo.txt
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Aunque recordemos que eso guardará en el historial la contraseña y
es muy discutible su seguridad, por lo que al menos deberíamos asegurarnos de
que tal cosa no sucede.</p>
</div>
<p>Para descifrar, podemos usar la opción <kbd class="kbd docutils literal notranslate">-d</kbd>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>-qd<span class="w"> </span>/tmp/saludo.txt.asc
<span class="go">Hola, caracola!!!</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La opción <code class="docutils literal notranslate"><span class="pre">-q</span></code> ejecuta la orden en modo silencioso.</p>
</div>
<p>Hay algo, sin embargo, extraño: ¿por qué no se nos pide la clave anteriormente
suministrada durante la operación de cifrado para descifrar?  La razón es que
<strong class="command">gpg</strong> levanta automáticamente un demonio que se encarga de recordar
claves. Si por alguna razón se desea pararlo, puede hacerse:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpgconf<span class="w"> </span>--kill<span class="w"> </span>gpg-agent
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Si nuestra intención es consultar cuáles es el cifrado sin descifrar
en absoluto, podemos hacer:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--list-only<span class="w"> </span>-d<span class="w"> </span>saludo.txt.asc
</pre></div>
</div>
</div>
</section>
<section id="gestion-de-claves">
<span id="gpg-pgp"></span><h3><span class="section-number">9.1.3.3.2.3. </span>Gestión de claves<a class="headerlink" href="#gestion-de-claves" title="Link to this heading">¶</a></h3>
<p>La aplicación utiliza un repositorio donde va almacenando las claves públicas y
privadas que se necesiten. Por ejemplo, nuestro propio par de claves (pública y
privada) y las claves públicas de todos aquellos con los que intercambiemos
información de forma segura. El objetivo de este epígrafe es cómo saber generar
nuestra clave (recordemos que en <abbr title="Pretty Good Privacy">PGP</abbr> cada usuario genera sus claves), cómo
exportar e importar claves, y cómo borrar claves que no deseemos almacenar más.</p>
<p class="rubric">Generación</p>
<p>Para generar un par de claves podemos hacer:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--gen-key<span class="w"> </span>--default-new-key-algo<span class="w"> </span>rsa3072
</pre></div>
</div>
<p>que nos pedirá el nombre de su propietario y la dirección de correo electrónico,
que se usará como identificador para las claves generadas. Además, se nos pedirá
una clave simétrica con la que cifrar la clave privada. Esta contraseña deberá
consignarse cada vez que la clave privada tenga que usarse y es una simple
medida de seguridad para evitar que, si la clave privada cae en manos ajenas, el
ladrón tenga fácil usurpar la identidad del legítimo propietario. Se han
añadido, además, dos datos relevantes: el tiempo de vigencia de la clave (un
año), que de forma predeterminada es eterno, y el tipo de algoritmo<a class="footnote-reference brackets" href="#id12" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a>. La
orden no sólo genera las claves, sino que las almacena en el anillo de claves
(todo dentro de <code class="file docutils literal notranslate"><span class="pre">~/.gnupg</span></code>), con lo que podremos consultar su existencia
listando cuáles son las claves públicas almacenadas:</p>
<div class="highlight-console notranslate" id="gpg-list-keys"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--list-keys<span class="w"> </span>--keyid-format<span class="w"> </span>short
<span class="go">/home/usuario/.gnupg/pubring.kbx</span>
<span class="go">--------------------------------</span>
<span class="go">pub   rsa3072/B0B83042 2019-11-08 [SC] [caduca: 2021-11-07]</span>
<span class="go">      F08A6107385FE48775100943E3DCBB0AB0B83042</span>
<span class="go">uid      [  absoluta ] Licenciado Cebadilla (cuenta de pruebas) &lt;xxxx@gmail.com&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Obsérvese que la clave, tal como se ha generado, sólo sirve para
firmar y no para cifrar (no aparece <kbd class="kbd docutils literal notranslate">E</kbd> dentro de los corchetes). Si
nuestra intención es usarla <a class="reference internal" href="#gnupg-cif-asi"><span class="std std-ref">también para cifrar</span></a>
entonces deberemos añadir una subclave para cifrado:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w">  </span>--quick-add-key<span class="w"> </span>F08A6107385FE48775100943E3DCBB0AB0B83042
</pre></div>
</div>
</div>
<p>También podemos comprobar las claves privadas:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--list-secret-keys
</pre></div>
</div>
<p>Por ahora sólo veremos una y una respectivamente. Lo habitual es que
dispongamos de una única clave privada y muchas públicas, ya que podemos importar
a nuestro repositorio claves públicas ajenas.</p>
<p>En versiones modernas  de <strong class="command">gpg</strong> existe la opción <kbd class="kbd docutils literal notranslate">-</kbd>-<kbd class="kbd docutils literal notranslate">full</kbd>-<kbd class="kbd docutils literal notranslate">gen</kbd>-<kbd class="kbd docutils literal notranslate">key</kbd> que
pregunta interactivamente otras opciones como el propio algoritmo o el tiempo de
vigencia. En cualquier caso, si se quiere alterar algún parámetro, como el
tiempo de vigencia, puede usarse la opción <kbd class="kbd docutils literal notranslate">-</kbd>-<kbd class="kbd docutils literal notranslate">edit</kbd>-<kbd class="kbd docutils literal notranslate">key</kbd>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--edit-key<span class="w"> </span>xxxx@gmail.com
</pre></div>
</div>
<p class="rubric">Importación/exportación local de claves</p>
<p>Como debemos compartir nuestra clave pública con el resto de usuarios y, a su
vez, recibir de éstos sendas claves públicas, <a class="reference internal" href="#gnupg">GnuPG</a> provee de mecanismos para
la importación y exportación de claves.</p>
<p>Para exportar una clave pública del repositorio, podemos hacer:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--export<span class="w"> </span>xxxx@gmail.com<span class="w"> </span>&gt;<span class="w"> </span>clave.asc
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La selección de la clave puede hacerse con cualquier parte
de la identificación que se usó al crear la clave (el correo electrónico
incluso sin llegar a estar completo, es una de ellas). Si no especificamos
ninguna clave en concreto, se exportarán todas.</p>
</div>
<p>Si, además, queremos exportar la clave privada, podemos añadirla al fichero
anterior:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--export-secret-keys<span class="w"> </span>xxxx@gmail.com<span class="w"> </span>&gt;&gt;<span class="w"> </span>clave.asc
</pre></div>
</div>
<p>El proceso inverso de importar claves es también sencillo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--import<span class="w"> </span>clave.asc
</pre></div>
</div>
<p>orden que importará todas las claves contenidas en el fichero<a class="footnote-reference brackets" href="#id13" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Si la importación se hace del siguiente modo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--import<span class="w"> </span>--import-options<span class="w"> </span>import-show<span class="w"> </span>--dry-run<span class="w"> </span>clave.asc
</pre></div>
</div>
<p>se muestran los datos de la clave o claves que se importarán, pero
al incluir también <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> no se hará efectiva la importación,
con lo que el resultado es que tenemos un método para consultar las
claves contenidas en un fichero.</p>
</div>
<p class="rubric">Importación/Exportación remota de claves</p>
<p>Hasta ahora, hemos importado y exportado claves a o desde ficheros. Ahora bien,
existen <strong>servidores</strong> <abbr title="Pretty Good Privacy">PGP</abbr> que almacenan claves públicas y que permiten
importarlas lo que facilita el intercambio de claves. Dependiendo de cuál sea
el servidor Puede accederse a través de distintos protocolos. El fichero de
configuración de configuración define un servidor que soporta un protocolo
seguro por el puerto <strong>443</strong> (lo que puede ayudarnos si estamos dentro de una
red que restringe el acceso a internet):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--send-keys<span class="w"> </span>B0B83042
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>En versiones modernas, para poder hacer esta exportación remota es
necesario que se encuentre instalado el paquete <a class="extlink-deb reference external" href="https://packages.debian.org/stable/dirmngr">dirmngr</a>.</p>
</div>
<p>La importación de claves, por su parte, puede hacerse así:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--recv-keys<span class="w"> </span><span class="m">00188366</span>
</pre></div>
</div>
<p>si se conoce el <strong>ID</strong> y, si no es así. es posible buscar la clave usando alguna
porción de la cadena de identificación (p.e. el correo electrónico):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--search-keys<span class="w"> </span>xxxx@gmail.com
</pre></div>
</div>
<p class="rubric">Revocación</p>
<p>Es posible que deseemos anular una clave antes de que esta expire por algún
motivo. Para ello debemos generar una revocación e importarla a nuestro
anillo de claves:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--gen-revoke<span class="w"> </span>xxxx@gmail.com<span class="w"> </span><span class="p">|</span><span class="w"> </span>gpg<span class="w"> </span>--import

<span class="go">[...]</span>
</pre></div>
</div>
<p>Para revocar también esta clave en el servidor público al que exportamos esta
clave con anterioridad, basta con exportar la clave ahora revocada de nuevo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--send-keys<span class="w"> </span>B0B83042
</pre></div>
</div>
<p class="rubric">Eliminación de claves</p>
<p>Para borrar una clave del repositorio basta con utilizar las opciones
<kbd class="kbd docutils literal notranslate">-</kbd>-<kbd class="kbd docutils literal notranslate">delete</kbd>-<kbd class="kbd docutils literal notranslate">keys</kbd>, <kbd class="kbd docutils literal notranslate">-</kbd>-<kbd class="kbd docutils literal notranslate">delete</kbd>-<kbd class="kbd docutils literal notranslate">secret</kbd>-<kbd class="kbd docutils literal notranslate">keys</kbd> o
<kbd class="kbd docutils literal notranslate">-</kbd>-<kbd class="kbd docutils literal notranslate">delete</kbd>-<kbd class="kbd docutils literal notranslate">secret</kbd>-<kbd class="kbd docutils literal notranslate">and</kbd>-<kbd class="kbd docutils literal notranslate">public</kbd>-<kbd class="kbd docutils literal notranslate">keys</kbd>, dependiendo de si queremos borrar una
clave pública o una clave privada. Por ejemplo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--delete-keys<span class="w"> </span>yanoloquiero@example.net
</pre></div>
</div>
<p class="rubric">Confianza</p>
<p>Ya se ha explicado que los certificados <abbr title="Pretty Good Privacy">PGP</abbr> no presentan una estructura
jerarquizada de confianza, sino que son los propios usuarios los que otorgan
confianza a una clave ajena firmándola. Al <a class="reference internal" href="#gpg-list-keys"><span class="std std-ref">listar claves</span></a>,
nos encontramos entre corchetes la confianza que nos inspira la clave. <kbd class="kbd docutils literal notranslate">[
absoluta</kbd> <kbd class="kbd docutils literal notranslate">]</kbd> implica confianza ciega y se fija automaticamente si nosotros mismos
somos los que hemos generado la clave.</p>
<p>Supongamos que hemos importado una clave de un conocido:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--import<span class="w"> </span>pubkey-conocido.asc
<span class="gp">$ </span>gpg<span class="w"> </span>--list-keys<span class="w"> </span>--keyid-format<span class="w"> </span>short
<span class="go">[...]</span>

<span class="go">pub   rsa3072/079F9ECF 2021-03-11 [SC] [caduca: 2023-03-11]</span>
<span class="go">      CF7DAB0C27CFF10B842B0DED1A54391B079F9ECF</span>
<span class="go">uid      [desconocida] Mi mejor amigo &lt;amigo@gmail.com&gt;</span>
</pre></div>
</div>
<p>La clave aparece con una confianza <em>desconocida</em>. Si hubieramos obtenido la
clave por un canal seguro (p.e. el amigo nos la ha facilitado personalmente),
podríamos entonces firmarla:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--sign-key<span class="w"> </span>amigo
<span class="gp">$ </span>gpg<span class="w"> </span>--list-signatures
<span class="go">[...]</span>

<span class="go">pub   rsa3072 2021-03-11 [SC] [caduca: 2023-03-11]</span>
<span class="go">      CF7DAB0C27CFF10B842B0DED1A54391B079F9ECF</span>
<span class="go">uid        [   total   ] Mi mejor amigo &lt;amigo@gmail.com&gt;</span>
<span class="go">sig 3        1A54391B079F9ECF 2021-03-11  Mi mejor amigo &lt;amigo@gmail.com&gt;</span>
<span class="go">sig          A2123969EB13CB39 2021-03-11  Licenciado Cebadilla (cuenta de pruebas) &lt;xxxx@gmail.com&gt;</span>
</pre></div>
</div>
<p>De esta forma la confianza cambiaría (ahora es <kbd class="kbd docutils literal notranslate">[</kbd> <kbd class="kbd docutils literal notranslate">total</kbd> <kbd class="kbd docutils literal notranslate">]</kbd>) y la clave de
nuestro conocido pasaría a incluir nuestra firma, que acredita que le hemos dado
nuestra confianza. Esta confianza se incorpora a la clave, de modo que si la
exportamos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--export<span class="w"> </span>amigo<span class="w"> </span>&gt;<span class="w"> </span>pubkey-conocido-firmada.asc
</pre></div>
</div>
<p>La clave incorporará nuestra firma y si la subimos a un servidor de claves
también lo incorporará, lo cual puede ayudar a otros a confiar en ella. En
cambio, sino hemos conocido personalmente al dueño lo más apropiado es:</p>
<ol class="arabic">
<li><p>Obtener la clave del conocido.</p></li>
<li><p>Firmarla con nuestra clave.</p></li>
<li><p>Exportarla y cifrarla para este desconocido:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--export<span class="w"> </span>amigo<span class="w"> </span><span class="p">|</span><span class="w"> </span>gpg<span class="w"> </span>-se<span class="w"> </span>-r<span class="w"> </span>amigo<span class="w"> </span>&gt;<span class="w"> </span>~/tmp/pubkey-amigo.asc.asc
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Cómo se cifra lo trataremos a continuación.</p>
</div>
</li>
<li><p>Enviarla por correo electrónico al conocido con un texto que explique
que hemos firmado su clave y que se le adjuntamos cifrada.</p></li>
</ol>
<p>Con ello, nos aseguraremos de que el conocido es el dueño de la cuenta de correo
electrónico que refiere en el clave (porque recibe el mensaje) y que es el dueño
de tal clave (porque es capaz de descifrarla con la clave privada).</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>De lo que no podríamos estar seguros es de su identidad física real.</p>
</div>
<p>Este conocido, por su parte, deberá descrifrar la clave y exportarla a un
servidor de claves:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>-decrypt<span class="w"> </span>pubkey-amigo.asc.asc
<span class="gp">$ </span>gpg<span class="w"> </span>--import<span class="w"> </span>pubkey-amigo.asc
<span class="gp">$ </span>gpg<span class="w"> </span>--send-keys<span class="w"> </span>079F9ECF
</pre></div>
</div>
</section>
<section id="cifrado-asimetrico">
<span id="gnupg-cif-asi"></span><h3><span class="section-number">9.1.3.3.2.4. </span>Cifrado asimétrico<a class="headerlink" href="#cifrado-asimetrico" title="Link to this heading">¶</a></h3>
<p>Para cifrar un mensaje con la clave pública de alguien a fin de que sólo éste
sea capaz de descifrarlo puede hacerse:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>-er<span class="w"> </span>su_correo@dominio.com<span class="w"> </span>-o<span class="w"> </span>-<span class="w"> </span>fichero.txt<span class="w"> </span>&gt;<span class="w"> </span>fichero.txt.asc
</pre></div>
</div>
<p>o bien, si se desea codificar lo remitido por la entrada estándar:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Esto es un secreto&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>gpg<span class="w"> </span>-er<span class="w"> </span>su_correo@dominio.com<span class="w"> </span>&gt;<span class="w"> </span>secreto.asc
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p><code class="code docutils literal notranslate"><span class="pre">-o</span> <span class="pre">-</span></code> permite que la salida cifrada vaya a la salida estándar,
ya que de lo contrario se escribirá en un fichero que se llamará igual que el
original adjuntando el prefijo <code class="docutils literal notranslate"><span class="pre">.asc</span></code> (o <code class="docutils literal notranslate"><span class="pre">.gpg</span></code> si se usa la opción
<code class="docutils literal notranslate"><span class="pre">--no-armor</span></code>). Si el mensaje original procedía de la entrada estándar, se
dirige directamente a la salida estándar y, en consecuencia, no es necesario.</p>
</div>
<p>Para descifrar la clave en un sistema que tenga disponible la clave privada
correspondiente a la pública con la que se firmó, basta con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>-qd<span class="w"> </span>secreto.asc
<span class="go">Esto es un secreto</span>
</pre></div>
</div>
<p>En realidad, esto acciíon que hemos presentado como cifrado <em>asimétrico</em> no es
tal, sino que <abbr title="GNU Provacy Guard">GnuPG</abbr> practica un <a class="reference internal" href="../02.algo.html#hibrido"><span class="std std-ref">cifrado híbrido</span></a>: se genera
una clave simétrica <em>ad hoc</em> para cifrar el archivo y es la clave simétrica la
que se cifra con la clave pública proporcionada con la opción <kbd class="kbd docutils literal notranslate">-r</kbd>. El
archivo resultante contiene el archivo cifrado y la clave cifrada. De hecho, es posible
repetir la opción <kbd class="kbd docutils literal notranslate">-r</kbd> para que el archivo pueda ser descifrado por
vartios:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>-er<span class="w"> </span>su_correo@dominio.com<span class="w"> </span>-r<span class="w"> </span>otro@example.net<span class="w"> </span>-o<span class="w"> </span>-<span class="w"> </span>fichero.txt<span class="w"> </span>&gt;<span class="w"> </span>fichero.txt.asc
</pre></div>
</div>
<p>En este caso, la clave simétrica se cifra dos veces con sendas claves públicas y
las dos versiones cifradas se adjuntan al archivo cifrado.</p>
</section>
<section id="firma-digital">
<h3><span class="section-number">9.1.3.3.2.5. </span>Firma digital<a class="headerlink" href="#firma-digital" title="Link to this heading">¶</a></h3>
<p>Para firmar un archivo basta con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Este es el contenido del fichero que firmo&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>fichero.txt
<span class="gp">$ </span>gpg<span class="w"> </span>--detach-sign<span class="w"> </span>--default-key<span class="w"> </span>mi_cuenta@example.com<span class="w"> </span>-o<span class="w"> </span>fichero.sig<span class="w"> </span>fichero.txt
</pre></div>
</div>
<p>De esta manera tenemos un fichero original (<code class="file docutils literal notranslate"><span class="pre">fichero.txt</span></code>) y su resumen
cifrado digitalmente con nuestra clave privada en <code class="file docutils literal notranslate"><span class="pre">fichero.sign</span></code>. Si
analizamos el fichero de firma:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--list-packets<span class="w"> </span>fichero.sign
<span class="go">:signature packet: algo 1, keyid 53175AA29C972B7B</span>
<span class="go">        version 4, created 1543050622, md5len 0, sigclass 0x00</span>
<span class="go">        digest algo 10, begin of digest 04 9e</span>
<span class="go">        hashed subpkt 33 len 21 (issuer fpr v4 040968BBC05C39A4DD2A43BD53175AA29C972B7B)</span>
<span class="go">        hashed subpkt 2 len 4 (sig created 2018-11-24)</span>
<span class="go">        hashed subpkt 28 len 23 (signer&#39;s user ID)</span>
<span class="go">        subpkt 16 len 8 (issuer key ID 53175AA29C972B7B)</span>
<span class="go">        data: [3071 bits]</span>
</pre></div>
</div>
<p>veremos algunas características de la firma, como:</p>
<ul>
<li><p>qué algoritmo de clave asimétrica se usó, el <strong>1</strong>, que se corresponde con una
clave asimétrica <abbr title="Rivest, Shamir y Adleman">RSA</abbr>, válida tanto para firma como para cifrado. El
significado de los códigos puede encontrarse en el <span class="target" id="index-2"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc4880.html"><strong>RFC 4880</strong></a>, y en concreto
en la <a class="reference external" href="https://tools.ietf.org/html/rfc4880#section-9.1">sección 9.1</a>.</p></li>
<li><p>qué clave se usó: la <em>53175AA29C972B7B</em>, que efectivamente es la nuestra:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--keyid-format<span class="w"> </span>long<span class="w"> </span>-list-keys
<span class="go">/home/usuario/.gnupg/pubring.kbx</span>
<span class="go">--------------------------------</span>
<span class="hll"><span class="go">pub   rsa3072/53175AA29C972B7B 2018-11-21 [SC] [expires: 2020-11-20]</span>
</span><span class="go">      040968BBC05C39A4DD2A43BD53175AA29C972B7B</span>
<span class="go">uid                 [ unknown] Soy el que soy &lt;mi_cuenta@example.com&gt;</span>
<span class="go">      sub   rsa3072/4B1F09C9B84F038E 2018-11-21 [E] [expires: 2020-11-20]</span>
</pre></div>
</div>
</li>
<li><p>con qué algoritmo se resumió el fichero, el <strong>10</strong>, que es <em>SHA512</em> según
<a class="reference external" href="https://tools.ietf.org/html/rfc4880#section-9.4">la sección 9.4</a> del
<span class="target" id="index-3"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc4880.html"><strong>RFC 4880</strong></a>.</p></li>
</ul>
<p>Si hacemos llegar <strong>ambos</strong> archivos a un tercero, y éste posee nuestra clave
pública, podrá verificar nuestra identidad gracias a descifrar la firma y la
integridad del fichero gracias al resumen que contiene esta:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg<span class="w"> </span>--verify<span class="w"> </span>fichero.sign<span class="w"> </span>fichero.txt
<span class="go">[...]</span>
<span class="go">Primary key fingerprint: 0409 68BB C05C 39A4 DD2A  43BD 5317 5AA2 9C97 2B7B</span>
<span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
<span class="go">0</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">Ver también</p>
<p>Hay un extenso tutorial del uso de <a class="reference internal" href="#gnupg">GnuPG</a> en la <a class="reference external" href="https://wiki.archlinux.org/index.php/GnuPG_(Espa%C3%B1ol)">wiki de Archlinux</a>.</p>
</div>
<p class="rubric">Notas al pie</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id8" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>Hay sin embargo, propuesta en ambos estándares para incorporar algunas
cabeceras escogidas: para Open<abbr title="Pretty Good Privacy">PGP</abbr>, el borrador
<a class="reference external" href="https://tools.ietf.org/id/draft-autocrypt-lamps-protected-headers-01.html">Protected Headers for Cryptographic E-mail</a>
y para <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr> el <span class="target" id="index-4"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7508.html"><strong>RFC 7508</strong></a>.</p>
</aside>
<aside class="footnote brackets" id="id9" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p>Si la clave está en archivo aparte puede usarse la opción <kbd class="kbd docutils literal notranslate">-inkey</kbd>.</p>
</aside>
<aside class="footnote brackets" id="id10" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">3</a><span class="fn-bracket">]</span></span>
<p>Para incluir certificados intermedios puede añadirse la opción <kbd class="kbd docutils literal notranslate">-certfile</kbd>
que refiera el archivo con los certificados intermedios (pero no el archivo firmante):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>smime<span class="w"> </span>-sign<span class="w"> </span>-in<span class="w"> </span>fichero.txt<span class="w"> </span>-signer<span class="w"> </span>micert.pem<span class="w"> </span>-certfile<span class="w"> </span>ca-certs.pem<span class="w"> </span>-outform<span class="w"> </span>pem<span class="w"> </span>-out<span class="w"> </span>smime.p7s
</pre></div>
</div>
</aside>
<aside class="footnote brackets" id="id11" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">4</a><span class="fn-bracket">]</span></span>
<p>El archivo cifrado es imprimible gracias a que incluimos <kbd class="kbd docutils literal notranslate">armor</kbd> en
el archivo de configuración.</p>
</aside>
<aside class="footnote brackets" id="id12" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">5</a><span class="fn-bracket">]</span></span>
<p>El algoritmo elegido utiliza una clave <abbr title="Rivest, Shamir y Adleman">RSA</abbr> de 2048 <em>bits</em> tanto para
cifrado como para firmado. Otro posible algoritmo es <em>ed25519</em>.</p>
</aside>
<aside class="footnote brackets" id="id13" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">6</a><span class="fn-bracket">]</span></span>
<p>En nuestro caso, sería una clave pública y su correspondiente privada.</p>
</aside>
</aside>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../../index.html">Tabla de contenido</a></h3>
    <ul>
<li><a class="reference internal" href="#">9.1.3.3. Correo electrónico</a><ul>
<li><a class="reference internal" href="#s-mime">9.1.3.3.1. <abbr title="Secure/Multipurpose Internet Mail Extensions">S/MIME</abbr></a></li>
<li><a class="reference internal" href="#gnupg">9.1.3.3.2. Open<abbr title="Pretty Good Privacy">PGP</abbr></a><ul>
<li><a class="reference internal" href="#instalacion">9.1.3.3.2.1. Instalación</a></li>
<li><a class="reference internal" href="#cifrado-simetrico">9.1.3.3.2.2. Cifrado simétrico</a></li>
<li><a class="reference internal" href="#gestion-de-claves">9.1.3.3.2.3. Gestión de claves</a></li>
<li><a class="reference internal" href="#cifrado-asimetrico">9.1.3.3.2.4. Cifrado asimétrico</a></li>
<li><a class="reference internal" href="#firma-digital">9.1.3.3.2.5. Firma digital</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Tema anterior</h4>
    <p class="topless"><a href="02.pdf.html"
                          title="capítulo anterior"><span class="section-number">9.1.3.2. </span>Firma de documentos</a></p>
  </div>
  <div>
    <h4>Próximo tema</h4>
    <p class="topless"><a href="04.ssl.html"
                          title="próximo capítulo"><span class="section-number">9.1.3.4. </span>Protocolos seguros de red</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/98.apendice/01.cryto/03.aplicaciones/03.correo.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Ir a" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="04.ssl.html" title="9.1.3.4. Protocolos seguros de red"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="02.pdf.html" title="9.1.3.2. Firma de documentos"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" ><span class="section-number">9. </span>Apéndices</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" ><span class="section-number">9.1. </span>Criptografía</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../03.aplicaciones.html" ><span class="section-number">9.1.3. </span>Aplicaciones de la criptografía</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">9.1.3.3. </span>Correo electrónico</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright CC BY 4.0, 2016-2025, José Miguel Sánchez Alés.
      Creado usando <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>