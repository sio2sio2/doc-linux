


<!DOCTYPE html>

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>7.3.3.2. Aceptación de mensajes &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css" />
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/translations.js"></script>
    
    <link rel="index" title="Índice" href="../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../search.html" />
    <link rel="next" title="7.3.3.3. Entrega" href="03-entrega.html" />
    <link rel="prev" title="7.3.3.1. Instalación y configuración" href="01-inst.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="03-entrega.html" title="7.3.3.3. Entrega"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="01-inst.html" title="7.3.3.1. Instalación y configuración"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" ><span class="section-number">7. </span>Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" ><span class="section-number">7.3. </span>Correo electrónico</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="index.html" accesskey="U"><span class="section-number">7.3.3. </span>Servidor <abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7.3.3.2. </span>Aceptación de mensajes</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="aceptacion-de-mensajes">
<h1><span class="section-number">7.3.3.2. </span>Aceptación de mensajes<a class="headerlink" href="#aceptacion-de-mensajes" title="Enlazar permanentemente con este título">¶</a></h1>
<section id="politicas-de-aceptacion">
<span id="postfix-accept"></span><h2><span class="section-number">7.3.3.2.1. </span>Políticas de aceptación<a class="headerlink" href="#politicas-de-aceptacion" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="admonition seealso">
<p class="admonition-title">Ver también</p>
<p>Para completar la información bajo este epígrafe pueden consultarse
los enlaces:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://www.universidaddecordoba.eu/servicios/informatica/sistemas/doc_ccc/postfix/restricciones.html">Restricciones de acceso en Postix</a>.</p></li>
<li><p><a class="reference external" href="http://desdelaconsola.es/controles-de-acceso-en-postfix/">Otra de controles de acceso en Postfix</a></p></li>
</ul>
</div>
<section id="control-de-accesos">
<h3><span class="section-number">7.3.3.2.1.1. </span>Control de accesos<a class="headerlink" href="#control-de-accesos" title="Enlazar permanentemente con este título">¶</a></h3>
<p><strong class="program">postfix</strong> tiene la habilidad de aceptar o rechazar mensajes dependiendo
de múltiples criterios. Cuando recibe un mensaje a través de una comunicación
<abbr title="Simple Mail Transfer Protocol">SMTP</abbr>, esta pasa por fases (véase la <a class="reference internal" href="../01-msg/index.html#smtp-trans"><span class="std std-ref">descripción de cómo se lleva a
cabo esta comunicación</span></a>) y en cada una de ellas pueden operar estas
restricciones de acceso:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Momento</p></th>
<th class="head"><p>Directiva</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Conexión</p></td>
<td><p><a class="reference external" href="http://www.postfix.org/postconf.5.html#smtpd_client_restrictions">smtpd_client_restrictions</a></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">EHLO</span></code></p></td>
<td><p><a class="reference external" href="http://www.postfix.org/postconf.5.html#smtpd_helo_restrictions">smtpd_helo_restrictions</a></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">MAIL</span> <span class="pre">FROM</span></code></p></td>
<td><p><a class="reference external" href="http://www.postfix.org/postconf.5.html#smtpd_sender_restrictions">smtpd_sender_restrictions</a></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">RCPT</span> <span class="pre">TO</span></code></p></td>
<td><div class="line-block">
<div class="line"><a class="reference external" href="http://www.postfix.org/postconf.5.html#smtpd_recipient_restrictions">smtpd_recipient_restrictions</a></div>
<div class="line"><a class="reference external" href="http://www.postfix.org/postconf.5.html#smtpd_relay_restrictions">smtpd_relay_restrictions</a></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Ante un comando <code class="docutils literal notranslate"><span class="pre">RCPT_TO</span></code> se consultan
<a class="reference external" href="http://www.postfix.org/postconf.5.html#smtpd_recipient_restrictions">smtpd_recipient_restrictions</a> o <a class="reference external" href="http://www.postfix.org/postconf.5.html#smtpd_relay_restrictions">smtpd_relay_restrictions</a> dependiendo
de cuál sea la dirección del destinatario. Si el destinatario es una cuenta
del propio servidor se aplican las primeras; y, si no, las segundas. Además,
si <a class="reference external" href="http://www.postfix.org/postconf.5.html#smtpd_relay_restrictions">smtpd_relay_restrictions</a> está vacía, se usa
<a class="reference external" href="http://www.postfix.org/postconf.5.html#smtpd_recipient_restrictions">smtpd_recipient_restrictions</a> para cualquier destinatario.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Existen más restricciones, que se relacionan <a class="reference external" href="http://www.postfix.org/SMTPD_ACCESS_README.html#lists">en la documentación de
postfix</a></p>
</div>
<p>Las restricciones de cada fase (clases de restricciones en la terminología de
<strong class="program">postfix</strong>) las define el administrador entre todas las que ofrece
<strong class="program">postfix</strong> y están constituidas por un conjunto de pruebas cada una de
las cuales, esencialmente, puede devolver tres respuestas:</p>
<ul class="simple">
<li><p>Una <em>respuesta de aceptación</em>, que supone que se abandonen las pruebas
faltantes y se considere que el mensaje ha superado las restricciones de esa
fase.</p></li>
<li><p>Una <em>respuesta de rechazo</em>, que supone que se abandonen las pruebas faltantes,
se considere que el mensaje no ha superado las restricciones de la fase y, en
consecuencia, el mensaje sea definitivamente rechazado.</p></li>
<li><p><em>Ninguna respuesta concluyente</em>, que supone que se pase a la siguiente prueba.
En caso de que la prueba fuese la última de la fase, se considera que el
mensaje ha superado las restricciones de esa fase.</p></li>
</ul>
<p>Para ilustrarlo, supongamos esta directiva:</p>
<div class="highlight-apache notranslate"><div class="highlight"><pre><span></span><span class="nb">smtpd_client_restrictions</span> = reject_unknown_client_hostname
                            <span class="nb">check_client_access</span> hash:/etc/postfix/tb/client_access
</pre></div>
</div>
<p>La directiva implica que, tras la conexión del cliente, el servidor hará la
prueba <a class="reference external" href="http://www.postfix.org/postconf.5.html#reject_unknown_client_hostname">reject_unknown_client_hostname</a>, que responderá <em>rechazo</em> si la <abbr title="Internet Protocol">IP</abbr> del
cliente no tiene nombre asignado<a class="footnote-reference brackets" href="#id14" id="id1">1</a>, y nada concluyente en caso contrario. En
el primer caso, las restricciones de esta fase acabarán con un resultado de
rechazo y no habrá nada más que hacer ni será necesario comprobar las
restricciones de fases ulteriores. En el segundo caso, aún hay otra prueba que
hacer: <a class="reference external" href="http://www.postfix.org/postconf.5.html#check_client_access">check_client_access</a>. Esta segunda comprobación hace uso de una <a class="reference external" href="http://www.postfix.org/access.5.html">tabla
access</a> que en este caso determina a
partir de la <abbr title="Internet Protocol">IP</abbr> o el nombre del cliente qué acción se toma. Imaginemos que su
contenido es el siguiente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> Cliente         <span class="c1"># Acción</span>
<span class="go">192.168.255.4     REJECT Banned client</span>
<span class="go">192.168.2         REJECT 192.168.2.0/24 banned network</span>
<span class="go">spammer.dhns.org  REJECT Banned client</span>
<span class="go">spammers.org      REJECT Banned domain</span>
</pre></div>
</div>
<p>En ese caso, se comprueba por orden la tabla y si el cliente es 192.168.255.4,
pertenece a la red 192.168.2.0/24, es <em>spammer.dhns.org</em> o su nombre pertenece
al dominio <em>spammers.org</em>, se rechazará la conexión. En cualquier otro caso, la
prueba no devuelve una respuesta concluyente y al no haber más pruebas en esta
fase se pasará a comprobar las restricciones de la siguiente fase
(<a class="reference external" href="http://www.postfix.org/postconf.5.html#smtpd_helo_restrictions">smtpd_helo_restrictions</a>).</p>
<p>Aunque lo lógico es que las restricciones de cada fase se aplicaran nada más
completarse esta (p.e. las que nos han servido para ilustrar deben efectuarse
nada más completarse la conexión y antes de que el cliente pueda saludar con
<code class="docutils literal notranslate"><span class="pre">EHLO</span></code>), <strong class="program">postfix</strong> deja que el cliente complete todas las fases hasta
el comando <code class="docutils literal notranslate"><span class="pre">DATA</span></code> y, entonces es cuando aplica las restricciones de todas las
fases secuencialmente. Este comportamiento puede alterarse usando la directiva:</p>
<div class="highlight-apache notranslate"><div class="highlight"><pre><span></span><span class="nb">smtpd_delay_reject</span> = no
</pre></div>
</div>
<p>Aunque cada prueba de las que provee <strong class="program">postfix</strong> es propia de una fase de
la comunicación <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> (p.e. la ilustrada <a class="reference external" href="http://www.postfix.org/postconf.5.html#check_client_access">check_client_access</a> de la fase de
conexión), se permiten usar cualquiera de ellas en las restricciones de
cualquier fase. Por esa razón, al presentar la configuración básica incluimos
una prueba propia de la conexión como <a class="reference external" href="http://www.postfix.org/postconf.5.html#reject_rbl_client">reject_rbl_client</a> en
<a class="reference external" href="http://www.postfix.org/postconf.5.html#smtpd_recipient_restrictions">smtpd_recipient_restrictions</a>. Ahora bien, es obvio que si, incorporando la
directiva anterior, hacemos que las restricciones se apliquen en su momento
respectivo y no al final, sólo podrán aplicarse las pruebas correspondientes a
la propia fase o a fases previas. En concreto, para <a class="reference external" href="http://www.postfix.org/postconf.5.html#smtpd_helo_restrictions">smtpd_helo_restrictions</a>
sólo podremos aplicar pruebas propias de la fase de conexión o de la fase de
saludo, ya que aún se desconocen el emisor y los destinatarios.</p>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Es importante tener presente que, si se usan restricciones de fases
anteriores a la de recepción (<code class="docutils literal notranslate"><span class="pre">RCTP</span> <span class="pre">TO</span></code>), normalmente sólo tiene sentido
utilizar pruebas para el rechazo y no para la aceptación, ya que la
aceptación de la fase, no implica que se acepte el correo, sino que se pase a
la fase siguiente. Para entenderlo observemos que;</p>
<div class="highlight-apache notranslate"><div class="highlight"><pre><span></span><span class="nb">smtpd_client_restrictions</span> = permit_sasl_authenticated
<span class="nb">smtpd_recipient_restrictions</span> = reject_unauth_destination
</pre></div>
</div>
<p>no es equivalente a:</p>
<div class="highlight-apache notranslate"><div class="highlight"><pre><span></span><span class="nb">smtpd_recipient_restrictions</span> = permit_sasl_authenticated
                               <span class="nb">reject_unauth_destination</span>
</pre></div>
</div>
<p>con la segunda configuración cualquier cliente autenticado podrá usar el
servidor de <em>relay</em> (enviar correos a cuentas que no son de nuestro propio
servidor), mientras que en el primer caso, no.</p>
</div>
<p class="rubric">Restricciones de usuario</p>
<p>Además de las clases de restricciones predefinidas (<a class="reference external" href="http://www.postfix.org/postconf.5.html#smtpd_client_restrictions">smtpd_client_restrictions</a>,
etc.), el administrador puede definir las suyas propias que pueden usarse como
alias para definir grupos de pruebas en las clases predefinidas o como valor en
la segunda columna de una <a class="reference external" href="http://www.postfix.org/access.5.html">tabla access</a><a class="footnote-reference brackets" href="#id15" id="id2">2</a>.</p>
<p>Por ejemplo, si quisiéramos que los clientes de nuestra red sólo envíen mensajes
con cuentas de nuestra red, podríamos hacer lo siguiente:</p>
<div class="highlight-apache notranslate"><div class="highlight"><pre><span></span><span class="nb">smtpd_restriction_classes</span> = emisor_propio_restriction
<span class="nb">emisor_propio_restriction</span> = check_sender_access hash:/etc/postfix/tb/cue_propias, reject
<span class="nb">smtpd_sender_restrictions</span> = check_client_access hash:/etc/postfix/tb/cli_propios
</pre></div>
</div>
<p>donde <code class="file docutils literal notranslate"><span class="pre">/etc/postfix/tb/cli_propios</span></code> es:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mail1.org         emisor_propio_restriction</span>
</pre></div>
</div>
<p>y <code class="file docutils literal notranslate"><span class="pre">/etc/postfix/tb/cue_propias</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mail1.org         OK</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Si el primero de los ficheros lo hubieras definido así:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mail1.org         check_sender_access hash:/etc/postfix/tb/cue_propias, reject</span>
</pre></div>
</div>
<p>nos habíamos ahorrado definir la clase propia.</p>
</div>
</section>
<section id="control-de-destinatario">
<span id="postfix-vrf-recipient"></span><h3><span class="section-number">7.3.3.2.1.2. </span>Control de destinatario<a class="headerlink" href="#control-de-destinatario" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Por defecto, el valor de <a class="reference external" href="http://www.postfix.org/postconf.5.html#smtpd_reject_unlisted_recipient">smtpd_reject_unlisted_recipient</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> postconf -d smtpd_reject_unlisted_recipient
<span class="go">smtpd_reject_unlisted_recipient = yes</span>
</pre></div>
</div>
<p>provoca que <strong class="program">postfix</strong> compruebe durante la comunicación <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> cuál
será el receptor del mensaje y lo rechace en los siguientes casos:</p>
<ul class="simple">
<li><p>Si el destinatario pertenece a alguno de los dominios listados en
<a class="reference external" href="http://www.postfix.org/postconf.5.html#mydestination">mydestination</a>, pero no se encuentra listado en <a class="reference external" href="http://www.postfix.org/postconf.5.html#local_recipient_maps">local_recipient_maps</a> (y
<a class="reference external" href="http://www.postfix.org/postconf.5.html#local_recipient_maps">local_recipient_maps</a> no está vacío).</p></li>
<li><p>Si el destinatario pertenece a alguno de los dominios listados en
<a class="reference external" href="http://www.postfix.org/postconf.5.html#virtual_alias_domains">virtual_alias_domains</a>, pero no se encuentra referido en <a class="reference external" href="http://www.postfix.org/postconf.5.html#virtual_alias_maps">virtual_alias_maps</a>.</p></li>
<li><p>Si el destinatario pertenece a alguno de los dominios listados en
<a class="reference external" href="http://www.postfix.org/postconf.5.html#virtual_mailbox_domains">virtual_mailbox_domains</a>, pero no se encuentra listado en
<a class="reference external" href="http://www.postfix.org/postconf.5.html#virtual_mailbox_maps">virtual_mailbox_maps</a>.</p></li>
<li><p>Si el destinatario pertenece a alguno de los dominios listado en
<a class="reference external" href="http://www.postfix.org/postconf.5.html#relay_domains">relay_domains</a>, pero no se encuentra referido en <a class="reference external" href="http://www.postfix.org/postconf.5.html#relay_recipient_maps">relay_recipient_maps</a> (y
<a class="reference external" href="http://www.postfix.org/postconf.5.html#relay_recipient_maps">relay_recipient_maps</a> no está vacío).</p></li>
</ul>
<p><strong class="program">postfix</strong> obra así, porque esto evita que, ante un envío indiscriminado
hacia nuestro servidor de cuentas generadas aleatoriamente, se llene nuestra
cola de salida con mensajes de que la cuenta no existe.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Existe una politica de aceptación llamada
<a class="reference external" href="http://www.postfix.org/postconf.5.html#reject_unlisted_recipient">reject_unlisted_recipient</a> que sirve exactamente para lo mismo, pero sólo
tiene sentido usarla si se modifica el valor de
<a class="reference external" href="http://www.postfix.org/postconf.5.html#smtpd_reject_unlisted_recipient">smtpd_reject_unlisted_recipient</a>.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">Ver también</p>
<p>Para más información, consulte el <a class="reference external" href="http://www.postfix.org/ADDRESS_VERIFICATION_README.html">artículo oficial sobre la
verificación del destino</a></p>
</div>
</section>
<section id="control-del-contenido-del-mensaje">
<span id="postfix-access-body"></span><h3><span class="section-number">7.3.3.2.1.3. </span>Control del contenido del mensaje<a class="headerlink" href="#control-del-contenido-del-mensaje" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Las restricciones al acceso anteriores no se aplican al contenido del mensaje,
sea la cabecera o el cuerpo. Si nuestra intención es rechazar mensajes según el
contenido podemos recurrir a <a class="reference external" href="http://www.postfix.org/postconf.5.html#header_checks">header_checks</a> y <a class="reference external" href="http://www.postfix.org/postconf.5.html#body_checks">body_checks</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Estos mecanismos de filtro no deberían sustituir a <em>software</em>
específico de filtrado (p.e. <em>software</em> antispam), porque su rendimiento es
pobre y sólo deben usarse para resolver casos muy concretos.</p>
</div>
<p>Un ejemplo de uso puede ser este:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">header_checks = regexp:/etc/postfix/tb/reject_rules</span>
</pre></div>
</div>
<p>y dentro de tal fichero:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">/^Subject: .*VIAGRA.*$/    REJECT Los clientes de este servidor no tienen problemas de erección</span>
</pre></div>
</div>
<p>Para probar si el filtro funciona, puede usarse la siguiente orden:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> postmap -q <span class="s1">&#39;Subject: Vendo VIAGRA barata&#39;</span> regexp:/etc/postfix/tb/reject_rules
<span class="go">REJECT Los clientes de este servidor no tienen problemas de erección</span>
</pre></div>
</div>
</section>
<section id="campo-from">
<span id="postfix-vrfydmn"></span><h3><span class="section-number">7.3.3.2.1.4. </span>Campo <code class="docutils literal notranslate"><span class="pre">From:</span></code><a class="headerlink" href="#campo-from" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="admonition seealso">
<p class="admonition-title">Ver también</p>
<p>Conviene que eche un vistazo a la introducción del epígrafe
dedicado a la <a class="reference external" href="smtp-acreditacion">acreditación del remitente</a> para que
tenga claros los conceptos de <em>remitente del sobre</em> y <em>dirección del
mensaje</em>, que se usarán aquí.</p>
</div>
<p>El propósito de este epígrafe es estudiar cómo evitar que nuestros usuarios
usen direcciones arbitrarias como <em>direccion del mensaje</em>, bien rechazando
aquel mensaje en que no coincide ésta con el <em>remitente del sobre</em>, bien
sustituyendo la <em>dirección del mensaje</em> por la del <em>remitente del sobre</em> antes
de remitirlo a su destinatario.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La tarea inversa de descubrir falsificaciones en el remitente o de
facilitarla sobre nuestros mensajes a servidores ajenos se desarrolla
en la <a class="reference external" href="smtp-acreditacion">acreditación del remitente</a>.</p>
</div>
<p><strong class="program">postfix</strong> no tiene ningún mecanismo para llvar a cabo este propósito
pero existe un software de terceros con paquete en <em>debian</em>, <a class="reference external" href="https://github.com/croessner/vrfydmn">vrfydmn</a>, que funciona como <a class="reference external" href="https://es.wikipedia.org/wiki/Milter">milter</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> apt install vfrydmn
</pre></div>
</div>
<p>La mayor dificultad de uso es que el paquete no parece estar perfectamente
integrado en la distribución, y es necesario modificar su arranque para que nos
funcione con <strong class="program">postfix</strong>.</p>
<p>Lo primero es cambiar el fichero <code class="file docutils literal notranslate"><span class="pre">/etc/default/vrfydmn</span></code> para que quede
con este contenido:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">DAEMON_OPTS</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">SOCKET</span><span class="o">=</span>local:/var/spool/postfix/var/run/vrfydmn.sock
<span class="nv">USER</span><span class="o">=</span>vrfydmn
<span class="nv">GROUP</span><span class="o">=</span>vrfydmn
<span class="nv">PIDFILE</span><span class="o">=</span>/var/run/vrfydmn/vrfydmn.pid
<span class="nv">FILE</span><span class="o">=</span>/etc/postfix/tb/vrfydmn
</pre></div>
</div>
<p>y crear el fichero
<code class="file docutils literal notranslate"><span class="pre">/etc/systemd/system/vrfydmn.service.d/10_override.conf</span></code> que sobreescriba
la configuración para <a class="reference internal" href="../../../04.servidor/03.init/index.html#systemd"><span class="std std-ref">systemd</span></a>, a fin de que se use el fichero
anterior:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Service]</span>
<span class="na">EnvironmentFile</span><span class="o">=</span><span class="s">/etc/default/vrfydmn</span>
<span class="na">ExecStart</span><span class="o">=</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/sbin/vrfydmn -s $SOCKET -u $USER -g $GROUP -p $PIDFILE --file $FILE $DAEMON_OPTS</span>
</pre></div>
</div>
<p id="postfix-aux">Para que se pueda crear el <em>socket</em> dentro de la jaula de <strong class="program">postfix</strong>,
crearemos un directorio <code class="file docutils literal notranslate"><span class="pre">var/run/</span></code> en el que puedan escribir todos los
usuarios, pero con bit <em>pegajoso</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> mkdir -m1777 /var/spool/postfix/var/run
</pre></div>
</div>
<p>Por último es necesario crear el fichero <code class="file docutils literal notranslate"><span class="pre">/etc/postfix/tb/vrfydmn</span></code> que
debe ser una tabla semejante a <a class="reference external" href="http://www.postfix.org/postconf.5.html#relay_domains">relay_domains</a> o <a class="reference external" href="http://www.postfix.org/postconf.5.html#virtual_mailbox_domains">virtual_mailbox_domains</a> en la que la
primera columna contiene los dominios para los que <strong class="program">vrfydmn</strong> no
realizará comprobaciones, y la segunda es indiferente<a class="footnote-reference brackets" href="#id16" id="id4">3</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mail1.org            importa_poco_que_se_ponga_aqui</span>
<span class="gp">#</span> Resto de dominios que gestionemos
</pre></div>
</div>
<p>Con estos cambios, ya podemos recargar la configuración de <strong class="program">systemd</strong> y
reiniciar el servicio:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> systemctl daemon-reload
<span class="gp">#</span> invoke-rc.d vrfydmn restart
</pre></div>
</div>
<p>Además, debemos indicarle a <strong class="program">postfix</strong> que use el <em>milter</em>:</p>
<div class="highlight-apache notranslate"><div class="highlight"><pre><span></span><span class="nb">smtpd_milters</span> = unix:var/run/vrfydmn.sock
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Es conveniente que aplique el <em>milter</em> en los <a class="reference internal" href="01-inst.html#postfix-25-465-587"><span class="std std-ref">puertos dedicados
a la escucha de clientes</span></a> (<strong>465</strong> y <strong>587</strong>), así que
la línea anterior debería aplicarla sólo al servicio <em>smtpd</em> que escuche en
esos puertos. Así pues, no incluya la línea en <code class="file docutils literal notranslate"><span class="pre">/etc/postfix/main.cf</span></code>,
sino de forma adecuada en <code class="file docutils literal notranslate"><span class="pre">/etc/postfix/master.cf</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">urd       inet  n       -       y       -       -       smtpd</span>
<span class="go">   -o smtpd_tls_wrappermode=yes</span>
<span class="go">   -o smtpd_milters=unix:aux/vrfydmn</span>
<span class="go">submission inet n       -       y       -       -       smtpd</span>
<span class="go">   -o smtpd_milters=unix:aux/vrfydmn</span>
</pre></div>
</div>
</div>
<p>Además, el usuario <em>postfix</em> debería pertenecer al grupo <em>vrfydmn</em>.</p>
<p>Tal como se ha configurado <strong class="program">vrfydmn</strong>, éste se comporta de modo que
permite cualquier <em>dirección del mensaje</em> siempre que sea de un dominio
incluido en el fichero. Si no es así, el mensaje se rechaza.</p>
<p>Una alternativa a lo anterior, es indicarle a <strong class="program">vrfydmn</strong> que en vez de
rechazar el correo, lo acepte, pero modificando el campo <code class="docutils literal notranslate"><span class="pre">From:</span></code> para que lo
haga coincidir con la dirección indicada en <code class="docutils literal notranslate"><span class="pre">MAIL</span> <span class="pre">FROM</span></code>. Para ello, habría que
modificar <code class="file docutils literal notranslate"><span class="pre">/etc/default/vrfydmn</span></code> para dejar esta línea:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">DAEMON_OPTS</span><span class="o">=</span><span class="s2">&quot;-F&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="spam">
<span id="id5"></span><h2><span class="section-number">7.3.3.2.2. </span>Spam<a class="headerlink" href="#spam" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El <em>correo indeseado</em> o <em>spam</em> puede afectar a nuestro servidor de correo de dos
maneras:</p>
<ul class="simple">
<li><p>Como <strong>emisor</strong> del <em>spam</em>, porque el servidor se use para enviar ingentemente
correo a otras cuentas.</p></li>
<li><p>Comp <strong>receptor</strong> del <em>spam</em> por algunas de nuestras cuentas lo reciban de
otros servidores.</p></li>
</ul>
<section id="control-del-flujo">
<span id="postfix-flujo"></span><h3><span class="section-number">7.3.3.2.2.1. </span>Control del flujo<a class="headerlink" href="#control-del-flujo" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Por lo general, los <em>spammers</em> se dedican a enviar miles y decenas de miles de
mensajes, por lo que una manera de controlar el <em>spam</em> es el limitar la
recepción o emisión de mensajes.</p>
<p class="rubric">Emisor</p>
<p>El servidor de correo puede convertirse en un emisor de <em>spam</em> si alguna de sus
cuentas se usa para tal fin. Puede deberse tanto a la existencia de un usuario
malintencionado o como al robo de alguna contraseña.</p>
<p>Para el primer caso (o bien cuando el segundo ya se ha consumado) es útil
limitar la capacidad de nuestros usuarios para enviar correos<a class="footnote-reference brackets" href="#id17" id="id6">4</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> Mensajes simultáneos que se pueden enviar a un mismo dominio.
<span class="go">smtp_destination_concurrency_limit = 2</span>
<span class="gp">#</span> Lapso entre dos envíos a un mismo dominio.
<span class="go">smtp_destination_rate_delay = 1s</span>
<span class="gp">#</span> Número máximo de destinatarios por mensaje.
<span class="go">smtp_extra_recipient_limit = 10</span>
</pre></div>
</div>
<p>Para el segundo, es necesario habilitar algun mecanismo que obstaculice los
robos de contraseña. Algunas veces estos robos se deben a ataques de fuerza
bruta efectuados contra el servidor. Para evitarlos es conveniente disponer
<a class="reference internal" href="../../../08.redes/99.ataques/02.tecnicas/03.brute.html#contra-bruta"><span class="std std-ref">algún mecanismo contra ellos</span></a>.</p>
<p class="rubric">Receptor</p>
<p>Para limitar los efectos del <em>spam</em> entrante, podemos limitar la recepción de
mensajes, si es que nuestras cuentas están recibiendo masivamente <em>spam</em> de
alguna fuente<a class="footnote-reference brackets" href="#id18" id="id7">5</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> Número de conexiones entrantes por cliente.
<span class="go">smtpd_client_connection_count_limit = 5</span>
<span class="gp">#</span> Número de conexiones que un cliente puede hacer en un intervalo <span class="o">(</span>fijado por anvil_rate_time_unit<span class="o">)</span>
<span class="go">smtpd_client_connection_rate_limit = 10</span>
<span class="gp">#</span> Número de mensajes entregados por cliente en un intervalo <span class="o">(</span>anvil_rate_time_unit<span class="o">)</span>
<span class="go">smtpd_client_message_rate_limit = 2</span>
<span class="gp">#</span> Número de destinatarios a los que un cliente puede enviar mensajes en un intervalo <span class="o">(</span>anvil_rate_time_unit<span class="o">)</span>
<span class="go">smtpd_client_recipient_rate_limit = 15</span>
</pre></div>
</div>
</section>
<section id="filtro-antispam">
<h3><span class="section-number">7.3.3.2.2.2. </span>Filtro <em>antispam</em><a class="headerlink" href="#filtro-antispam" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Los <em class="dfn">filtros antispam</em> analizan los mensajes recibidos con la intención
de detectar los que son <em>spam</em> y desecharlos o, al menos, marcarlos como
indeseados.</p>
<div class="admonition seealso">
<p class="admonition-title">Ver también</p>
<p>Otras técnicas para detectar <em>spam</em> están relacionadas con los
mecanismos que acreditan al remitente del mensaje, que se explican en
<a class="reference internal" href="05-dns.html#smtp-acreditacion"><span class="std std-ref">su epígrafe correspondiente</span></a>.</p>
</div>
<section id="spamassassin">
<span id="id8"></span><h4><span class="section-number">7.3.3.2.2.2.1. </span>Spamassassin<a class="headerlink" href="#spamassassin" title="Enlazar permanentemente con este título">¶</a></h4>
<p>El <em>software</em> más extendido encargado de esta tarea es <strong class="program">spamassassin</strong>
(<a class="reference external" href="https://spamassassin.apache.org/">página oficial</a>), que tiene fácil
instalación en <em>debian</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> apt-get install spamassassin spamc
</pre></div>
</div>
<p>Puede, además tocarse la configuración de <code class="file docutils literal notranslate"><span class="pre">/etc/default/spamassassin</span></code> para
alterar la prioridad del proceso:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">NICE=&quot;--nicelevel 15&quot;</span>
</pre></div>
</div>
<p>Por último, es necesario habilitar el servicio ya que viene deshabilitado por
defecto<a class="footnote-reference brackets" href="#id19" id="id9">6</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> systemctl <span class="nb">enable</span> spamassassin
<span class="gp">#</span> systemctl start spamassassin
</pre></div>
</div>
<p>El siguiente paso es hacer que <strong class="program">postfix</strong> haga pasar los correos por
<strong class="program">spamassassin</strong> para que este los analice, lo cual requiere editar el
fichero <code class="file docutils literal notranslate"><span class="pre">/etc/postfix/master.cf</span></code> y dejar la primera línea que empieza por
<code class="docutils literal notranslate"><span class="pre">smtp</span></code> así:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">smtp      inet  n       -       -       -       -       smtpd -o content_filter=spamfilter</span>
</pre></div>
</div>
<p>además de añadir al final del fichero en qué consiste este filtro:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">spamfilter unix  -       n       n       -       -       pipe</span>
<span class="go">   flags=Rq user=debian-spamd argv=/usr/local/bin/spamfilter.sh -oi -f ${sender} ${recipient}</span>
</pre></div>
</div>
<p>El usuario <em>debian-spamd</em> lo crea la propia instalación de
<strong class="program">spamassassin</strong> y el <em>script</em> mencionado lo debemos crear nosotros en la
ruta señalada con <a class="reference download internal" download="" href="../../../_downloads/c9c9adf39518d3b7d3e8d28ddd5da752/spamfilter.sh"><code class="xref download docutils literal notranslate"><span class="pre">este</span> <span class="pre">contenido</span></code></a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="c1">#</span>
<span class="c1"># Vease: http://wiki.apache.org/spamassassin/IntegratedSpamdInPostfix</span>
<span class="c1">#</span>

<span class="c1"># Los correos &gt;10MB no se procesan como spam.</span>
<span class="nv">MAX_MESSAGE_SIZE</span><span class="o">=</span><span class="m">10485760</span>

<span class="nv">SENDMAIL</span><span class="o">=</span>/usr/sbin/sendmail
<span class="nv">SPAMASSASSIN</span><span class="o">=</span>/usr/bin/spamc

logger <span class="s2">&quot;Spam filter piping to SpamAssassin, then to: </span><span class="nv">$SENDMAIL</span><span class="s2"> </span><span class="nv">$*</span><span class="s2">&quot;</span>
<span class="si">${</span><span class="nv">SPAMASSASSIN</span><span class="si">}</span> -x -E -s <span class="nv">$MAX_MESSAGE_SIZE</span> <span class="p">|</span> <span class="si">${</span><span class="nv">SENDMAIL</span><span class="si">}</span> <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>

<span class="nb">exit</span> <span class="nv">$?</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Recuérdese que habrá que dar permisos de ejecución al <em>script</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> chmod <span class="m">755</span> /usr/local/bin/spamfilter.sh
</pre></div>
</div>
</div>
<p>A partir de ahora, todo tráfico que sea considerado <em>spam</em> por
<strong class="program">spamassassin</strong> contendrá una cabecera<a class="footnote-reference brackets" href="#id20" id="id10">7</a><a class="footnote-reference brackets" href="#id21" id="id11">8</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">X-Spam-Flag: YES</span>
</pre></div>
</div>
<p>Para tratar la cabecera podemos seguir dos estrategias.</p>
<ul>
<li><p>Utilizar <a class="reference external" href="http://www.postfix.org/postconf.5.html#header_checks">header_checks</a> para desecharlo, según lo <a class="reference internal" href="#postfix-access-body"><span class="std std-ref">expuesto anteriormente</span></a>. En este caso, el filtro podría ser:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">/^X-Spam-Flag:\s+YES$/    DISCARD  Mensaje de spam</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Lo prudente ante el <em>spam</em> es descartar el mensaje silenciosamente,
no rechazarlo.</p>
</div>
</li>
<li><p>Postergar y delegar la decisión en un <abbr title="Mail Delivery Agent">MDA</abbr> externo, que podrá desecharlo
o mandarlo al buzón de <em>spam</em>.</p></li>
</ul>
</section>
<section id="rspamd">
<span id="id12"></span><h4><span class="section-number">7.3.3.2.2.2.2. </span>rspamd<a class="headerlink" href="#rspamd" title="Enlazar permanentemente con este título">¶</a></h4>
<div class="admonition-todo admonition" id="id13">
<p class="admonition-title">Por hacer</p>
<p><strong class="program">spamassassin</strong> tiene el problema de que es un poco monstruoso
y no es la solución más rápida del mundo. Como alternativas pueden tentarse:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://bogofilter.sourceforge.net/">bogofilter</a> según lo explicado <a class="reference external" href="https://www.tinslave.co.uk/blog/index.php?post/50/Lightweight-anti-spam-alternative-for-small-servers">aquí</a>.
Tiene el inconveniente de que usa exclusivamente filtros bayesiano y no
reglas de puntuación.</p></li>
<li><p><a class="reference external" href="https://rspamd.com/">Rrspamd</a>. que sí se basa en reglas Hay <a class="reference external" href="https://thomas-leister.de/en/mailserver-debian-stretch/">una guía
completa de cómo integrarlo con postfix</a>. También es
interesante <a class="reference external" href="https://workaround.org/ispmail/stretch/filtering-out-spam-with-rspamd">es enlace</a></p></li>
</ul>
</div>
<p class="rubric">Notas al pie</p>
<dl class="footnote brackets">
<dt class="label" id="id14"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>En realidad, la comprobación es algo más complicado. Puede ver los
términos exactos en la explicación de la documentación oficial.</p>
</dd>
<dt class="label" id="id15"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>De hecho, también pueden usarse las clases predefinidas o, incluso,
las pruebas (<a class="reference external" href="http://www.postfix.org/postconf.5.html#reject_unauth_destination">reject_unauth_destination</a>, etc.)</p>
</dd>
<dt class="label" id="id16"><span class="brackets"><a class="fn-backref" href="#id4">3</a></span></dt>
<dd><p>También puede usarse una consulta <abbr title="Lightweight Directory Access Protocol">LDAP</abbr> o una consulta <abbr title="Structured Query Language">SQL</abbr>, aunque
en este último caso el <em>backend</em> sólo puede ser <em>MySQL</em>.</p>
</dd>
<dt class="label" id="id17"><span class="brackets"><a class="fn-backref" href="#id6">4</a></span></dt>
<dd><p>Véase al respecto <a class="reference external" href="http://steam.io/2013/04/01/postfix-rate-limiting/">esta entrada de steam.io</a></p>
</dd>
<dt class="label" id="id18"><span class="brackets"><a class="fn-backref" href="#id7">5</a></span></dt>
<dd><p>Véase la <a class="reference external" href="http://www.postfix.org/TUNING_README.html#conn_limit">información al respecto de la documentación de postfix</a></p>
</dd>
<dt class="label" id="id19"><span class="brackets"><a class="fn-backref" href="#id9">6</a></span></dt>
<dd><p>En versiones antiguas de <em>debian</em> sin <strong class="program">systemd</strong>, se habilitaba
en el fichero de configuración:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ENABLED=1</span>
</pre></div>
</div>
</dd>
<dt class="label" id="id20"><span class="brackets"><a class="fn-backref" href="#id10">7</a></span></dt>
<dd><p>En realidad, se añade algún campo de cabecera más, como uno que explica
por qué <strong class="program">spamassassin</strong> ha considerado <em>spam</em> el mensaje.</p>
</dd>
<dt class="label" id="id21"><span class="brackets"><a class="fn-backref" href="#id11">8</a></span></dt>
<dd><p>Es posible modificar el comportamiento editando
<code class="file docutils literal notranslate"><span class="pre">/etc/spamassassin/local.cf</span></code>. Por ejemplo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rewrite_header Subject *****SPAM***** [_SCORE_]</span>
<span class="go">report_safe 0</span>
<span class="go">required_score 4.0</span>
</pre></div>
</div>
<p>La primera directiva reescribirá el asunto del mensaje, la segunda no
modificaría el cuerpo del mensaje y la última bajará la puntuación para la que
un mensaje se considere <em>spam</em> (por defecto es 5).</p>
</dd>
</dl>
</section>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../index.html">Tabla de contenido</a></h3>
  <ul>
<li><a class="reference internal" href="#">7.3.3.2. Aceptación de mensajes</a><ul>
<li><a class="reference internal" href="#politicas-de-aceptacion">7.3.3.2.1. Políticas de aceptación</a><ul>
<li><a class="reference internal" href="#control-de-accesos">7.3.3.2.1.1. Control de accesos</a></li>
<li><a class="reference internal" href="#control-de-destinatario">7.3.3.2.1.2. Control de destinatario</a></li>
<li><a class="reference internal" href="#control-del-contenido-del-mensaje">7.3.3.2.1.3. Control del contenido del mensaje</a></li>
<li><a class="reference internal" href="#campo-from">7.3.3.2.1.4. Campo <code class="docutils literal notranslate"><span class="pre">From:</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#spam">7.3.3.2.2. Spam</a><ul>
<li><a class="reference internal" href="#control-del-flujo">7.3.3.2.2.1. Control del flujo</a></li>
<li><a class="reference internal" href="#filtro-antispam">7.3.3.2.2.2. Filtro <em>antispam</em></a><ul>
<li><a class="reference internal" href="#spamassassin">7.3.3.2.2.2.1. Spamassassin</a></li>
<li><a class="reference internal" href="#rspamd">7.3.3.2.2.2.2. rspamd</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Tema anterior</h4>
  <p class="topless"><a href="01-inst.html"
                        title="capítulo anterior"><span class="section-number">7.3.3.1. </span>Instalación y configuración</a></p>
  <h4>Próximo tema</h4>
  <p class="topless"><a href="03-entrega.html"
                        title="próximo capítulo"><span class="section-number">7.3.3.3. </span>Entrega</a></p>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/07.serre/03.mail/02-smtp/02-accept.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Ir a" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="03-entrega.html" title="7.3.3.3. Entrega"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="01-inst.html" title="7.3.3.1. Instalación y configuración"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" ><span class="section-number">7. </span>Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" ><span class="section-number">7.3. </span>Correo electrónico</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="index.html" ><span class="section-number">7.3.3. </span>Servidor <abbr title="Simple Mail Transfer Protocol">SMTP</abbr></a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7.3.3.2. </span>Aceptación de mensajes</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2022, José Miguel Sánchez Alés.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.2.
    </div>
  </body>
</html>