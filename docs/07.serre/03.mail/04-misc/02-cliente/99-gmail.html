


<!DOCTYPE html>

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>7.3.5.3.6. Uso de cuentas de Gmail &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/classic.css" />
    <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
    
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/translations.js"></script>
    
    <link rel="index" title="Índice" href="../../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../../search.html" />
    <link rel="next" title="7.3.5.4. Servicio de webmail" href="../04-webmail/index.html" />
    <link rel="prev" title="7.3.5.3.5. mutt (MUA)" href="05-mua.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="../04-webmail/index.html" title="7.3.5.4. Servicio de webmail"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="05-mua.html" title="7.3.5.3.5. mutt (MUA)"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">7. </span>Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">7.3. </span>Correo electrónico</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" ><span class="section-number">7.3.5. </span>Otros aspectos</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="index.html" accesskey="U"><span class="section-number">7.3.5.3. </span>Linux como cliente</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7.3.5.3.6. </span>Uso de cuentas de Gmail</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="uso-de-cuentas-de-gmail">
<span id="oauth2-gmail"></span><h1><span class="section-number">7.3.5.3.6. </span>Uso de cuentas de Gmail<a class="headerlink" href="#uso-de-cuentas-de-gmail" title="Enlazar permanentemente con este título">¶</a></h1>
<p>Desde junio de 2022 <a class="reference external" href="https://support.google.com/accounts/answer/6010255?hl=en">Google no permite la autenticación simple con usuario y
contraseña</a>, lo que
inutiliza algunas de las configuraciones expuestas si se utiliza <em>Gmail</em> como
servidor de correo.</p>
<p>Para que la autenticación sea válida, debe realizarse desde una aplicación
confiable que haya sido registrada como tal en <em>Google</em>. Tal es el caso, por
ejemplo, del cliente gráfico <a class="reference external" href="https://thunderbird.net">Thunderbird</a>. Sin embargo, muchas de las
aplicaciones indicadas aquí no son aplicaciones confiables, lo que nos obliga a
hacer una configuración adicional, que básicamente consiste en</p>
<ul class="simple">
<li><p>Obtener unas credenciales válidad de autenticación a través de la consola de
desarrollo que proporciona Google.</p></li>
<li><p>Configurar la aplicación que queremos usar para que use tales credenciales.</p></li>
</ul>
<section id="obtencion-de-credenciales">
<h2><span class="section-number">7.3.5.3.6.1. </span>Obtención de credenciales<a class="headerlink" href="#obtencion-de-credenciales" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Antes de configurar las aplicaciones, nuestro objetivo es obtener una
credenciales apropiadas, para lo cual debemos acceder con nuestro usuario de
<em>Gmail</em> a la <a class="reference external" href="https://console.developers.google.com">consola de desarrollador</a>
y seguir los siguientes pasos:</p>
<ol class="arabic">
<li><p>En la sección de «Biblioteca» habilitar la <abbr title="Application Programming Interface">API</abbr> para <em>Gmail</em>:</p>
<img alt="../../../../_images/00-api.png" src="../../../../_images/00-api.png" />
</li>
<li><p>A continuación debemos definir una pantalla de consentimiento para <em>OAuth2</em>,
que nos pedirá que creemos antes un nuevo proyecto, si aún no hemos creado
ninguno:</p>
<img alt="../../../../_images/01-OAuth.png" src="../../../../_images/01-OAuth.png" />
<img alt="../../../../_images/02-proyecto.png" src="../../../../_images/02-proyecto.png" />
</li>
<li><p>Completar la definición de la pantalla de consentimiento, lo cual no tiene
excesiva dificultad:</p>
<img alt="../../../../_images/03-consentimiento.png" src="../../../../_images/03-consentimiento.png" />
<img alt="../../../../_images/04-consentimiento.png" src="../../../../_images/04-consentimiento.png" />
<img alt="../../../../_images/05-consentimiento.png" src="../../../../_images/05-consentimiento.png" />
<p>Eso sí, habrá que definir los permisos que se conceden y deberemos habilitar
los relativos a <em>Gmail</em>:</p>
<img alt="../../../../_images/06-cons-permisos.png" src="../../../../_images/06-cons-permisos.png" />
<p>Y, finalmente, habrá que incluir como usuario de prueba el usuario con el
que deseamos autenticarnos:</p>
<img alt="../../../../_images/07-cont-usuario.png" src="../../../../_images/07-cont-usuario.png" />
</li>
<li><p>Crear propiamente las credeanciales para «ID de cliente de OAuth»:</p>
<img alt="../../../../_images/08-credenciales.png" src="../../../../_images/08-credenciales.png" />
<img alt="../../../../_images/09-credenciales.png" src="../../../../_images/09-credenciales.png" />
<img alt="../../../../_images/10-credenciales.png" src="../../../../_images/10-credenciales.png" />
</li>
</ol>
<p>Como resultado, obtenemos las credenciales que deberemos usar en la
configuración de nuestras aplicaciones.</p>
</section>
<section id="configuracion-de-aplicaciones">
<h2><span class="section-number">7.3.5.3.6.2. </span>Configuración de aplicaciones<a class="headerlink" href="#configuracion-de-aplicaciones" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El método de configuración, obviamente, es particular para cada aplicación.</p>
<section id="mutt">
<h3><span class="section-number">7.3.5.3.6.2.1. </span><strong class="program">mutt</strong><a class="headerlink" href="#mutt" title="Enlazar permanentemente con este título">¶</a></h3>
<p><strong class="program">mutt</strong> requiere la autenticación tanto para el envío de mensajes a
través del servidor <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> como para el acceso <abbr title="Internet Message Access Protocol">IMAP</abbr> interactivo. para
llevarlo a cabo, el paquete <a class="reference external" href="https://packages.debian.org/stable/mutt">mutt</a> provee un <em>script</em> escrito en
<strong class="program">python</strong>: <code class="file docutils literal notranslate"><span class="pre">/usr/share/doc/mutt/examples/mutt_oauth2.py</span></code>.
asi que empezaremos por copiar este <em>script</em> en un lugar adecuado:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir -p .config/mutt
<span class="gp">$ </span>install -m750 /usr/share/doc/mutt/examples/mutt_oauth2.py ~/.config/mutt/
</pre></div>
</div>
<p>Este <em>script</em> nos permitirá obtener un token de acceso que se almacena en una
base de datos gestionada por <a class="reference internal" href="../../../../98.apendice/01.cryto/03.aplicaciones/03.correo.html#gnupg"><span class="std std-ref">GNUpg</span></a>, por lo que necesitaremos
también este <em>software</em>. Como en <em>Debian</em> es una dependencia del propio
<strong class="program">mutt</strong> no será necesaria ninguna instalación adicional.</p>
<p>Lo que sí debemos hacer es crearlo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gpg --gen-key
</pre></div>
</div>
<p>La orden nos pedirá un nombre (podemos usar «Mutt OAuth2», por ejemplo) y una
dirección de correo, que puede ser la dirección de correo de la que estamos
generando la autenticación (p.e. <kbd class="kbd docutils literal notranslate">pericodelospalotes&#64;gmail.com</kbd>), aunque no
necesariamente. Finalmente deberemos asegurarlo todo con una contraseña, que
deberemos recordar, porque será la que se nos pregunte cada vez que queramos
tener acceso al token.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Para que <strong class="program">gpg-agent</strong> sepa por donde pedir la contraseña
podría ser necesario definir una variable de ambiente persistente:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">GPG_TTY</span><span class="o">=</span><span class="k">$(</span>tty<span class="k">)</span>
</pre></div>
</div>
</div>
<p>Generada la clave, debemos editar <code class="file docutils literal notranslate"><span class="pre">~/.config/mutt/mutt_oauth2.py</span></code> para:</p>
<ul class="simple">
<li><p>En la definición de <kbd class="kbd docutils literal notranslate">ENCRYPTION_PIPE</kbd> añadir la dirección a la que
asociamos la clave recién creada.</p></li>
<li><p>Añadir las credenciales <kbd class="kbd docutils literal notranslate">client_id</kbd> y <kbd class="kbd docutils literal notranslate">client_secret</kbd> obtenidas
bajo el epígrafe anterior.</p></li>
</ul>
<p>Una vez hecho, podemos obtener el <em>token</em> ejecutando la orden:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>~/.config/mutt/mutt_oauth2.py -va --authflow authcode ~/.config/mutt/pericodelospalotes@gmail.com
</pre></div>
</div>
<p>Esta orden generará una <abbr title="Uniform Resource Locator">URL</abbr> que habrá que copiar en el navegador y a resultas
de la cual, se generará un código que debemos facilitar al <em>script</em> para que
cree el archivo cifrado.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La dirección no debe ser necesariamente la dirección de correo
(podríamos haber usando otra falsa como <kbd class="kbd docutils literal notranslate">pericodelospalotes&#64;gmail.com.token</kbd>).
La dirección real debe usarse en la configuración del propio <strong class="program">mutt</strong>
(véase a continuación) y en la dirección de correo que interactivamente nos
pregunta la ejecución de <strong class="command">mutt_oauth2.py</strong></p>
</div>
<p>Con esto ya podemos configurar <strong class="program">mutt</strong>, pero antes probemos que el <em>token</em> funciona:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>~/.config/mutt/mutt_oauth2.py -vt ~/.config/mutt/pericodelospalotes@gmail.com
<span class="go">Access token: xxx</span>
<span class="go">IMAP authentication succeeded</span>
<span class="go">POP authentication succeeded</span>
<span class="go">SMTP authentication succeeded</span>
</pre></div>
</div>
<p>Finalmente, para configurar <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> e <abbr title="Internet Message Access Protocol">IMAP</abbr> la configuración necesaria es la siguiente:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> <span class="nv">smtp_url</span> <span class="o">=</span> <span class="s2">&quot;smtp://pericodelospalotes@gmail.com@smtp.gmail.com:587/&quot;</span>
<span class="nb">set</span> <span class="nv">smtp_authenticators</span> <span class="o">=</span> <span class="s2">&quot;oauthbearer:xoauth2&quot;</span>
<span class="nb">set</span> <span class="nv">smtp_oauth_refresh_command</span> <span class="o">=</span> <span class="s2">&quot;~/.config/mutt/mutt_oauth2.py ~/.config/mutt/pericodelospalotes@gmail.com&quot;</span>

<span class="nb">set</span> <span class="nv">imap_user</span><span class="o">=</span><span class="s2">&quot;pericodelospalotes@gmail.com&quot;</span>
<span class="nb">set</span> <span class="nv">folder</span> <span class="o">=</span> <span class="s2">&quot;imap://imap.gmail.com&quot;</span>
<span class="nb">set</span> <span class="nv">imap_authenticators</span><span class="o">=</span><span class="nv">$smtp_authenticators</span>
<span class="nb">set</span> <span class="nv">imap_oauth_refresh_command</span><span class="o">=</span><span class="nv">$smtp_oauth_refresh_command</span>
</pre></div>
</div>
</section>
<section id="getmail">
<span id="getmail-oauth2"></span><h3><span class="section-number">7.3.5.3.6.2.2. </span><strong class="program">getmail</strong><a class="headerlink" href="#getmail" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Debemos crear un archivo <code class="file docutils literal notranslate"><span class="pre">~/.config/provider.json</span></code> con este
contenido:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="nt">&quot;scope&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://mail.google.com/&quot;</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="w">   </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;xxx@gmail.com&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="w">   </span><span class="nt">&quot;client_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;yyy.apps.googleusercontent.com&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="w">   </span><span class="nt">&quot;client_secret&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;zzz-ttt&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="w">   </span><span class="nt">&quot;token_uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://accounts.google.com/o/oauth2/token&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="nt">&quot;auth_uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://accounts.google.com/o/oauth2/auth&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="nt">&quot;redirect_uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;urn:ietf:wg:oauth:2.0:oob&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="nt">&quot;auth_provider_x509_cert_url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://www.googleapis.com/oauth2/v1/certs&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>donde <kbd class="kbd docutils literal notranslate">client_id</kbd> y <kbd class="kbd docutils literal notranslate">client_secret</kbd> son las credenciales que hemos
obtenido en el paso anterior. Creado el archivo, podemos obtener el token
necesario ejecutando:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>getmail-gmail-xoauth-tokens -i ~/.config/provider.json
</pre></div>
</div>
<p>que añadirá al archivo los campos <kbd class="kbd docutils literal notranslate">access_token</kbd> y <kbd class="kbd docutils literal notranslate">refresh_token</kbd>.
Hecho lo cual, podemos autenticarnos creando una sección <kbd class="kbd docutils literal notranslate">[retriever]</kbd> en
el archivo de configuración (el resto de puede quedarse tal como <a class="reference internal" href="03-fetchmail.html#getmail"><span class="std std-ref">se expuso
anteriormente</span></a>):</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[retriever]</span><span class="w"></span>
<span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">SimpleIMAPSSLRetriever</span><span class="w"></span>
<span class="na">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">imap.gmail.com</span><span class="w"></span>
<span class="na">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">xxx@gmail.com</span><span class="w"></span>
<span class="na">use_xoauth2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span><span class="w"></span>
<span class="na">password_command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">(&quot;/usr/bin/getmail-gmail-xoauth-tokens&quot;, &quot;/home/usuario/.config/provider.json&quot;)</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>El <em>token</em> tiene una caducidad por lo que cada 90 días habrá que
volver a renegerarlos con la orden anterior.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">Ver también</p>
<p><a class="reference external" href="https://www3.isi.edu/~johnh/OTHER/LINUX/OAUTH2/index.html">Este artículo</a> documenta el
soporte de OAuth2 en <strong class="program">getmail</strong>.</p>
</div>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../../../index.html">Tabla de contenido</a></h3>
    <ul>
<li><a class="reference internal" href="#">7.3.5.3.6. Uso de cuentas de Gmail</a><ul>
<li><a class="reference internal" href="#obtencion-de-credenciales">7.3.5.3.6.1. Obtención de credenciales</a></li>
<li><a class="reference internal" href="#configuracion-de-aplicaciones">7.3.5.3.6.2. Configuración de aplicaciones</a><ul>
<li><a class="reference internal" href="#mutt">7.3.5.3.6.2.1. <strong class="program">mutt</strong></a></li>
<li><a class="reference internal" href="#getmail">7.3.5.3.6.2.2. <strong class="program">getmail</strong></a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Tema anterior</h4>
    <p class="topless"><a href="05-mua.html"
                          title="capítulo anterior"><span class="section-number">7.3.5.3.5. </span><strong class="command">mutt</strong> (<abbr title="Mail User Agent">MUA</abbr>)</a></p>
  </div>
  <div>
    <h4>Próximo tema</h4>
    <p class="topless"><a href="../04-webmail/index.html"
                          title="próximo capítulo"><span class="section-number">7.3.5.4. </span>Servicio de webmail</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/07.serre/03.mail/04-misc/02-cliente/99-gmail.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Ir a" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="../04-webmail/index.html" title="7.3.5.4. Servicio de webmail"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="05-mua.html" title="7.3.5.3.5. mutt (MUA)"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">7. </span>Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">7.3. </span>Correo electrónico</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" ><span class="section-number">7.3.5. </span>Otros aspectos</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="index.html" ><span class="section-number">7.3.5.3. </span>Linux como cliente</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7.3.5.3.6. </span>Uso de cuentas de Gmail</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2022, José Miguel Sánchez Alés.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>