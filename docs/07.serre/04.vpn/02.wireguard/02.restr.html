


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="es">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>7.4.3.2.2. Redes restringidas &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Índice" href="../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../search.html" />
    <link rel="next" title="7.5. Proxies" href="../../05.proxies/index.html" />
    <link rel="prev" title="7.4.3.2.1. Configuración" href="01.conf.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="../../05.proxies/index.html" title="7.5. Proxies"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="01.conf.html" title="7.4.3.2.1. Configuración"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >7. Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" >7.4. Redes VPN</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="index.html" accesskey="U">7.4.3.2. Wireguard</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="redes-restringidas">
<h1>7.4.3.2.2. Redes restringidas<a class="headerlink" href="#redes-restringidas" title="Enlazar permanentemente con este título">¶</a></h1>
<p>Cuando nuestro <em>guerrero de la carretera</em> se encuentra dentro de una red
restringida que no controlamos nos toparemos muy probablemente con el problema
de que seremos incapaces de acceder al puerto <abbr title="User Datagram Protocol">UDP</abbr> en que hayamos dejado
escuchando el servidor (el <em>1194</em> en nuestra propuesta).</p>
<p>En estas redes restringidas, lo habitual es que sólo podemos:</p>
<ul class="simple">
<li>Hacer consultas <abbr title="Domain Name Server">DNS</abbr> (<em>53/UDP</em>).</li>
<li>Navegar (puertos <em>80/TCP</em> y <em>443/TCP</em>).</li>
</ul>
<p>Podríamos dejar escuchando el servicio en el puerto <em>53/UDP</em>, pero es común que
en estas redes restringidas las consultas <abbr title="Domain Name Server">DNS</abbr> se limiten a algún servidor
interno, con lo cual es una solución que no será efectiva en todas las redes.</p>
<p>La solución general es usar los puertos para tráfico web, pero nos topamos con
el problema de que por motivos de rendimiento <strong class="program">wireguard</strong> sólo se ha
implementado para <abbr title="User Datagram Protocol">UDP</abbr>. Una solución para solucionar este inconveniente es
tunelizador el trafico mediante <cite>Websockets &lt;https://v0ctor.me/websocket&gt;</cite>. Como
forma parte del estándar <abbr title="HyperText Markup Language">HTML</abbr>5, no deberiamos tener problemas con el proxy
web, aun usando <abbr title="HyperText Transfer Protocol">HTTP</abbr> y no <abbr title="HyperText Transfer Protocol">HTTP</abbr>s. Además, no recifrar con <abbr title="Secure Sockets Layer">SSL</abbr> aminorará
la pérdida de rendimiento de tener que tunelizar <strong class="program">wireguard</strong>.</p>
<div class="section" id="wstunnel">
<h2>7.4.3.2.2.1. <strong class="program">wstunnel</strong><a class="headerlink" href="#wstunnel" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Para lograr nuestro objetivo podemos usar <a class="reference external" href="https://github.com/erebe/wstunnel">wstunnel</a>, el cual es capaz de tunelizar mediante
<em>Websockets</em> tráfico <abbr title="User Datagram Protocol">UDP</abbr>. No existe paquete para <em>Debian</em>, pero podemos
descargar el ejecutable del propio repositio de <em>Github</em>. Su uso es bastante
sencillo. Descargamos en dos máquinas el ejecutable y:</p>
<ul>
<li><p class="first">En la máquina servidor lo ejecutamos de esta forma:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> /usr/local/bin/wstunnel -v --server ws://0.0.0.0 --restrictTo <span class="m">127</span>.0.0.1:1194
</pre></div>
</div>
<p>lo cual supone que la aplicación escuche en el puerto <em>80</em> los datos
que se pretenden tunelizar. Además, sólo se aceptará tráfico que el cliente
indique que va dirigido al puerto <em>1194</em> de la interfaz de loopback.</p>
</li>
<li><p class="first">En la máquina cliente, rematamos el otro extremo del túnel con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> /usr/local/bin/wstunnel -v --udp --udpTimeoutSec -1 -L <span class="m">127</span>.0.0.1:12345:127.0.0.1:1194 ws://203.0.113.1
</pre></div>
</div>
<p>que conecta con el puerto 80 del servidor (hemos supuesto que <em>203.0.113.1</em> es
su dirección <abbr title="Internet Protocol">IP</abbr>) y envía los datos que recibe por el puerto <em>12345/UDP</em>
de la interfaz de <em>loopback</em> al puerto <em>1194/UDP</em> de la interfaz de <em>loopback</em>
del servidor (esto último coincide con lo que se indicó con
<kbd class="kbd docutils literal notranslate">--restrictTo</kbd> en el servidor).</p>
</li>
</ul>
<p>Con ello ya tendremos establecido el tunel dentro del cual circula el tráfico
<abbr title="User Datagram Protocol">UDP</abbr>. Si queremos probarlo, podemos hacer:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">servidor$ netcat -u -l -p 1194</span>
</pre></div>
</div>
<p>y en el cliente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cliente$ netcat -u localhost 12345</span>
</pre></div>
</div>
<p>Ambos <a class="reference internal" href="../../../02.conbas/99.misc/05.ordenes.html#netcat"><span class="std std-ref">netcat</span></a> deberían comunicarse a través del <em>websocket</em>.</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Para que el tráfico hubiera sido cifrado (y por el puerto 443) habría
bastado con usar <kbd class="kbd docutils literal notranslate">wss</kbd> en vez de <kbd class="kbd docutils literal notranslate">ws</kbd>.</p>
</div>
</div>
<div class="section" id="encapsulando-wireguard">
<h2>7.4.3.2.2.2. Encapsulando <strong class="program">wireguard</strong><a class="headerlink" href="#encapsulando-wireguard" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Podemos aplicar lo expuesto bajo el epígrafe anterior al caso <em>sede-equipo
móvil</em> en el que el equipo móvil se halla dentro de una red restringida.</p>
<p class="rubric">Servidor</p>
<p>La configuración de <strong class="program">wireguard</strong> es exactamente la misma pero con el
añadido de que junto a la interfaz debemos arrancar o parar la parte de servidor
de <strong class="program">wstunnel</strong> que redirige el tráfico recibido hacia el propio
<strong class="program">wireguard</strong>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Interface]</span>
<span class="na">Address</span> <span class="o">=</span> <span class="s">10.0.8.1/24</span>
<span class="na">ListenPort</span> <span class="o">=</span> <span class="s">1194</span>
<span class="na">PrivateKey</span> <span class="o">=</span> <span class="s">kEANNMfztMtzgwFyyaWOou7+c8ZPD/lyGhmcM7oFtXA=</span>
<span class="na">PreUp</span> <span class="o">=</span> <span class="s">/etc/wireguard/wstunnel.sh up %i</span>
<span class="na">PostDown</span> <span class="o">=</span> <span class="s">/etc/wireguard/wstunnel.sh down %i</span>

<span class="k">[Peer]</span>
<span class="na">PublicKey</span> <span class="o">=</span> <span class="s">f2CH3QXHiXwFhdATcDi42DU+PUOC9Ky8BgkHBigY5H4=</span>
<span class="na">AllowedIPs</span> <span class="o">=</span> <span class="s">10.0.8.2/32</span>
</pre></div>
</div>
<p>La automatización de <strong class="program">wstunnel</strong> se logra gracias al <a class="reference download internal" download="" href="../../../_downloads/e9edf6fd543196caa599376d2fb42bd5/wstunnel.sh"><code class="xref download docutils literal notranslate"><span class="pre">script</span>
<span class="pre">wstunnel.sh</span></code></a>, que debe guardarse con permisos de ejecución
en <code class="file docutils literal notranslate"><span class="pre">/etc/wireguard</span></code>. El <em>script</em>, además, lee un fichero de configuración
<code class="file docutils literal notranslate"><span class="pre">/etc/wireguard/wg0.wstunnel</span></code> en el que pueden definirse (con la sintaxis
de <strong class="command">sh</strong>) algunas variables:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">SECURE</span><span class="o">=</span><span class="m">1</span>                   <span class="c1"># Para usar wss, en vez de ws.</span>
<span class="nv">LISTEN_ADDRESS</span><span class="o">=</span><span class="m">127</span>.0.0.1   <span class="c1"># IP de escucha de wstunnel. Por defecto, 0.0.0.0.</span>
<span class="nv">LISTEN_PORT</span><span class="o">=</span><span class="m">8080</span>           <span class="c1"># Por si se desea cambiar el predefinido: ws=80; wss=443</span>
</pre></div>
</div>
<p>Como para este caso, no cifraremos y queremos que el tunel creado por
<strong class="program">wstunnel</strong> escuche en la interfaz física, <strong>no definiremos ninguna
variable</strong>.</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Como el <strong class="program">wireguard</strong> sigue escuchando en el puerto 1194 de
todas las interfaces, incluida la física, los clientes podrán seguir
conectándose, si tienen la posibilidad, sin necesidad de <strong class="program">wstunnel</strong>.</p>
</div>
<p class="rubric">Cliente</p>
<p>Mientras en el cliente, debemos crear un archivo <code class="file docutils literal notranslate"><span class="pre">/etc/wireguard/wgt0.conf</span></code>
con el siguiente contenido:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Interface]</span>
<span class="na">Address</span> <span class="o">=</span> <span class="s">10.0.8.2/24</span>
<span class="na">PrivateKey</span> <span class="o">=</span> <span class="s">WB4TAWIIlaOyULudlcdhqctTl/pdzO7m+6x4DhAP+0k=</span>
<span class="na">PreUp</span> <span class="o">=</span> <span class="s">/etc/wireguard/wstunnel.sh up %i</span>
<span class="na">PostUp</span> <span class="o">=</span> <span class="s">/etc/wireguard/wstunnel.sh route %i</span>
<span class="na">PostDown</span> <span class="o">=</span> <span class="s">/etc/wireguard/wstunnel.sh down %i</span>

<span class="k">[Peer]</span>
<span class="na">PublicKey</span> <span class="o">=</span> <span class="s">/Pr37VgN7GVvizJw9FpCL62DSwocdNEf7lwfdDRZXj8=</span>
<span class="na">Endpoint</span> <span class="o">=</span> <span class="s">0.0.0.0:1194</span>
<span class="na">AllowedIPs</span> <span class="o">=</span> <span class="s">0.0.0.0/0</span>
</pre></div>
</div>
<p>que utiliza <a class="reference download internal" download="" href="../../../_downloads/e9edf6fd543196caa599376d2fb42bd5/wstunnel.sh"><code class="xref download docutils literal notranslate"><span class="pre">el</span> <span class="pre">mismo</span> <span class="pre">script</span></code></a> para crear la parte
cliente de <strong class="program">wstunnel</strong>. Lo habitual, en el caso de redes restringidas,
es que queramos usar el túnel para salir son cortapisas a internet, de ahí el
valor de <kbd class="kbd docutils literal notranslate">AllowedIPs</kbd>.</p>
<p>Para esta parte cliente sí es necesario el fichero de configuración del tunel en
el que puede definirse:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">SECURE</span><span class="o">=</span><span class="m">1</span>             <span class="c1"># Si queremos usar wss, en vez ws.</span>
<span class="nv">RHOST</span><span class="o">=</span><span class="m">203</span>.0.113.1    <span class="c1"># Obligatorio. Dirección del servidor.</span>
<span class="nv">WG_PORT</span><span class="o">=</span><span class="m">1194</span>         <span class="c1"># Puesto en el que escucha la parte servidor de wireguard.</span>
</pre></div>
</div>
<p>Entiéndase que <span class="var">RHOST</span> es la dirección donde escucha el otro extremo de
<strong class="program">wstunnel</strong>. En consecuencia, si se usó en la configuración del servidor
<span class="var">LISTEN_PORT</span> para alterar el puerto predeterminado y se dejó este
escuchando en la interfaz física, es más que probable que tenga que incluir
el puerto al definir <span class="var">RHOST</span>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">RHOST</span><span class="o">=</span><span class="m">203</span>.0.113.1:8080
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Advertencia</p>
<p>Si deseamos acceder al servidor mediante nombre y no mediante <abbr title="Internet Protocol">IP</abbr>
(lo cual puede ser de mucha utilidad, si colocamos <a class="reference internal" href="#wg-nginx"><span class="std std-ref">nginx como proxy
inverso</span></a>), entonces deberemos añadir en <code class="file docutils literal notranslate"><span class="pre">/etc/hosts</span></code> la
resolución. para evitar consultar un <abbr title="Domain Name Server">DNS</abbr> externo que no estará disponible
hasta no haberse completado el establecimiento del túnel:</p>
<div class="last highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> <span class="nb">echo</span> <span class="s2">&quot;203.0.113.1  vpn.example.net&quot;</span> &gt;&gt; /etc/hosts
</pre></div>
</div>
</div>
<p>En cuanto a <span class="var">WG_PORT</span> coincidirá con el valor de <kbd class="kbd docutils literal notranslate">ListenPort</kbd> definido
en el servidor.</p>
<p>Para resolver nuestro caso, dejaremos esta configuración:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/wireguard/wgt0.wstunnel</span>

<span class="nv">RHOST</span><span class="o">=</span><span class="m">203</span>.0.113.1
<span class="nv">WG_PORT</span><span class="o">=</span><span class="m">1194</span>
</pre></div>
</div>
</div>
<div class="section" id="anadiendo-nginx-a-la-ecuacion">
<span id="wg-nginx"></span><h2>7.4.3.2.2.3. Añadiendo <strong class="program">nginx</strong> a la ecuación<a class="headerlink" href="#anadiendo-nginx-a-la-ecuacion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Poner a escuchar en la interfaz física a <strong class="program">wstunnel</strong> imposibilita
a la máquina hacer también de servidor web. Si este es el caso, la solución
consiste en disponer un <em>proxy</em> inverso que redirija el tráfico hacia el
servidor web o hacia <strong class="program">wstunnel</strong> según convenga.</p>
<p>La solución es valida tanto para tráfico cifrado como para tráfico sin cifrar.
Ahora bien, si el tráfico es cifrado, lo conveniente es que quien cifra sea el
proxy, no la parte servidor de <strong class="program">wstunnel</strong>.</p>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Por hacer</p>
<p class="last">Completar</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">7.4.3.2.2. Redes restringidas</a><ul>
<li><a class="reference internal" href="#wstunnel">7.4.3.2.2.1. <strong class="program">wstunnel</strong></a></li>
<li><a class="reference internal" href="#encapsulando-wireguard">7.4.3.2.2.2. Encapsulando <strong class="program">wireguard</strong></a></li>
<li><a class="reference internal" href="#anadiendo-nginx-a-la-ecuacion">7.4.3.2.2.3. Añadiendo <strong class="program">nginx</strong> a la ecuación</a></li>
</ul>
</li>
</ul>

  <h4>Tema anterior</h4>
  <p class="topless"><a href="01.conf.html"
                        title="capítulo anterior">7.4.3.2.1. Configuración</a></p>
  <h4>Próximo tema</h4>
  <p class="topless"><a href="../../05.proxies/index.html"
                        title="próximo capítulo">7.5. Proxies</a></p>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/07.serre/04.vpn/02.wireguard/02.restr.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Ir a" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="../../05.proxies/index.html" title="7.5. Proxies"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="01.conf.html" title="7.4.3.2.1. Configuración"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >7. Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" >7.4. Redes VPN</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="index.html" >7.4.3.2. Wireguard</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2020, José Miguel Sánchez Alés.
      Creado con <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>