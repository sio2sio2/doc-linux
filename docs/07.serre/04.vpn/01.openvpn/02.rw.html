

<!DOCTYPE html>

<html lang="es" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>7.4.3.1.2. Conexión sede-equipo móvil &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css?v=514cf933" />
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    
    <script src="../../../_static/documentation_options.js?v=a621b78a"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/translations.js?v=efdbd0b9"></script>
    
    <link rel="index" title="Índice" href="../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../search.html" />
    <link rel="next" title="7.4.3.1.3. Conexión sede-sede" href="03.ss.html" />
    <link rel="prev" title="7.4.3.1.1. Preparativos" href="01.previo.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="03.ss.html" title="7.4.3.1.3. Conexión sede-sede"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="01.previo.html" title="7.4.3.1.1. Preparativos"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" ><span class="section-number">7. </span>Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" ><span class="section-number">7.4. </span>Redes VPN</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="index.html" accesskey="U"><span class="section-number">7.4.3.1. </span>OpenVPN</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7.4.3.1.2. </span>Conexión sede-equipo móvil</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="conexion-sede-equipo-movil">
<h1><span class="section-number">7.4.3.1.2. </span>Conexión sede-equipo móvil<a class="headerlink" href="#conexion-sede-equipo-movil" title="Link to this heading">¶</a></h1>
<p>Esta conexión se produce cuando se quiere conectar un equipo aislado (el
ordenador portátil de un comercial) con la red local al servidor <abbr title="Virtual Private Network">VPN</abbr> (la
empresa, por ejemplo). Los clientes, por supuesto, pueden ser varios pero cada
uno de ellos se encontrará en una localización y distinta y las conexiones <abbr title="Virtual Private Network">VPN</abbr>
con el servidor será distintas.</p>
<img alt="../../../_images/roadwarrior.png" src="../../../_images/roadwarrior.png" />
<p>En este caso, la red remota en la que se encuentra el cliente es absolutamente
irrelevante mas allá de que debe ser tal que nos permita establecer el túnel.</p>
<p>Desarrollaremos dos casos de estudio: en uno se establece el túnel en capa de
red y en el otro en capa de enlace. Para ambos, no obstante, se desrrolla la
configuración para que:</p>
<ul class="simple">
<li><p>La identificación de los clientes sea mediante usuario y contraseña.</p></li>
<li><p>Se use como certificado de servidor el generado con <em>Let’s Encrypt</em>.</p></li>
<li><p>El cliente pase a conectar a internet a través del túnel <abbr title="Virtual Private Network">VPN</abbr>.</p></li>
</ul>
<section id="capa-de-red">
<h2><span class="section-number">7.4.3.1.2.1. </span>Capa de red<a class="headerlink" href="#capa-de-red" title="Link to this heading">¶</a></h2>
<p>En este caso hay tres redes: la red remota del cliente, la red local al servidor
y la red a la que pertenecen las dos interfaces virtuales (una del cliente y
otra del servidor) entre las cuales se establece el túnel.</p>
<p>Cuál sea la red remota importa poco, así que establezcamos las otras dos a
efectos de aplicar el caso a la configuración:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head" colspan="2"><p>Red</p></th>
<th class="head" colspan="2"><p>Máquina</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td rowspan="2"><p>Local</p></td>
<td rowspan="2"><p>192.168.255.0/24</p></td>
<td><p>Servidor <abbr title="Virtual Private Network">VPN</abbr> (eth0)</p></td>
<td><p>192.168.255.2</p></td>
</tr>
<tr class="row-odd"><td><p>Router Local</p></td>
<td><p>192.168.255.1</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>Túnel <abbr title="Virtual Private Network">VPN</abbr></p></td>
<td rowspan="2"><p>10.8.0.0/24</p></td>
<td><p>Servidor <abbr title="Virtual Private Network">VPN</abbr> (tun0)</p></td>
<td><p>-</p></td>
</tr>
<tr class="row-odd"><td><p>Cliente <abbr title="Virtual Private Network">VPN</abbr> (tun0)</p></td>
<td><p>-</p></td>
</tr>
</tbody>
</table>
<section id="servidor">
<span id="srw3-server"></span><h3><span class="section-number">7.4.3.1.2.1.1. </span>Servidor<a class="headerlink" href="#servidor" title="Link to this heading">¶</a></h3>
<p>Dispondremos <a class="reference download internal" download="" href="../../../_downloads/bd48fac428e91a2337e1b1265f1de354/s-rw_3.txt"><code class="xref download docutils literal notranslate"><span class="pre">esta</span> <span class="pre">configuración</span></code></a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/openvpn/server.conf</span>
port<span class="w"> </span><span class="m">1194</span>
proto<span class="w"> </span>udp
dev<span class="w"> </span>tun0

<span class="c1"># Certificados y claves.</span>
ca<span class="w"> </span>certs/ca.crt
cert<span class="w"> </span>certs/server.crt
key<span class="w"> </span>keys/server.key
dh<span class="w"> </span>keys/dh2048.pem

<span class="p">;</span>tls-verify<span class="w"> </span><span class="s2">&quot;/usr/share/openvpn/verify-cn /etc/openvpn/allowed-cns&quot;</span>

<span class="c1"># Autentificacion con usuario/password</span>
verify-client-cert<span class="w"> </span>none
username-as-common-name<span class="w"> </span>
tmp-dir<span class="w"> </span><span class="s2">&quot;/etc/openvpn/tmp/&quot;</span>
plugin<span class="w"> </span>/usr/lib/openvpn/openvpn-plugin-auth-pam.so<span class="w"> </span>/etc/pam.d/login

<span class="c1"># Configuración de la red del túnel VPN</span>
server<span class="w"> </span><span class="m">10</span>.8.0.0<span class="w"> </span><span class="m">255</span>.255.255.0
topology<span class="w"> </span>subnet
ifconfig-pool-persist<span class="w"> </span>ipp.txt

push<span class="w"> </span><span class="s2">&quot;route 192.168.255.0 255.255.255.0 vpn_gateway&quot;</span>
push<span class="w"> </span><span class="s2">&quot;dhcp-option DNS 1.1.1.1&quot;</span>
push<span class="w"> </span><span class="s2">&quot;dhcp-option DNS 1.0.0.1&quot;</span>

keepalive<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">120</span>
compress<span class="w"> </span>lz4
persist-key
persist-tun
status<span class="w"> </span>openvpn-status.log
verb<span class="w"> </span><span class="m">3</span>

cipher<span class="w"> </span>AES-128-CBC
tls-auth<span class="w"> </span>keys/ta.key<span class="w"> </span><span class="m">0</span>

user<span class="w"> </span>nobody
group<span class="w"> </span>nogroup

max-clients<span class="w"> </span><span class="m">5</span>
<span class="p">;</span>client-to-client

script-security<span class="w"> </span><span class="m">2</span>
up<span class="w"> </span><span class="s2">&quot;/etc/openvpn/bin/masquerade.sh eth0&quot;</span>
plugin<span class="w"> </span>/usr/lib/openvpn/openvpn-plugin-down-root.so<span class="w"> </span><span class="s2">&quot;/etc/openvpn/bin/masquerade.sh eth0&quot;</span>
</pre></div>
</div>
<p>Cuya justificación es la siguiente:</p>
<ul class="simple">
<li><p>Escuchamos en el puerto <em>1194/UDP</em></p></li>
<li><p>Como establecemos el túnel en capa 3, la interfaz es <em>TUN</em>. Hemos especificado
un nombre concreto (<em>tun0</em>), pero podríamos hacer indicado simplemente <em>tun</em> y
<strong class="program">openvpn</strong> se habría encargado de buscar el primer nombre <em>tunX</em>
disponible.</p></li>
<li><p>Las rutas a los certificados son coherentes con los preparativos que hicimos
bajo el epígrafe anterior.</p></li>
<li><p>Si usáramos el certificado facilitado por <em>Let’s Encrypt</em>, deberíamos
descomentar la línea que verifica con <code class="docutils literal notranslate"><span class="pre">tls-verify</span></code>.</p></li>
<li><p>Añadimos las líneas necesarias para la autenticación de clientes con clave y
contraseña. Obsérvese que para la autenticación con <em>PAM</em> usamos el módulo
<em>login</em>. Podríamos usar otro personalizado, si <a class="reference internal" href="../../../04.servidor/09.autenticacion/index.html#pam"><span class="std std-ref">entendemos cómo funciona
PAM</span></a>.</p></li>
<li><p>Establecemos que actuamos como servidor y definimos cuál es la
red (<em>10.8.0.0/24</em>)</p></li>
<li><p>Elegimos como topología <em>subnet</em> que se traduce en que se asigna a cada
interfaz <em>TUN</em> una sola dirección <abbr title="Internet Protocol">IP</abbr> y no dos como hace la topología
<em>net30</em>.</p></li>
<li><p>Hacemos que los clientes reciban siempre la misma <abbr title="Internet Protocol">IP</abbr>.</p></li>
<li><dl class="simple">
<dt>Enviamos al cliente alguna información útil para su configuración<a class="footnote-reference brackets" href="#id9" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>:</dt><dd><ul>
<li><p>Le instamos a que incluya en su tabla de encaminamiento que para llegar
a su red local debe utilizar el túnel.</p></li>
<li><p>Le instamos a que cambie la información de los servidores de nombres.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Hacemos <em>ping</em> periódicos entre cliente y servidor para mantener viva la
conexión.</p></li>
<li><p>Comprimimos la información<a class="footnote-reference brackets" href="#id10" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a></p></li>
<li><p>Establecemos un nivel de logs más bien bajo (3 cuando el rango va de 0 a 11).</p></li>
<li><p>Ciframos con el algoritmo AES-128-CBC.</p></li>
<li><p>Tras arrancar el servidor reducimos privilegios.</p></li>
<li><p>Permitimos un máximo de cinco clientes conectados y, en caso de no haberse
comentado la directiva <em>client-to-client</em>, estaría permitida la comunicación
entre los propios clientes.</p></li>
<li><p>Por último, establecemos que se ejecute un <em>script</em> tras arrancar y al parar.
En el segundo caso, la ejecución debe hacerse de esta manera debido a que
redujimos privilegios.</p></li>
</ul>
<p>Este <em>script</em> <code class="file docutils literal notranslate"><span class="pre">/etc/openvpn/bin/masquerade.sh</span></code> permite que el cliente
pueda conectarse con la red local (o salir a internet a través del túnel).
Obsérvese que, cuando el cliente intenta comunicar con un dispositivo que se
halla <em>por detrás</em> del servidor <abbr title="Virtual Private Network">VPN</abbr> los paquetes tendrán como origen su <abbr title="Internet Protocol">IP</abbr>
virtual, de manera que una máquina de la red local <em>192.168.255.0/24</em> tendrá que
devolver su respuesta a esta <abbr title="Internet Protocol">IP</abbr>. Si el servidor <abbr title="Virtual Private Network">VPN</abbr> es la puerta de enlace
de esta red, no habrá problema; pero, si no lo es, la máquina local no sabrá que
debe entregar al servidor la respuesta para que éste la encamine hacia el
cliente, por lo que la respuesta se perdera. Para evitarlo es necesario que el
servidor enmascare los paquetes a su salida y de eso es de lo que se encarga el
<em>script</em>. Admite como argumentos la lista de interfaces a cuya salida se quiere
enmascarar.</p>
<p>Puede descarse el <em>script</em> del <a class="reference download internal" download="" href="../../../_downloads/531b108e6dd8e363af27a475e69eeefe/masquerade.sh"><code class="xref download docutils literal notranslate"><span class="pre">siguiente</span> <span class="pre">enlace</span></code></a>.</p>
</section>
<section id="cliente">
<span id="srw3-client"></span><h3><span class="section-number">7.4.3.1.2.1.2. </span>Cliente<a class="headerlink" href="#cliente" title="Link to this heading">¶</a></h3>
<p>La configuración del cliente depende básicamente de si queremos que éste, además
de establecer el túnel, lo use para salir a internet. Dado que en el cliente,
podemos disponer varias configuraciones de acceso a varios servidores lo más
adecuado es incluir todos los ficheros de una conexión dentro de un mismo
subdirectorio de <code class="file docutils literal notranslate"><span class="pre">/etc/openvpn/client</span></code>. En nuestro caso:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mkdir<span class="w"> </span>/etc/openvpn/client/example
</pre></div>
</div>
<p>Dentro de él puede incluirse una configuración como <a class="reference download internal" download="" href="../../../_downloads/0ec4696a2829ee72fdeed8e86b3bedff/c-rw_3.txt"><code class="xref download docutils literal notranslate"><span class="pre">ésta</span></code></a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/openvpn/client/example/example.conf</span>
client
dev-type<span class="w"> </span>tun
dev<span class="w"> </span>tun0
topology<span class="w"> </span>subnet

&lt;connection&gt;
<span class="w">   </span>remote<span class="w"> </span>www.example.net<span class="w"> </span><span class="m">1194</span><span class="w"> </span>udp
&lt;/connection&gt;

resolv-retry<span class="w"> </span>infinite

ca<span class="w"> </span>client/example/ca.crt
remote-cert-tls<span class="w"> </span>server

nobind
persist-key
persist-tun
compress<span class="w"> </span>lz4
verb<span class="w"> </span><span class="m">3</span>

cipher<span class="w"> </span>AES-128-CBC
tls-auth<span class="w"> </span>client/example/ta.key<span class="w"> </span><span class="m">1</span>

<span class="c1"># Autenticación con usuario/contraseña</span>
auth-user-pass<span class="w"> </span>client/example/ident

<span class="c1"># Encaminamiento</span>
redirect-gateway<span class="w"> </span>autolocal
route<span class="w"> </span><span class="m">172</span>.16.0.0<span class="w"> </span><span class="m">255</span>.255.0.0<span class="w"> </span>net_gateway

script-security<span class="w"> </span><span class="m">2</span>
up<span class="w"> </span>/etc/openvpn/update-resolv-conf
down<span class="w"> </span>/etc/openvpn/update-resolv-conf
</pre></div>
</div>
<p>Muchas de las líneas ya está explicadas en la parte del servidor. Pero atiéndase
a estas novedades:</p>
<ul class="simple">
<li><p>Hemos incluido la direciva <em>dev-type</em> para especificar que es una interfaz
<em>TUN</em>. Esto ya lo sabe <strong class="program">openvpn</strong> porque el nombre de la interfaz es
<em>tun0</em>. Sin embargo, el cliente no tiene por qué ser obligatoriamente <em>linux</em>
y en otros sistemas como <em>windows</em> la interfaz tendrá un nombre más raro cuyo
tipo el <em>software</em> no sabrá adivinar. De modo que es bueno especificarlo
explícitamente.</p></li>
<li><p>La directiva <em>remote</em> especifica cuál es el servidor, puerto de conexión y
protocolo. Sólo es obligatorio que la incluyamos dentro de un nodo
<em>connection</em> cuando definimos dentro del fichero varias conexiones
alternativas. En ese caso, el cliente intentará secuencialmente establecer la
conexión según los datos que facilite el <em>remote</em> correspondiente. Un
ejemplo de esto, lo veremos al tratar el <a class="reference internal" href="04.misc.html#openvpn-restr"><span class="std std-ref">acceso a redes restringidas</span></a>.</p></li>
<li><p>Intentamos infinitamente la conexión en caso de que falle. Es el
comportamiento por defecto, así que podríamos habernos ahorrado la línea.</p></li>
<li><p>Declaramos cuál es el fichero donde almacenamos usuario y contraseña. Si
deseáramos que estos escribieran interactivamente, podríamos no declarar
ningún fichero. También podríamos escribir en el fichero sólo el nombre de
usuario y se nos requeriría la contraseña interactivamente.</p></li>
<li><p>Las restantes líneas (a partir del comentario «Encaminamiento») posibilitan
que el cliente use el túnel para salir de la red:</p>
<ul>
<li><p><em>redirect-gateway</em> es la encargada principal de ello, ya que se ocupa de
añadir dos entradas a la tabla de encaminamiento: una para que la puerta
de enlace predeterminada sea la <abbr title="Internet Protocol">IP</abbr> virtual del servidor, y otra para
que la puerta de enlace que se use para acceder a la <abbr title="Internet Protocol">IP</abbr> pública del
servidor (es decir, la que resuelve <em>www.example.net</em>) siga siendo la
puerta de enlace que hubiera antes de establecer el túnel.</p></li>
<li><p>El <em>route</em> que añadimos a continuación es sólo una muestra de cómo hacer
para seguir accediendo a una red determinada por la puerta de enlace
antigua.</p></li>
<li><p>El <em>script</em> mencionado con <em>up</em> y <em>down</em> lo proporciona el propio
<strong class="program">openvpn</strong> y permite haciendo uso de <strong class="program">resolvconf</strong>
alterar los servidores de nombres para incluir los que proporciona el
servidor <abbr title="Virtual Private Network">VPN</abbr>. Es probable que si queremos salir a internet por el túnel,
también queramos usar los servidores de nombres que el servidor <abbr title="Virtual Private Network">VPN</abbr> nos
sugiera.</p></li>
<li><p>Si no quisiéramos usar el túnel para encaminar el tráfico a internet,
podríamos prescindir de todas estas últimas líneas.</p></li>
</ul>
</li>
</ul>
<p>También es interesante notar lo que no hay en el fichero:</p>
<ul>
<li><p>No rebajamos los privilegios como hicimos en el servidor. Esto es debido a que
si lo hacemos, al acabar no tendremos permisos suficientes para volver a
alterar la tabla de rutas y en consecuencia <strong class="program">openvpn</strong> no podrá
restablecer la puerta de enlace antigua.</p></li>
<li><p>El servidor <abbr title="Virtual Private Network">VPN</abbr> con la directiva <em>push</em> puede conminar al cliente a usar
alguna configuración. Sin embargo, el cliente tiene potestad para hacerle
caso o no. Para evitar hacerles caso, puede hacerse lo siguiente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">pull-filter ignore &quot;dhcp-option DNS 1.0.&quot;</span>
</pre></div>
</div>
<p>es decir la directiva <em>pull-filter</em>, la palabra <em>ignore</em> y una cadena con el
comienzo de la directiva que queremos evitar.</p>
</li>
</ul>
<p>El subdirectorio <code class="file docutils literal notranslate"><span class="pre">/etc/openvpn/client/example/</span></code> deberá contener, además,
otros ficheros necesarios: <code class="file docutils literal notranslate"><span class="pre">ca.crt</span></code>, <code class="file docutils literal notranslate"><span class="pre">ta.key</span></code> y <code class="file docutils literal notranslate"><span class="pre">ident</span></code> o
<code class="file docutils literal notranslate"><span class="pre">cliente1.crt</span></code> y <code class="file docutils literal notranslate"><span class="pre">cliente2.key</span></code> dependiendo de cómo se realice la
autenticación del cliente.</p>
<p>Por otro lado, como <em>debian</em> espera que los ficheros de configuración se
encuentren estrictamente dentro de <code class="file docutils literal notranslate"><span class="pre">/etc/openvpn</span></code> deberemos hacer un
enlace simbólico:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span><span class="nb">cd</span><span class="w"> </span>/etc/openvpn
<span class="gp"># </span>ln<span class="w"> </span>-s<span class="w"> </span>client/example/example.conf
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Si usa versiones recientes de debian (<a class="reference external" href="https://www.debian.org/News/2019/20190706">Buster</a> en adelante) tenga
en cuenta que <strong class="program">openssl</strong> está configurado para que sólo admita <abbr title="Transport Layer Security">TLS</abbr>v1.2 o superior, ya que en <code class="file docutils literal notranslate"><span class="pre">/etc/ssl/openssl</span></code> se encuentra esto:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[system_default_sect]</span>
<span class="hll"><span class="na">MinProtocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">TLSv1.2</span>
</span><span class="na">CipherString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">DEFAULT@SECLEVEL=2</span>
</pre></div>
</div>
<p>Si el servidor <strong class="program">openvpn</strong> es antiguo, es posible que requiera la
versión 1.0, por lo que el cliente se negará a efectuar la conexión y fallará
el establecimiento del túnel. Si no hay posibilidad de actualizar el
servidor, se deberá reducir la versión mínima en el cliente:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">MinProtocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">TLSv1.2</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="capa-de-enlace">
<h2><span class="section-number">7.4.3.1.2.2. </span>Capa de enlace<a class="headerlink" href="#capa-de-enlace" title="Link to this heading">¶</a></h2>
<p>Implementar el túnel en la capa de enlace posibilita que el <em>guerrero de la
carretera</em> pertenezca a la propia red local y no a una red diferenciada como
ocurría en el caso anterior. A su vez tiene una desventaja: el tráfico
aumentará, por lo que la conexión será menos eficiente.</p>
<p>En este caso, se usan interfaces <em>TAP</em> y un esquema adecuado puede ser el
siguiente:</p>
<img alt="../../../_images/br_c2.png" src="../../../_images/br_c2.png" />
<p>O sea, en el lado del servidor se crea una interfaz puente<a class="footnote-reference brackets" href="#id11" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> que contenga
la interfaz real y la interfaz <em>TAP</em> creada por <strong class="program">openvpn</strong>: de esta
manera la interfaz <em>TAP</em> del cliente pertenece a la red local. Por su parte la
interfaz real del cliente pertenecerá a la red remota.</p>
<p>Hay, además, otro aspecto a considerar impropio del caso anterior: cómo obtiene
su configuración de red el cliente que, recordemos, deberá ser una configuración
que le haga pertenecer a la red local. Aparte de asignarle una <abbr title="Internet Protocol">IP</abbr> fija (existe
una opción llamada <em>ifconfig</em> para ello), tenemos dos posibilidades:</p>
<ul class="simple">
<li><p>Que sea el propio servidor <abbr title="Virtual Private Network">VPN</abbr> el que sirva las direcciones.</p></li>
<li><p>Que el servidor <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> de la red local facilite estas direcciones, lo cual
será más adecuado si tal servidor existe.</p></li>
</ul>
<p>La diferencia entre una y otra estrategia, además de quién facilita la
dirección, es que el servidor <abbr title="Virtual Private Network">VPN</abbr> se limita a proporcionar <abbr title="Internet Protocol">IP</abbr> y máscara y el
cliente a configurarla; mientras que en el segundo caso, el cliente debe
ejecutar un cliente de <em>dhcp</em> (por ejemplo, <strong class="command">dhclient</strong>) que recibirá
del servidor mucha más información (servidores de nombres, puerta de enlace,
etc.).</p>
<section id="srw2-server">
<span id="id4"></span><h3><span class="section-number">7.4.3.1.2.2.1. </span>Servidor<a class="headerlink" href="#srw2-server" title="Link to this heading">¶</a></h3>
<p>SI echamos un ojo al esquema dibujado, veremos que el servidor requiere una
interfaz puente que contenga la interfaz real y la interfaz <em>TAP</em> creada por
<strong class="program">openvpn</strong>. Podríamos, en vista de ello, preparar el servidor para que
exista esta interfaz puente y ya esté dentro de ella la interfaz local<a class="footnote-reference brackets" href="#id12" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a>.
pero, en vez de eso, dejaremos la configuración de red sin tocar<a class="footnote-reference brackets" href="#id13" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a> y
esperaremos a que el <em>script</em> que se ejecuta al crear el túnel se encargue del
trabajo de constituir el puente necesario. Para ello, planteamos <a class="reference download internal" download="" href="../../../_downloads/114faded5ea08d18360f7eba884eb385/s-rw_2.txt"><code class="xref download docutils literal notranslate"><span class="pre">esta</span>
<span class="pre">posible</span> <span class="pre">configuración</span></code></a>, en la que dejamos que el servidor
<abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> que haya en la red local sea el que facilita también a los clientes su
configuración:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/openvpn/server.conf</span>
port<span class="w"> </span><span class="m">1194</span>
proto<span class="w"> </span>udp
dev<span class="w"> </span>tap0
dev-type<span class="w"> </span>tap

<span class="c1"># Certificados y claves</span>
ca<span class="w"> </span>certs/ca.crt
cert<span class="w"> </span>certs/server.crt
key<span class="w"> </span>keys/server.key
dh<span class="w"> </span>keys/dh2048.pem

<span class="p">;</span>tls-verify<span class="w"> </span><span class="s2">&quot;/usr/share/openvpn/verify-cn /etc/openvpn/allowed-cns&quot;</span>

<span class="c1"># Autentificacion con usuario/password</span>
verify-client-cert<span class="w"> </span>none
username-as-common-name<span class="w"> </span>
tmp-dir<span class="w"> </span><span class="s2">&quot;/etc/openvpn/tmp/&quot;</span>
plugin<span class="w"> </span>/usr/lib/openvpn/openvpn-plugin-auth-pam.so<span class="w"> </span>/etc/pam.d/login

<span class="c1"># Configuración de la red del túnel VPN</span>
server-bridge

keepalive<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">120</span>
compress<span class="w"> </span>lz4
persist-key
persist-tun
status<span class="w"> </span>openvpn-status.log
verb<span class="w"> </span><span class="m">3</span>

cipher<span class="w"> </span>AES-128-CBC
tls-auth<span class="w"> </span>keys/ta.key<span class="w"> </span><span class="m">0</span>

user<span class="w"> </span>nobody
group<span class="w"> </span>nogroup

max-clients<span class="w"> </span><span class="m">5</span>

script-security<span class="w"> </span><span class="m">2</span>
up<span class="w"> </span><span class="s2">&quot;/etc/openvpn/bin/bridge.sh eth0 vpn&quot;</span>
plugin<span class="w"> </span>/usr/lib/openvpn/openvpn-plugin-down-root.so<span class="w"> </span><span class="s2">&quot;/etc/openvpn/bin/bridge.sh eth0 vpn&quot;</span>
</pre></div>
</div>
<p>De esta configuración, semejante a la que se realizó para el túnel en capa 3.
hay dos aspectos que deben señalarse:</p>
<ul>
<li><p>La directiva <code class="code docutils literal notranslate"><span class="pre">server-bridge</span></code> provoca que el servidor <abbr title="Virtual Private Network">VPN</abbr> no
conceda direcciones a los clientes, sino que deje que sea el servidor <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>
de la red local el que lo haga. Por supuesto, si no existiera tal servidor
<abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>, podríamos hacer que <strong class="program">openvpn</strong> se encargara de esa tarea:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">server-bridge 192.168.255.0 255.255.255.0 192.168.255.250 192.168.255.254</span>
<span class="go">ifconfig-pool-persistent ipp.txt</span>
</pre></div>
</div>
</li>
<li><p>De la constituición del túnel y toda la configuración que ello supone se
encarga el <a class="reference download internal" download="" href="../../../_downloads/87ded814012304d092b2eae5bf198248/bridge.sh"><code class="xref download docutils literal notranslate"><span class="pre">script</span> <span class="pre">bridge.sh</span></code></a>, que requiere
que le pasemos la interfaz física que se incluirá en el puente y el nombre que
le daremos a dicho puente.</p></li>
</ul>
</section>
<section id="srw2-client">
<span id="id7"></span><h3><span class="section-number">7.4.3.1.2.2.2. </span>Cliente<a class="headerlink" href="#srw2-client" title="Link to this heading">¶</a></h3>
<p>Suponiendo que pretendamos que el cliente use el túnel para conectarse a
internet <a class="reference download internal" download="" href="../../../_downloads/473cca7c96861bb8e2c594c0d8ab6786/c-rw_2.txt"><code class="xref download docutils literal notranslate"><span class="pre">una</span> <span class="pre">configuración</span> <span class="pre">posible</span></code></a> es la
siguiente:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/openvpn/client/example/example.conf</span>
client
dev-type<span class="w"> </span>tap
dev<span class="w"> </span>tap0

&lt;connection&gt;
<span class="w">   </span>remote<span class="w"> </span>www.example.net<span class="w"> </span><span class="m">1194</span><span class="w"> </span>udp
&lt;/connection&gt;

resolv-retry<span class="w"> </span>infinite

ca<span class="w"> </span>client/example/ca.crt
remote-cert-tls<span class="w"> </span>server

nobind
persist-key
persist-tun

compress<span class="w"> </span>lz4
verb<span class="w"> </span><span class="m">3</span>

cipher<span class="w"> </span>AES-128-CBC
tls-auth<span class="w"> </span>client/example/ta.key<span class="w"> </span><span class="m">1</span>
auth-user-pass<span class="w"> </span>client/example/ident

<span class="c1"># Encaminamiento</span>
route-delay<span class="w"> </span><span class="m">30</span>
route-gateway<span class="w"> </span>dhcp
redirect-gateway<span class="w"> </span>autolocal

<span class="c1"># Configuración de la interfaz</span>
script-security<span class="w"> </span><span class="m">2</span>
up<span class="w"> </span>/etc/openvpn/bin/dhcp.sh
down<span class="w"> </span>/etc/openvpn/bin/dhcp.sh

<span class="c1"># Esto confiere una IP fija al cliente y</span>
<span class="c1"># podría sustituir a las tres líneas anteriores</span>
<span class="c1">#ifconfig 192.168.255.3 255.255.255.0</span>
<span class="c1">#route-gateway 192.168.255.1</span>
</pre></div>
</div>
<p>Antes de comentar la configuración, es indispensable tener presente que, cuando
<strong class="program">openvpn</strong> actúa como <em>dhcp relay</em> del servidor <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> local, manipula
los paquetes de concesión para eliminar de ellos la puerta de enlace (la opción
<strong>3</strong> de <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>), a fin de que el cliente <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> no modificaque la tabla de
encaminamiento. Esto es así, porque <strong class="program">openvpn</strong> está pensado para que
las modificaciones al encaminamiento se definan en el propio fichero de
configuración tal como hacemos nosotros:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">route-delay 30</span>
<span class="go">route-gateway dhcp</span>
<span class="go">redirect-gateway autolocal</span>
</pre></div>
</div>
<p>La segunda directiva define como puerta de enlace predeterminada la que haya
definido el servidor <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> y que se extirpó del paquete de concesión. La
tercera actúa exactamente igual que como vimos en el caso anterior. La primera
pospone la escritura de las entradas <strong>30</strong> segundos, ya veremos por qué.</p>
<p>Además, es preciso ejecutar un cliente que pida la concesión al levantar la
interfaz y que pida la revocación al bajarla, por lo que se ha añadido la
ejecución del script <strong class="command">dhcp.sh</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$script_type</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;up&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">   </span>dhclient<span class="w"> </span>-nw<span class="w"> </span><span class="nv">$1</span>
<span class="k">else</span>
<span class="w">   </span>dhclient<span class="w"> </span>-r<span class="w"> </span><span class="nv">$1</span>
<span class="k">fi</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Esta configuración tiene un pequeño problema en sistemas <em>UNIX</em>:
como no es posible utilizar el túnel hasta que no se ha completado su
establecimiento (y esto incluye la finalización de <strong class="command">dhcp.sh</strong>)<a class="footnote-reference brackets" href="#id14" id="id8" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a>,
hay que ejecutar <strong class="command">dhclient</strong> directamente en segundo plano (con la
opción <em>nw</em>) a fin de que el <em>script</em> acabe, se establezca por completo el
túnel, y <strong class="command">dhclient</strong> siga en segundo plano a su aire buscando al
servidor <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>. Como por otro lado hemos fijado que la puerta de enlace es
la que nos facilite este servidor, la modificación de la tabla de
encaminamiento debe realizarse después de que <strong class="program">dhclient</strong> haya
completado su trabajo. Para ello diferimos <strong>30</strong> segundos la modificación
del encaminamiento, aunque este tiempo podremos acortarlo o deberemos
alargarlo segun el tiempo que veamos que tarda <strong class="program">dhclient</strong> en
completar su tarea.</p>
</div>
<p class="rubric">Notas al pie</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id9" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>Ya veremos que en principio el cliente acepta la información recibida,
pero también hacer oídos sordos si así lo indicamos.</p>
</aside>
<aside class="footnote brackets" id="id10" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p>La opción <em>compress</em> existe a partir de la versión <em>2.4</em>. En versiones
anteriores la única compresión posibles es con el algoritmo <em>lzo</em>. Téngalo en
cuenta si prevé que haya conexiones con clientes antiguos.</p>
</aside>
<aside class="footnote brackets" id="id11" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">3</a><span class="fn-bracket">]</span></span>
<p>Como se hace en linux, esta interfaz puente (<em>br0</em>) será a la que se
asigne <abbr title="Internet Protocol">IP</abbr>.</p>
</aside>
<aside class="footnote brackets" id="id12" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">4</a><span class="fn-bracket">]</span></span>
<p>Por ejemplo, incluyendo en <code class="file docutils literal notranslate"><span class="pre">/etc/network/interfaces</span></code> esta
configuración:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">auto br0</span>
<span class="go">iface br0 inet static</span>
<span class="go">   address 192.168.255.2/24</span>
<span class="go">   gateway 192.168.255.1</span>
<span class="go">   bridge_ports eth0</span>
<span class="go">   openvpn server</span>

<span class="go">allow-hotplug eth0</span>
<span class="go">iface eth0 inet manual</span>
</pre></div>
</div>
<p>o bien usando esta misma configuración, pero eliminando la línea
<code class="code docutils literal notranslate"><span class="pre">openvpn</span> <span class="pre">server</span></code> y tocando convenientemente
<code class="file docutils literal notranslate"><span class="pre">/etc/default/openvpn</span></code>.</p>
</aside>
<aside class="footnote brackets" id="id13" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">5</a><span class="fn-bracket">]</span></span>
<p>O sea que la configuración será algo
así:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">allow-hotplug eth0</span>
<span class="go">iface eth0 inet static</span>
<span class="go">   address 192.168.255.2/24</span>
<span class="go">   gateway 192.168.255.1</span>
<span class="go">   openvpn server</span>
</pre></div>
</div>
</aside>
<aside class="footnote brackets" id="id14" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id8">6</a><span class="fn-bracket">]</span></span>
<p>Véase <a class="reference external" href="https://forums.openvpn.net/viewtopic.php?t=20040">esta entrada en el foro de openvpn</a>, para más información.</p>
</aside>
</aside>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../../index.html">Tabla de contenido</a></h3>
    <ul>
<li><a class="reference internal" href="#">7.4.3.1.2. Conexión sede-equipo móvil</a><ul>
<li><a class="reference internal" href="#capa-de-red">7.4.3.1.2.1. Capa de red</a><ul>
<li><a class="reference internal" href="#servidor">7.4.3.1.2.1.1. Servidor</a></li>
<li><a class="reference internal" href="#cliente">7.4.3.1.2.1.2. Cliente</a></li>
</ul>
</li>
<li><a class="reference internal" href="#capa-de-enlace">7.4.3.1.2.2. Capa de enlace</a><ul>
<li><a class="reference internal" href="#srw2-server">7.4.3.1.2.2.1. Servidor</a></li>
<li><a class="reference internal" href="#srw2-client">7.4.3.1.2.2.2. Cliente</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Tema anterior</h4>
    <p class="topless"><a href="01.previo.html"
                          title="capítulo anterior"><span class="section-number">7.4.3.1.1. </span>Preparativos</a></p>
  </div>
  <div>
    <h4>Próximo tema</h4>
    <p class="topless"><a href="03.ss.html"
                          title="próximo capítulo"><span class="section-number">7.4.3.1.3. </span>Conexión sede-sede</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/07.serre/04.vpn/01.openvpn/02.rw.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Ir a" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="03.ss.html" title="7.4.3.1.3. Conexión sede-sede"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="01.previo.html" title="7.4.3.1.1. Preparativos"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" ><span class="section-number">7. </span>Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" ><span class="section-number">7.4. </span>Redes VPN</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="index.html" ><span class="section-number">7.4.3.1. </span>OpenVPN</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7.4.3.1.2. </span>Conexión sede-equipo móvil</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright CC BY 4.0, 2016-2024, José Miguel Sánchez Alés.
      Creado usando <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>