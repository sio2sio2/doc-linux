


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="es">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>7.2.2.2.4. Control de accesos &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Índice" href="../../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../../search.html" />
    <link rel="next" title="7.2.2.2.5. Reescritura de direcciones" href="04.rewrite.html" />
    <link rel="prev" title="7.2.2.2.3. Location" href="02.location.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="04.rewrite.html" title="7.2.2.2.5. Reescritura de direcciones"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="02.location.html" title="7.2.2.2.3. Location"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >7. Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" >7.2. Web</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" >7.2.2. nginx</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="index.html" accesskey="U">7.2.2.2. Configuración</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="control-de-accesos">
<h1>7.2.2.2.4. Control de accesos<a class="headerlink" href="#control-de-accesos" title="Enlazar permanentemente con este título">¶</a></h1>
<p>Los servidor <em>web</em> permiten la restricción del acceso a los recursos del
servidor por dos vías:</p>
<div class="section" id="segun-origen-de-la-peticion">
<h2>7.2.2.2.4.1. Según origen de la petición<a class="headerlink" href="#segun-origen-de-la-peticion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Para ello, en principio, se analiza cuál es la dirección de origen de la
conexión y se restringe o permite el acceso mediante las directivas <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_access_module.html#allow">allow</a>, <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_access_module.html#deny">deny</a> e
<a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#internal">internal</a>.</p>
<p id="nginx-internal">La última de ellas, <code class="docutils literal notranslate"><span class="pre">internal</span></code>, impide el acceso al recurso si la petición no es interna,
esto es, generada por el propio servidor, como por ejemplo cuando se devuelve
una página de error:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">error_page</span>  <span class="mi">403</span>  <span class="s">/403.html</span>

<span class="s">location</span> <span class="p">=</span> <span class="s">/403.html</span> <span class="p">{</span>
   <span class="kn">internal</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>De este modo, la página sólo será enviada al servidor cuando se intente acceder
a un recurso prohibido. Si el cliente intenta obtenerla directamente con
<em>http://www.example.net/403.html</em> obtendrá un error <strong>404</strong>.</p>
<p id="nginx-deny"><span id="nginx-allow"></span><code class="docutils literal notranslate"><span class="pre">allow</span></code> y <code class="docutils literal notranslate"><span class="pre">deny</span></code> sirven respectivamente para permitir o denegar el acceso y
se evalúan en el orden en que aparecen. Por ejemplo:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">location</span> <span class="s">/docs/</span> <span class="p">{</span>
   <span class="kn">deny</span>  <span class="mi">192</span><span class="s">.168.255.10</span><span class="p">;</span>
   <span class="kn">allow</span> <span class="mi">192</span><span class="s">.168.255.0/24</span><span class="p">;</span>
   <span class="kn">deny</span> <span class="s">all</span><span class="p">;</span>
   <span class="kn">autoindex</span> <span class="no">on</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>niega el acceso de los recursos bajo tal localización a la máquina
<em>192.168.255.10</em>, se lo permite al resto de máquinas de esa red y, por último,
se lo niega al resto.</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Cuando las reglas son largas y complicadas, es mejor recurrir al
módulo <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_geo_module.html">ngx_http_geo_module</a></p>
</div>
<p id="nginx-clientip">El problema de esta restricción es que la presencia de <em>proxies</em> intermedios
(que no actúen de manera transparente) altera la <em>ip</em> de origen de la conexión,
ya que el servidor recibirá una conexión cuyo origen será el <em>proxy</em> más cercano
a él. Un caso extremo es aquel en que disponemos un <em>proxy</em> en la propia máquina
donde se encuentra el servidor <em>web</em>. En este caso, el origen de todas las
conexiones entrantes será la propia máquina (<em>127.0.0.1</em>) con lo que en
principio este sistema de restricción es absolutamente inútil.</p>
<p>Para soslayar este inconveniente los <em>proxies</em> pueden ir poblando la cabecera
<a class="reference internal" href="../../01.desc/03.cabecera.html#xforwardedfor"><span class="std std-ref">X-Forwarded-For</span></a> de manera que el servidor pueda, así,
sustituir la <em>ip</em> original de la conexión. <strong class="program">nginx</strong> puede recalcular
la variable <code class="docutils literal notranslate"><span class="pre">$remote_addr</span></code> a partir de la información del campo anterior, si se
crea un fichero de configuración semejante a éste que aprovecha el módulo
<a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html">ngx_http_realip_module</a>:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/nginx/conf.d/realip.conf</span>
<span class="k">set_real_ip_from</span> <span class="mi">127</span><span class="s">.0.0.1</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">10</span><span class="s">.0.0.0/8</span><span class="p">;</span>
<span class="k">real_ip_recursive</span> <span class="no">on</span><span class="p">;</span>
<span class="k">real_ip_header</span> <span class="s">X-Forwarded-For</span><span class="p">;</span>
</pre></div>
</div>
<p>La directiva <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html#real_ip_header">real_ip_header</a>
permite indicar cuál es el nombre del campo a analizar, <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html#set_real_ip_from">set_real_ip_from</a>
las redes y máquinas en que consideramos que hay <em>proxies</em> que alteran la <em>ip</em>
original y que queremos ignorar; y <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html#real_ip_recursive">real_ip_recursive</a>
provoca a <em>off</em> que consideremos la <em>ip</em> del cliente la última contenida en
<code class="docutils literal notranslate"><span class="pre">X-Forwarded-For</span></code> (siempre que la <code class="docutils literal notranslate"><span class="pre">$remote_addr</span></code> coincida con alguna de
las referidas en <code class="docutils literal notranslate"><span class="pre">set_real_ip_from</span></code>); y a <em>on</em>, que la <em>ip</em> del cliente sea
la última de <code class="docutils literal notranslate"><span class="pre">X-Forwarded-For</span></code> que tampoco coincida con las referidas en
<code class="docutils literal notranslate"><span class="pre">set_real_ip_from</span></code>.</p>
<p>Para ilustrarlo supongamos este esquema:</p>
<img alt="../../../../_images/proxies.png" src="../../../../_images/proxies.png" />
<p>que genera la siguiente cabecera <code class="docutils literal notranslate"><span class="pre">X-Forwarded-For</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>X-Forwarded-For: 80.35.60.114 123.12.21.34 10.35.2.3
</pre></div>
</div>
<p>y un <code class="docutils literal notranslate"><span class="pre">$remote_address</span></code> original que vale <em>127.0.0.1</em>, ya que el <em>proxy</em> que
recibe la comunicación en nuestro servidor (<strong class="program">haproxy</strong>) se comunica con
<strong class="program">nginx</strong> a través de la interfaz de <em>loopback</em>.  En este caso, y con la
configuración anterior en <code class="file docutils literal notranslate"><span class="pre">conf.d/realip.conf</span></code>:</p>
<ul class="simple">
<li>Si <code class="docutils literal notranslate"><span class="pre">real_ip_recursive</span></code> está deshabilitado, <code class="docutils literal notranslate"><span class="pre">$remote_address</span></code> acabará
valiendo <em>10.35.2.3</em>, o sea, la última <em>ip</em> de <code class="docutils literal notranslate"><span class="pre">X-Forwarded-For</span></code>.</li>
<li>En caso contrario, <code class="docutils literal notranslate"><span class="pre">$remote_address</span></code> valdrá <em>123.12.21.34</em> ya que éste es el
último valor de <code class="docutils literal notranslate"><span class="pre">X-Forwarded-For</span></code> que no está incluido en las directivas
<code class="docutils literal notranslate"><span class="pre">set_real_ip_from</span></code>.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">La existencia de proxies intermedios puede alterar también el
protocolo original como en el caso de que <a class="reference internal" href="../../../../04.servidor/10.ssh/04.adicional.html#haproxy"><span class="std std-ref">interpongamos haproxy para
tunelizar por el puerto 443 también el tráfico SSH</span></a>. Más adelante
veremos cómo lidiar con este problema.</p>
</div>
</div>
<div class="section" id="autenticacion">
<span id="nginx-auth"></span><h2>7.2.2.2.4.2. Autenticación<a class="headerlink" href="#autenticacion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>La autenticación del cliente puede ser realizada de distintos modos:</p>
<ul class="simple">
<li>Mediante <em>usuario/contraseña</em>, que será la que tratemos aquí.</li>
<li>Como <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_auth_request_module.html">consecuencia de un subpetición</a>.</li>
<li>Mediante <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_auth_jwt_module.html">JWT</a>.</li>
</ul>
<p>La regla general es que el usuario logra acceso cuando satisface todas las
condiciones de acceso (esto incluye la restricción por origen), pero puede
modificarse este comportamiento a través de la directiva <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#satisfy">satisfy</a>.</p>
<p>Es posible utilizar <em>PAM</em> para la autenticación gracias al módulo
<a class="reference external" href="https://github.com/sto/ngx_http_auth_pam_module">ngx_http_auth_pam</a><a class="footnote-reference" href="#id2" id="id1">[1]</a>,
pero aquí trataremos la autenticación básica usando un fichero de contraseñas.
Para proteger con este mecanismo un recurso podemos hacer lo siguiente:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">location</span> <span class="s">/privado/</span> <span class="p">{</span>

   <span class="kn">satisfy</span> <span class="s">any</span><span class="p">;</span>

   <span class="c1"># El acceso interno es libre</span>
   <span class="kn">allow</span> <span class="mi">192</span><span class="s">.168.0.0/16</span><span class="p">;</span>
   <span class="kn">allow</span> <span class="mi">172</span><span class="s">.16.0.0/12</span><span class="p">;</span>
   <span class="kn">deny</span> <span class="s">all</span><span class="p">;</span>

   <span class="c1"># Como el acceso interno es libre debemos impedir el cacheo del contenido.</span>
   <span class="kn">expires</span> <span class="s">-1s</span><span class="p">;</span>  <span class="c1"># Valor negativo crea la cabecera Cache-Control: no-cache</span>

   <span class="c1"># Si se accede desde internet, es necesaria contraseña</span>
   <span class="kn">auth_basic</span>             <span class="s">&quot;Zona</span> <span class="s">privada&quot;</span><span class="p">;</span>
   <span class="kn">auth_basic_user_file</span>   <span class="s">htpasswd</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last"><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_auth_basic_module.html#auth_basic">auth_basic</a>
puede contener cualquier cadena y si vale <em>off</em>, se deshabilita la
autenticación.</p>
</div>
<p>En el fichero de contraseñas cada línea contiene un nombre de usuario y una
contraseña ofuscada:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> <span class="nb">echo</span> privilegiado:<span class="k">$(</span>openssl passwd -apr1 <span class="s2">&quot;contraseña&quot;</span><span class="k">)</span> &gt;&gt; /etc/nginx/htpasswd
<span class="gp">#</span> chmod <span class="m">600</span> /etc/nginx/htpasswd
<span class="gp">#</span> chown www-data /etc/nginx/htpasswd
</pre></div>
</div>
<p class="rubric">Notas al pie</p>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Pero usar <em>pam_unix.so</em> exige permitir la lectura de <code class="file docutils literal notranslate"><span class="pre">/etc/shadow</span></code>
al usuario <em>www-data</em>, ya que es este el que ejecuta el módulo. Tiene más
interés usar este módulo cuando se tiene un servidor <abbr title="Lightweight Directory Access Protocol">LDAP</abbr>, por ejemplo.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">7.2.2.2.4. Control de accesos</a><ul>
<li><a class="reference internal" href="#segun-origen-de-la-peticion">7.2.2.2.4.1. Según origen de la petición</a></li>
<li><a class="reference internal" href="#autenticacion">7.2.2.2.4.2. Autenticación</a></li>
</ul>
</li>
</ul>

  <h4>Tema anterior</h4>
  <p class="topless"><a href="02.location.html"
                        title="capítulo anterior">7.2.2.2.3. <em>Location</em></a></p>
  <h4>Próximo tema</h4>
  <p class="topless"><a href="04.rewrite.html"
                        title="próximo capítulo">7.2.2.2.5. Reescritura de direcciones</a></p>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/07.serre/02.web/02.nginx/02.avanz/03.acceso.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Ir a" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="04.rewrite.html" title="7.2.2.2.5. Reescritura de direcciones"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="02.location.html" title="7.2.2.2.3. Location"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >7. Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" >7.2. Web</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" >7.2.2. nginx</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="index.html" >7.2.2.2. Configuración</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2020, José Miguel Sánchez Alés.
      Creado con <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>