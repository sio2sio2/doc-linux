


<!DOCTYPE html>

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>7.2.2.2.7. Contenido dinámico &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/classic.css" />
    <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
    
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/translations.js"></script>
    
    <link rel="index" title="Índice" href="../../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../../search.html" />
    <link rel="next" title="7.2.2.2.8. Conexión segura" href="07.https.html" />
    <link rel="prev" title="7.2.2.2.6. Sentencia condicional" href="05.if.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="07.https.html" title="7.2.2.2.8. Conexión segura"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="05.if.html" title="7.2.2.2.6. Sentencia condicional"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">7. </span>Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">7.2. </span>Web</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" ><span class="section-number">7.2.2. </span>nginx</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="index.html" accesskey="U"><span class="section-number">7.2.2.2. </span>Configuración</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7.2.2.2.7. </span>Contenido dinámico</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="contenido-dinamico">
<h1><span class="section-number">7.2.2.2.7. </span>Contenido dinámico<a class="headerlink" href="#contenido-dinamico" title="Enlace permanente a este encabezado">¶</a></h1>
<p><strong class="program">nginx</strong> no ejecuta directamente código para generar el contenido
dinámico, sino que actúa de <em>proxy</em> hacia el intérprete adecuado. Esta es una
gran diferencia respecto a <strong class="program">apache</strong> que suele tener módulos para
la ejecución de los distintos lenguajes.</p>
<section id="php">
<span id="nginx-php"></span><h2><span class="section-number">7.2.2.2.7.1. </span>PHP<a class="headerlink" href="#php" title="Enlace permanente a este encabezado">¶</a></h2>
<section id="instalacion">
<h3><span class="section-number">7.2.2.2.7.1.1. </span>Instalación<a class="headerlink" href="#instalacion" title="Enlace permanente a este encabezado">¶</a></h3>
<p>Para dar soporte a aplicaciones escritas en <abbr title="PHP Hypertext Preprocessor">PHP</abbr> y que hagan uso de bases de
datos <em>MySQL</em><a class="footnote-reference brackets" href="#id4" id="id1">1</a> combinación muy frecuente es necesario como mínimo lo
siguiente<a class="footnote-reference brackets" href="#id5" id="id2">2</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt-get<span class="w"> </span>install<span class="w"> </span>php-<span class="o">{</span>fpm,mysql<span class="o">}</span><span class="w"> </span>mariadb-<span class="o">{</span>server,client<span class="o">}</span>
</pre></div>
</div>
<p>Esta es una instalación muy mínima y cualquier aplicación <abbr title="PHP Hypertext Preprocessor">PHP</abbr> medianamente
seria requerirá algún paquete más. Como <em>alternativa</em>, podemos instalar lo siguiente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt-get<span class="w"> </span>install<span class="w"> </span>php<span class="o">{</span>,-mysql<span class="o">}</span><span class="w"> </span>libapache2-mod-php7.3-<span class="w"> </span>mariadb-<span class="o">{</span>server,client<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>En este caso, <em>php</em> instala librerías muy comunes y que muy
probablemente las necesite alguna aplicación que instalemos después. Sin
embargo, <em>php</em> prefiere como dependencia <strong class="program">apache</strong>, así que evitamos
su instalación.</p>
<p>Aunque no usemos este segundo método de instalación, sino el primero, el
truco de evitar explícitamente la dependencia de <strong class="program">apache</strong> es válido
cuando, al instalar una aplicación web desde repositorios (p.e.
<a class="reference internal" href="../../../03.mail/04-misc/04-webmail/index.html#roundcube"><span class="std std-ref">roundcube</span></a>), <em>debian</em> nos pretenda instalar también este
servidor.</p>
</div>
</section>
<section id="configuracion-del-sitio">
<h3><span class="section-number">7.2.2.2.7.1.2. </span>Configuración del sitio<a class="headerlink" href="#configuracion-del-sitio" title="Enlace permanente a este encabezado">¶</a></h3>
<p>Resueltas las dependencias, hay que configurar <strong class="program">nginx</strong>. Lo más sencillo
es crear el siguiente fichero:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="c1"># cat /etc/nginx/conf.d/php.conf</span>
<span class="k">upstream</span><span class="w"> </span><span class="s">php</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">server</span><span class="w"> </span><span class="s">unix:/var/run/php/php7.3-fpm.sock</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>En <em>buster</em> la versión de <abbr title="PHP Hypertext Preprocessor">PHP</abbr> es la versión <em>7.3</em>; mientras que en
<em>stretch</em>, la <em>7.0</em>. Este hecho debe tenerse en cuenta a la hora de nombrar
ciertos ficheros (como el anterior) o instalar paquetes.</p>
</div>
<p>y habilitar el uso del intérprete para los <em>scripts</em> de <abbr title="PHP Hypertext Preprocessor">PHP</abbr>, por ejemplo,
así:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>

<span class="w">   </span><span class="kn">server_name</span><span class="w"> </span><span class="s">_</span><span class="p">;</span>

<span class="w">   </span><span class="kn">root</span><span class="w"> </span><span class="s">/srv/www</span><span class="p">;</span>
<span class="w">   </span><span class="kn">try_files</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nv">$uri/</span><span class="w"> </span><span class="p">=</span><span class="mi">404</span><span class="p">;</span>
<span class="hll"><span class="w">   </span><span class="kn">index</span><span class="w">  </span><span class="s">index.php</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll"><span class="w">   </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">\.php$</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">      </span><span class="kn">include</span><span class="w"> </span><span class="s">snippets/fastcgi-php.conf</span><span class="p">;</span>
</span><span class="hll"><span class="w">      </span><span class="kn">fastcgi_pass</span><span class="w"> </span><span class="s">php</span><span class="p">;</span>
</span><span class="hll"><span class="w">   </span><span class="p">}</span>
</span><span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Tenga en cuenta que esto ejecuta como <abbr title="PHP Hypertext Preprocessor">PHP</abbr> cualquier fichero cuyo
extensión sea <em>.php</em>. Si la aplicación permite subir ficheros, esto provocará
un agujero de seguridad, ya que podría permitir subir un <em>script</em> al servidor
y ejecutarlo luego. Sería conveniente excluir el directorio de subidas para
evitarlo. Suponiendo que este se llame <code class="file docutils literal notranslate"><span class="pre">/wp-content/uploads/</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">location ~ ^((?!/wp-content/uploads/).)*\.php$ {</span>
<span class="go">   include snippets/fastcgi-php.conf;</span>
<span class="go">   fastcgi_pass php;</span>
<span class="go">}</span>
</pre></div>
</div>
<p>o bien dejarlo como estaba en un principio y añadir:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">location ^~ /wp-content/uploads/ {</span>
<span class="go">}</span>
</pre></div>
</div>
<p>que evitará que aplicar el bloque de la localización anterior cuando la ruta
esté dentro de <code class="file docutils literal notranslate"><span class="pre">/wp-content/uploads</span></code>.</p>
</div>
</section>
<section id="comprobacion">
<h3><span class="section-number">7.2.2.2.7.1.3. </span>Comprobación<a class="headerlink" href="#comprobacion" title="Enlace permanente a este encabezado">¶</a></h3>
<p>La prueba más sencilla para comprobar si se interpreta <abbr title="PHP Hypertext Preprocessor">PHP</abbr> es crear un fichero
<code class="file docutils literal notranslate"><span class="pre">index.php</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;&lt;?php phpinfo(); ?&gt;&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/srv/www/index.php
</pre></div>
</div>
<p>que devuelve la actual configuración del intérprete <abbr title="PHP Hypertext Preprocessor">PHP</abbr>. Si, además, queremos
probar el acceso a la base de datos podemos <a class="reference download internal" download="" href="../../../../_downloads/a927df8339b9de312a461d01d08b06ce/prueba-php.tar.gz"><code class="xref download docutils literal notranslate"><span class="pre">descargar</span> <span class="pre">esta</span> <span class="pre">prueba</span> <span class="pre">muy</span>
<span class="pre">simple</span></code></a> con un <em>script</em> que crea una tabla <abbr title="HyperText Markup Language">HTML</abbr> a
partir de los datos almacenados en una base de datos. Basta con colocar el
<em>script</em> en una localización en que se ejecute y volcar el guión <abbr title="Structured Query Language">SQL</abbr> en la
base de datos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mysql<span class="w"> </span>&lt;<span class="w"> </span>guion.sql
</pre></div>
</div>
</section>
<section id="optimizacion-por-cacheo">
<span id="nginx-fastcgi-cache"></span><h3><span class="section-number">7.2.2.2.7.1.4. </span>Optimización por cacheo<a class="headerlink" href="#optimizacion-por-cacheo" title="Enlace permanente a este encabezado">¶</a></h3>
<p>El servicio de páginas dinámicas es muy costoso en la medida en que su petición
exige la generación al vuelo del código <abbr title="HyperText Markup Language">HTML</abbr>. Por ello, una muy buena
optimización es que el servidor cachee la página generada, de suerte que
posteriores peticiones no generen la página, sino que entreguen la página ya
generada. Es obvio que si el contenido es dinámico se debe a que cambia y
que, en consecuencia, cachear es muy peligroso en la medida en que, si la
configuración no es la adecuada, estaremos remitiendo al cliente contenido
obsoleto.</p>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Hay que estudiar muy concienzudamente cómo, cuándo y durante cuánto
tiempo se cacheará a fin de que los clientes no reciban contenido cacheado
obsoleto.</p>
</div>
<p>Antes de empezar, no obstante, es muy útil crear una página dinámica por la que
conozcamos de un vistazo si la página, de petición a petición, cambia o no:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>
   <span class="nb">header</span><span class="p">(</span><span class="s1">&#39;Content-type: text/plain; charset=utf-8&#39;</span><span class="p">);</span>
   <span class="k">echo</span> <span class="s1">&#39;Página generada en el momento &#39;</span><span class="o">.</span><span class="nb">time</span><span class="p">();</span>
<span class="cp">?&gt;</span>
</pre></div>
</div>
<p>que podemos colocar como archivo <code class="file docutils literal notranslate"><span class="pre">index.php</span></code> y nos servirá para hacer
pruebas. Es obvio que, si no cacheamos, cada vez que pidamos la página
obtendremos una página que devuelve un <a class="reference external" href="https://es.wikipedia.org/wiki/Tiempo_Unix">tiempo UNIX</a> distinto.</p>
<p>Para cachear el <abbr title="PHP Hypertext Preprocessor">PHP</abbr> hay que crear primero un directorio de caché:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mkdir<span class="w"> </span>-m700<span class="w"> </span>/var/cache/nginx/wp-cache
<span class="gp"># </span>chown<span class="w"> </span>www-data<span class="w"> </span>/var/cache/nginx/wp-cache
</pre></div>
</div>
<p>y, luego, una configuración de este estilo para <strong class="program">nginx</strong> (remarcamos
los cambios respecto a la configuración que no cachea):</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="k">fastcgi_cache_path</span><span class="w"> </span><span class="s">/var/cache/nginx/wp-cache</span>
</span><span class="hll"><span class="w">                   </span><span class="s">levels=1:2</span>
</span><span class="hll"><span class="w">                   </span><span class="s">keys_zone=wp-cache:100m</span>
</span><span class="hll"><span class="w">                   </span><span class="s">inactive=7m</span><span class="p">;</span>
</span>
<span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>

<span class="w">   </span><span class="kn">server_name</span><span class="w"> </span><span class="s">_</span><span class="p">;</span>

<span class="w">   </span><span class="kn">root</span><span class="w"> </span><span class="s">/srv/www</span><span class="p">;</span>
<span class="w">   </span><span class="kn">try_files</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nv">$uri/</span><span class="w"> </span><span class="p">=</span><span class="mi">404</span><span class="p">;</span>
<span class="w">   </span><span class="kn">index</span><span class="w">  </span><span class="s">index.php</span><span class="p">;</span>

<span class="w">   </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">\.php$</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kn">include</span><span class="w"> </span><span class="s">snippets/fastcgi-php.conf</span><span class="p">;</span>
<span class="w">      </span><span class="kn">fastcgi_pass</span><span class="w"> </span><span class="s">php</span><span class="p">;</span>

<span class="hll"><span class="w">      </span><span class="kn">fastcgi_cache</span><span class="w"> </span><span class="s">wp-cache</span><span class="p">;</span>
</span><span class="hll"><span class="w">      </span><span class="kn">fastcgi_no_cache</span><span class="w"> </span><span class="nv">$http_authorization</span><span class="p">;</span>
</span><span class="hll"><span class="w">      </span><span class="kn">fastcgi_cache_valid</span><span class="w"> </span><span class="mi">1m</span><span class="p">;</span>
</span><span class="hll"><span class="w">      </span><span class="kn">fastcgi_cache_bypass</span><span class="w"> </span><span class="nv">$http_pragma</span><span class="p">;</span><span class="w">  </span><span class="c1"># Evita la cache con Ctrl+F5 (Pragma: no-cache)</span>
</span><span class="hll"><span class="w">      </span><span class="kn">fastcgi_cache_key</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$scheme$host$request_uri&quot;</span><span class="p">;</span>
</span><span class="hll"><span class="w">      </span><span class="kn">fastcgi_cache_use_stale</span><span class="w"> </span><span class="s">updating</span><span class="w"> </span><span class="s">error</span><span class="w"> </span><span class="s">timeout</span><span class="w"> </span><span class="s">invalid_header</span><span class="w"> </span><span class="s">http_500</span><span class="p">;</span>
</span><span class="hll"><span class="w">      </span><span class="kn">fastcgi_ignore_headers</span><span class="w"> </span><span class="s">Cache-Control</span><span class="w"> </span><span class="s">Expires</span><span class="w"> </span><span class="s">Set-Cookie</span><span class="p">;</span>
</span><span class="hll"><span class="w">      </span><span class="kn">add_header</span><span class="w"> </span><span class="s">X-RunCloud-Cache</span><span class="w"> </span><span class="nv">$upstream_cache_status</span><span class="p">;</span>
</span><span class="w">   </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Esta configuración supone:</p>
<ul>
<li><p>Mediante <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_cache_path">fastcgi_cache_path</a> se define como directorio de caché, el
directorio <code class="file docutils literal notranslate"><span class="pre">/var/cache/nginx/wp-cache</span></code> antes creado. A esta caché
dedicarenos 100MB y nos referiremos a ella como <em>wp-cache</em>, según se determina
con <code class="docutils literal notranslate"><span class="pre">keys_zone</span></code>. Además, determinamos que, a los 7 minutos de haber cacheado
una página, ésta desaparezca de la caché.</p></li>
<li><p>En la <em>location</em> para <abbr title="PHP Hypertext Preprocessor">PHP</abbr> añadimos que se cachee usando la caché anterior
y, además:</p>
<ul>
<li><p><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_no_cache">fastcgi_no_cache</a> permite definir cuándo no se quiere cachear en absoluto.
No se cacheará cuando la variable tenga algún valor y este no sea <strong>0</strong>.
Pueden añadirse varias, en cuyo caso bastará con que alguna tenga un valor
distinto a <strong>0</strong>.</p></li>
<li><p>Fijamos que los contenidos cacheados tienen una validez de <strong>1</strong> minuto.
Como la línea es esta:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">fastcgi_cache_valid 1m;</span>
</pre></div>
</div>
<p>y no se ha expresado código de respuesta alguno, sólo se cachean durante un
minuto las respuestas correctas (código <strong>200</strong>) y las redirecciones
(códigos <strong>301</strong> y <strong>302</strong>). Cualquier otro código, no es cacheado. Pueden,
por supuesto, cachearse otros códigos, incluso todos usando la palabra <em>any</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">fastcgi_cache_valid any 1m;</span>
</pre></div>
</div>
<p>o varios con distinto tiempo usando varias veces la directiva:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">fastcgi_cache_valid 200 301 302 307 1m;</span>
<span class="go">fastcgi_cache_valid 404 30s;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>El tiempo apropiado, por supuesto, dependerá de cuál sea la
la aplicación web y cuál la situación que queremos resolver.</p>
</div>
</li>
<li><p>Evitamos los contenidos cacheados (<a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_cache_bypass">fastcgi_cache_bypass</a>) cuando el
cliente envía una cabecera:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Pragma: no-cache</span>
</pre></div>
</div>
<p>lo cual ocurre cuando desde un navegador se refresca la página pulsando
Ctrl+F5. Es importante notar que, al puentear la caché, se vuelve a generar
el contenido, lo que supone no solamente que obtenegamos el nuevo contenido,
sino que se renueve la caché.</p>
</li>
<li><p>Hacemos que se identifique cada recurso cacheado con la cadena
«$scheme$host$request_uri». Esto significa que si una nueva petición
construye una cadena exactamente igual a la que construyó una petición
anterior, <strong class="program">nginx</strong> devolverá el cacheo de esta petición anterior.</p></li>
<li><p>Con <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_cache_use_stale">fastcgi_cache_use_stale</a> definimos bajo qué circunstancias es
permisible devolver una respuesta obsoleta cacheada. En el ejemplo, si al
hacer una petición se obtiene un error <strong>500</strong>, pero la caché conservaba una
respuesta obsoleta (recordemos que las respuestas caducan al minuto, pero
que no se borrar hasta pasados 7), entonces en vez de devolver tal error,
<strong class="program">nginx</strong> devolverá la respuesta obsoleta.
También es posible obtener una respuesta obsoleta, si se recibe una petición
durante el tiempo de actualización de la caché (debido al parámetro
<code class="docutils literal notranslate"><span class="pre">updating</span></code> incluido).</p></li>
<li><p>No atendemos campos en la cabecera de respuesta (<em>Cache-Control</em>, <em>Expires</em>,
<em>Set-Cookie</em>) que podrían alterar nuestra política de cacheo. De hecho, es
bastante común que las aplicaciones web incluyan este tipo de cabeceras para
evitar que <em>proxies</em> intermedios cacheen contenido que es dinámico.</p></li>
<li><p>Por último, incluimos añadimos una cabecera que informa al cliente de si el
contenido está cacheado o no: un valor de <em>MISS</em> significa que el contenido
se generó para nuestra solicitud y uno de <em>HIT</em> que se obtuvo de la caché.</p></li>
</ul>
</li>
</ul>
<p>Podemos hacer pruebas con un navegador, pero si disponemos de <em>linux</em> en nuestra
máquina cliente, es bastante más cómodo usar <strong class="command">wget</strong>:</p>
<ol class="arabic">
<li><p>Generamos contenido por primera vez (y, de paso, miramos las cabeceras):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>wget<span class="w"> </span>-qSO<span class="w"> </span>-<span class="w"> </span>http://www.example.net
<span class="go">  HTTP/1.1 200 OK</span>
<span class="go">  Server: nginx/1.10.3</span>
<span class="go">  Date: Thu, 08 Nov 2018 15:41:51 GMT</span>
<span class="go">  Content-Type: text/plain; charset=utf-8</span>
<span class="go">  Transfer-Encoding: chunked</span>
<span class="go">  Connection: keep-alive</span>
<span class="go">  X-RunCloud-Cache: MISS</span>
<span class="go">Página generada en el momento 1541691711</span>
</pre></div>
</div>
</li>
<li><p>Volvemos a pedir la página, sin esperar a que pase el minuto:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>wget<span class="w"> </span>-qSO<span class="w"> </span>-<span class="w"> </span>http://www.example.net
<span class="go">  HTTP/1.1 200 OK</span>
<span class="go">  Server: nginx/1.10.3</span>
<span class="go">  Date: Thu, 08 Nov 2018 15:42:30 GMT</span>
<span class="go">  Content-Type: text/plain; charset=utf-8</span>
<span class="go">  Transfer-Encoding: chunked</span>
<span class="go">  Connection: keep-alive</span>
<span class="go">  X-RunCloud-Cache: HIT</span>
<span class="go">Página generada en el momento 1541691711</span>
</pre></div>
</div>
</li>
<li><p>Pedimos de nuevo el contenido (deberá regenerarse):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>wget<span class="w"> </span>-qSO<span class="w"> </span>-<span class="w"> </span>http://www.example.net
<span class="go">  HTTP/1.1 200 OK</span>
<span class="go">  Server: nginx/1.10.3</span>
<span class="go">  Date: Thu, 08 Nov 2018 15:45:56 GMT</span>
<span class="go">  Content-Type: text/plain; charset=utf-8</span>
<span class="go">  Transfer-Encoding: chunked</span>
<span class="go">  Connection: keep-alive</span>
<span class="go">  X-RunCloud-Cache: EXPIRED</span>
<span class="go">Página generada en el momento 1541691984</span>
</pre></div>
</div>
</li>
<li><p>Emulamos el refresco con <em>Ctrl+F5</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>wget<span class="w"> </span>-qSO<span class="w"> </span>-<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Pragma: no-cache&quot;</span><span class="w"> </span>http://www.example.net
<span class="go">  HTTP/1.1 200 OK</span>
<span class="go">  Server: nginx/1.10.3</span>
<span class="go">  Date: Thu, 08 Nov 2018 15:46:21 GMT</span>
<span class="go">  Content-Type: text/plain; charset=utf-8</span>
<span class="go">  Transfer-Encoding: chunked</span>
<span class="go">  Connection: keep-alive</span>
<span class="go">  X-RunCloud-Cache: BYPASS</span>
<span class="go">Página generada en el momento 1541692253</span>
</pre></div>
</div>
</li>
</ol>
<p class="rubric">Purgando la caché</p>
<p><strong class="program">nginx</strong> dispone directivas para purgar de forma manual la caché, pero
forman parte de la versión de pago. <em>debian</em>, sin embargo, permite la
instalación del módulo <a class="reference external" href="https://github.com/phusion/passenger_apt_automation/tree/master/debian_specs/nginx/modules/nginx-cache-purge">ngx_cache_purge</a> que habilita precisamente eso:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>libnginx-mod-http-cache-purge
</pre></div>
</div>
<p>Las directivas de purga (<code class="docutils literal notranslate"><span class="pre">fastcgi_cache_purge</span></code> en nuestro caso no pueden
usarse dentro de un directiva <code class="docutils literal notranslate"><span class="pre">if</span></code>), por lo que una argucia para poder purgar
sería la siguiente configuración:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">fastcgi_cache_path</span><span class="w"> </span><span class="s">/var/cache/nginx/wp-cache</span>
<span class="w">                   </span><span class="s">levels=1:2</span>
<span class="w">                   </span><span class="s">keys_zone=wp-cache:100m</span>
<span class="w">                   </span><span class="s">inactive=7m</span><span class="p">;</span>

<span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>

<span class="w">   </span><span class="kn">server_name</span><span class="w"> </span><span class="s">_</span><span class="p">;</span>

<span class="w">   </span><span class="kn">root</span><span class="w"> </span><span class="s">/srv/www</span><span class="p">;</span>
<span class="w">   </span><span class="kn">try_files</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nv">$uri/</span><span class="w"> </span><span class="p">=</span><span class="mi">404</span><span class="p">;</span>
<span class="w">   </span><span class="kn">index</span><span class="w">  </span><span class="s">index.php</span><span class="p">;</span>

<span class="hll"><span class="w">   </span><span class="kn">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$request_method</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;PURGE&quot;)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">      </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">^</span><span class="w"> </span><span class="s">/purge</span><span class="nv">$request_uri</span><span class="w"> </span><span class="s">last</span><span class="p">;</span>
</span><span class="hll"><span class="w">   </span><span class="p">}</span>
</span><span class="hll">
</span><span class="hll"><span class="w">   </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">/purge(/.*)$</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">      </span><span class="kn">internal</span><span class="p">;</span>
</span><span class="hll"><span class="w">      </span><span class="kn">allow</span><span class="w"> </span><span class="mi">127</span><span class="s">.0.0.0/8</span><span class="p">;</span>
</span><span class="hll"><span class="w">      </span><span class="kn">deny</span><span class="w"> </span><span class="s">all</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll"><span class="w">      </span><span class="kn">fastcgi_cache_purge</span><span class="w"> </span><span class="s">wp-cache</span><span class="w"> </span><span class="nv">$request_uri</span><span class="p">;</span>
</span><span class="hll"><span class="w">   </span><span class="p">}</span>
</span>
<span class="w">   </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">\.php$</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kn">include</span><span class="w"> </span><span class="s">snippets/fastcgi-php.conf</span><span class="p">;</span>
<span class="w">      </span><span class="kn">fastcgi_pass</span><span class="w"> </span><span class="s">php</span><span class="p">;</span>

<span class="w">      </span><span class="kn">fastcgi_cache</span><span class="w"> </span><span class="s">wp-cache</span><span class="p">;</span>
<span class="w">      </span><span class="kn">fastcgi_no_cache</span><span class="w"> </span><span class="nv">$http_authorization</span><span class="p">;</span>
<span class="w">      </span><span class="kn">fastcgi_cache_valid</span><span class="w"> </span><span class="mi">1m</span><span class="p">;</span>
<span class="w">      </span><span class="kn">fastcgi_cache_bypass</span><span class="w"> </span><span class="nv">$http_pragma</span><span class="p">;</span><span class="w">  </span><span class="c1"># Evita la cache con Ctrl+F5 (Pragma: no-cache)</span>
<span class="hll"><span class="w">      </span><span class="kn">fastcgi_cache_key</span><span class="w"> </span><span class="nv">$request_uri</span><span class="p">;</span>
</span><span class="w">      </span><span class="kn">fastcgi_cache_use_stale</span><span class="w"> </span><span class="s">updating</span><span class="w"> </span><span class="s">error</span><span class="w"> </span><span class="s">timeout</span><span class="w"> </span><span class="s">invalid_header</span><span class="w"> </span><span class="s">http_500</span><span class="p">;</span>
<span class="w">      </span><span class="kn">fastcgi_ignore_headers</span><span class="w"> </span><span class="s">Cache-Control</span><span class="w"> </span><span class="s">Expires</span><span class="w"> </span><span class="s">Set-Cookie</span><span class="p">;</span>
<span class="w">      </span><span class="kn">add_header</span><span class="w"> </span><span class="s">X-RunCloud-Cache</span><span class="w"> </span><span class="nv">$upstream_cache_status</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Con esta configuración podremos purgar de la caché usando el método <em>PURGE</em>,
pero sólo desde el propio servidor. Por tanto, si obtenemos así, la página:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>wget<span class="w"> </span>-qSO<span class="w"> </span>-<span class="w"> </span>http://www.example.net
</pre></div>
</div>
<p>podremos purgar desde el propio servidor de este modo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>wget<span class="w"> </span>-qSO<span class="w"> </span>-<span class="w"> </span>--method<span class="o">=</span>PURGE<span class="w"> </span><span class="s2">&quot;http://localhost&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="otros-lenguajes">
<h2><span class="section-number">7.2.2.2.7.2. </span>Otros lenguajes<a class="headerlink" href="#otros-lenguajes" title="Enlace permanente a este encabezado">¶</a></h2>
<div class="admonition-todo admonition" id="id3">
<p class="admonition-title">Por hacer</p>
<p>Por escribir</p>
</div>
<p class="rubric">Notas al pie</p>
<dl class="footnote brackets">
<dt class="label" id="id4"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>En las distribuciones linux modernas <strong class="program">mysql</strong> es, en realidad,
<a class="reference external" href="https://mariadb.org/">mariadb</a>, el <a class="reference external" href="https://es.wikipedia.org/wiki/Bifurcaci%C3%B3n_(desarrollo_de_software)">derivado</a>
de <strong class="program">mysql</strong> a raíz de su adquisición por <em>Oracle</em>.</p>
</dd>
<dt class="label" id="id5"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>En realidad, <em>mysql-client</em> no es necesario, pero suele ser muy útil
poder acceder directamente al servidor <em>MySQL</em>.</p>
</dd>
</dl>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../../../index.html">Tabla de contenido</a></h3>
    <ul>
<li><a class="reference internal" href="#">7.2.2.2.7. Contenido dinámico</a><ul>
<li><a class="reference internal" href="#php">7.2.2.2.7.1. PHP</a><ul>
<li><a class="reference internal" href="#instalacion">7.2.2.2.7.1.1. Instalación</a></li>
<li><a class="reference internal" href="#configuracion-del-sitio">7.2.2.2.7.1.2. Configuración del sitio</a></li>
<li><a class="reference internal" href="#comprobacion">7.2.2.2.7.1.3. Comprobación</a></li>
<li><a class="reference internal" href="#optimizacion-por-cacheo">7.2.2.2.7.1.4. Optimización por cacheo</a></li>
</ul>
</li>
<li><a class="reference internal" href="#otros-lenguajes">7.2.2.2.7.2. Otros lenguajes</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Tema anterior</h4>
    <p class="topless"><a href="05.if.html"
                          title="capítulo anterior"><span class="section-number">7.2.2.2.6. </span>Sentencia condicional</a></p>
  </div>
  <div>
    <h4>Próximo tema</h4>
    <p class="topless"><a href="07.https.html"
                          title="próximo capítulo"><span class="section-number">7.2.2.2.8. </span>Conexión segura</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/07.serre/02.web/02.nginx/02.avanz/06.dynamic.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Ir a" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="07.https.html" title="7.2.2.2.8. Conexión segura"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="05.if.html" title="7.2.2.2.6. Sentencia condicional"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">7. </span>Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">7.2. </span>Web</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" ><span class="section-number">7.2.2. </span>nginx</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="index.html" ><span class="section-number">7.2.2.2. </span>Configuración</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7.2.2.2.7. </span>Contenido dinámico</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2023, José Miguel Sánchez Alés.
      Creado usando <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>