


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="es">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>7.2.2.2.9. Puerto compartido &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Índice" href="../../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../../search.html" />
    <link rel="next" title="7.2.2.2.10. Otros aspectos" href="08.misc.html" />
    <link rel="prev" title="7.2.2.2.8. Conexión segura" href="07.https.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="08.misc.html" title="7.2.2.2.10. Otros aspectos"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="07.https.html" title="7.2.2.2.8. Conexión segura"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >7. Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" >7.2. Web</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" >7.2.2. nginx</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="index.html" accesskey="U">7.2.2.2. Configuración</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="puerto-compartido">
<span id="compartido"></span><h1>7.2.2.2.9. Puerto compartido<a class="headerlink" href="#puerto-compartido" title="Enlazar permanentemente con este título">¶</a></h1>
<p>Los puertos <strong>80</strong> y <strong>443</strong> son puertos a los que comúnmente todas las redes,
por muy restrictivas que sean, dejan salir ya que de lo contrario ni siquiera
se permitiría la navegación en ellas. Por esto motivo, puede darse el caso de
que, para asegurarnos el acceso, tengamos interés es que nuestro servicio <abbr title="Security SHell">SSH</abbr>
o <abbr title="Virtual Private Network">VPN</abbr> escuche en ellos. Cuando esto es así caben dos posibilidades en el lado
del servidor:</p>
<ul class="simple">
<li>Que no tengamos servidor web y, por tanto, los puertos estén libres.</li>
<li>Que sí tengamos servidor web y, consecuentemente, no podamos ocupar los puertos
con ningún otro servicio.</li>
</ul>
<p>Por su parte, en el lado del cliente hay dos posibilidades también para la red
restringida:</p>
<ul class="simple">
<li>Que no haya vigilancia sobre esos puertos y, por tanto, pueda enviarse
tráfico no web.</li>
<li>Que los puertos sí esten vigilados por un proxy y, en consecuencia, el tráfico
deba ser forzosamente web. A este respecto es más común la vigilancia del
puerto <strong>80</strong> que la del puerto <strong>443</strong>.</li>
</ul>
<p>Un cuadro resumen con las alternativas posibles es el siguiente:</p>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="13%" />
<col width="76%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Puerto</th>
<th class="head">Vigilancia</th>
<th class="head">Solución</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Libre</td>
<td>No</td>
<td>Poner a escuchar directamente el servicio.</td>
</tr>
<tr class="row-odd"><td>Ocupado</td>
<td>No</td>
<td>Usar un multiplexar como <a class="reference internal" href="#sslh"><span class="std std-ref">sslh</span></a>.</td>
</tr>
<tr class="row-even"><td>Libre</td>
<td>Sí</td>
<td>Enmascarar el tráfico.</td>
</tr>
<tr class="row-odd"><td>Ocupado</td>
<td>Sí</td>
<td>Enmascarar el tráfico y discriminar tráfico a continuación.</td>
</tr>
</tbody>
</table>
<p>Por supuesto, que el puerto esté ocupado depende de nuestro servidor, pero que
la red remota esté sometida a vigilancia depende de cuál sea la red desde la que
se conecta el cliente: en ocasiones no habrá restricción alguna y en otra la
rstricción y vigilancia puede ser máxima. Hay, además, otra circunstancia a
tener en cuenta y es el coste para la conexión de la solución. Es obvio que
escuchar directamente es la solución más ventajosa desde el punto de vista del
rendimiento, mientras que tener que enmascarar el tráfico y, además, deber
discriminar tráfico por compartir el puerto la más costosa.</p>
<p>Las posibles soluciones para puerto compartido, ajustadas a la necesidad, son:</p>
<ul class="simple">
<li><a class="reference internal" href="#sslh"><span class="std std-ref">sslh</span></a>, que identifica tráfico y lo deriva al servidor apropiado.
Es inútil si la comunicaciones al puerto son vigiladas.</li>
<li>Enmascarar el tráfico haciéndolo pasar como una aplicación que usa <a class="reference external" href="https://v0ctor.me/websocket">Websocket</a>.. Como <em>Websocket</em> forma parte del estándar
HTML5, la comunicación debería ser aceptada incluso en presencia de un <em>proxy</em>.
Aún con ello, si se usa una comunicación sin cifrar, en teoría, se podría
analizar cuál es el tráfico de la aplicación que usa <em>websocket</em> y rechazarlo.</li>
<li>Enmascarar el tráfico cifrándolo con <abbr title="Secure Socket Layer">SSL</abbr> y enviándolo al puerto <strong>443</strong>.
Esto lo haría indistiguible del tráfico <abbr title="HyperText Transfer Protocol">HTTP</abbr>s por cualquier proxy y, <em>en
consecuencia</em>, irrestringible. La contrapartida es que se añade un cifrado
sonre un protocolo ya cifrado (<abbr title="Security SHell">SSH</abbr> o <abbr title="Virtual Private Network">VPN</abbr>) lo que disminuye enormemente el
rendimiento. Es obvio que la solución de tunelizar con <em>Websocket</em> también
puede llevarse a cabo sobre <abbr title="HyperText Transfer Protocol">HTTP</abbr>s, pero no añade más que un poco de
pérdida de rendimiento. Ahora bien, si se implementó la solución de
<em>Websocket</em> para <abbr title="HyperText Transfer Protocol">HTTP</abbr>, puede ser interesante, ya que la configuración
adicional sería mínima.</li>
</ul>
<p>Este epígrafe está dedicado a la implementación en la parte del servidor, ya que
es la que afecta a <strong class="program">nginx</strong>.</p>
<div class="section" id="multiplexacion">
<span id="sslh"></span><h2>7.2.2.2.9.1. Multiplexación<a class="headerlink" href="#multiplexacion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Para aquellos casos en que no haya vigilancia sobre el puerto <strong>443</strong>, pero éste
esté ocupado en el servidor por <strong class="program">ngnix</strong>, la solución consiste en poner
a escuchar el servidor web seguro exclusivamente en el puerto <strong>443</strong> de la
interfaz de <em>loopback</em> y reservar el puerto de la interfaz física para el
<a class="reference external" href="http://www.rutschle.net/tech/sslh/README.html">servicio SSLH</a>. Este servicio
es, por decirlo así, un <em>multiplexor de protocolos</em> que analiza el trafico
recibido en un determinado puerto (típicamente el <strong>443</strong>), analiza el tráfico
y, en función de su tipo, lo redirige al puerto de la interfaz que le
indiquemos. Gracias a ello, podemos ofrecer distintos servicios (p.e. <abbr title="HyperText Transfer Protocol">HTTP</abbr>s,
<abbr title="Security SHell">SSH</abbr> y <abbr title="Virtual Private Network">VPN</abbr>) por el mismo puerto <strong>443</strong> de la interfaz física. La estrategia,
pues, consiste en levantar los siguientes servicios, escuchando en los
siguientes interfaces y puertos:</p>
<table border="1" class="docutils">
<colgroup>
<col width="34%" />
<col width="45%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Servicio</th>
<th class="head">Interfaz</th>
<th class="head">Puerto</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><abbr title="Security SHell">SSH</abbr></td>
<td>0.0.0.0</td>
<td>22/TCP</td>
</tr>
<tr class="row-odd"><td><em>OpenVPN</em><a class="footnote-reference" href="#id3" id="id1">[1]</a></td>
<td>0.0.0.0</td>
<td>1194/TCP</td>
</tr>
<tr class="row-even"><td><abbr title="HyperText Transfer Protocol">HTTP</abbr>s</td>
<td>0.0.0.0</td>
<td>80/TCP</td>
</tr>
<tr class="row-odd"><td><em>SSLH</em></td>
<td>Todas excepto local</td>
<td>443/TCP</td>
</tr>
</tbody>
</table>
<p>Para llevarlo a cabo, es necesario instalar:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> apt-get install sslh
</pre></div>
</div>
<p>y configurar el fichero <code class="file docutils literal notranslate"><span class="pre">/etc/default/sslh</span></code> del siguiente modo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">RUN=yes  # SSLH corre permanentemente, no a través de inetd.</span>

<span class="go">[...]</span>

<span class="go">DAEMON_OPTS=&quot;--user sslh --listen 172.22.0.2:443 \</span>
<span class="go">             --ssh 127.0.0.1:22 --ssl 127.0.0.1:443 --openvpn 127.0.0.1:1194 \</span>
<span class="go">             --pidfile /var/run/sslh/sslh.pid&quot;</span>
</pre></div>
</div>
<p>esto suponiendo que tengamos una sólo interfaz física y esta tenga por <abbr title="Internet Protocol">IP</abbr>
<em>172.22.0.2</em>. Si hubiera varias, habría que colocar varias veces la opción
<code class="docutils literal notranslate"><span class="pre">--listen</span></code> con la <em>ip</em> correspondiente.</p>
</div>
<div class="section" id="nginx-websocket">
<span id="id2"></span><h2>7.2.2.2.9.2. Websocket<a class="headerlink" href="#nginx-websocket" title="Enlazar permanentemente con este título">¶</a></h2>
</div>
<div class="section" id="ssl">
<h2>7.2.2.2.9.3. <abbr title="Secure Socket Layer">SSL</abbr><a class="headerlink" href="#ssl" title="Enlazar permanentemente con este título">¶</a></h2>
<p class="rubric">Notas al pie</p>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><p class="first">Donde queramos poner a escuchar <strong class="program">openvpn</strong> depende de nuestras
intenciones. Escoger el puerto <strong>1194</strong> responde a que ese es el puerto
estándar para esa aplicación (de hecho, aparece referido en
<code class="file docutils literal notranslate"><span class="pre">/etc/services</span></code>). Una buena estrategia es ponerlo a escuchar:</p>
<ul class="last simple">
<li>En el puerto <em>1194/UDP</em> en todas las interfaces.</li>
<li>En el puerto <em>1194/TCP</em> de la interfaz local, cuya conexión remota se
haŕa gracias a la intermediación de <strong class="program">haproxy</strong>.</li>
</ul>
</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">7.2.2.2.9. Puerto compartido</a><ul>
<li><a class="reference internal" href="#multiplexacion">7.2.2.2.9.1. Multiplexación</a></li>
<li><a class="reference internal" href="#nginx-websocket">7.2.2.2.9.2. Websocket</a></li>
<li><a class="reference internal" href="#ssl">7.2.2.2.9.3. <abbr title="Secure Socket Layer">SSL</abbr></a></li>
</ul>
</li>
</ul>

  <h4>Tema anterior</h4>
  <p class="topless"><a href="07.https.html"
                        title="capítulo anterior">7.2.2.2.8. Conexión segura</a></p>
  <h4>Próximo tema</h4>
  <p class="topless"><a href="08.misc.html"
                        title="próximo capítulo">7.2.2.2.10. Otros aspectos</a></p>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/07.serre/02.web/02.nginx/02.avanz/08.compartido.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Ir a" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="08.misc.html" title="7.2.2.2.10. Otros aspectos"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="07.https.html" title="7.2.2.2.8. Conexión segura"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >7. Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" >7.2. Web</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" >7.2.2. nginx</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="index.html" >7.2.2.2. Configuración</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2020, José Miguel Sánchez Alés.
      Creado con <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>