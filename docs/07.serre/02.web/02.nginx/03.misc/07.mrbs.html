


<!DOCTYPE html>

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>7.2.2.3.9. MRBS &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/classic.css" />
    <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
    
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/translations.js"></script>
    
    <link rel="index" title="Índice" href="../../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../../search.html" />
    <link rel="next" title="7.2.2.3.10. DMS" href="08.dms.html" />
    <link rel="prev" title="7.2.2.3.8. Foro" href="06.foro.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="08.dms.html" title="7.2.2.3.10. DMS"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="06.foro.html" title="7.2.2.3.8. Foro"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">7. </span>Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">7.2. </span>Web</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" ><span class="section-number">7.2.2. </span>nginx</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="index.html" accesskey="U"><span class="section-number">7.2.2.3. </span>Recetas</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7.2.2.3.9. </span><abbr title="Meeting Room Booking System">MRBS</abbr></a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="mrbs">
<span id="app-mrbs"></span><h1><span class="section-number">7.2.2.3.9. </span><abbr title="Meeting Room Booking System">MRBS</abbr><a class="headerlink" href="#mrbs" title="Enlace permanente a este encabezado">¶</a></h1>
<p><a class="reference external" href="https://mrbs.sourceforge.io/">MRBS</a> es una pequeña aplicación web que
facilita la reserva anticipada de aulas.</p>
<section id="preliminares">
<h2><span class="section-number">7.2.2.3.9.1. </span>Preliminares<a class="headerlink" href="#preliminares" title="Enlace permanente a este encabezado">¶</a></h2>
<p>No tiene muchas dependencias y la instalación básica de <abbr title="PHP Hypertext Preprocesor">PHP</abbr>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt-get<span class="w"> </span>install<span class="w"> </span>php<span class="o">{</span>,-mysql<span class="o">}</span><span class="w"> </span>libapache2-mod-php7.0-<span class="w"> </span>mysql-<span class="o">{</span>server,client<span class="o">}</span>
</pre></div>
</div>
<p>es más que suficiente. Además, como cualquier otra aplicación web, requiere que
se le prepare una base de datos y un usuario para manipularla:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mysql
<span class="go">mysql&gt; CREATE DATABASE mrbs;</span>
<span class="go">mysql&gt; GRANT ALL PRIVILEGES ON mrbs.* TO &#39;mrbs&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;contraseñadificil&#39;;</span>
</pre></div>
</div>
</section>
<section id="configuracion-en-nginx">
<h2><span class="section-number">7.2.2.3.9.2. </span>Configuración en <strong class="program">nginx</strong><a class="headerlink" href="#configuracion-en-nginx" title="Enlace permanente a este encabezado">¶</a></h2>
<p>Basta con crear una <a class="reference download internal" download="" href="../../../../_downloads/eb3c2da156a01c29ef1ea1fff4502158/site-mrbs"><code class="xref download docutils literal notranslate"><span class="pre">configuración</span> <span class="pre">de</span> <span class="pre">sitio</span></code></a> con esta pinta:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">   </span><span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="p">;</span>

<span class="w">   </span><span class="kn">server_name</span><span class="w"> </span><span class="s">aulas.example.net</span><span class="p">;</span>

<span class="w">   </span><span class="kn">include</span><span class="w"> </span><span class="s">snippets/snakeoil.conf</span><span class="p">;</span>

<span class="w">   </span><span class="kn">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$https</span><span class="w"> </span><span class="s">!=</span><span class="w"> </span><span class="s">&quot;on&quot;)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kn">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="s">https://</span><span class="nv">$host$request_uri</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="kn">index</span><span class="w"> </span><span class="s">index.php</span><span class="p">;</span>
<span class="w">   </span><span class="kn">root</span><span class="w"> </span><span class="s">/srv/www/mrbs</span><span class="p">;</span>

<span class="w">   </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="sr">*</span><span class="w">  </span><span class="s">\.(jpg|jpeg|png|gif|css|js|ico)</span>$<span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kn">expires</span><span class="w"> </span><span class="s">max</span><span class="p">;</span>
<span class="w">      </span><span class="kn">log_not_found</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">\.php$</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kn">try_files</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="p">=</span><span class="mi">404</span><span class="p">;</span>
<span class="w">      </span><span class="kn">fastcgi_param</span><span class="w"> </span><span class="s">SCRIPT_FILENAME</span><span class="w"> </span><span class="nv">$request_filename</span><span class="p">;</span>
<span class="w">      </span><span class="kn">include</span><span class="w"> </span><span class="s">fastcgi_params</span><span class="p">;</span>
<span class="w">      </span><span class="kn">fastcgi_pass</span><span class="w"> </span><span class="s">php</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="instalacion">
<h2><span class="section-number">7.2.2.3.9.3. </span>Instalación<a class="headerlink" href="#instalacion" title="Enlace permanente a este encabezado">¶</a></h2>
<p>Lo primero es ir a la <a class="reference external" href="https://mrbs.sourceforge.io">página del proyecto</a>,
descargar la ultima versión<a class="footnote-reference brackets" href="#id8" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> y descomprimirla en un directorio adecuado:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/srv/www/mrbs
<span class="gp"># </span>tar<span class="w"> </span>-C<span class="w"> </span>/srv/www/mrbs<span class="w"> </span>--strip-component<span class="o">=</span><span class="m">2</span><span class="w"> </span>-axvf<span class="w"> </span>mrbs-1.7.1.tar.gz<span class="w"> </span>mrbs-1.7.1/web
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Sólo el contenido del subdirectorio <code class="file docutils literal notranslate"><span class="pre">web/</span></code> contiene los ficheros
de la aplicación.</p>
</div>
<p>La instalación, a diferencia de otras aplicaciones web, es manual y requiere que
la generación de la base de datos y la configuración básica, se haga en la
consola. Para lo primero, la propia aplicación trae un guión <abbr title="tructured Query Language">SQL</abbr> apropiado:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>tar<span class="w"> </span>-C<span class="w"> </span>/tmp<span class="w"> </span>--strip-component<span class="o">=</span><span class="m">1</span><span class="w"> </span>-axvf<span class="w"> </span>mrbs-1.7.1.tar.gz<span class="w"> </span>mrbs-1.7.1/tables.my.sql
<span class="gp"># </span>mysql<span class="w"> </span>mrbs<span class="w"> </span>&lt;<span class="w"> </span>/tmp/tables.my.sql
</pre></div>
</div>
<p>Por último es necesario editar el fichero <code class="file docutils literal notranslate"><span class="pre">config.inc.php</span></code> y descomentar o
modificar las siguientes líneas:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$timezone</span> <span class="o">=</span> <span class="s2">&quot;Europe/Madrid&quot;</span><span class="p">;</span>

<span class="nv">$dbsys</span> <span class="o">=</span> <span class="s2">&quot;mysql&quot;</span><span class="p">;</span>
<span class="nv">$db_host</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">;</span>
<span class="nv">$db_database</span> <span class="o">=</span> <span class="s2">&quot;mrbs&quot;</span><span class="p">;</span>
<span class="nv">$db_login</span> <span class="o">=</span> <span class="s2">&quot;mrbs&quot;</span><span class="p">;</span>
<span class="nv">$db_password</span> <span class="o">=</span> <span class="s2">&quot;crontraseñadificl&quot;</span><span class="p">;</span>
<span class="nv">$db_tbl_prefix</span> <span class="o">=</span> <span class="s2">&quot;mrbs_&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Con esto, ya es suficiente para ver cómo queda la aplicación, aunque al
visitarla se detectará que no existen usuarios y se forzará a crear al menos un
usuario administrador. <abbr title="Meeting Room Booking System">MRBS</abbr> soporta <a class="reference external" href="https://mrbs.sourceforge.io/view_text.php?section=Documentation&amp;file=AUTHENTICATION">varios métodos de autenticación para
gestionar usuarios</a>
y el predeterminado es «db»<a class="footnote-reference brackets" href="#id9" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>, por lo que este administrador y todos los que
usuarios que definamos desde la interfaz web se almacenarán en la base de datos
<em>MySQL</em> que acabamos de crear<a class="footnote-reference brackets" href="#id10" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>.</p>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Si visita la aplicación para ver el resultado puede crear el
usuario administrador, pero no realice ninguna otra acción (como crear áreas
y aulas), porque es conveniente haber afinado antes la configuración.</p>
</div>
</section>
<section id="configuracion">
<h2><span class="section-number">7.2.2.3.9.4. </span>Configuración<a class="headerlink" href="#configuracion" title="Enlace permanente a este encabezado">¶</a></h2>
<p>Una configuración mínima pasa por añadir las siguientes líneas al final del
fichero de configuración <code class="file docutils literal notranslate"><span class="pre">config.inc.php</span></code>:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1"># En versiones modernas estas tres líneas posiblemene sean redundantes.</span>
<span class="nb">unset</span><span class="p">(</span><span class="nv">$periods</span><span class="p">);</span>
<span class="nb">unset</span><span class="p">(</span><span class="nv">$auth</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]);</span>
<span class="nb">unset</span><span class="p">(</span><span class="nv">$auth</span><span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">]);</span>

<span class="k">require</span> <span class="s2">&quot;ies.inc.php&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>en que básicamente borramos todos los usuarios predeterminados, eliminamos los
periodos de tiempo predefinidos y pedimos que se lea un fichero
<code class="file docutils literal notranslate"><span class="pre">ies.inc.php</span></code>, que será donde realmente escribamos la configuración.
podemos empezarlo con las siiguientes líneas:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">namespace</span> <span class="nx">MRBS</span><span class="p">;</span>

<span class="c1">#</span>
<span class="c1"># Configuración de la empresa</span>
<span class="c1">#</span>
<span class="nv">$mrbs_company</span> <span class="o">=</span> <span class="s2">&quot;IES Bla, bla, bla&quot;</span><span class="p">;</span>
<span class="nv">$mrbs_company_logo</span> <span class="o">=</span> <span class="s2">&quot;/logo.png&quot;</span><span class="p">;</span>  <span class="c1"># Y colocamos el logo dentro de /srv/www/mrbs</span>
<span class="nv">$mrbs_company_url</span> <span class="o">=</span> <span class="s2">&quot;http://web.del.centro.es&quot;</span><span class="p">;</span>

<span class="c1">#</span>
<span class="c1"># Autenticación de usuarios</span>
<span class="c1">#</span>
<span class="c1">#$auth[&quot;type&quot;] = &quot;config&quot;;</span>
<span class="c1">#$auth[&quot;user&quot;][&quot;admin&quot;]=&quot;una.buena.contraseña&quot;;</span>
<span class="c1">#$auth[&quot;user&quot;][&quot;profesor&quot;]=&quot;roseforp&quot;;</span>
<span class="c1">## admin, además, es administrador</span>
<span class="c1">#$auth[&quot;admin&quot;][]=&quot;admin&quot;;</span>

<span class="c1">#</span>
<span class="c1"># Tramos horarios</span>
<span class="c1">#</span>
<span class="nv">$enable_periods</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
<span class="nv">$periods</span><span class="p">[]</span><span class="o">=</span><span class="s2">&quot;08:15-09:15&quot;</span><span class="p">;</span>
<span class="nv">$periods</span><span class="p">[]</span><span class="o">=</span><span class="s2">&quot;09:15-10:15&quot;</span><span class="p">;</span>
<span class="nv">$periods</span><span class="p">[]</span><span class="o">=</span><span class="s2">&quot;10:15-11:15&quot;</span><span class="p">;</span>
<span class="nv">$periods</span><span class="p">[]</span><span class="o">=</span><span class="s2">&quot;Recreo&quot;</span><span class="p">;</span>
<span class="nv">$periods</span><span class="p">[]</span><span class="o">=</span><span class="s2">&quot;11:45-12:45&quot;</span><span class="p">;</span>
<span class="nv">$periods</span><span class="p">[]</span><span class="o">=</span><span class="s2">&quot;12:45-13:45&quot;</span><span class="p">;</span>
<span class="nv">$periods</span><span class="p">[]</span><span class="o">=</span><span class="s2">&quot;13:45-14:45&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Hay que destacar dos aspectos:</p>
<ol class="arabic">
<li><p>La líneas de autenticación comentadas definen la autenticación más sencilla,
que consiste en indicar en un <em>array</em> asociativo de la propia configuración
quiénes son los usuarios y cuáles sus contraseñas. En otro array se indica
qué usuarios son administradores. Para el caso se han establecido dos únicos
usuarios: uno es administrador y el otro no.</p>
<p>No obstante, la configuración predeterminada es la que almacena usuarios en
la base de datos, de ahí que si se accede sin haber configurado nada o con
esta configuración propuesta con las líneas comentadas, la aplicación exija
la creación de un primer usuario administrador. Sin perjuicio de otras
autenticaciones más complejas, es preferible almacenar usuarios en la base de
datos que tenerlos definidos dentro de la configuración, así que se
desaconseja incluir estas líneas.</p>
</li>
<li><p>Por defecto, la aplicación habilita unos tramos horarios de duración fija
(aunque ésta puede modificarse). Las líneas incluidas al respecto en la
configuración redefinen los tramos como periodos.</p>
<p>En realidad, la aplicación permite definir áreas (o sedes) y, dentro de cada
sede, salas (o aulas). Son las aulas las que se reservan y las áreas sirven
para definir salas que tienen características comunes como, por ejemplo, el
horario. Cada área puede tener definidos unos tramos distintos, pero con la
configuración que hemos propuesto, se crearán en principio copiando los
tramos predefinidos en la configuración.</p>
</li>
</ol>
<section id="configuracion-en-la-interfaz-web">
<h3><span class="section-number">7.2.2.3.9.4.1. </span>Configuración en la interfaz web<a class="headerlink" href="#configuracion-en-la-interfaz-web" title="Enlace permanente a este encabezado">¶</a></h3>
<p>La configuración a través de la interfaz web, consiste básicamente en la
creación de las aulas (<em>salas</em> en la terminología de la aplicación) susceptibles
de ser reservadas. La creación es sencilla y no requiere explicación, pero si es
pertinente una aclaración: las <em>aulas</em> se agrupan en <em>sedes</em>, de manera que
antes de crearlas es necesario crear al menos una sede.</p>
</section>
<section id="personalizacion">
<h3><span class="section-number">7.2.2.3.9.4.2. </span>Personalización<a class="headerlink" href="#personalizacion" title="Enlace permanente a este encabezado">¶</a></h3>
<p>Con la configuración anterior es suficiente para echar a andar la aplicación,
pero puede pulirse un poco más esta, según el gusto de cada cual. Por gusto
propio me gusta añadir lo siguiente en <code class="file docutils literal notranslate"><span class="pre">ies.inc.php</span></code>:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Vista</span>
<span class="c1">#</span>
<span class="nv">$default_view</span><span class="o">=</span><span class="s1">&#39;week&#39;</span><span class="p">;</span>  <span class="c1"># La página inicial muestra la semana en curso completa.</span>
<span class="nv">$dateformat</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>         <span class="c1"># Ver día-mes, en vez de mes-día.</span>

<span class="c1">#</span>
<span class="c1"># Semana</span>
<span class="c1">#</span>
<span class="nv">$weekstarts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>           <span class="c1">#Lunes, primer día.</span>
<span class="nv">$hidden_days</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span> <span class="c1">#Sábados y domingos, no.</span>

<span class="c1">#</span>
<span class="c1"># Las reservas periódicas y multidía sólo pueden hacerlas administradores.</span>
<span class="c1">#</span>
<span class="nv">$auth</span><span class="p">[</span><span class="s1">&#39;only_admin_can_book_repeat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
<span class="nv">$auth</span><span class="p">[</span><span class="s1">&#39;only_admin_can_book_multiday&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>

<span class="c1">#</span>
<span class="c1"># Anticipación en las reservas</span>
<span class="c1">#</span>
<span class="nv">$max_book_ahead_enabled</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
<span class="nv">$max_book_ahead_secs</span> <span class="o">=</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">7</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span> <span class="c1"># Máximo, cuatro semanas.</span>

<span class="c1">#</span>
<span class="c1"># Cancelación de reservas</span>
<span class="c1">#</span>
<span class="nv">$min_book_ahead_enabled</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
<span class="nv">$min_book_ahead_secs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>   <span class="c1"># Se puede cancelar la reserva de un aula</span>
                                 <span class="c1"># hasta 10 min. después de empezada la clase</span>
</pre></div>
</div>
<p>La configuración es autoexplicativa, pero resumiendo:</p>
<ul class="simple">
<li><p>Al visitar la aplicación se muestran las reservas de la semana en curso de la
primera de las aulas<a class="footnote-reference brackets" href="#id11" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a>. Sin configurarlo, lo que se muestra son las
reservas del día en curso para todas las aulas.</p></li>
<li><p>Se eliminan los fines de semana, ya que siempre son festivos.</p></li>
<li><p>Se impide que los usuarios normales puedan hacer reservas periódicas. Esto
evita que un profesor acapare durante todo un curso una misma aula.</p></li>
<li><p>En consonancia con lo anterior, se limita la reserva anticipada a cuatro
semanas.</p></li>
<li><p>También se limita la cancelación de las reservas: diez minutos después de
haber empezado el tramo horario en que se hizo una reserva, la reserva no
podrá eliminarse del cuadrante.</p></li>
</ul>
<p>Podemos hacer una última configuración: la aplicación permite definir reservas
de distinto tipo que se distinguen a la vista por el color. De hecho, por
defecto hay definidos dos tipos distintos: <em>Externa</em> e <em>Interna</em>. Por otro lado,
y al margen de los tipos, las reservas periódicas se distinguen de las reservas
puntuales tan sólo por un pequeño circulito que aparece a la derecha de la
leyenda. Dado que en nuestra situación las reservas periódicas sólo las realiza
el administrador y que son en realidad asignaciones fijas de aula, se nos antoja
que sería bastante conveniente hacer que se distinguieran también por el color,
así que definiremos los siguientes tipos de reserva:</p>
<ul class="simple">
<li><p>Tipo «Puntual», para que con ese tipo definan los profesores sus reservas de
aula (que forzosamente serán puntuales).</p></li>
<li><p>Tipo «Asignación fija», para que con ese tipo defina el administrador las
reservas que son periódicas.</p></li>
<li><p>Tipo «Festivo», para que el administrador reserve con este tipo todos los días
festivos, ya que la aplicación no tiene ninguna forma de marcar días
festivos e impedir la reserva en ellos.</p></li>
</ul>
<p>Hay, no obstante, un escollo para esto: que una reserva sea periódica o puntual
nada tiene que ver con su tipo, así que un profesor podría elegir el tipo
«Asignación fija» para hacer una reserva puntual. También podría hacer su
reserva escogiendo el tipo «Festivo». Para evitarlo, actuaremos sobre la
configuración añadiendo en <code class="file docutils literal notranslate"><span class="pre">config.inc.php</span></code> justo antes de la carga de
<code class="file docutils literal notranslate"><span class="pre">ies.inc.php</span></code> lo siguiente:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Tipos de reservas</span>
<span class="c1">#</span>
<span class="nb">unset</span><span class="p">(</span><span class="nv">$booking_types</span><span class="p">);</span>
<span class="nv">$booking_types</span><span class="p">[]</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">;</span>
<span class="nv">$booking_types</span><span class="p">[]</span><span class="o">=</span><span class="s2">&quot;I&quot;</span><span class="p">;</span>
<span class="nv">$booking_types</span><span class="p">[]</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">;</span>
<span class="nv">$default_type</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">;</span>

<span class="nv">$vocab_override</span><span class="p">[</span><span class="s2">&quot;es&quot;</span><span class="p">][</span><span class="s2">&quot;type.A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Asign.fija&quot;</span><span class="p">;</span>
<span class="nv">$vocab_override</span><span class="p">[</span><span class="s2">&quot;es&quot;</span><span class="p">][</span><span class="s2">&quot;type.I&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Puntual&quot;</span><span class="p">;</span>
<span class="nv">$vocab_override</span><span class="p">[</span><span class="s2">&quot;es&quot;</span><span class="p">][</span><span class="s2">&quot;type.F&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Festivo&quot;</span><span class="p">;</span>

<span class="c1"># Tipos que reserva exclusivamente el administrador</span>
<span class="nv">$auth</span><span class="p">[</span><span class="s1">&#39;admin_only_types&#39;</span><span class="p">][]</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">;</span>
<span class="nv">$auth</span><span class="p">[</span><span class="s1">&#39;admin_only_types&#39;</span><span class="p">][]</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La configuración está pensada para que el administrador, antes de que
los profesores empiecen a reservar aulas, establezca los festivos
(reservándolos como tipo «Festivo») y haga las asignaciones fijas (como
reservas periódicas). Al hacerlo ha de tener en cuenta dos cosas:</p>
<ul class="simple">
<li><p>Los festivos ha de marcarlos siempre como reservas puntuales, no
periódicas. Por ello, una Semana Santa, por ejemplo, deberá marcarla como
una reserva fija que dura una semana, y no como una reserva periódica de
día completo que se repite durante una semana con una frecuencia diaria.</p></li>
<li><p>Deberá establecer primero los festivos y después hacer las asignaciones
fijas, ya que una reserva periódica puede llevarse a cabo aunque haya
conflictos con reservas puntuales (simplemente, no se reservarán los días
ya ocupados), pero no al revés.</p></li>
</ul>
</div>
</section>
<section id="autenticacion-con-google-openid">
<h3><span class="section-number">7.2.2.3.9.4.3. </span>Autenticación con Google OpenID<a class="headerlink" href="#autenticacion-con-google-openid" title="Enlace permanente a este encabezado">¶</a></h3>
<p>Otra posible mejora consiste en cambiar la autenticación para que sea más
compleja que la simple de tener dos usuarios definidos en la propia
configuración. Nótese que el hecho de que todos los profesores compartan el
usuario con el que realizar las reservas supone que cualquiera podrá cancelar la
reserva que haya hecho previamente otro, ya que a ojos de la aplicación todos
serán el mismo sujeto.</p>
<p><abbr title="Meeting Room Booking System">MRBS</abbr> trae de serie algunas alternativas como la autenticación con <abbr title="Lightweight Directory Access Protocol">LDAP</abbr>, pero
puede ser interesante habilitar la autenticación con <em>Google</em> ya que la <a class="reference external" href="https://gsuite.google.es/intl/es/">G Suite</a> es <a class="reference external" href="https://support.google.com/a/answer/2856827">gratuita para centros educativos</a> y el centro puedo haber
asociado su dominio al servidor de correo de <em>Google</em> y hacer que todos sus
trabajadores dispongan de una cuenta del dominio autenticable con <em>Google</em>.
Desgraciadamente, <abbr title="Meeting Room Booking System">MRBS</abbr> no trae soporte para ello, pero hay disponible <a class="reference external" href="https://github.com/AllSaintsHoole/mrbs-google-identity">una extensión
que sí lo permite</a>.</p>
<p>La extensión afirma ser usable al menos para la versión <strong>1.6.1</strong>, pero lo
cierto es que el tema que trae consigo no funciona<a class="footnote-reference brackets" href="#id12" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a> ni con esa versión. En
cualquier caso, puede usarse este <a class="reference download internal" download="" href="../../../../_downloads/c2343e01e929353bdd682eb3926fca99/mrbs-google.tar.xz"><code class="xref download docutils literal notranslate"><span class="pre">arreglo</span> <span class="pre">para</span> <span class="pre">la</span> <span class="pre">extension</span></code></a> con estas diferencias respecto a la original:</p>
<ul class="simple">
<li><p>Sirve para la versión <strong>1.7.1</strong>.</p></li>
<li><p>Incluye un tema (<em>google</em>) que añade al tema predeterminado lo necesario
para que funcione esta autenticación.</p></li>
<li><p>Añade la función <em>authGetUserMail</em> para que puedan implementarse los avisos
mediante correo electrónico.</p></li>
<li><p>Permite que cualquier usuario declarado en el array <em>$auth[“admin”]</em> sea
considerado administrador<a class="footnote-reference brackets" href="#id13" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a>.</p></li>
<li><p>Al desautenticarnos de <abbr title="Meeting Room Booking System">MRBS</abbr>, también lo hacemos del propio sitio de
<em>Google</em>.</p></li>
</ul>
<p class="rubric">Instalación</p>
<ol class="arabic">
<li><p>Acudir a <a class="reference external" href="https://developers.google.com/identity/sign-in/web/sign-in#before_you_begin">google</a>
para abrir un proyecto y obtener un <em>ID</em> que será necesario luego al escribir
la configuración.</p></li>
<li><p>Descomprimir <a class="reference download internal" download="" href="../../../../_downloads/c2343e01e929353bdd682eb3926fca99/mrbs-google.tar.xz"><code class="xref download docutils literal notranslate"><span class="pre">la</span> <span class="pre">extensión</span></code></a>. Los
ficheros contenidos pueden copiarse dentro de <code class="file docutils literal notranslate"><span class="pre">/srv/www/mrbs</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>tar<span class="w"> </span>-C<span class="w"> </span>/srv/www/mrbs<span class="w"> </span>--strip-component<span class="o">=</span><span class="m">1</span><span class="w"> </span>-axvf<span class="w"> </span>mrbs-google.tar.xz
</pre></div>
</div>
</li>
<li><p>Borrar el fichero <code class="file docutils literal notranslate"><span class="pre">mrbs/edit_users.php</span></code> de la distribución original,
ya que deja de tener utilidad.</p></li>
<li><p>Descargar <a class="reference external" href="https://github.com/googleapis/google-api-php-client/blob/master/README.md">Google API PHP Client</a>
e incluir los ficheros dentro de <code class="file docutils literal notranslate"><span class="pre">srv/www/mrbs/google-api</span></code>. En
cualquier caso, la referencia a esta <abbr title="Application Programming Interface">API</abbr> se hace dentro del fichero
<code class="file docutils literal notranslate"><span class="pre">auth/auth_google.inc</span></code>.</p></li>
<li><p>Añadir la configuración necesaria en <code class="file docutils literal notranslate"><span class="pre">ies.inc.php</span></code>:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># Autenticación</span>
<span class="c1">#</span>
<span class="nv">$theme</span> <span class="o">=</span> <span class="s1">&#39;google&#39;</span><span class="p">;</span>  <span class="c1"># Este tema soporta la autenticación con google.</span>
<span class="nv">$auth</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;google&quot;</span><span class="p">;</span>
<span class="nv">$auth</span><span class="p">[</span><span class="s2">&quot;session&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="s2">&quot;google&quot;</span><span class="p">;</span>
<span class="nv">$google_domain</span> <span class="o">=</span> <span class="s1">&#39;midominio.es&#39;</span><span class="p">;</span>
<span class="nv">$google_client_id</span> <span class="o">=</span> <span class="s1">&#39;ID-OBTENIDO-DE-GOOGLE.apps.googleusercontent.com&#39;</span><span class="p">;</span>
<span class="nv">$auth</span><span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">][]</span> <span class="o">=</span> <span class="s2">&quot;soy.el.jefe@midominio.es&quot;</span><span class="p">;</span>

<span class="c1">#</span>
<span class="c1"># Configuración de los avisos por mail</span>
<span class="c1">#</span>
<span class="nv">$mail_settings</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;no-reply@midominio.es&#39;</span><span class="p">;</span>
<span class="nv">$mail_settings</span><span class="p">[</span><span class="s1">&#39;booker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>  <span class="c1"># Se envía correos al dueño de la reserva.</span>
<span class="c1"># Correos al crear o eliminar la reserva.</span>
<span class="nv">$mail_settings</span><span class="p">[</span><span class="s1">&#39;on_new&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="nv">$mail_settings</span><span class="p">[</span><span class="s1">&#39;on_delete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

<span class="nv">$mail_settings</span><span class="p">[</span><span class="s1">&#39;admin_lang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;es&#39;</span><span class="p">;</span>
<span class="c1"># Configuración del envío.</span>
<span class="nv">$mail_settings</span><span class="p">[</span><span class="s1">&#39;admin_backend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;smtp&#39;</span><span class="p">;</span>
<span class="nv">$smtp_settings</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;smtp.servidorcorreo.com&#39;</span><span class="p">;</span>
<span class="nv">$smtp_settings</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">465</span><span class="p">;</span>
<span class="nv">$smtp_settings</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="nv">$smtp_settings</span><span class="p">[</span><span class="s1">&#39;secure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ssl&#39;</span><span class="p">;</span>
<span class="nv">$smtp_settings</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;una_cuenta@servidorcorreo.com&#39;</span><span class="p">;</span>
<span class="nv">$smtp_settings</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;contraseña&#39;</span><span class="p">;</span>

<span class="c1"># $mail_settings[&#39;debug&#39;] = true;</span>
</pre></div>
</div>
<p>La primera parte de la configuración configura la autenticación en sí,
mientras que la segunda habilita el aviso por correo electrónico. En esta
segunda es necesario asegurarse de que los correos serán confiables y no
acabarán en la bandeja de <em>spam</em> de los usuarios. Un modo sencillo de
logararlo es utlizar una cuenta de correo que permita el envío por <abbr title="Simple Mail Transfer Protocol">SMTP</abbr>.</p>
</li>
</ol>
<p class="rubric">Problemas</p>
<ol class="arabic">
<li><p>Para que la autenticación sea efectiva es necesario que el navegador acepte
<em>cookies</em> de terceros o al menos <em>cookies</em> definidas para nuestro servidor
procedentes del dominio <em>accounts.google.con</em>. En <a class="reference external" href="https://www.mozilla.org/es-ES/firefox/new/">Firefox</a> esto es posible por defecto,
mientras que en <a class="reference external" href="https://www.google.com/chrome/">Chrome</a> se requiere acudir
a:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">chrome://settings/content/cookies</span>
</pre></div>
</div>
<p>y añadir en «<em>Permitir</em>» el dominio <em>accounts.google.com</em>.</p>
</li>
</ol>
<p class="rubric">Notas al pie</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id8" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">1</a><span class="fn-bracket">]</span></span>
<p>En el momento de la redacción es la versión <strong>1.7.1</strong>.</p>
</aside>
<aside class="footnote brackets" id="id9" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">2</a><span class="fn-bracket">]</span></span>
<p>Véase el valor de <kbd class="kbd docutils literal notranslate">$auth[&quot;type&quot;]</kbd> en <code class="file docutils literal notranslate"><span class="pre">systemdefaults.inc.php</span></code>.</p>
</aside>
<aside class="footnote brackets" id="id10" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">3</a><span class="fn-bracket">]</span></span>
<p>En versiones antiguas el <em>backend</em> predefinido era «user» que permitía
definir usuarios y contraseñas directamente en el archivo de configuración.
<code class="file docutils literal notranslate"><span class="pre">systemdefaults.inc.php</span></code> contenía la definición de algunos usuarios
como <em>administrator</em>/<em>secret</em> o <em>bob</em>/<em>b</em>.</p>
</aside>
<aside class="footnote brackets" id="id11" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">4</a><span class="fn-bracket">]</span></span>
<p>La variable <em>$default_room</em> define cuál es el aula que se mostrará, pero
su valor debe ser igual al identificador que se usa en la base de datos para
el aula en cuestión. Tal identificador no aparecen en la página del sitio,
pero puede consultarse mirando la propia base de datos o mirando los
parámentros de la dirección <abbr title="Uniform Resource Locator">URL</abbr> cuando se pincha para editar tal aula.
También existe una variable <em>$default_area</em> que permite definir la sede
predeterminada.</p>
</aside>
<aside class="footnote brackets" id="id12" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">5</a><span class="fn-bracket">]</span></span>
<p>Tal vez la incompatibilidad es en <abbr title="PHP Hypertext Preprocesor">PHP</abbr>.</p>
</aside>
<aside class="footnote brackets" id="id13" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">6</a><span class="fn-bracket">]</span></span>
<p>El comportamiento predeterminado es que sea administrador el primer
usuario que se autentique.</p>
</aside>
</aside>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../../../index.html">Tabla de contenido</a></h3>
    <ul>
<li><a class="reference internal" href="#">7.2.2.3.9. <abbr title="Meeting Room Booking System">MRBS</abbr></a><ul>
<li><a class="reference internal" href="#preliminares">7.2.2.3.9.1. Preliminares</a></li>
<li><a class="reference internal" href="#configuracion-en-nginx">7.2.2.3.9.2. Configuración en <strong class="program">nginx</strong></a></li>
<li><a class="reference internal" href="#instalacion">7.2.2.3.9.3. Instalación</a></li>
<li><a class="reference internal" href="#configuracion">7.2.2.3.9.4. Configuración</a><ul>
<li><a class="reference internal" href="#configuracion-en-la-interfaz-web">7.2.2.3.9.4.1. Configuración en la interfaz web</a></li>
<li><a class="reference internal" href="#personalizacion">7.2.2.3.9.4.2. Personalización</a></li>
<li><a class="reference internal" href="#autenticacion-con-google-openid">7.2.2.3.9.4.3. Autenticación con Google OpenID</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Tema anterior</h4>
    <p class="topless"><a href="06.foro.html"
                          title="capítulo anterior"><span class="section-number">7.2.2.3.8. </span>Foro</a></p>
  </div>
  <div>
    <h4>Próximo tema</h4>
    <p class="topless"><a href="08.dms.html"
                          title="próximo capítulo"><span class="section-number">7.2.2.3.10. </span><abbr title="Document Management System">DMS</abbr></a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/07.serre/02.web/02.nginx/03.misc/07.mrbs.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Ir a" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="08.dms.html" title="7.2.2.3.10. DMS"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="06.foro.html" title="7.2.2.3.8. Foro"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">7. </span>Servicios de red</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">7.2. </span>Web</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" ><span class="section-number">7.2.2. </span>nginx</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="index.html" ><span class="section-number">7.2.2.3. </span>Recetas</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7.2.2.3.9. </span><abbr title="Meeting Room Booking System">MRBS</abbr></a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2023, José Miguel Sánchez Alés.
      Creado usando <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>