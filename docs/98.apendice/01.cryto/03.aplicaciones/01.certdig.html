


<!DOCTYPE html>

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>9.1.3.1. Certificado digital &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css" />
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/translations.js"></script>
    
    <link rel="index" title="Índice" href="../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../search.html" />
    <link rel="next" title="9.1.3.2. Firma de documentos" href="02.pdf.html" />
    <link rel="prev" title="9.1.3. Aplicaciones de la criptografía" href="../03.aplicaciones.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="02.pdf.html" title="9.1.3.2. Firma de documentos"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="../03.aplicaciones.html" title="9.1.3. Aplicaciones de la criptografía"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" ><span class="section-number">9. </span>Apéndices</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" ><span class="section-number">9.1. </span>Criptografía</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../03.aplicaciones.html" accesskey="U"><span class="section-number">9.1.3. </span>Aplicaciones de la criptografía</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">9.1.3.1. </span>Certificado digital</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="certificado-digital">
<span id="cert-digital"></span><h1><span class="section-number">9.1.3.1. </span>Certificado digital<a class="headerlink" href="#certificado-digital" title="Enlazar permanentemente con este título">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Tratamos los <em>certificados digitales de clave pública</em>, por lo que a
partir de ahora hablaremos, simplemente, de <em>certificados digitales</em>.</p>
</div>
<p>Antes de pasar a las aplicaciones prácticas propiamente dichas, nos detendremos
en un concepto que usarán comúnmente tales aplicaciones. Téngase presente que a
pesar de que la suplantación de identidad parece resuelta gracias al cifrado
asimétrico, puesto que poder descifrar una firma  supone que el firmante sea el
propietario de tal clave pública, hay aún una debilidad: ¿cómo puede el
verificador estar seguro de que tal clave pública pertenece a quien parece
pertenecer? A fin de cuentas, la suplantación ha podido producirse en el momento
de la entrega de la clave pública y, si ha sido así, todo el proceso de
verificación de la identidad estará viciado. Para subsanar este último escollo
existen los <em>certificados digitales</em>.</p>
<section id="concepto">
<h2><span class="section-number">9.1.3.1.1. </span>Concepto<a class="headerlink" href="#concepto" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Un <em class="dfn">certificado digital</em> es un documento compuesto por una clave pública
(asociada a una clave privada) y unos datos que identifican al propietario de
tales claves, todo él firmado por un tercero que avala la veracidad de tal
identificación.</p>
<img alt="../../../_images/certificado.png" src="../../../_images/certificado.png" />
<p>Es importante tener presente que lo que hemos denominados <em>datos identificativos</em>
en el esquema no son exclusivamente datos referentes a la identidad del
propietario del certificado, sino que son también metadatos relativos al propio
certificado como cuáles son las fechas entre las que el certificado es válido o
cuáles son las finalidades lícitas para las que se puede usar. Por ejemplo, un
certificado puede o no estar habilitado para firmar otros certificados (es decir
para actuar como tercero de confianza).</p>
<p>De esta forma, el propietario no cede a los demás una simple clave pública, sino
un documento acreditativo (el certificado) para asegurar la legitimidad de la
clave, Es obvio que el problema de suplantación no se soluciona simplemente por
adjuntar los datos de identificación, sino porque un tercero avala la relación
entre la clave y la identidad firmando el conjunto. Por tanto, hemos trasladado
el problema de <strong>confianza</strong> desde las claves del propietario a las claves del
tercero firmante. Pero ¿cómo confiamos en el tercero?</p>
</section>
<section id="estrategias-de-confianza">
<h2><span class="section-number">9.1.3.1.2. </span>Estrategias de confianza<a class="headerlink" href="#estrategias-de-confianza" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Hay dos estrategias para conferir confianza a un tercero:</p>
<ol class="arabic" id="web-trust-strat">
<li><p>Una <strong>red de confianza</strong> totalmente descentralizada en que las relacionaes de
confianza entre los propietarios de las claves se establecen de igual a igual.
Así, si dos propietarios –«Pepe» y «Paco»– están seguros de la veracidad del
certificado del otro (por ejemplo, por un encuentro físico), podrán firmarse
los certificados y establecer una relación de confianza directa. Un tercer
propietario llamado «Manolo», que no haya entrado en contaco con «Paco», pero
si con «Pepe», tendrá una relación de confianza directa con «Pepe» y, en
consecuencia, también podrá confiar en la veracidad del certificado de «Paco»,
puesto que «Pepe» lo avala y él confía en «Pepe» (relación de confianza
indirecta). Los <a class="reference internal" href="03.correo.html#openpgp"><span class="std std-ref">certificados PGP</span></a>, de los que discutiremos al
tratar el <a class="reference internal" href="03.correo.html#email-seguro"><span class="std std-ref">correo electrónico</span></a>, fundamentan su
confiabialidad en <em>una red de confianza</em>.</p>
<img alt="../../../_images/webtrust.png" src="../../../_images/webtrust.png" />
</li>
<li id="pki-strat"><p>Una infraestructura <abbr title="Public Key Infraestructure">PKI</abbr>, que es una estructura jerárquica de confianza. En
ella, el tercero que acredita la identidad del propietario del certificado es
una <em class="dfn">autoridad de certificación</em> (<abbr title="Certification Authority">CA</abbr>). Esta <abbr title="Certification Authority">CA</abbr> a su vez gozará de
confianza, porque otra <abbr title="Certification Authority">CA</abbr> de nivel superior la haya acreditado firmándole el
certificado. Los <a class="reference external" href="https://www.ssl.com/faqs/what-is-an-x-509-certificate/">certificados X.509</a>, definidos en el
<span class="target" id="index-0"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc5280.html"><strong>RFC 5280</strong></a>, basan su confianza en <abbr title="Public Key Infraestructure">PKI</abbr>.</p>
<img alt="../../../_images/PKI.png" src="../../../_images/PKI.png" />
</li>
</ol>
<p>El resto de la exposición se centra en esta segunda estrategia jerárquica. Las
primera estrategia sólo es ampliamente utilizada en el correo electrónico, por
lo que la trataremos al hablar sobre <a class="reference internal" href="03.correo.html#email-seguro"><span class="std std-ref">el cifrado y la firma de mensajes de
correo electrónico</span></a>.</p>
</section>
<section id="infraestructura-pki">
<span id="pki"></span><h2><span class="section-number">9.1.3.1.3. </span>Infraestructura <abbr title="Public Key Infraestructure">PKI</abbr><a class="headerlink" href="#infraestructura-pki" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Centraremos nuestra atención exclusivamente en los <a class="reference external" href="https://www.ssl.com/faqs/what-is-an-x-509-certificate/">certificados
X.509</a>, aunque una infraestructura de este naturaleza puede hacerse con otro
tipo de certificados. Por ejemplo, los <a class="reference internal" href="../../../04.servidor/10.ssh/02.certificados.html#ssh-auth-certs"><span class="std std-ref">certificados SSH</span></a> fundamentan su
confiabilidad también en una infraestructura <abbr title="Public Key Infraestructure">PKI</abbr>. Se tratará de ellos al
analizar la <a class="reference internal" href="05.auth.html#auth-crypto"><span class="std std-ref">aplicación de la criptografía en la autenticación</span></a>.  Para la conversión entre claves generadas con Open<abbr title="Security SHell">SSH</abbr> y
Open<abbr title="Secure Socket Layer">SSL</abbr> puede consultar el <a class="reference internal" href="../../../04.servidor/10.ssh/02.certificados.html#openssh-openssl"><span class="std std-ref">epígrafe dedicado a ello</span></a>.</p>
</div>
<p>Retomando lo expuesto hasta ahora, un <em>certificado digital</em> se compone de:</p>
<ul class="simple">
<li><p>Una clave pública.</p></li>
<li><p>La identidad del propietario de dichas claves.</p></li>
<li><p>La firma digital de una <em>autoridad de certificación</em> sobre la clave pública y
los datos identificativos, que avala la relación entre la clave y la
identidad de su propietario.</p></li>
</ul>
<p>Ahora bien, ¿quién es esta <em>autoridad de certificación</em> y por qué es digna de
confianza? Una <em class="dfn">autoridad de certificación</em> (a partir de ahora, <abbr title="Certification Authority">CA</abbr>) es
aquella entidad de confianza encargada de emitir (y revocar) certificados
digitales. Para llevar a cabo esta tarea la propia <abbr title="Certification Authority">CA</abbr> dispone de un
certificado, de manera que con su clave privada asociada firma los certificados
que emite. La estructura es jerárquica y el certificado de una <abbr title="Certification Authority">CA</abbr> intermedia
estará avalado por la firma de otra <abbr title="Certification Authority">CA</abbr> de rango superior. Sin embargo, la
relación jerárquica no puede ser infinita por lo que al final de la cadena de
confianza siempre existirán unas <abbr title="Certification Authority">CA</abbr> raíz cuyos certificados son autofirmados,
esto es, certificados que nadie ha avalado digitalmente. La confianza en los
certificados raíz se debe a que los propios sistemas operativos y navegadores
web los incorporan de serie, porque de algún modo los fabricantes de este tipo
de <em>software</em> habrán efectuado la verificación. Así, <em>Debian</em> incluye el paquete
<a class="reference external" href="https://packages.debian.org/stable/ca-certificates">ca-certificates</a> con certificados raíz que reconoce como confiables.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Aunque un certificado raíz puede en teoría firmar certificados de
usuario, en la práctica una infraestructura <abbr title="Public Key Infraestructure">PKI</abbr> tiene siempre al menos un
certificado intermedio.</p>
</div>
<p>Un ejemplo de esta jerarquía es el <a class="reference internal" href="../../../07.serre/02.web/02.nginx/02.avanz/07.https.html#nginx-https"><span class="std std-ref">certificado gratuito para servidores
web</span></a> emitido por <a class="reference external" href="https://letsencrypt.org/">Let’s Encrypt</a> (descargable en <a class="reference external" href="http://r3.i.lencr.org/">esta dirección</a>), cuyo certificado a su vez está firmado por <a class="reference external" href="https://www.identrust.com/">Digital
Signature Trust</a> (la cual sí es una <abbr title="Certification Authority">CA</abbr> raíz):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>wget -qO letsencrypt.cer <span class="s2">&quot;http://r3.i.lencr.org/&quot;</span>
<span class="gp">$ </span>openssl x509 -inform der -in letsencrypt.cer -subject -issuer -noout
<span class="go">subject=C = US, O = Let&#39;s Encrypt, CN = R3</span>
<span class="go">issuer=O = Digital Signature Trust Co., CN = DST Root CA X3</span>
</pre></div>
</div>
<p>Sea como sea, las <abbr title="Certification Authority">CA</abbr> generan distintos tipos de certificados:</p>
<ul class="simple">
<li><p>Para otra <abbr title="Certification Authority">CA</abbr> subordinada.</p></li>
<li><p>Para persona física o jurídica.</p></li>
<li><p>Para firma de código.</p></li>
<li><p>Para servidor en red.</p></li>
</ul>
<p id="cert-clases">Además, suelen clasificar los certificados que emite dependiendo del grado de
verificación que haya exigido, del grado de seguridad de las claves que use o
de a quienes vayan dirigidos (para persona física, para administración pública,
etc). Tales clasificaciones no siguen unas mismas reglas, pero suelen coincidir
en la nomenclatura: «Clase 1», «Clase 2», «Clase 3», etc. donde mayor es el
cardinal cuanto mayor el grado de seguridad. Por ejemplo, una clasificación
podría ser la siguiente:</p>
<dl>
<dt><strong>Clase 1</strong></dt><dd><p>Certificado que acredita parcialmente la identidad mediante algún mecanismo
telemático. Por ejemplo, acredita la dirección de correo electrónico de una
persona o el nombre de dominio a un servidor. Sin embargo, no queda
constancia fehaciente de quién es la persona física propietaria del correo o
quién el propietario del dominio.</p>
</dd>
<dt><strong>Clase 2</strong></dt><dd><p>Exige una acreditación fehaciente de la identidad, generalmente mediante
asistencia física. Con un certificado de esta clase sí se puede asociar un
certificado personal a una persona física o un nombre de dominio a su empresa
propietaria.</p>
<p>Los certificados personales expedidos por la <abbr title="Fábrica Nacional de Moneda y Timbre">FNMT</abbr> podrían ser un ejemplo de
esta clase.</p>
</dd>
<dt><strong>Clase 3</strong></dt><dd><p>Para su expedición se exige el más alto grado de acreditación.y se usan los
algoritmos y claves más potentes.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Legalmente, en España el Ministerio competente reconoce una seríe de
<abbr title="Certification Authority">CA</abbr> cualificadas para emitir certificados con los cuales la firma digital
tiene exactamente la misma validez legal que la firma manuscrita (más
adelante <a class="reference internal" href="02.pdf.html#firma-legal"><span class="std std-ref">trataremos brevemente el estatus legal</span></a>), Una
de estas <abbr title="Certification Authority">CA</abbr> es <abbr title="CERtificación Española">CERES</abbr>, departamento de la <a class="reference external" href="http://www.cert.fnmt.es">Fábrica Nacional de Moneda y
Timbre</a>, que emite en España una buena parte de
los certificados para persona física gracias a una <a class="reference external" href="http://mapaoficinascert.appspot.com/">extensa red de oficinas
de registro</a> (<abbr title="Registration Authority">RA</abbr>) que incluye
oficinas de la Seguridad Social, de la Agencia Tributaria o ayuntamientos.</p>
</div>
<section id="certificados-personales">
<h3><span class="section-number">9.1.3.1.3.1. </span>Certificados personales<a class="headerlink" href="#certificados-personales" title="Enlazar permanentemente con este título">¶</a></h3>
<p>El proceso típico de emisión de un certificado personal es el siguiente:</p>
<ol class="arabic simple">
<li><p>El interesado realiza una solicitud a la <abbr title="Certification Authority">CA</abbr>, por lo general a través de
un servicio web, en que se recogen los datos identificativos y se genera una
pareja de claves. Ahora bien, como la identidad del interesado no ha podido
verificarse, la <abbr title="Certification Authority">CA</abbr> genera una petición <abbr title="Certificate Signing Request">CSR</abbr>.</p></li>
<li><p>El interesado se acerca físicamente a la oficina de una <abbr title="Registration Authority">RA</abbr> (autoridad de
registro) a fin de confirmar ante ésta que es quien dice ser.</p></li>
<li><p>La <abbr title="Registration Authority">RA</abbr> notifica a la <abbr title="Certification Authority">CA</abbr> tal verificación, con lo que esta pone a
disposición del interesado (p.e. a través del servicio web que utilizó
primeramente) el certificado solicitado.</p></li>
<li><p>El interesado obtiene el certificado y lo instala en su sistema (navegador,
cliente de correo, etc).</p></li>
</ol>
<img alt="../../../_images/certificados.png" src="../../../_images/certificados.png" />
<p>Por último, es necesario señalar que, para asegurar la validez de un
certificado, no basta sólo con comprobar si el certificado no ha caducado y la
cadena de confianza a través de las firmas que contienen los certificados de la
cadena. Un certificado puede haberse revocado antes de caducar y, en
consecuencia, dejar de haber sido válido antes de tiempo. Por eso, las <abbr title="Certification Authority">CA</abbr>
mantienen unas listas de revocación (<abbr title="Certificate Revocation List">CRL</abbr>) en que incluyen todos aquellos
certificados revocados con la fecha efectiva de revocación y la causa por la que
se produjo; y es preciso a efectos de corroborar la validez de un certificado
consultar tal lista. Para facilitarlo, las <abbr title="Certification Authority">CA</abbr> suelen ofrecer un servicio de
consulta a través del estándar <abbr title="Online Certificate Status Protocol">OCSP</abbr> descrito en el <span class="target" id="index-1"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6960.html"><strong>RFC 6960</strong></a>.</p>
<div class="admonition seealso">
<p class="admonition-title">Ver también</p>
<p>Más adelante realizaremos una <a class="reference internal" href="#verif-cert"><span class="std std-ref">verificación completa de la
validez de un certficado</span></a>.</p>
</div>
</section>
<section id="certificados-de-servidor">
<h3><span class="section-number">9.1.3.1.3.2. </span>Certificados de servidor<a class="headerlink" href="#certificados-de-servidor" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Estos certificados avalan la identidad de una máquina, esto es, que una máquina
(o un conjunto de máquinas, si estamos ante un servicio distribuido) responde a
un determinado nombre <abbr title="Domain Name Server">DNS</abbr>. Así, por ejemplo, cuando conectamos a la <a class="reference external" href="https://www.lamoncloa.gob.es">página
oficial de la Presidencia del Gobierno</a>, su
certificado de servidor avala que la máquina con la que conectamos es
<kbd class="kbd docutils literal notranslate">www.lamoncloa.gob.es</kbd> y no una impostora que ha logrado que conectemos a
ella <a class="reference internal" href="../../../08.redes/99.ataques/02.tecnicas/01.dns.html#dns-spoofing"><span class="std std-ref">envenenando nuestro DNS</span></a>.</p>
<p>En los certificados de servidor, lo que se acredita no es una identidad física,
sino uno o varios nombres, por lo que si consultamos uno (tal como se explica
en el próximo epígrafe), nos toparemos con que:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl x509 -in /etc/ssl/certs/letsencrypt-fullchain.crt -subject -ext subjectAltName -noout
<span class="go">subject=CN = lets2.iescdl.es</span>
<span class="go">X509v3 Subject Alternative Name:</span>
<span class="go">    DNS:azure.iescdl.es, DNS:lets.iescdl.es, DNS:lets2.iescdl.es</span>
</pre></div>
</div>
<p>La obtención de estos certificados necesita que la máquina acredite su
identidad, esto es, que acredite que el nombre <abbr title="Domain Name Server">DNS</abbr> resuelve a su <abbr title="Internet Protocol">IP</abbr>. Hay
distintos niveles de acreditación ya que quizás no sólo interesa acreditar la
propiedad del nombre <abbr title="Domain Name Server">DNS</abbr>, sino, por ejemplo, también la propiedad del nombre
comercial de la empresa para la que se quiere crear el sitio web (véanse las
<a class="reference internal" href="#cert-clases"><span class="std std-ref">clases de certificado</span></a>). Para el nivel más básico de
acreditación, esto es, aquel en que sólo se pretende acreditar la propiedad
sobre el nombre <abbr title="Domain Name Server">DNS</abbr>, es posible la acreditación puramente telemática. Para
ella, existe definido el protocolo <abbr title="Automated Certificate Management Environment">ACME</abbr>, descrito en <a class="reference internal" href="../../../07.serre/02.web/02.nginx/02.avanz/07.https.html#nginx-https"><span class="std std-ref">este epígrafe
sobre nginx</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Tenga presente que, aunque descritos dentro de la configuración de un
servidor web, estos certificados X.509 son válidos para cualquier protocolo
seguro basado en <abbr title="Secure Socket Layer">SSL</abbr>/<abbr title="Transport Layer Security">TLS</abbr>.</p>
</div>
<p>Para descargar el certificado asociado a un sitio web podemos usar el subcomando
<strong class="program">s_client</strong> de Open<abbr title="Secure Socket Layer">SSL</abbr>:</p>
<ol class="arabic">
<li><p>Para obtener el certificado del servidor:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl s_client -servername www.iescastillodeluna.es -connect www.iescastillodeluna.es:443 &lt; /dev/null &gt; cert.pem
<span class="go">depth=2 C = US, O = Internet Security Research Group, CN = ISRG Root X1</span>
<span class="go">verify return:1</span>
<span class="go">depth=1 C = US, O = Let&#39;s Encrypt, CN = R3</span>
<span class="go">verify return:1</span>
<span class="go">depth=0 CN = iescastillodeluna.es</span>
<span class="go">verify return:1</span>
<span class="go">DONE</span>
</pre></div>
</div>
<p>Además, obtendremos la verificación de toda la cadena de confianza. La opción
<kbd class="kbd docutils literal notranslate">-servername</kbd> permite pasar <a class="reference internal" href="04.ssl.html#sni"><span class="std std-ref">el valor de la extensión SNI</span></a>.</p>
</li>
<li><p>Para comprobar la cadena de confianza sin obtener el certificado podemos añadir
un par de opciones más:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl s_client -quiet -no_ign_eof -servername www.iescastillodeluna.es -connect www.iescastillodeluna.es:443 &lt; /dev/null
<span class="go">depth=2 C = US, O = Internet Security Research Group, CN = ISRG Root X1</span>
<span class="go">verify return:1</span>
<span class="go">depth=1 C = US, O = Let&#39;s Encrypt, CN = R3</span>
<span class="go">verify return:1</span>
<span class="go">depth=0 CN = iescastillodeluna.es</span>
<span class="go">verify return:1</span>
<span class="go">DONE</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Esta acción permite verificar el certificado y toda su cadena de
confianza de forma equivalente a la que se describe <a class="reference internal" href="#verif-cert"><span class="std std-ref">algo más
adelante</span></a> para archivos de certificados. Es bastante cómoda,
pero sólo nos sirve si se obtiene el certificado de un servidor.</p>
</div>
</li>
<li><p>Para obtener la cadena completa de certificados basta con añadir
la opción <kbd class="kbd docutils literal notranslate">-showcerts</kbd> a la primera orden:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl s_client -showcerts -servername www.iescastillodeluna.es -connect www.iescastillodeluna.es:443 &lt; /dev/null &gt; fullchain.pem
<span class="go">depth=2 C = US, O = Internet Security Research Group, CN = ISRG Root X1</span>
<span class="go">verify return:1</span>
<span class="go">depth=1 C = US, O = Let&#39;s Encrypt, CN = R3</span>
<span class="go">verify return:1</span>
<span class="go">depth=0 CN = iescastillodeluna.es</span>
<span class="go">verify return:1</span>
<span class="go">DONE</span>
</pre></div>
</div>
<p>Esto, no obstante, generará un <abbr title="Private Enhanced Mail">PEM</abbr> con todos los certificados
concatenados. Si queremos obtenerlos por separado, podemos pasar
la salida por <a class="reference internal" href="../../../02.conbas/10.texto/03.manipulacion.html#csplit"><span class="std std-ref">csplit</span></a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl s_client -showcerts -servername www.iescastillodeluna.es -connect www.iescastillodeluna.es:443 &lt; /dev/null <span class="p">|</span> <span class="se">\</span>
   csplit -fcert -b%02d.pem -sz - <span class="s1">&#39;/^-----B/&#39;</span> <span class="s1">&#39;{*}&#39;</span>
</pre></div>
</div>
<p>que generará los archivos <code class="file docutils literal notranslate"><span class="pre">cert01.pem</span></code>, <code class="file docutils literal notranslate"><span class="pre">cert02.pem</span></code>, etc. El
archivo <code class="file docutils literal notranslate"><span class="pre">cert00.pem</span></code> no contendrá certificado alguno, sino las líneas
anteriores al comienzo del primer certificado.</p>
</li>
</ol>
</section>
<section id="formatos">
<span id="x-509"></span><h3><span class="section-number">9.1.3.1.3.3. </span>Formatos<a class="headerlink" href="#formatos" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Los certificados digitales se presentan en distintos formatos de archivo que
conviene conocer, porque en ocasiones para hacer una determinada operación o
utilizarlo con cierta aplicación lo necesitaremos en uno concreto. Además, de la
descripción de estos formatos incluimos, a modo de vademécum, las órdenes más
comunes con <strong class="program">openssl</strong> para transformar del formato <abbr title="Private Enhanced Mail">PEM</abbr> (el estándar
común en el <em>software</em> libre) al resto de formatos y viceversa<a class="footnote-reference brackets" href="#id17" id="id1">1</a>:</p>
<dl>
<dt><abbr title="Private Enhanced Mail">PEM</abbr></dt><dd><p>Es el estándar desarrollado por los <span class="target" id="index-2"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc1421.html"><strong>RFC 1421</strong></a>, <span class="target" id="index-3"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc1422.html"><strong>RFC 1422</strong></a>, <span class="target" id="index-4"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc1423.html"><strong>RFC 1423</strong></a> y
<span class="target" id="index-5"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc1424.html"><strong>RFC 1424</strong></a> y muy usado por aplicaciones de <em>software</em> libre (p.e. los
certificados de servidor de <a class="reference internal" href="../../../07.serre/02.web/02.nginx/index.html#n-ginx"><span class="std std-ref">nginx</span></a> o <strong class="program">apache</strong> se
almacenan usando este estándar). Cuando se aseguran mediante cifrado
simétrico, sólo se cifra la clave privada. Los archivos <abbr title="Private Enhanced Mail">PEM</abbr> son, en realidad,
contenedores de certificados, de manera que a menudo contienen sólo la clave
privada, o sólo un certificado, o el certificado y la clave privada,
o el certificado, la clave privada y toda la cadena de certificados
de las <abbr title="Certification Authority">CA</abbr>s intermedias necesarias para la verificación.</p>
<p>Este estándar genera archivos (normalmente imprimibles mediante codificación
<a class="reference external" href="https://es.wikipedia.org/wiki/Base64">Base64</a>) y suele presentarse bajo estas extensiones:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.pem</span></code> tanto cuando contienen sólo el certificado (y,
opcionalmente, también los de la autoridad de certificación) como cuando
contienen, además, la clave privada. Los certificados están codificados en <a class="reference external" href="https://es.wikipedia.org/wiki/Base64">Base64</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">der</span></code> cuando contienen sólo el certificado o la clave privada, pero se
encuentran codificados en <abbr title="Distinguished Encoding Rules">DER</abbr>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.key</span></code> cuando el fichero contiene sólo la clave privada.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.cer</span></code> y <code class="docutils literal notranslate"><span class="pre">.crt</span></code> cuando contiene sólo el certificado.</p></li>
</ul>
<p>Los distintos certificados dentro del archivo son fácilmente distinguibles
porque su codificación <a class="reference external" href="https://es.wikipedia.org/wiki/Base64">Base64</a> se prologa con la marca <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">-</kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">BEGIN</kbd>
<kbd class="kbd docutils literal notranslate">CERTIFICATE</kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">-</kbd></kbd> y se cierra con <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">-</kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">END</kbd> <kbd class="kbd docutils literal notranslate">CERTIFICATE</kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">-</kbd></kbd> y con una
leyenda similar también se prologa y cierra la clave privada. No obstante lo
anterior, en ocasiones el certificado no se presenta codificado en <a class="reference external" href="https://es.wikipedia.org/wiki/Base64">Base64</a>
sino codificado en forma binaria (formato <abbr title="Distinguished Encoding Rules">DER</abbr>). De hecho, la codificación
en <a class="reference external" href="https://es.wikipedia.org/wiki/Base64">Base64</a> se obtiene a partir de la binaria añadiendo las leyendas de
prólogo y de cierre ya descritas<a class="footnote-reference brackets" href="#id18" id="id2">2</a>.</p>
<p>Cuando el certificado está en esta forma <abbr title="Distinguished Encoding Rules">DER</abbr>, el archivo sólo puede
contener o el certificado o la clave privada, ya que no hay marcas
<kbd class="kbd docutils literal notranslate">BEGIN</kbd>/<kbd class="kbd docutils literal notranslate">END</kbd> que puedan separar los distintos certificados.
<strong class="command">openssl</strong> presupone que la codificación es <a class="reference external" href="https://es.wikipedia.org/wiki/Base64">Base64</a>, así que cuando
se trabaja con este formato no hay que expresar que tiene esta codificación
(»<em>PEM</em>» como la llama el <strong class="command">openssl</strong>). En cambio, cuando utilicemos la
codificación <abbr title="Distinguished Encoding Rules">DER</abbr> necesitaremos indicarlo expresamente con <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">-inform</kbd>
<kbd class="kbd docutils literal notranslate">der</kbd></kbd>, si es un archivo de entrada, o <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">-outform</kbd> <kbd class="kbd docutils literal notranslate">der</kbd></kbd>, si es un archivo de
salida.</p>
<p>Algunas operaciones habituales con este tipo de certificado son:</p>
<ol class="arabic">
<li><p>Ver los datos públicos del certificado:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl x509 -in CERTIFICADO.pem -text -noout
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Si el archivo contiene varios certificados públicos, sólo
mostrará el primero presente en el archivo. Siga leyendo para saber
cómo ver el resto.</p>
</div>
</li>
<li id="openssl-hash-subject"><p>Generar el <em>hash</em> del campo «<em>Subject</em>»:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl x509 -in CERTIFICADO.pem -hash -noout
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Este <em>hash</em> es el que se usa para generar el nombre del enlace
simbólico en <code class="file docutils literal notranslate"><span class="pre">/etc/ssl/certs</span></code>. Véase más adelante <a class="reference internal" href="#catalogo-cert"><span class="std std-ref">catálogo
de certificados</span></a>.</p>
</div>
<p>También es posible generar el <em>hash</em> del campo «<em>Issuer</em>»<a class="footnote-reference brackets" href="#id19" id="id3">3</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl x509 -in CERTIFICADO.pem -issuer_hash -noout
</pre></div>
</div>
</li>
<li><p>Comprobar que una clave privada (en <code class="file docutils literal notranslate"><span class="pre">CERTIFICADO.key</span></code>) corresponde
a un certificado (en <code class="file docutils literal notranslate"><span class="pre">CERTIFICADO.pem</span></code>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl x509 -in CERTIFICADO.pem -modulus -noout <span class="p">|</span> md5sum
<span class="go">513830b5a6d44284ac84deb1566f34b6  -</span>
<span class="gp">$ </span>openssl rsa -in CERTIFICADO.key -modulus -noout <span class="p">|</span> md5sum
<span class="go">513830b5a6d44284ac84deb1566f34b6  -</span>
</pre></div>
</div>
<p>Si coinciden (como es el caso), entonces la clave privada es la
correspondiente.</p>
</li>
<li><p>Generar un archivo <code class="docutils literal notranslate"><span class="pre">.p12</span></code> a partir de los archivos <code class="docutils literal notranslate"><span class="pre">.pem</span></code> y <code class="docutils literal notranslate"><span class="pre">,key</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl pkcs12 -export -in CERTIFICADO.pem -inkey CERTIFICADO.key -out CERTIFICADO.p12
</pre></div>
</div>
<p>supuesto que tengamos certificado y clave privada en distinto archivo. Si
están contenidas en el mismo <abbr title="Private Enhanced Mail">PEM</abbr> basta la opción <kbd class="kbd docutils literal notranslate">-in</kbd>.
El archivo con el certificado puede contener también el certificado de
la(s) autoridad(es) de certificación. Si el certificado de la autoridad
está en archivo distinto, pero se quiere incluir dentro del resultado
puede referirse este tercer archivo mediante la opción <kbd class="kbd docutils literal notranslate">-CAfile</kbd>.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La orden requerirá interactivamente, en principio. dos
claves: una para descifrar la clave privada contenida en el <abbr title="Private Enhanced Mail">PEM</abbr> y
otra para cifrar <code class="file docutils literal notranslate"><span class="pre">CERTIFICADO.p12</span></code><a class="footnote-reference brackets" href="#id20" id="id4">4</a>.
Para pasar por la línea de órdenes las claves (útil en <em>scripts</em>)
utilice las opciones <kbd class="kbd docutils literal notranslate">-passin</kbd> y <kbd class="kbd docutils literal notranslate">-passout</kbd> y consulte la
sección «Pass Phrase Options» de <em class="manpage"><a class="manpage reference external" href="https://manpages.debian.org/openssl(1)">openssl(1)</a></em>.</p>
</div>
</li>
<li><p>Transformar el certificado <abbr title="Private Enhanced Mail">PEM</abbr> al formato <abbr title="Public-Key Cryptography Standards">PKCS</abbr> #7:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl crl2pkcs7 -nocrl -certfile CERTIFICADO.pem -out CERTIFICADO.p7b
</pre></div>
</div>
</li>
<li><p>Ver todos los certificados contenidos en el archivo <abbr title="Private Enhanced Mail">PEM</abbr>.  Esto se logra
traduciendo el certificado al formato <abbr title="Public-Key Cryptography Standards">PKCS</abbr> #7 primero, porque para
este formato <strong class="command">openssl</strong> sí muestra la información sobre todos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$  </span>openssl crl2pkcs7 -nocrl -certfile CHAIN.pem <span class="p">|</span> openssl pkcs7 -print_certs -text -noout
</pre></div>
</div>
</li>
<li><p>Transformar el certificado <abbr title="Private Enhanced Mail">PEM</abbr> en <a class="reference external" href="https://es.wikipedia.org/wiki/Base64">Base64</a> a codificación <abbr title="Distinguished Encoding Rules">DER</abbr>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl x509 -in CERTIFICADO.pem -outform der -out CERTIFICADO.crt
</pre></div>
</div>
</li>
<li><p>Trasformar la clave privada <abbr title="Private Enhanced Mail">PEM</abbr> en <a class="reference external" href="https://es.wikipedia.org/wiki/Base64">Base64</a> a codificación <abbr title="Distinguished Encoding Rules">DER</abbr>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl rsa -in CERTIFICADO.key -outform der -out CERTIFICADO.key.der
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>El formato resultante no estará cifrado y, por tanto, la
clave privada estará totalmente desprotegida.</p>
</div>
</li>
<li><p>Ver los datos del certificado (si usa codificación <abbr title="Distinguished Encoding Rules">DER</abbr>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl x509 -inform der -in CERTIFICADO.crt -text -noout
</pre></div>
</div>
</li>
<li><p>Trasformar un certificado público <abbr title="Distinguished Encoding Rules">DER</abbr> a <a class="reference external" href="https://es.wikipedia.org/wiki/Base64">Base64</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl x509 -inform der -in CERTIFICADO.crt -outform pem -out CERTIFICADO.pem
</pre></div>
</div>
</li>
<li><p>Trasformar la clave privada en codificación <abbr title="Distinguished Encoding Rules">DER</abbr> a <a class="reference external" href="https://es.wikipedia.org/wiki/Base64">Base64</a> protegiéndola
con un cifrado <abbr title="Advanced Encryption Standard">AES</abbr>256):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl rsa -inform der -in CERTIFICADO.key.der -outform pem -aes256 -out CERTIFICADO.key
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Consulte <em class="manpage"><a class="manpage reference external" href="https://manpages.debian.org/openssl-rsa(1)">openssl-rsa(1)</a></em> para ver qué otros parámetros
cifran la clave con algoritmos distintos.</p>
</div>
</li>
</ol>
</dd>
<dt><abbr title="Public-Key Cryptography Standards">PKCS</abbr> #12 (<code class="docutils literal notranslate"><span class="pre">.p12</span></code> o, frecuentemente en <em>Windows</em>, <code class="docutils literal notranslate"><span class="pre">.pfx</span></code>)</dt><dd><p>Formato originario de <a class="reference external" href="https://www.microsoft.com">Microsoft</a> que se acabó estandarizando mediante el
<span class="target" id="index-6"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7292.html"><strong>RFC 7292</strong></a> y contiene tanto el certificado como la clave privada asociada.
También puede contener certificados de <abbr title="Certification Authority">CA</abbr> intermedias. En este formato toda
la información contenida esta cifrada con una clave simétrica (a diferencia
del <abbr title="Private Enhanced Mail">PEM</abbr> que sólo cifra la clave privada) y es el que suelen usar los
navegadores para exportar e importar los certificados personales de los
usuarios.</p>
<p>Operaciones habituales:</p>
<ol class="arabic">
<li><p>Convertir el archivo <code class="docutils literal notranslate"><span class="pre">.p12</span></code> al formato <abbr title="Private Enhanced Mail">PEM</abbr><a class="footnote-reference brackets" href="#id21" id="id5">5</a> en un sólo archivo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl pkcs12 -in CERTIFICADO.p12 -out CERTIFICADO.pem
</pre></div>
</div>
</li>
<li><p>Ídem, pero separando en dos archivos la clave pública y la privada:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl pkcs12 -in CERTIFICADO.p12 -nocerts -out CERTIFICADO.key
<span class="gp">$ </span>openssl pkcs12 -in CERTIFICADO.p12 -nokeys -out CERTIFICADO.pem
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Al generar el <abbr title="Private Enhanced Mail">PEM</abbr> con el certificado se puede querer
no incluir los certificados de las <abbr title="Certification Authority">CA</abbr> intermedias añadiendo
<kbd class="kbd docutils literal notranslate">-clcerts</kbd>; o justo lo contrario y sólo incluir los certificados
intermedios (añadiendo <kbd class="kbd docutils literal notranslate">-cacerts</kbd>).</p>
</div>
</li>
<li><p>Ver los datos del certificado (no hay forma directa, así que hay
que traducir a <abbr title="Private Enhanced Mail">PEM</abbr> y obtener la información de la traducción):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl pkcs12 -in CERTIFICADO.p12 -clcerts -nokeys <span class="p">|</span> openssl x509 -text -noout
</pre></div>
</div>
</li>
</ol>
</dd>
<dt><abbr title="Public-Key Cryptography Standards">PKCS</abbr> #7</dt><dd><p>Formato estandarizado a través del <span class="target" id="index-7"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc2315.html"><strong>RFC 2315</strong></a> que sólo contiene el
certificado (no la clave privada). Suele usarse en sistemas <em>Windows</em> y
aplicaciones escritas en Java. Utiliza las extensiones:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.p7b</span></code> cuando está codificado en <a class="reference external" href="https://es.wikipedia.org/wiki/Base64">Base64</a>. En este caso el archivo puede
contener varios certificados públicos prologado y cerrado cada uno de ellos
con una leyenda semejante a la que vimos para el caso del formato <abbr title="Private Enhanced Mail">PEM</abbr>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.p7c</span></code> cuando contiene un único certificado público en codificación
<abbr title="Distinguished Encoding Rules">DER</abbr>. En este caso, debemos usar la opción <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">-inform</kbd> <kbd class="kbd docutils literal notranslate">der</kbd></kbd> para
informar a <strong class="command">openssl</strong>.</p></li>
</ul>
<p>Operaciones habituales:</p>
<ol class="arabic">
<li><p>Consultar los datos de los certificados incluidos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl pkcs7 -in CERTIFICADO.p7b -print_certs -text -noout
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>A diferencia de cuando se trata con el formato <abbr title="Private Enhanced Mail">PEM</abbr>, la
opción <kbd class="kbd docutils literal notranslate">-print_certs</kbd> para este tipo de formato muestra la
información de todos los certificados incluidos en el archivo.</p>
</div>
</li>
</ol>
<p># Consultar el dato del certificado codificado en <abbr title="Distinguished Encoding Rules">DER</abbr>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$  </span>openssl pkcs7 -inform der -in CERTIFICADO.p7c -print_certs -text -noout
</pre></div>
</div>
<ol class="arabic">
<li><p>Transformar el certificado <abbr title="Public-Key Cryptography Standards">PKCS</abbr> #7 al formato <abbr title="Private Enhanced Mail">PEM</abbr>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl pkcs7 -in certificate.p7b -print_certs -out certificate.pem
</pre></div>
</div>
</li>
</ol>
</dd>
</dl>
<div class="admonition seealso">
<p class="admonition-title">Ver también</p>
<p>Como referencia para este apartado se ha usado la <a class="reference external" href="https://serverfault.com/questions/9708/what-is-a-pem-file-and-how-does-it-differ-from-other-openssl-generated-key-file">extensa
respuesta a una pregunta formulada en serverfault</a></p>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Lo habitual es que los navegadores:</p>
<ul class="simple">
<li><p>Usen el formato <abbr title="Public-Key Cryptography Standards">PKCS</abbr>#12 para exportar e importar certificados
personales (que incluyen la clave privada).</p></li>
<li><p>Usen el formato <abbr title="Public-Key Cryptography Standards">PKCS</abbr>#7 para exportar e importar certificados de
terceros (que, en consecuencia, no incluyen la clave privada).</p></li>
</ul>
</div>
</section>
<section id="anatomia-del-certificado">
<span id="info-cert"></span><h3><span class="section-number">9.1.3.1.3.4. </span>Anatomía del certificado<a class="headerlink" href="#anatomia-del-certificado" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Consultar la información contenida en el certificado puede proporcionar datos
muy jugosos sobre el propio certificado y eso es lo que haremos con
<strong class="command">openssl</strong>, ya que, aunque el formato <abbr title="Private Enhanced Mail">PEM</abbr> sea imprimible sólo
es información binaria codificada en <a class="reference external" href="https://es.wikipedia.org/wiki/Base64">Base64</a>, por lo que un <a class="reference internal" href="../../../02.conbas/02.informacion/03.ficheros.html#cat"><span class="std std-ref">cat</span></a> es
de poca ayuda. La orden para consultar los datos del certificado ya se encuentra
escrita en el epígrafe anterior:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl x509 -in CERTFICADO.pem -text -noout
</pre></div>
</div>
<p>Si aplicamos esta orden sobre, por ejemplo, un certificado de servidor emitido por  <a class="reference external" href="https://letsencrypt.org/">Let’s
Encrypt</a> obtendremos lo siguiente:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            03:0f:0a:5a:7a:49:c4:c1:e3:77:a3:ae:0f:7b:94:db:6d:c5
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: C = US, O = Let&#39;s Encrypt, CN = R3
        Validity
            Not Before: Jan 18 10:03:44 2021 GMT
            Not After : Apr 18 10:03:44 2021 GMT
        Subject: CN = lets2.iescdl.es
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: (2048 bit)
                Modulus:
                    00:e0:ba:dd:c2:58:8e:93:81:8c:72:62:8a:93:44:
                    7f:46:42:bd:88:33:b8:56:be:7a:6b:3c:2f:dd:9f:
                    f6:50:8f:9e:ff:d4:08:67:4b:20:f5:45:57:33:6e:
                    26:21:bb:25:cc:6a:69:8b:7b:92:ce:a6:ae:8b:2f:
                    46:31:8c:ab:03:b5:9b:c1:31:5b:81:4d:d0:e9:69:
                    cd:92:a8:28:15:de:db:39:4c:5a:12:19:d0:95:f7:
                    13:bb:8c:a8:af:9c:7f:b4:b1:ff:c2:8a:e8:72:61:
                    40:5e:12:32:f6:3a:c4:c9:5c:d1:fd:7a:8a:ba:d5:
                    48:58:a8:4f:b9:e7:e7:ad:7b:cb:47:5a:18:5a:fd:
                    9b:5b:fc:c4:0f:4d:c8:1c:d4:5c:4f:26:4d:6b:cb:
                    9d:39:f0:c2:67:2a:9a:1e:33:3c:e1:b9:e5:82:88:
                    8c:02:63:f9:02:be:09:ed:07:5e:86:de:5c:20:16:
                    38:64:d9:82:99:31:ca:59:28:db:10:55:bb:87:a8:
                    65:ec:78:87:87:cf:a0:77:a5:fa:4a:a6:56:18:00:
                    18:3d:4f:d1:8e:49:30:64:5f:46:34:ae:51:73:1c:
                    51:5e:18:ca:1a:4c:0c:3b:d2:0a:95:9f:20:1d:83:
                    69:95:1d:b2:b8:7b:a3:56:c5:11:f8:87:11:97:d3:
                    12:c3
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Key Usage: critical
                Digital Signature, Key Encipherment
            X509v3 Extended Key Usage: 
                TLS Web Server Authentication, TLS Web Client Authentication
            X509v3 Basic Constraints: critical
                CA:FALSE
            X509v3 Subject Key Identifier: 
                E4:0B:D3:2C:DA:89:8A:80:4A:7A:76:AD:D1:9B:1C:32:5A:D2:82:C8
            X509v3 Authority Key Identifier: 
                keyid:14:2E:B3:17:B7:58:56:CB:AE:50:09:40:E6:1F:AF:9D:8B:14:C2:C6

            Authority Information Access: 
                OCSP - URI:http://r3.o.lencr.org
                CA Issuers - URI:http://r3.i.lencr.org/

            X509v3 Subject Alternative Name: 
                DNS:azure.iescdl.es, DNS:lets.iescdl.es, DNS:lets2.iescdl.es
            X509v3 Certificate Policies: 
                Policy: 2.23.140.1.2.1
                Policy: 1.3.6.1.4.1.44947.1.1.1
                  CPS: http://cps.letsencrypt.org

            CT Precertificate SCTs: 
                Signed Certificate Timestamp:
                    Version   : v1 (0x0)
                    Log ID    : 94:20:BC:1E:8E:D5:8D:6C:88:73:1F:82:8B:22:2C:0D:
                                D1:DA:4D:5E:6C:4F:94:3D:61:DB:4E:2F:58:4D:A2:C2
                    Timestamp : Jan 18 11:03:44.729 2021 GMT
                    Extensions: none
                    Signature : ecdsa-with-SHA256
                                30:45:02:20:1E:02:B9:E3:8E:72:85:FF:85:E6:33:63:
                                1E:52:BA:7C:91:01:BE:F1:C8:BC:9B:45:99:0F:4C:3A:
                                BB:7F:16:FB:02:21:00:EC:18:54:D9:86:65:63:B7:53:
                                C9:8B:62:C3:AA:9E:D8:95:1E:64:CB:EA:D7:B9:E0:71:
                                C0:72:CF:78:16:ED:F6
                Signed Certificate Timestamp:
                    Version   : v1 (0x0)
                    Log ID    : F6:5C:94:2F:D1:77:30:22:14:54:18:08:30:94:56:8E:
                                E3:4D:13:19:33:BF:DF:0C:2F:20:0B:CC:4E:F1:64:E3
                    Timestamp : Jan 18 11:03:44.723 2021 GMT
                    Extensions: none
                    Signature : ecdsa-with-SHA256
                                30:46:02:21:00:EA:A9:7C:3A:2E:5D:76:CE:E9:F8:C9:
                                4B:0D:7C:2C:48:DB:C9:3B:2A:3D:DA:06:3C:17:C4:33:
                                BA:E7:0D:FA:1C:02:21:00:BC:6B:0D:C1:4F:A3:F6:64:
                                E5:FC:9A:C9:24:61:83:0B:D2:9B:4D:35:2C:51:BA:E9:
                                93:43:6E:57:5D:31:F8:84
    Signature Algorithm: sha256WithRSAEncryption
         64:d5:bb:73:b6:45:9e:36:1e:92:53:bc:2a:82:1e:35:51:f3:
         ae:96:6c:62:25:55:cf:3a:21:67:2b:09:3f:da:f3:81:34:7a:
         b7:f7:07:72:db:6f:0b:d1:4f:d6:1e:6f:1a:8c:8c:a3:1d:09:
         29:4b:ac:b2:c9:65:4a:a6:9c:ab:49:60:54:e9:22:22:f1:39:
         33:09:1b:eb:95:bd:70:ff:fc:5f:6e:42:a2:5e:b5:63:35:4a:
         b1:fa:4f:4e:ed:34:a2:2d:35:78:3a:67:0d:f7:82:bb:03:bb:
         f1:d6:05:38:40:d5:2f:3f:34:51:9f:39:9b:a1:e1:10:a5:a8:
         07:21:71:fa:1f:1a:de:e7:8d:22:44:59:e9:8f:0a:d5:6a:f7:
         9d:35:80:54:a2:38:10:9d:b3:cb:3d:6e:e1:41:61:1c:60:9c:
         07:a0:bb:9d:f5:c0:04:6a:4f:4c:c7:50:70:4e:7f:1d:12:08:
         9e:8c:7b:ac:a8:cb:e8:7a:21:36:dd:da:e3:00:0b:a5:91:ff:
         5f:2d:23:47:b9:22:34:96:0d:80:ca:0d:16:8f:72:5f:88:68:
         c2:8c:fe:90:e4:82:b6:7b:30:10:87:46:64:28:17:cc:9b:db:
         96:e2:e5:cf:ca:22:93:ef:3e:ba:bf:15:61:fc:bc:88:03:dd:
         cd:03:c5:e1
</pre></div>
</div>
<p>Observando la salida se distinguen dos partes:</p>
<ul class="simple">
<li><p>Los datos en sí (<kbd class="kbd docutils literal notranslate">Data</kbd>).</p></li>
<li><p>La firma de tales datos (<kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">Signature</kbd> <kbd class="kbd docutils literal notranslate">Algorithm</kbd></kbd>) para lo cual han usado
como <a class="reference internal" href="../02.algo.html#hash"><span class="std std-ref">función hash el algoritmo sha256</span></a>.</p></li>
</ul>
<p>Dentro de los datos podemos distinguir:</p>
<ul class="simple">
<li><p>Datos propiamente identificativos como su número de serie o la identidad del
propietario del certificado (<code class="docutils literal notranslate"><span class="pre">Subject</span></code>).</p></li>
<li><p>Datos referentes al propio certificado como su validez o quién es el firmante
(<code class="docutils literal notranslate"><span class="pre">Issuer</span></code>)<a class="footnote-reference brackets" href="#id21" id="id6">5</a>.</p></li>
<li><p>La clave pública del certificado (<code class="docutils literal notranslate"><span class="pre">Subject</span> <span class="pre">Public</span> <span class="pre">Key</span> <span class="pre">Info</span></code>).</p></li>
</ul>
<p>Uno de los campos (<code class="docutils literal notranslate"><span class="pre">X509v3</span> <span class="pre">extensions</span></code>) contiene campos adicionales con
información de cualquiera de los tres tipos anteriores. Algunos de estos campos
ofrecen información interesante como:</p>
<ul class="simple">
<li><p>La <abbr title="Uniform Resource Locator">URL</abbr> en la que comprobar si el certificado está revocado (<code class="docutils literal notranslate"><span class="pre">Authority</span>
<span class="pre">Information</span> <span class="pre">Access</span></code>).</p></li>
<li><p>Un identificador para el propio certificado (<code class="docutils literal notranslate"><span class="pre">X509v3</span> <span class="pre">Subject</span> <span class="pre">Key</span> <span class="pre">Identifier</span></code>).</p></li>
<li><p>El identificador para el certificado con que la <abbr title="Certification Authority">CA</abbr> firmó (<code class="docutils literal notranslate"><span class="pre">X509v3</span> <span class="pre">Authority</span>
<span class="pre">Key</span> <span class="pre">Identifier</span></code>).</p></li>
</ul>
<p>La opción <code class="docutils literal notranslate"><span class="pre">-text</span></code> de <strong class="command">openssl</strong> devuelve toda la información, pero
podemos afinar (véase <em class="manpage"><a class="manpage reference external" href="https://manpages.debian.org/openssl-x509(1)">openssl-x509(1)</a></em>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl x509 -in CERTIFICADO.pem -subject -noout
<span class="go">subject=CN = lets2.iescdl.es</span>
<span class="gp">$ </span>openssl x509 -in CERTIFICADO.pem -dates -noout
<span class="go">notBefore=Jan 18 10:03:44 2021 GMT</span>
<span class="go">notAfter=Apr 18 10:03:44 2021 GM</span>
<span class="gp">$ </span>openssl x509 -in CERTIFICADO.pem -issuer -noout
<span class="go">issuer=C = US, O = Let&#39;s Encrypt, CN = R3</span>
<span class="gp">$ </span>openssl x509 -in CERTIFICADO.pem -pubkey -noout
<span class="go">-----BEGIN PUBLIC KEY-----</span>
<span class="go">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA4LrdwliOk4GMcmKKk0R/</span>
<span class="go">RkK9iDO4Vr56azwv3Z/2UI+e/9QIZ0sg9UVXM24mIbslzGppi3uSzqauiy9GMYyr</span>
<span class="go">A7WbwTFbgU3Q6WnNkqgoFd7bOUxaEhnQlfcTu4yor5x/tLH/worocmFAXhIy9jrE</span>
<span class="go">yVzR/XqKutVIWKhPuefnrXvLR1oYWv2bW/zED03IHNRcTyZNa8udOfDCZyqaHjM8</span>
<span class="go">4bnlgoiMAmP5Ar4J7Qdeht5cIBY4ZNmCmTHKWSjbEFW7h6hl7HiHh8+gd6X6SqZW</span>
<span class="go">GAAYPU/RjkkwZF9GNK5RcxxRXhjKGkwMO9IKlZ8gHYNplR2yuHujVsUR+IcRl9MS</span>
<span class="go">wwIDAQAB</span>
<span class="go">-----END PUBLIC KEY-----</span>
</pre></div>
</div>
<p>Los campos propios de la extensión también pueden obtenerse, aunque hay que
recurrir a <em class="manpage"><a class="manpage reference external" href="https://manpages.debian.org/x509v3_config(5)">x509v3_config(5)</a></em> para saber cuáles son sus nombres:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl x509 -in CERTIFICADO.pem -ext authorityInfoAccess -noout
<span class="go">Authority Information Access:</span>
<span class="go">    OCSP - URI:http://r3.o.lencr.org</span>
<span class="go">    CA Issuers - URI:http://r3.i.lencr.org</span>
</pre></div>
</div>
<p>En este caso, el campo nos indica cuál es la <abbr title="Uniform Resource Locator">URL</abbr> con el servicio <abbr title="Online Certificate Status Protocol">OCSP</abbr> donde
podemos comprobar si el certificado está revocado y dónde se encuentra el
certificado con el que firmo este certificado. No obstante lo anterior,
<strong class="command">openssl</strong> ya ofrece una opción para obtener directamente la <abbr title="Uniform Resource Locator">URL</abbr> con
el servicio <abbr title="Online Certificate Status Protocol">OCSP</abbr>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl x509 -in CERTIFICADO.pem -ocsp_uri -noout
<span class="go">http://r3.o.lencr.org</span>
</pre></div>
</div>
</section>
<section id="verificacion">
<span id="verif-cert"></span><h3><span class="section-number">9.1.3.1.3.5. </span>Verificación<a class="headerlink" href="#verificacion" title="Enlazar permanentemente con este título">¶</a></h3>
<p><strong class="command">openssl</strong> proporciona la suborden <code class="docutils literal notranslate"><span class="pre">verify</span></code> para verificar la validez
de un certificado en lo referente a las fechas y a la cadena de confianza de las <abbr title="Certification Authority">CA</abbr>.
Aún, sin embargo, el certificado puede ser invalido por haberse revocado. Por
ello, las <abbr title="Certification Authority">CA</abbr> mantienen una listas de revocación (<abbr title="Certificate Revocation List">CRL</abbr> por sus siglas en
inglés), donde se registran los números de serie de los certificados que han sido revocados y en qué
momento se ha realizado tal operación. En consecuencia, cuando se verifica un
certificado también ha de comprobarse si éste está incluido en la <abbr title="Certificate Revocation List">CRL</abbr>.</p>
<p>Como verificar la revocación mediante <abbr title="Certificate Revocation List">CRL</abbr> exige descargar la lista y
tiene que estar actualizada, existe el protocolo <abbr title="Online Certificate Status Protocol">OCSP</abbr> que permite consultar
directamente a la propia <abbr title="Certification Authority">CA</abbr> si el certficado está revocado. Esta es la
operación que pretendemos ilustrar bajo este epígrafe.</p>
<p>Supongamos que tenemos el certificado <code class="file docutils literal notranslate"><span class="pre">CERTIFICADO.pem</span></code> del epígrafe
anterior emitido por <a class="reference external" href="https://letsencrypt.org/">Let’s Encrypt</a>, la orden:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl verify CERTIFICADO.pem
</pre></div>
</div>
<p>comprobará si el certificado es válido utilizando los certificados raíz
instalados en el sistema (en una <em>Debian</em> en <code class="file docutils literal notranslate"><span class="pre">/etc/ssl/certs</span></code>). Sin
embargo, en este caso el certificado firmante de <a class="reference external" href="https://letsencrypt.org/">Let’s Encrypt</a> no es un
certificado raíz, ya que esta actúa como una <abbr title="Certification Authority">CA</abbr> subordinada. Por tal motivo,
fallará y requeriremos obtener también el certificado firmante. Es probable que
<code class="file docutils literal notranslate"><span class="pre">CERTIFICADO.pem</span></code> también contenga el de <cite>Let’s Encrypt</cite><a class="footnote-reference brackets" href="#id22" id="id7">6</a>, pero si no
fuera el caso, podríamos obtenerlo muy fácilmente de la  <abbr title="Uniform Resource Locator">URL</abbr>
<a class="reference external" href="http://r3.i.lencr.org">http://r3.i.lencr.org</a> según nos informa el propio
certificado. Con ambos certificados podríamos reintentar la verificación con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl verify -CAfile FIRMANTE.pem CERTIFICADO.pem
</pre></div>
</div>
<p>Esta comprobación ya funcionará, porque el certificado firmante sí está firmado
a su vez por un certificado raíz que posee el sistema. Si no fuera así,
podríamos ir añadiendo los sucesivos certificados de las <abbr title="Certification Authority">CA</abbr> intermedias dentro
de <code class="file docutils literal notranslate"><span class="pre">FIRMANTE.pem</span></code>.</p>
<p>Hay algunas variantes interesantes a esta orden:</p>
<ul>
<li><p>La opción <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">-no</kbd>-<kbd class="kbd docutils literal notranslate">CApath</kbd></kbd> evita que se usen los certificados raíz instalados
en el sistema. La verificación obligaría, pues, a incluir en
<code class="file docutils literal notranslate"><span class="pre">FIRMANTE.pem</span></code> también el certificado raíz de la <abbr title="Certification Authority">CA</abbr> pertinente.</p></li>
<li><p>La opción <kbd class="kbd docutils literal notranslate">-partial_chain</kbd> permite hacer la verificación, aunque no se
tenga la cadena completa de <abbr title="Certification Authority">CA</abbr>. Por consiguiente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl verify -no-CApath -partial_chain -CAfile FIRMANTE.pem CERTIFICADO.pem
</pre></div>
</div>
<p>podría verificar el certificado, aunque <code class="file docutils literal notranslate"><span class="pre">FIRMANTE.pem</span></code> no contuviera
también el certificado raíz.</p>
</li>
</ul>
<p>Lo anterior, no obstante, no puede verificar si el certificado ha sido revocado
y, por tanto, es a pesar de todo inválido. Para ello hay que recurrir a la <abbr title="Certification Authority">CA</abbr>
y en el caso de <cite>Let’s Encrypt</cite> la verificación es sencilla porque ofrece el
servicio a través del estándar <abbr title="Online Certificate Status Protocol">OCSP</abbr>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl ocsp -url <span class="s2">&quot;</span><span class="k">$(</span>openssl x509 -in CERTIFICADO.pem -ocsp_uri -noout<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
     -issuer FIRMANTE.pem -cert CERTIFICADO.pem
<span class="go">WARNING: no nonce in response</span>
<span class="go">Response verify OK</span>
<span class="go">azure.pem: good</span>
<span class="go">        This Update: Jan 21 11:00:00 2021 GMT</span>
<span class="go">        Next Update: Jan 28 11:00:00 2021 GMT</span>
</pre></div>
</div>
<p>Obsérvese que hay que proporcionar la <abbr title="Uniform Resource Locator">URL</abbr> con el servicio, el certificado que
se desea comprobar y el certificado firmante. Si el certificado estuviera revocado,
la verificación se completaría con éxito:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl verify -CAfile FIRMANTE.pem CERTIFICADO.pem
<span class="go">CERTFICADO.pem: OK</span>
</pre></div>
</div>
<p>pero al comprobarse su validez ante la autoridad certificadora:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl ocsp -url <span class="s2">&quot;</span><span class="k">$(</span>openssl x509 -in CERTIFICADO.pem -ocsp_uri -noout<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
     -issuer FIRMANTE.pem -cert CERTIFICADO.pem
<span class="go">WARNING: no nonce in response</span>
<span class="go">Response verify OK</span>
<span class="hll"><span class="go">CERTIFICADO.pem: revoked</span>
</span><span class="go">        This Update: Jan 25 11:34:36 2021 GMT</span>
<span class="go">        Next Update: Feb  1 11:34:36 2021 GMT</span>
<span class="hll"><span class="go">        Revocation Time: Jan 18 17:40:13 2021 GMT</span>
</span></pre></div>
</div>
<p>nos descubriría que el certificado ha sido revocado y cuándo lo fue<a class="footnote-reference brackets" href="#id23" id="id8">7</a>.
También se puede indicar cuál fue la razón de la revocación, como ocurre cuando
se revoca automáticamente un certificado digital de la <abbr title="Fábrica Nacional de Moneda y Timbre">FNMT</abbr> por haberse pedido
otro posteriormente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl ocsp -url <span class="s2">&quot;</span><span class="k">$(</span>openssl x509 -in josem.pem -ocsp_uri -noout<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
     -issuer FIRMANTE.pem -cert josem.pem
<span class="go">Response verify OK</span>
<span class="go">josem.pem: revoked</span>
<span class="go">        This Update: Nov  6 13:10:47 2021 GMT</span>
<span class="go">        Next Update: Nov  6 21:10:47 2021 GMT</span>
<span class="hll"><span class="go">        Reason: superseded</span>
</span><span class="go">        Revocation Time: Nov  3 08:07:08 2021 GMT</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Cerciórese de que el archivo <abbr title="Private Enhanced Mail">PEM</abbr> del certificado firmante no
contiene también el propio certificado u obtendrá un <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">Unauthorized</kbd>
<kbd class="kbd docutils literal notranslate">(6)</kbd></kbd>.</p>
</div>
</section>
<section id="creacion-de-una-pki">
<span id="cert-gen"></span><h3><span class="section-number">9.1.3.1.3.6. </span>Creación de una <abbr title="Public Key Infraestructure">PKI</abbr><a class="headerlink" href="#creacion-de-una-pki" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Para obtener certificados aceptables, ya sean personales o de
servidor, debe recurrirse a una <abbr title="Certification Authority">CA</abbr> reconocida, ya que tanto los unos como
los otros pueden obtenerse de forma sencilla gratuitamente. Este epígrafe
carece realmente de interés práctico real<a class="footnote-reference brackets" href="#id24" id="id9">8</a>, pero sirve para conocer cómo
funciona <em>por dentro</em> la solicitud de un certificado.</p>
</div>
<p>El propósito del epígrafe es generar un certificado de <abbr title="Certification Authority">CA</abbr> raíz, un certificado
de <abbr title="Certification Authority">CA</abbr> intermedia firmado con el anterior y, finalmente, certificados de
usuario y de servidor firmados con el segundo certificado.</p>
<p>El procedimiento de generación de certificados es siempre el mismo:</p>
<ol class="arabic simple">
<li><p>Se genera la clave privada del certificado</p></li>
<li><p>Se crea una solicitud de certificado <abbr title="Certificate Signing Request">CSR</abbr>.</p></li>
<li><p>Con la solicitud anterior y el certificado de la <abbr title="Certification Authority">CA</abbr> (incluida su necesaria
clave privada) se genera el certificado público.</p></li>
</ol>
<p>Antes, no obstante, crearemos un archivo de configuración <a class="reference download internal" download="" href="../../../_downloads/397467cf314a227790279ba82fc3d6d4/ssl.conf"><code class="xref download docutils literal notranslate"><span class="pre">ssl.conf</span></code></a>.</p>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>El archivo contiene una directiva que es un peligro de seguridad:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">copy_extension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">copy</span><span class="w"></span>
</pre></div>
</div>
<p>Esta directiva implica que las extensiones que añadamos en la solicitud se
copiarán en el certificado firmado. ¿Por qué es esto un peligro? Porque la
solicitud, en general, la realiza el interesado y. si nosotros (la CA) las
copiamos en el certificado final, éste puede añadir algo indeseable (como
<kbd class="kbd docutils literal notranslate">CA:TRUE</kbd>) para que el certificado le sirva para validar otros
certificados). Pero como en nuestro caso, vamos a hacer nosotros mismos
tanto la solicitud como la expedición, no hay este problema.</p>
</div>
<p>El archivo permite simplificar las respuestas al hacer una solicitud y define
cuáles serán los campos de extensión que deben contener los certificados.
Preparemos el directorio de trabajo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir -p store/<span class="o">{{</span>new,<span class="o">}</span>certs,crl,keys,csr<span class="o">}</span>
<span class="gp">$ </span>chmod <span class="m">700</span> store/keys
<span class="gp">$ </span><span class="nb">echo</span> <span class="m">1000</span> &gt; store/serial
<span class="gp">$ </span>touch store/index.txt
</pre></div>
</div>
<p>Empecemos pues:</p>
<dl>
<dt><strong>Certificado raíz</strong></dt><dd><p>Tiene la particularidad de que estará autofirmado:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl genrsa -aes256 -out store/ca.key <span class="m">4096</span>
<span class="gp">$ </span>chmod <span class="m">600</span> store/ca.key
<span class="gp">$ </span>openssl req -new -config ssl.conf -key store/ca.key -out store/csr/ca.csr
<span class="gp">$ </span>openssl x509 -req -sha256 -in store/csr/ca.csr -signkey store/ca.key <span class="se">\</span>
    -days <span class="m">3650</span> -extfile ssl.conf -extensions e_ca -out store/ca.crt
</pre></div>
</div>
<p>Esto nos permite obtener el certificado raíz (<code class="file docutils literal notranslate"><span class="pre">store/ca.crt</span></code>) con su
clave privada (<code class="file docutils literal notranslate"><span class="pre">store/ca.key</span></code>), cuyas rutas coinciden con las que hemos
indicado en el archivo de configuración, lo que nos evitará a partir de ahora
tener que especificarlas.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>En el archivo <a class="reference download internal" download="" href="../../../_downloads/397467cf314a227790279ba82fc3d6d4/ssl.conf"><code class="xref download docutils literal notranslate"><span class="pre">ssl.conf</span></code></a> se incluyen dos
secciones para definir los campos de extensión de un certificado de <abbr title="Certification Authority">CA</abbr>
(<kbd class="kbd docutils literal notranslate">[e_ca]</kbd> y <kbd class="kbd docutils literal notranslate">[e_inter]</kbd>). La única diferencia entre ellos es
el valor <kbd class="kbd docutils literal notranslate">pathlen:0</kbd>. Este parámetro determina los niveles de
confianza por debajo del certificado que lo contiene que pueden existir en
la cadena. Si el valor es <strong>0</strong>, entonces no puede haber ningún nivel
inferior y el certificado sólo podrá firmar certificados de usuario y no
certificados para una <abbr title="Certification Authority">CA</abbr> intermedia subordinada.</p>
</div>
</dd>
<dt><strong>Certificado intermedio</strong></dt><dd><p>Para esta <abbr title="Certification Authority">CA</abbr> subordinada crearemos su propia estructura de directorios,
análoga a la anterior:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir -p store/sub1/<span class="o">{{</span>new,<span class="o">}</span>certs,crl,keys,csr<span class="o">}</span>
<span class="gp">$ </span>chmod <span class="m">700</span> store/sub1/keys
<span class="gp">$ </span><span class="nb">echo</span> <span class="m">1000</span> &gt; store/sub1/serial
<span class="gp">$ </span>touch store/sub1/index.txt
</pre></div>
</div>
<p>Y, manteniendo el directorio de trabajo, generamos el certificado de la
subordinada:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl genrsa -out store/sub1/ca.key <span class="m">4096</span>
<span class="gp">$ </span>chmod <span class="m">600</span> store/sub1/ca.key
<span class="gp">$ </span>openssl req -new -config ssl.conf -key store/sub1/ca.key -out store/csr/inter1.csr
<span class="gp">$ </span>openssl ca -config ssl.conf -batch -notext -extensions e_inter -create_serial <span class="se">\</span>
   -out store/sub1/ca.crt -infiles store/csr/inter1.csr
</pre></div>
</div>
<p>Hay dos diferencias respecto al certificado raíz:</p>
<ul class="simple">
<li><p>La clave privada de este certificado no la cifraremos por comodidad (falta
la opción <kbd class="kbd docutils literal notranslate">-aes256</kbd>), porque será el que usemos para cifrar todos los
certificados de usuario. Obviamente, sería más conveniente sí cifrarla.</p></li>
<li><p>Cambia la orden para generar el certificado, a fin de que usemos el
certificado raíz para firmarlo.</p></li>
</ul>
<p>Una vez generado el certificado intermedio, como nuestra intención es usarlo
para generar los certificados de usuario, cambiamos de directorio de trabajo
y hacemos que <code class="file docutils literal notranslate"><span class="pre">sub1</span></code> haga el papel de <code class="file docutils literal notranslate"><span class="pre">store</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span> store
<span class="gp">$ </span>ln -s sub1 store
</pre></div>
</div>
</dd>
<dt><strong>Certificado personal</strong></dt><dd><p>Al haber cambiado de directorio de trabajo, el certificado de la <abbr title="Certification Authority">CA</abbr>
firmante, será el de la subordinada:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl genrsa -aes256 -out store/keys/<span class="k">$(</span>cat store/serial<span class="k">)</span>.key <span class="m">2048</span>
<span class="gp">$ </span>openssl req -new -config ../ssl.conf -key store/keys/<span class="k">$(</span>cat store/serial<span class="k">)</span>.key -out store/csr/<span class="k">$(</span>cat store/serial<span class="k">)</span>.csr <span class="se">\</span>
   -subj<span class="o">=</span><span class="s2">&quot;/C=ES/GN=MI NOMBRE/SN=MIS APELLIDOS/CN=APELLIDOS NOMBRE/emailAddress=midir@ecci.on&quot;</span>
<span class="gp">$ </span>openssl ca -config ../ssl.conf -batch -notext -extensions e_personal -infiles store/csr/<span class="k">$(</span>cat store/serial<span class="k">)</span>.csr
</pre></div>
</div>
<p>El certificado generado quedarán <code class="file docutils literal notranslate"><span class="pre">sub1/newcerts/1000.pem</span></code> y la clave
privada correspondiente donde la creamos (<code class="file docutils literal notranslate"><span class="pre">sub1/keys/1000.key</span></code>).
Obsérvese que:</p>
<ul class="simple">
<li><p>En vez de introducir de forma interactiva los datos para generar el
«Subject», lo incluimos como parámetro en la orden que genera la solicitud.</p></li>
<li><p>Volvemos a utilizar la suborden <strong class="command">ca</strong>, pero en esta ocasión no
especificamos el certificado de salida. Esto tiene el efecto de generarnos
el certificado con el nombre del identificador de serie (el <strong>1000</strong> en un
comienzo) y, además, de crear un nuevo identificador (el <strong>1001</strong>) sin
necesidad de incluir la opción <kbd class="kbd docutils literal notranslate">-create_serial</kbd>. Además, se creará un
índice que lista todos los certificados creados (<code class="file docutils literal notranslate"><span class="pre">store/index.txt</span></code>).</p></li>
</ul>
</dd>
<dt><strong>Certificado de servidor</strong></dt><dd><p>Utilizaremos la misma <abbr title="Certification Authority">CA</abbr> subordinada, aunque también podríamos generar una
distinta y dedicar una a los certificados de usuario, y otra a los de
servidor. La generación, en cualquier caso, es semejante al de un
certificado personal:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl genrsa -out store/keys/<span class="k">$(</span>cat store/serial<span class="k">)</span>.key <span class="m">2048</span>
<span class="gp">$ </span>openssl req -new -config ../ssl.conf -key store/keys/<span class="k">$(</span>cat store/serial<span class="k">)</span>.key -out store/csr/<span class="k">$(</span>cat store/serial<span class="k">)</span>.csr <span class="se">\</span>
   -subj<span class="o">=</span><span class="s2">&quot;/CN=www.example.net&quot;</span> -addext <span class="s2">&quot;subjectAltName=DNS:www.example.net,DNS:alt.example.net&quot;</span>
<span class="gp">$ </span>openssl ca -config ../ssl.conf -batch -notext -extensions e_server -infiles store/csr/<span class="k">$(</span>cat store/serial<span class="k">)</span>.csr
</pre></div>
</div>
<p>aunque:</p>
<ul class="simple">
<li><p>Naturalmente, no ciframos la clave privada.</p></li>
<li><p>Incluimos los nombres alternativos para el certificado en la orden de
solicitud (de ahí que luego necesitemos copiarla al generar el certificado<a class="footnote-reference brackets" href="#id25" id="id10">9</a>).</p></li>
</ul>
</dd>
<dt><strong>Revocación</strong></dt><dd><p>Del modo ilustrado podemos seguir generando más certificados de usuario. Si
generados los dos anteriores, comprobamos el archivo <code class="file docutils literal notranslate"><span class="pre">index.txt</span></code> que
lista los certificados generados por la <abbr title="Certification Authority">CA</abbr> subordinada obtendremos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat store/index.txt
<span class="go">V  220317174209Z                 1000    unknown /C=ES/SN=APELLIDOS/GN=NOMBRE/CN=APELLIDOS NOMBRE/emailAddress=midir@ecci.on</span>
<span class="go">V  220317174342Z                 1001    unknown /CN=www.example.net</span>
</pre></div>
</div>
<p>esto es, la lista de los certificados generados. Para revocar el primero de
ellos podemos hacer:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl ca -config ../ssl.cnf -revoke store/newcerts/1001.pem -crl_reason keyCompromise
</pre></div>
</div>
<p>lo cual provoca:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat store/index.txt
<span class="go">V  220317174209Z                              1000    unknown /C=ES/SN=APELLIDOS/GN=NOMBRE/CN=APELLIDOS NOMBRE/emailAddress=midir@ecci.on</span>
<span class="go">R  220317174342Z  210317175803Z,keyCompromise 1001    unknown /CN=www.example.net</span>
</pre></div>
</div>
<p>Podríamos generar la <abbr title="Certificate Revocation List">CRL</abbr>, aunque antes debemos generar
<code class="file docutils literal notranslate"><span class="pre">store/crlnumber</span></code> (que cumple un papel semejante a <code class="file docutils literal notranslate"><span class="pre">store/serial</span></code>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">echo</span> <span class="m">1000</span> &gt; store/crlnumber
<span class="gp">$ </span>openssl ca -config ../ssl.conf -gencrl -out store/crl/<span class="k">$(</span>cat store/crlnumber<span class="k">)</span>.crl
</pre></div>
</div>
<p>Esto generará <code class="file docutils literal notranslate"><span class="pre">store/crl/1000.crl</span></code> que contiene la lista de
certificados revocados:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl crl -in store/crl/1000.crl -text -noout
<span class="go">[...]</span>
<span class="go">Revoked Certificates:</span>
<span class="go">    Serial Number: 1001</span>
<span class="go">        Revocation Date: Mar 17 17:58:03 2021 GMT</span>
<span class="go">        CRL entry extensions:</span>
<span class="go">            X509v3 CRL Reason Code:</span>
<span class="go">                Key Compromise</span>
<span class="go">[...]</span>
</pre></div>
</div>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p><a class="reference external" href="https://sourceforge.net/projects/gnomint/">GnoMint</a> permite
gestiornar gráficamente una infraestructura <abbr title="Public Key Infraestructure">PKI</abbr>.</p>
</div>
</section>
<section id="catalogo-de-certificados">
<span id="catalogo-cert"></span><h3><span class="section-number">9.1.3.1.3.7. </span>Catálogo de certificados<a class="headerlink" href="#catalogo-de-certificados" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Ya se ha afirmado que los certificados raíz son fiables a pesar de estar
autofirmados, porque el propio sistema operativo (o aplicación particular<a class="footnote-reference brackets" href="#id26" id="id11">10</a>) los avala instalándolos de serie o a través de algún paquete oficial. Por
consiguiente, para que la entrategia <abbr title="Public Key Infraestructure">PKI</abbr> funcione, es necesario disponer
previamente de una colección de certificados a la cual se la denomina
<em class="dfn">catálogo de certificados</em>. Son tres<a class="footnote-reference brackets" href="#id27" id="id12">11</a> los catálogos más habituales:</p>
<ol class="arabic simple">
<li><p>El que usa el sistema <em>Windows</em> que por razones obvias no se trata en este
manual (vea para más información <a class="reference external" href="https://superuser.com/questions/411909/where-is-the-certificate-folder-in-windows-7">esta pregunta en superuser.com</a>),
aunque se le echa un <a class="reference internal" href="../../../guias/02.seg/03.crypto.html#cat-cert-windows"><span class="std std-ref">vistazo superficial</span></a> en la
<a class="reference internal" href="../../../guias/02.seg/index.html#seg"><span class="std std-ref">guía del módulo de Seguridad Informática</span></a>.</p></li>
<li><p>El de <a class="reference external" href="https://www.openssl.org">OpenSSL</a>, que constituye el catálogo general del sistema en <em>Linux</em>.
Muchas aplicaciones basadas en las librerías de <a class="reference external" href="https://www.openssl.org">OpenSSL</a> lo usan (empezando
por la propia orden <strong class="command">openssl</strong>)</p></li>
<li><p>El generado con la librería <abbr title="Network Secure Services">NSS</abbr>3, originaria de <a class="reference external" href="https://es.wikipedia.org/wiki/Netscape_Navigator">Netscape</a>, y que usan
navegadores como <a class="reference external" href="https://www.mozilla.org">Firefox</a> o <a class="reference external" href="https://www.chromium.org">Chromium</a><a class="footnote-reference brackets" href="#id28" id="id13">12</a>.</p></li>
</ol>
<p>Ciñéndonos a estos dos últimos. la diferencia fundamental entre ambos catálogos
es que el primero utiliza archivos <abbr title="Private Enhanced Mail">PEM</abbr> incluidos dentro de un directorio (o un
archivo <abbr title="Private Enhanced Mail">PEM</abbr> que contiene todos los certificados), mientras que el segundo
añade los certificados individuales a una base de datos y los gestiona a través
de ella.</p>
<div class="admonition seealso">
<p class="admonition-title">Ver también</p>
<p>Puede encontrar información adicional en el artículo <a class="reference external" href="https://fy.blackhats.net.au/blog/html/pages/nss_and_openssl_command_reference.html">NSS and
OpenSSL Command Reference</a>.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">Ver también</p>
<p><a class="reference external" href="https://www.happyassassin.net/posts/2015/01/12/a-note-about-ssltls-trusted-certificate-stores-and-platforms/">Esta entrada de Adam Williamson</a>
proporciona abundante información sobre dónde se encuentran los certificados
del catálogo de Open<abbr title="Secure Socket Layer">SSL</abbr> y también de <a class="reference external" href="https://packages.debian.org/stable/gnutls-bin">gnutls-bin</a><a class="footnote-reference brackets" href="#id29" id="id14">13</a>.</p>
</div>
<section id="catalogo-general">
<span id="cert-general"></span><h4><span class="section-number">9.1.3.1.3.7.1. </span>Catálogo general<a class="headerlink" href="#catalogo-general" title="Enlazar permanentemente con este título">¶</a></h4>
<p>El catálogo general de <em>Debian</em> se encuentra en el directorio <code class="file docutils literal notranslate"><span class="pre">/etc/ssl/certs</span></code>,
el cual contiene cada uno de los certificados confiables (en realidad, enlaces
simbólicos cuyo nombre es el <a class="reference internal" href="#openssl-hash-subject"><span class="std std-ref">hash de su campo «Subject»</span></a> apuntando adonde realmente se encuentran) y un archivo
<code class="file docutils literal notranslate"><span class="pre">ca-certificates.crt</span></code> en formato <abbr title="Private Enhanced Mail">PEM</abbr> que contiene concatenados todos los
certificados disponibles.  Adicionalmente, hay un archivo
<code class="file docutils literal notranslate"><span class="pre">/etc/ca-certificates.conf</span></code> en que se pueden vetar certificados (échele un
ojo al archivo para saber más sobre ello).</p>
<p>La orden <strong class="command">update-ca-certificates</strong> se encarga de recolectar los
certificados que se encuentren en <code class="file docutils literal notranslate"><span class="pre">/usr/share/certificates</span></code> y, además,
repasa el contenido de <code class="file docutils literal notranslate"><span class="pre">/usr/local/share/ca-certificates/</span></code> en busca de los
que deseemos añadir manualmente. Por tanto, si se necesitan añadir certificados
raíz adicionales basta con:</p>
<ol class="arabic">
<li><p>Se guarda el certificado público en formato <abbr title="Private Enhanced Mail">PEM</abbr> (codificado en <a class="reference external" href="https://es.wikipedia.org/wiki/Base64">Base64</a>)
dentro de <code class="file docutils literal notranslate"><span class="pre">/usr/local/share/ca-certificates/</span></code> con extensión <code class="docutils literal notranslate"><span class="pre">.crt</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>cp acraiz.pem /usr/local/share/ca-certificates/acraiz.crt
</pre></div>
</div>
</li>
<li><p>Se ejecuta:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>update-ca-certificates
</pre></div>
</div>
</li>
</ol>
<p>Para eliminar un certificado que previamente hubiéramos añadido basta borrarlo
de <code class="file docutils literal notranslate"><span class="pre">/usr/local/share/ca-certificates</span></code> y ejecutar:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>update-ca-certificates  --fresh
</pre></div>
</div>
</section>
<section id="nss">
<span id="cert-nss"></span><h4><span class="section-number">9.1.3.1.3.7.2. </span><abbr title="Network Secure Services">NSS</abbr><a class="headerlink" href="#nss" title="Enlazar permanentemente con este título">¶</a></h4>
<p>Hay aplicaciones que usan la librería <abbr title="Network Secure Services">NSS</abbr>3 para la gestión del almacén de
certificados. Tal es el caso de navegadores como <a class="reference external" href="https://www.chromium.org">Chromium</a>, <a class="reference external" href="https://www.mozilla.org">Firefox</a> o la
orden <a class="reference internal" href="02.pdf.html#pdfsig"><span class="std std-ref">pdfsig</span></a> para el soporte de firma digital en documentos
<abbr title="Portable Dcument Format">PDF</abbr>. Este almacén tiene la forma de una base de datos (modernamente <a class="reference external" href="https://www.sqlite.org">SQLite</a>).
Para la gestión de estos catálogos podemos instalar el paquete:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt install libnss3-tools
</pre></div>
</div>
<p>que trae la orden <strong class="command">certutil</strong>. La gestión de un catálogo de certificados
no es complicada con ella.</p>
<p>Empecemos por crear un almacén de claves <em>ex-novo</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir -p /tmp/nssdb
<span class="gp">$ </span>certutil -d sql:/tmp/nssdb -N --empty-password
</pre></div>
</div>
<p>La opción <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">-</kbd>-<kbd class="kbd docutils literal notranslate">empty</kbd>-<kbd class="kbd docutils literal notranslate">password</kbd></kbd> deja sin cifrar las claves privadas que
puedan almacenarse. De no usarse, se nos pedirá una clave maestra con que se
cifrarán las claves privadas de los certificados de usuario<a class="footnote-reference brackets" href="#id30" id="id15">14</a>. El catálogo se
encontrará, por ahora vacío, pero podemos importar un archivo <abbr title="Public-Key Cryptography Standards">PKCS</abbr> #12 con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>pk12util -d /tmp/nssdb -i micert.p12
</pre></div>
</div>
<p>lo cual importará no sólo el propio certificado, sino también todos los
certificados incluidos en ese archivo <abbr title="Public-Key Cryptography Standards">PKCS</abbr>#12. Eso sí, si está incluido el
certificado raíz, éste no tendrá los atributos pertinentes, así que habrá que
añadírselos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>certutil -d /tmp/nssdb -Mn <span class="s1">&#39;AC RAIZ FNMT-RCM - FNMT-RCM&#39;</span> -t <span class="s1">&#39;C,C,C&#39;</span>
</pre></div>
</div>
<p>Para referirnos a los certificados incluidos en el catálogo, se usa un nombre
(«AC RAIZ FNMT-RCM - FNMT-RCM» en esta orden) que conoceremos si listamos cuáles
el contenido:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>certutil -d /tmp/nssdb -L

<span class="go">Certificate Nickname                                         Trust Attributes</span>
<span class="go">                                                             SSL,S/MIME,JAR/XPI</span>
<span class="go">PERICO_DE_LOS_PALOTES                                        u,u,u</span>
<span class="go">AC FNMT Usuarios - FNMT-RCM                                  ,,</span>
<span class="go">AC RAIZ FNMT-RCM - FNMT-RCM                                  C,C,C</span>
</pre></div>
</div>
<p>En este caso, hay un certificado de usuario que se reconoce como tal
(<kbd class="kbd docutils literal notranslate">u,u,u</kbd>), porque la clave privada está también en la base de datos. Por
otro lado, una <abbr title="Certification Authority">CA</abbr> raíz debe tener los atributos <kbd class="kbd docutils literal notranslate">C,C,C</kbd>.</p>
<p>Si se quiere añadir un certificado individual debe usarse <strong class="command">certutil</strong>.
Por ejemplo, si el <code class="file docutils literal notranslate"><span class="pre">.p12</span></code> no hubiera incluido el certificado raíz,
podríamos haberlo añadido con la orden:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>certutil -d /tmp/nssdb -An <span class="s1">&#39;AC RAIZ FNMT-RCM - FNMT-RCM&#39;</span> -t <span class="s1">&#39;C,C,C&#39;</span> -i raiz.pem
</pre></div>
</div>
<p>donde <code class="file docutils literal notranslate"><span class="pre">raiz.pem</span></code> está en formato <abbr title="Private Enhanced Mail">PEM</abbr> con codificación <a class="reference external" href="https://es.wikipedia.org/wiki/Base64">Base64</a>.</p>
<p>Si queremos ver la información de un certificado individual, podemos hacer:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>certutil -d /tmp/nssdb -Ln <span class="s1">&#39;PERICO_DE_LOS_PALOTES&#39;</span>
</pre></div>
</div>
<p>lo cual nos mostrará su información legible tal como la muestra la opción
<kbd class="kbd docutils literal notranslate">-text</kbd> de <a class="reference internal" href="../02.algo.html#openssl"><span class="std std-ref">openssl</span></a>. Si en cambio deseamos obtenerlo en
formato <abbr title="Private Enhanced Mail">PEM</abbr> (para posteriormente tratarlo con <strong class="command">openssl</strong> por ejemplo),
debemos añadir la opción <kbd class="kbd docutils literal notranslate">-a</kbd>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>certutil -d /tmp/nssdb -aLn <span class="s1">&#39;PERICO_DE_LOS_PALOTES&#39;</span> &gt; perico.pem
</pre></div>
</div>
<p>También es posible consultar su cadena de confianza:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>certutil -d /tmp/nssdb -On <span class="s1">&#39;PERICO_DE_LOS_PALOTES&#39;</span>
</pre></div>
</div>
<p>El nombre con que debemos referirnos al certificado («PERICO_DE_LOS_PALOTES» en
este caso) nos puede resultar un poco engorroso. Podemos cambiarlo fácilmente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>certutil -d /tmp/nssdb --rename -n <span class="s1">&#39;PERICO_DE_LOS_PALOTES&#39;</span> --new-n <span class="s1">&#39;PERICO&#39;</span>
</pre></div>
</div>
<p>El catálogo es independiente del <a class="reference internal" href="#cert-general"><span class="std std-ref">catálogo del sistema</span></a>,
por lo que, si se desea que las aplicaciones que usen este catálogo <abbr title="Network Secure Services">NSS</abbr>
consulten los certificados que están en <code class="file docutils literal notranslate"><span class="pre">/etc/ssl/certs</span></code>, será
necesario el paquete <a class="reference external" href="https://packages.debian.org/stable/p11-kit-modules">p11-kit-modules</a> y añadir el uso del módulo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>modutil -dbdir /tmp/nssdb/ -add <span class="s1">&#39;PKCS#11 Trust Module&#39;</span> -libfile /usr/lib/x86_64-linux-gnu/pkcs11/p11-kit-trust.so
</pre></div>
</div>
<p>De este modo, en nuestro catálogo de ejemplo será prescindible el certificado
«AC RAIZ FNMT-RCM - FNMT-RCM», porque éste debe estar incluido ya en el
catálogo general. Por tanto, podremos borrarlo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>certutil -d /tmp/nssdb -Dn <span class="s1">&#39;AC RAIZ FNMT-RCM - FNMT-RCM&#39;</span>
</pre></div>
</div>
<p>También puede interesarnos exportar como <kbd class="kbd docutils literal notranslate">.p12</kbd> un certificado que se
encuentre en la base de datos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>pk12util -d /tmp/nssdb -o micert_exportado.p12 -n <span class="s1">&#39;PERICO&#39;</span>
</pre></div>
</div>
<p>Tanto <a class="reference external" href="https://www.mozilla.org">Firefox</a> como <a class="reference external" href="https://www.chromium.org">Chromium</a><a class="footnote-reference brackets" href="#id31" id="id16">15</a> usan catálogos de este tipo en los que
almacenan los certificados añadidos a través del navegador (p.e. los
certificados personales). La gestión, a través de su interfaz gráfica, es
bastante sencilla, con lo que se hace innecesario el uso de
<strong class="command">certutil</strong>.  Presentan, no obstante, algunas diferencias:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.mozilla.org">Firefox</a> trae su propia lista de certificados raíz y no consulta los del
sistema. Por otra parte, cada perfil consulta un catálogo distinto que se
encuentra en el propio directorio del perfil.</p></li>
<li><p><a class="reference external" href="https://www.chromium.org">Chromium</a>, en cambio, sí carga los certificados del sistema y a éstos añade
los que se hayan instalado en su catálogo <abbr title="Network Secure Services">NSS</abbr>. Además, todos los perfiles
creados por un mismo usuario comparten el catálogo cuya ruta es
<code class="file docutils literal notranslate"><span class="pre">~/.pki/nssdb</span></code>.</p></li>
</ul>
<div class="admonition note" id="seg-cat-chromium">
<p class="admonition-title">Nota</p>
<p>Por defecto, <a class="reference external" href="https://www.chromium.org">Chromium</a> crea un catálogo <abbr title="Network Secure Services">NSS</abbr> que no tiene cifradas
las claves privadas contenidas, lo cual puede parecernos
inseguro, puesto que con una sesión abierta un tercero podrá usar el
certificado o incluso exportar una copia. No parece haber en su interfaz
gráfica un modo de evitar o corregir esto, pero si al catálogo se le define
una contraseña maestra, es capaz de preguntarnos por ella cuando la necesite.
Utilizando <strong class="command">certutil</strong> podemos establecer una contraseña del
siguiente modo (asegúrese de cerrar primero el navegador):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>certutil -d ~/.pki/nssdb -W
</pre></div>
</div>
<p>La orden nos pedirá primero la contraseña actual (que estará vacía por lo que
basta con pulsar directamente <kbd class="kbd docutils literal notranslate">Enter</kbd>). A continuación, podremos fijar
la contraseña con la que deseamos cifrar y comprobarla abriendo en el
navegador <a class="reference external" href="chrome://settings/certificates">chrome://settings/certificates</a>.</p>
</div>
<p class="rubric">Notas al pie</p>
<dl class="footnote brackets">
<dt class="label" id="id17"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Las órdenes sólo exponen cómo hacer conversiones entre formatos y ver los
datos del certificado. Por supuesto, se hay otras operaciones interesantes
como crear certificados o verificar su validez.</p>
</dd>
<dt class="label" id="id18"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>Hasta el punto es así que, si tenemos un certificado en codificación
binaria, podemos transformarlo manualmente a su forma en <a class="reference external" href="https://es.wikipedia.org/wiki/Base64">Base64</a> así:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="o">{</span> <span class="nb">echo</span> <span class="s1">&#39;-----BEGIN CERTIFICATE-----&#39;</span>
<span class="go">    base64 -w64 CERTIFICADO.cer</span>
<span class="go">    echo &#39;-----END CERTIFICATE-----&#39;; } &gt; CERTFICADO.pem</span>
</pre></div>
</div>
<p>Échele un ojo a <a class="reference internal" href="../02.algo.html#formato-pem"><span class="std std-ref">lo comentado para este formato al hablar de las
claves RSA</span></a>.</p>
</dd>
<dt class="label" id="id19"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p>Si el firmante es un certificado raíz puede resultarnos útil calcular su
<em>hash</em> para a través de él identificarlo en el sistema (véase el
<a class="reference internal" href="#cert-general"><span class="std std-ref">catálogo general del sistema</span></a>).</p>
</dd>
<dt class="label" id="id20"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p>Añadir la opción <kbd class="kbd docutils literal notranslate">-nodes</kbd> deja la clave privada sin cifrar, pero
posiblemente no sea una buena idea.</p>
</dd>
<dt class="label" id="id21"><span class="brackets"><a class="fn-backref" href="#id6">5</a></span></dt>
<dd><p>En un certificado autofirmado <code class="docutils literal notranslate"><span class="pre">Subject</span></code> e <code class="docutils literal notranslate"><span class="pre">Issuer</span></code> coincidirán.</p>
</dd>
<dt class="label" id="id22"><span class="brackets"><a class="fn-backref" href="#id7">6</a></span></dt>
<dd><p>Basta con hacer un <a class="reference internal" href="../../../02.conbas/02.informacion/03.ficheros.html#cat"><span class="std std-ref">cat</span></a> y ver si hay uno o dos certificados
en el archivo.</p>
</dd>
<dt class="label" id="id23"><span class="brackets"><a class="fn-backref" href="#id8">7</a></span></dt>
<dd><p>Es importante tal fecha porque el certificado fue válido hasta ese
momento. Por tanto, una firma formalizada con el certificado antes, es
perfectamente válida.</p>
</dd>
<dt class="label" id="id24"><span class="brackets"><a class="fn-backref" href="#id9">8</a></span></dt>
<dd><p>Aunque no en todos los casos. Por ejemplo, para la instalación de un
<a class="reference internal" href="../../../07.serre/04.vpn/01.openvpn/index.html#openvpn"><span class="std std-ref">servidor OpenVPN</span></a> se utiliza la técnica de crear una <abbr title="Certification Authority">CA</abbr>
raíz que genera el certificado del servidor y todos certificados para los
clientes. Sin embargo, se incluye un <em>script</em> (en el paquete <a class="reference external" href="https://packages.debian.org/stable/easy-rsa">easy-rsa</a>)
para automatizar la generación de los certificados con lo que no es necesario
utilizar (y conocer) <strong class="program">openssl</strong>.</p>
</dd>
<dt class="label" id="id25"><span class="brackets"><a class="fn-backref" href="#id10">9</a></span></dt>
<dd><p>No hay un modo sencillo de incluir en la línea de la orden de generación
del certificado los nombres alternativos, que sería lo suyo.</p>
</dd>
<dt class="label" id="id26"><span class="brackets"><a class="fn-backref" href="#id11">10</a></span></dt>
<dd><p><a class="reference external" href="https://www.mozilla.org">Firefox</a>, por ejemplo, trae su propio catálogo de certificados raíz y no
atiende a los que haya instalados en el sistema operativo. <a class="reference external" href="https://www.chromium.org">Chromium</a>, en
cambio, sí lo hace.</p>
</dd>
<dt class="label" id="id27"><span class="brackets"><a class="fn-backref" href="#id12">11</a></span></dt>
<dd><p>En realidad 4, si añadimos el catalogo propio de <em>MacOs</em> que se gestiona
con <a class="reference external" href="https://kb.wisc.edu/helpdesk/page.php?id=2197">Keychain</a>.</p>
</dd>
<dt class="label" id="id28"><span class="brackets"><a class="fn-backref" href="#id13">12</a></span></dt>
<dd><p><a class="reference external" href="https://www.chromium.org">Chromium</a>, en realidad, se comporta de distinto modo según actúe en
<em>Linux</em> o en <em>Windows</em>. En este segundo usa exclusivamente el catálogo del
sistema. En <em>Linux</em>, sin embargo, usa un <a class="reference internal" href="#cert-nss"><span class="std std-ref">catálogo NSS</span></a> para
los certificados instalados con el propio navegador y consulta el catálogo
del sistema para buscar certificados de <abbr title="Certification Authority">CA</abbr> raíz.</p>
</dd>
<dt class="label" id="id29"><span class="brackets"><a class="fn-backref" href="#id14">13</a></span></dt>
<dd><p>Esta aplicación, como Open<abbr title="Secure Socket Layer">SSL</abbr> también permite gestionar certificados
y podríamos haber construido un apéndice práctico con ella en sustitución de
Open<abbr title="Secure Socket Layer">SSL</abbr>.</p>
</dd>
<dt class="label" id="id30"><span class="brackets"><a class="fn-backref" href="#id15">14</a></span></dt>
<dd><p>Más adelante, no obstante, podrá añadirse (o cambiarse) la contraseña
maestra para el  cifrado de las claves privadas. Véase <a class="reference internal" href="#seg-cat-chromium"><span class="std std-ref">la nota de
seguridad al catálogo de Chromium</span></a>.</p>
</dd>
<dt class="label" id="id31"><span class="brackets"><a class="fn-backref" href="#id16">15</a></span></dt>
<dd><p><a class="reference external" href="https://www.chromium.org">Chromium</a> en <em>Windows</em> usa directamente el catálogo proporcionado por
el sistema e instala y desinstala certificados en él.</p>
</dd>
</dl>
</section>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../../index.html">Tabla de contenido</a></h3>
    <ul>
<li><a class="reference internal" href="#">9.1.3.1. Certificado digital</a><ul>
<li><a class="reference internal" href="#concepto">9.1.3.1.1. Concepto</a></li>
<li><a class="reference internal" href="#estrategias-de-confianza">9.1.3.1.2. Estrategias de confianza</a></li>
<li><a class="reference internal" href="#infraestructura-pki">9.1.3.1.3. Infraestructura <abbr title="Public Key Infraestructure">PKI</abbr></a><ul>
<li><a class="reference internal" href="#certificados-personales">9.1.3.1.3.1. Certificados personales</a></li>
<li><a class="reference internal" href="#certificados-de-servidor">9.1.3.1.3.2. Certificados de servidor</a></li>
<li><a class="reference internal" href="#formatos">9.1.3.1.3.3. Formatos</a></li>
<li><a class="reference internal" href="#anatomia-del-certificado">9.1.3.1.3.4. Anatomía del certificado</a></li>
<li><a class="reference internal" href="#verificacion">9.1.3.1.3.5. Verificación</a></li>
<li><a class="reference internal" href="#creacion-de-una-pki">9.1.3.1.3.6. Creación de una <abbr title="Public Key Infraestructure">PKI</abbr></a></li>
<li><a class="reference internal" href="#catalogo-de-certificados">9.1.3.1.3.7. Catálogo de certificados</a><ul>
<li><a class="reference internal" href="#catalogo-general">9.1.3.1.3.7.1. Catálogo general</a></li>
<li><a class="reference internal" href="#nss">9.1.3.1.3.7.2. <abbr title="Network Secure Services">NSS</abbr></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Tema anterior</h4>
    <p class="topless"><a href="../03.aplicaciones.html"
                          title="capítulo anterior"><span class="section-number">9.1.3. </span>Aplicaciones de la criptografía</a></p>
  </div>
  <div>
    <h4>Próximo tema</h4>
    <p class="topless"><a href="02.pdf.html"
                          title="próximo capítulo"><span class="section-number">9.1.3.2. </span>Firma de documentos</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/98.apendice/01.cryto/03.aplicaciones/01.certdig.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Ir a" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="02.pdf.html" title="9.1.3.2. Firma de documentos"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="../03.aplicaciones.html" title="9.1.3. Aplicaciones de la criptografía"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" ><span class="section-number">9. </span>Apéndices</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" ><span class="section-number">9.1. </span>Criptografía</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../03.aplicaciones.html" ><span class="section-number">9.1.3. </span>Aplicaciones de la criptografía</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">9.1.3.1. </span>Certificado digital</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2022, José Miguel Sánchez Alés.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>