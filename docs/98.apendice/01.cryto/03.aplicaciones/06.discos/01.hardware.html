

<!DOCTYPE html>

<html lang="es" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>9.1.3.6.1. Cifrado por hardware &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/classic.css?v=2bf1fcf8" />
    <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
    
    <script src="../../../../_static/documentation_options.js?v=a621b78a"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/translations.js?v=f85f4cfb"></script>
    
    <link rel="index" title="Índice" href="../../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../../search.html" />
    <link rel="next" title="9.1.3.6.2. Cifrado de bloques" href="02.luks.html" />
    <link rel="prev" title="9.1.3.6. Cifrado de discos" href="../06.discos.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="02.luks.html" title="9.1.3.6.2. Cifrado de bloques"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="../06.discos.html" title="9.1.3.6. Cifrado de discos"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">9. </span>Apéndices</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">9.1. </span>Criptografía</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../../03.aplicaciones.html" ><span class="section-number">9.1.3. </span>Aplicaciones de la criptografía</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="../06.discos.html" accesskey="U"><span class="section-number">9.1.3.6. </span>Cifrado de discos</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">9.1.3.6.1. </span>Cifrado por <em>hardware</em></a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="cifrado-por-hardware">
<h1><span class="section-number">9.1.3.6.1. </span>Cifrado por <em>hardware</em><a class="headerlink" href="#cifrado-por-hardware" title="Link to this heading">¶</a></h1>
<p>También conocido como <em>autocifrado</em>. Gracias a que es el propio <em>hardware</em> del
disco el que encarga de su cifrado, la estrategia es totalmente transparente
para el sistema operativo y es la más eficiente, puesto que no consume <abbr title="Central Processing Unit">CPU</abbr> ni
memoria <abbr title="Random Access Memory">RAM</abbr>. Ahora bien, requiere que el disco implemente esta funcionalidad y
no todos lo hacen.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>El artículo <a class="reference external" href="https://www.fmad.io/blog/what-is-a-self-encrypting-disk-sed">¿Qué es SED? (en inglés)</a> explica
cuáles son las tres posibilidades respecto al cifrado que podemos encontrar
en los dispositivos de almacenamiento. Este apartado refiere la última
(<em>cifrado con bloqueo</em>), mientras que la segunda (<em>cifrado sin bloqueo</em>) refiere
la que se trata en el <a class="reference internal" href="../../../../05.discos/07.delete/index.html#hdparm"><span class="std std-ref">epígrafe sobre borrado seguro</span></a>. También
es conveniente saber que puede existir un <em>bloqueo sin cifrado</em> que es
el que ofrece la seguridad <abbr title="Advanced Technology Attachment">ATA</abbr> cuando permite establecer una contraseña que
permite bloquear el acceso a disco. Este bloqueo es un mero bloqueo lógico
que realiza el <em>firmware</em> y, de hecho, el acceso es posible si se logra
leer el disco sin utilizar su <em>firmware</em>. Incluso en el caso de que el disco
realice un <em>cifrado sin bloqueo</em> para facilitar el borrado seguro, y se
establezca la contraseña <abbr title="Advanced Technology Attachment">ATA</abbr>, esta no tiene relación criptográfica con la
clave de cifrado.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>En el cifrado por <em>hardware</em> pueden parecer todo ventajas, pero
el <em>firmware</em> puede presentar vulnerabilidades <a class="reference external" href="https://www.stationx.net/think-your-ssd-offers-rock-solid-encryption-heres-why-its-time-to-think-again/">como ya ha ocurrido en varias
ocasiones</a>.
Y es que, a diferencia de un cifrado por <em>software</em> donde este puede ser
libre (todas las alternativas que se presentan aquí lo son), el cifrado por
<em>hardware</em> lo realiza el <em>firmware</em> cerrado del dispositivo, que es mucho más
difícilmente auditable.</p>
</div>
<p>A esta capacidad del disco para cifrar sus propios datos y bloquear así el
acceso no autorizado se la denomina <abbr title="Self-Encrypting Drive">SED</abbr> y se desarrolla en la especificación
<abbr title="Trusted Computing Group">TGC</abbr>/Opal. Para almacenamiento de servidor existe otra especificación llamada
<abbr title="Trusted Computing Group">TGC</abbr> Enterprise.</p>
<div class="admonition seealso">
<p class="admonition-title">Ver también</p>
<p>Puede ver algunas de las diferencias entre ambas especificaciones
en el artículo <a class="reference external" href="https://winmagic.com/blog/trusted-computing-group-opal-vs-seds/">Trusted Computing Group Opal vs Enterprise SEDs</a>.</p>
</div>
<p>Los principios de este cifrado son los siguientes:</p>
<ol class="arabic simple">
<li><p>Todos los datos se guardan cifrados mediante una clave simétrica llamada
<abbr title="Media Encryption Key">MEK</abbr> (clave de cifrado del medio).</p></li>
<li><p>La clave anterior se guarda en el dispositivo, pero cifrada mediante otra
clave denominada <abbr title="Key Encryption Key">KEK</abbr> (clave de cifrado de la clave) que se obtiene a partir
de una contraseña proporcionada por el usuario.</p></li>
<li><p>Al perder su alimentación el disco, se pierde el descifrado de la <abbr title="Media Encryption Key">MEK</abbr> y los
datos quedan otra vez ilegibles.</p></li>
<li><p>Si el disco cifrado es disco de arranque, es preciso que se pida antes de
su lectura la contraseña, por lo que su introducción requiere una
<abbr title="Basic I/O System">BIOS</abbr> con soporte o cargar un <em>software</em> competente.</p></li>
</ol>
<p>Para ponerlo en práctica esta estrategia necesitaremos:</p>
<ol class="arabic simple">
<li><p>Un disco con soporte. Para ello deberemos leer con detenimiento las
características y comprobar si soporta <abbr title="Trusted Computing Group">TGC</abbr>/Opal. En las características
resumidas que nos proporcione una tienda online es probable que sólo lo
refiera como «<em>Algoritmo de seguridad soportado AES-256</em>» o una redacción
similar.</p></li>
<li><p>Una herramienta para habilitar y manipular la seguridad:</p>
<ul class="simple">
<li><p>En <em>Linux</em>, podemos usar <a class="reference external" href="https://github.com/Drive-Trust-Alliance/sedutil">sedutil</a> (o mejor <a class="reference external" href="https://github.com/Drive-Trust-Alliance/sedutil/wiki/Executable-Distributions">sus ejecutables</a>), proporcionada por la
<a class="reference external" href="https://drivetrust.com">Drive Trust Alliance</a>.</p></li>
<li><p>En <em>Windows</em>, <a class="reference external" href="https://es.wikipedia.org/wiki/BitLocker_Drive_Encryption">BitLocker</a> permite seleccionar el uso de cifrado por
<em>hardware</em>.</p></li>
</ul>
</li>
</ol>
<section id="conceptos-previos">
<h2><span class="section-number">9.1.3.6.1.1. </span>Conceptos previos<a class="headerlink" href="#conceptos-previos" title="Link to this heading">¶</a></h2>
<p>Antes de intentar manipular el acceso a un disco con cifrado es importante
conocer algunos conceptos que se encuentran ampliamente explicados en el
documento <a class="reference external" href="http://develop.trustedcomputinggroup.org/wp-content/uploads/2019/05/Opal_Drive_Guide_v1_Final_20190515.pdf">A Practical Guide to Use of Opal Drives</a>.</p>
<dl class="simple">
<dt><em class="dfn">PBA</em></dt><dd><p>Es el <em>software</em> encargado de pedir la contraseña que desbloquea un disco
de arranque. Si la placa tiene soporte para Opal el propio <em>firmware</em> de la
placa puede asumir esta función, pero, si no es así, este <em>software</em> deberá
ejecutarse antes de cualquier lectura sobre el disco, de ahí su nombre
<abbr title="Pre Boot Authorization">PBA</abbr>: <em>autorización previa al arranque</em>.</p>
</dd>
</dl>
<dl id="sed-shadowmbr">
<dt><em class="dfn">Shadow  MBR</em></dt><dd><p>No es propiamente un <abbr title="Master Boot Record">MBR</abbr> (en el sentido clásico del término), sino un
espacio de 128 MiB que, cuando está habilitado, suplanta los 128 MiB
iniciales del disco y las lecturas y escrituras se redirigen hacia estos 128
MiB en vez de a los 128 MiB habituales. Las escrituras, no obstante, están
vetadas y sólo se pueden llevar a cabo a través del <a class="reference internal" href="#sedutil-cli"><span class="std std-ref">software
especialidado para SED</span></a>.</p>
<p>En realidad, no basta con que esté habilitado, puesto que existe otro
parámetro llamado «Done» que puede estar habilitado o deshabilitado. Cuando
está deshabilitado, es cuando propiamente el <em>Shadow</em> <abbr title="Master Boot Record">MBR</abbr> suplanta el
inicio del disco.</p>
<p>Dicho lo cual, ¿cuál es la razón de todo esto? Es sencilla: la de poder
albergar un <abbr title="Pre Boot Authorization">PBA</abbr> que permita el desbloqueo del disco. Así, de fábrica el
bloqueo está deshabilitado  y, consecuentemente, también lo está el <em>Shadow</em>
<abbr title="Master Boot Record">MBR</abbr>. Al bloquear con contraseña el dispositivo, se habilita el <em>Shadow</em>
<abbr title="Master Boot Record">MBR</abbr> (que debe contener el <abbr title="Pre Boot Authorization">PBA</abbr>) y se deshabilita el «Done». Debido a esto,
al arrancar por ese disco, se leerá el <abbr title="Pre Boot Authorization">PBA</abbr> del <em>Shadow</em> <abbr title="Master Boot Record">MBR</abbr> y se nos
pedirá la contraseña. Si ésta es correcta, se podrá descifrar el disco, se
habilitará el «Done» y se hará un reinicio automático. Este reinicio vuelve
a arrancar por el disco, pero al encontrarse habilitado «Done», se leerá el
inicio del disco que ocultaba el <em>Shadow</em> <abbr title="Master Boot Record">MBR</abbr> y podrá iniciarse el sistema
operativo que contuviera el disco. El disco permenecerá en ese estado de
desbloqueo hasta que pierda alimentación. Cuando eso ocurre, será imposible
descifrarlo y se deshabilitará «Done» para que un arranque posterior permita
de nuevo la introducción de la contraseña.</p>
</dd>
</dl>
<dl id="sed-rangos">
<dt><em class="dfn">Rangos</em> (o <em class="dfn">Bandas</em>)</dt><dd><p>Son distintas áreas de disco constituidas por espacio contiguo, que no se
solapan entre sí y que pueden ser bloqueadas de manera independiente. El
<em>Shadow</em> <abbr title="Master Boot Record">MBR</abbr>, queda fuera de la definición de estas áreas. Hay predefinida
una, la <strong>0</strong>, que se denomina <em class="dfn">rango global</em> y que abarca todo el
disco, y 15 más que pueden ser definidas por el usuario. Lo más lógico es que
su definición, de hacerse, coincidiera con particiones de disco.</p>
</dd>
<dt><strong>Proveedores de seguridad</strong></dt><dd><p>En Opal hay definidos dos <abbr title="Service Provider">SP</abbr> hasta la fecha:</p>
<dl class="simple">
<dt><strong>Admin SP</strong></dt><dd><p>cuyos usuario se encargan de administrar el resto de <abbr title="Service Provider">SP</abbr>.</p>
</dd>
<dt><strong>Locking SP</strong></dt><dd><p>cuyos usuarios gestionan los rangos del disco.</p>
</dd>
</dl>
</dd>
</dl>
<dl id="sed-usuarios">
<dt><strong>Usuarios</strong></dt><dd><p>Dado que hay dos <abbr title="Service Provider">SP</abbr>, hay usuarios distintos definidos dentro de ambos:</p>
<dl class="simple">
<dt><strong>Admin SP</strong></dt><dd><p>Tiene definidos dos:</p>
<ul class="simple">
<li><p>el <abbr title="Security IDentifier">SID</abbr>, que tiene todos los permisos de administración y cuyo valor
coincide inicialmente con el <abbr title="Manufacter's Secure IDentifier">PSID</abbr>, consultable a través de la <abbr title="Application Programming Interface">API</abbr>.</p></li>
<li><p>el <abbr title="Physical Security IDentifier">PSID</abbr>, que se encuentra escrito habitualmente sobre el propio frontal
del disco y sólo tiene el permiso de <a class="reference internal" href="#sed-reset"><span class="std std-ref">resetear por completo el
disco</span></a> en caso de haber olvidado todas las contraseñas.
Gracias a él, podremos reutilizar un disco del que se hayan olvidado o
se desconozcan las contraseñas.</p></li>
</ul>
</dd>
<dt><strong>Locking SP</strong></dt><dd><p>Que puede llegar a tener hasta 20 usuarios de dos tipos:</p>
<ul class="simple">
<li><p>Cuatro administradores (<strong>Admin1</strong>, .. , <strong>Admin4</strong>), de los cuales sólo
el primero esta inicialmente habilitado con la contraseña del <abbr title="Manufacter's Secure IDentifier">PSID</abbr>.</p></li>
<li><p>Hasta 16 usuarios denominados <strong>User1</strong>, .. <strong>User16</strong>, deshabilitados
todos inicialmente. Cada usuario podría gestionar su rango
correspondiente.</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
</section>
<section id="configuracion">
<span id="sedutil-cli"></span><h2><span class="section-number">9.1.3.6.1.2. </span>Configuración<a class="headerlink" href="#configuracion" title="Link to this heading">¶</a></h2>
<div class="admonition note" id="sed-rescue-img">
<p class="admonition-title">Nota</p>
<p>Las herramientas ya compiladas podemos descargarlas del <a class="reference external" href="https://github.com/Drive-Trust-Alliance/sedutil/wiki/Executable-Distributions">github de
sedutil</a>
y utilizarlas en cualquier linux, pero lo más recomendable es descargar la imagen
<code class="file docutils literal notranslate"><span class="pre">RESCUE64.img.gz</span></code> y pasarla a un pincho <abbr title="Universal Serial Bus">USB</abbr>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>zcat<span class="w"> </span>RESCUE64.img.gz<span class="w"> </span>&gt;<span class="w"> </span>/dev/sdz
</pre></div>
</div>
<p>Luego, podremos arrancar el ordenador desde este <em>Linux</em> mínimo que contiene
todas las herramientas necesarias.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">Ver también</p>
<p>Las <a class="reference external" href="https://github.com/Drive-Trust-Alliance/sedutil/wiki/Encrypting-your-drive">instrucciones oficiales</a>
se encuentran en   la wiki de sedutil.</p>
</div>
<dl>
<dt><strong>Comprobaciones de soporte</strong></dt><dd><div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Si no se usa el disco de rescate, antes de intentar cualquier
operación, es necesario que estén habilitados los <abbr title="Advanced Technology Attachment">ATA</abbr> <em>trusted commands</em>, lo
cual se logra fijando el valor del parámetro del núcleo <code class="docutils literal notranslate"><span class="pre">libata.allow_tpm</span></code>
a <strong>1</strong> mediante la adición de la opción <kbd class="kbd docutils literal notranslate">libata.allow_tpm=1</kbd> en el
arranque.</p>
</div>
<p>Supuesto esto, podremos usar ya la orden <strong class="command">sedutil-cli</strong> para
comprobar el soporte de nuestros discos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--scan
<span class="go">Scanning for Opal compliant disks</span>
<span class="go">/dev/sda    2  Samsung SSD 870 EVO 250GB                SVT02B6Q</span>
<span class="go">/dev/sdb   No  Flash Disk       8.07</span>
<span class="go">No more disks present ending scan</span>
</pre></div>
</div>
<p>Tenemos, pues, que nuestro <code class="file docutils literal notranslate"><span class="pre">sda</span></code> soporta cifrado por <em>hardware</em>: el
<strong>2</strong> indica que soporta la <abbr title="Trusted Computing Group">TGC</abbr>/Opal 2.0<a class="footnote-reference brackets" href="#id3" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>. Ahora bien, ¿en qué estado
se encuentra?:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--query<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Locked
<span class="go">   Locked = N, LockingEnabled = N, LockingSupported = Y, MBRDone = N, MBREnabled = N, MediaEncfrypt = Y</span>
</pre></div>
</div>
<p>El disco no está bloqueado (<code class="docutils literal notranslate"><span class="pre">Locked</span></code>), no tienen habilitado el bloqueo,
(<code class="docutils literal notranslate"><span class="pre">LockingEnabled</span></code>) y, por supuesto, no tiene habilitado el <em>Shadow</em> <abbr title="Master Boot Record">MBR</abbr>
(<code class="docutils literal notranslate"><span class="pre">MBREnabled</span></code>)<a class="footnote-reference brackets" href="#id4" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>. En estas circunstancias (que son las que trae de
fábrica), el disco se comportará como cualquier otro sin soporte para Opal.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Si este no es el estado del disco, entonces es porque ya se
configuró su bloqueo anteriormente y pueden ocurrir que no sepamos las
contraseñas de administración. Si es así, la única posibilidad para que
podamos reconfigurar el bloqueo es <a class="reference internal" href="#sed-psidrevert"><span class="std std-ref">resetear con el PSID</span></a>, lo que supone <strong>perder todos los datos</strong>.</p>
</div>
<p>Además, el disco de rescate proporciona la orden <strong class="command">linuxpba</strong> que
realiza la acción equivalente al <abbr title="Pre Boot Authorization">PBA</abbr> y, por tanto, permite desbloquear el
disco tras introducir la contraseña. Si la usamos ahora que no hemos aún
configurado nada:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># linuxpba</span>
Please<span class="w"> </span>enter<span class="w"> </span>pass-phrase<span class="w"> </span>to<span class="w"> </span>unlock<span class="w">  </span>OPAL<span class="w"> </span>drives:
<span class="hll">Drive<span class="w"> </span>/dev/sda<span class="w"> </span>Samsung<span class="w"> </span>SSD<span class="w"> </span><span class="m">870</span><span class="w"> </span>EVO<span class="w"> </span>250GB<span class="w">                 </span>is<span class="w"> </span>OPAL<span class="w"> </span>NOT<span class="w"> </span>LOCKED
</span>Drive<span class="w"> </span>/dev/sdb<span class="w">                                           </span>not<span class="w"> </span>OPAL
</pre></div>
</div>
<p>que requiere como contraseña <em>debug</em>, ya que aún no hemos establecido
ninguna. El sistema, además, no reiniciaría en estas circunstancias.</p>
</dd>
<dt><strong>Habilitación del bloqueo</strong></dt><dd><p>Una vez que hemos hecho las comprobaciones iniciales y sabiendo ya que
<code class="file docutils literal notranslate"><span class="pre">sda</span></code> tiene soporte para Opal, deberemos:</p>
<ol class="arabic">
<li><p>Habilitar el bloqueo (haremos un bloqueo global sobre todo el disco):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--initialsetup<span class="w"> </span>debug<span class="w"> </span>/dev/sda
<span class="gp"># </span>sedutil-cli<span class="w"> </span>--enablelockingrange<span class="w"> </span><span class="m">0</span><span class="w"> </span>debug<span class="w"> </span>/dev/sda
<span class="gp"># </span>sedutil-cli<span class="w"> </span>--setlockingrange<span class="w"> </span><span class="m">0</span><span class="w"> </span>lk<span class="w"> </span>debug<span class="w"> </span>/dev/sda
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>En el caso de que el disco, al intentar inicializar el bloqueo,
nos devuelva el error:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--initialsetup<span class="w"> </span>debug<span class="w"> </span>/dev/sda
<span class="go">method status code NOT_AUTHORIZED</span>
</pre></div>
</div>
<p>tendremos el problema de que tal disco ya se configuró para su bloqueo
y la configuración no quedó completamente limpia. En este caso, no hay
otro modo de habilitar su configuración que <a class="reference internal" href="#sed-psidrevert"><span class="std std-ref">reseteándolo con el
PSID</span></a> (lo cual supondrá la <strong>pérdida de todos los
datos</strong>).</p>
</div>
</li>
<li><p>Instalar el <abbr title="Pre Boot Authorization">PBA</abbr> en el <em>Shadow</em> <abbr title="Master Boot Record">MBR</abbr>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>gunzip<span class="w"> </span>/usr/sedutil/UEFI64-1.20.img.gz
<span class="gp"># </span>sedutil-cli<span class="w"> </span>--loadpbaimage<span class="w"> </span>debug<span class="w"> </span>/usr/sedutil/UEFI64-1.20.img<span class="w"> </span>/dev/sda
</pre></div>
</div>
<p>Si comprobamos el estado de bloqueo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--query<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Locked
<span class="go">   Locked = Y, LockingEnabled = Y, LockingSupported = Y, MBRDone = Y, MBREnabled = Y, MediaEncfrypt = Y</span>
</pre></div>
</div>
<p>Lo cual implica que el disco está ya bloqueado y el <em>Shadow</em> <abbr title="Master Boot Record">MBR</abbr>
habilitado. Sin embargo, el «Done» está también habilitado, por lo que
el <em>Shadow</em> <abbr title="Master Boot Record">MBR</abbr> no será visible y el <abbr title="Pre Boot Authorization">PBA</abbr> no se ejecutará al arrancar.
Podemos, no obstante, solucionarlo fácilmente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--setmbrdone<span class="w"> </span>off<span class="w"> </span>debug<span class="w"> </span>/dev/sda
</pre></div>
</div>
<p>Ahora sí podemos probar a reiniciar y arrancar por el disco <code class="file docutils literal notranslate"><span class="pre">sda</span></code>.
Debería pedirnos la contraseña de desbloqueo (que sigue siendo «<em>debug</em>»).
Sin embargo, como aún seguimos con la contraseña predeterminada, el
equipo no reiniciará, sino que nos presentará una <em>shell</em> como la del
disco de rescate. Consultemos el estado:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--query<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Locked
<span class="go">   Locked = N, LockingEnabled = Y, LockingSupported = Y, MBRDone = N, MBREnabled = Y, MediaEncfrypt = Y</span>
</pre></div>
</div>
<p>Es hora de que establezcamos una contraseña:</p>
</li>
<li><p>Establecer las contraseñas del <abbr title="Security IDentifier">SID</abbr> y el <em>Admin1</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--setsidpassword<span class="w"> </span>debug<span class="w"> </span>soysid<span class="w"> </span>/dev/sda
<span class="gp"># </span>sedutil-cli<span class="w"> </span>--setadmin1pwd<span class="w"> </span>debug<span class="w"> </span>soyadmin1<span class="w"> </span>/dev/sda
</pre></div>
</div>
<p>la segunda de las cuales nos permiterá a partir de ahora desbloquear el
disco al arrancar. En cualquier caso, si gestionamos un disco personal,
lo más recomendable es hacer que coincidan ambas contraseñas, para poder
hacer todas las operaciones con la misma.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La segunda orden también podríamos haberla escrito del modo en
que se cambian de forma general las contraseñas de los usuarios del
<em>Locking SP</em>:</p>
<blockquote>
<div><p># sedutil-cli –setpassword debug Admin1 soyadmin1 /dev/sda</p>
</div></blockquote>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p><abbr title="Pre Boot Authorization">PBA</abbr> sólo soporta teclado americano. Téngalo presente: un «;»
estará en la tecla <kbd class="kbd docutils literal notranslate">Ñ</kbd>, no en donde indique nuestro teclado para
español.</p>
</div>
</li>
<li><p>Bloquear y desbloquear:</p>
<p>Como el disco se encuentra desbloqueado, volvamos a bloquearlo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--setlockingrange<span class="w"> </span><span class="m">0</span><span class="w"> </span>lk<span class="w"> </span>soyadmin1<span class="w"> </span>/dev/sda
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Obsérvese que ya tenemos que usar la nueva contraseña para
gestionar <abbr title="Self-Encrypting Drive">SED</abbr>.</p>
</div>
<p>Finalmente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--query<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Locked
<span class="go">   Locked = Y, LockingEnabled = Y, LockingSupported = Y, MBRDone = N, MBREnabled = Y, MediaEncfrypt = Y</span>
</pre></div>
</div>
<p>Ahora al reiniciar e intentar arrancar el disco, debería pedirnos la nueva
contraseña y, tras introducirla correctamente, desbloquear y reiniciar el
equipo con el <em>Shadow</em> <abbr title="Master Boot Record">MBR</abbr> invisible.</p>
<p>Si arrancamos algún sistema en el que podamos ejecutar
<strong class="command">sedutil-cli</strong> (por ejemplo, el disco de rescate), el estado habrá
quedado así:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--query<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Locked
<span class="go">   Locked = N, LockingEnabled = Y, LockingSupported = Y, MBRDone = Y, MBREnabled = Y, MediaEncfrypt = Y</span>
</pre></div>
</div>
<p>El desbloqueo debería mantenerse mientras el disco reciba alimentación. Si
en algún momento la cortamos, el disco pasará de nuevo a estar bloqueado:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--query<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Locked
<span class="go">   Locked = Y, LockingEnabled = Y, LockingSupported = Y, MBRDone = N, MBREnabled = Y, MediaEncfrypt = Y</span>
</pre></div>
</div>
<p>Y así continuará mientras no se introduzca la contraseña.</p>
</li>
</ol>
</dd>
<dt><strong>Desbloqueo manual</strong></dt><dd><p>Si no hemos usado el <abbr title="Pre Boot Authorization">PBA</abbr>, podemos desbloquear un disco con un <em>Linux</em> haciendo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--setlockingrange<span class="w"> </span><span class="m">0</span><span class="w"> </span>rw<span class="w"> </span>soyadmin1<span class="w"> </span>/dev/sda
<span class="gp"># </span>sedutil-cli<span class="w"> </span>--setmbrdone<span class="w"> </span>on<span class="w"> </span>soyadmin1<span class="w"> </span>/dev/sda
<span class="gp"># </span>partx<span class="w"> </span>-d<span class="w"> </span>/dev/sda<span class="w">  </span><span class="c1"># Eliminamos la tabla de particiones obsoleta.</span>
<span class="gp"># </span>partx<span class="w"> </span>-a<span class="w"> </span>/dev/sda<span class="w">  </span><span class="c1"># Leemos la nueva tabla de particiones.</span>
</pre></div>
</div>
</dd>
<dt><strong>Bloqueo manual</strong></dt><dd><p>Si queremos bloquear un disco desbloqueado sin necesidad de cortarle la
alimentación:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--setlockingrange<span class="w"> </span><span class="m">0</span><span class="w"> </span>lk<span class="w"> </span>soyadmin1<span class="w"> </span>/dev/sda
<span class="gp"># </span>sedutil-cli<span class="w"> </span>--setmbrdone<span class="w"> </span>off<span class="w"> </span>soyadmin1<span class="w"> </span>/dev/sda
<span class="gp"># </span>reboot
</pre></div>
</div>
<p>Y al reiniciar deberíamos observar que, efectivamente, está bloqueado.</p>
</dd>
<dt><strong>Deshabilitar/habilitar el bloqueo</strong></dt><dd><p>Si decidimos deshabilitar el bloqueo indefinidamente para que la pérdida
de alimentación no provoque el bloqueo del disco, podemos hacer lo
siguiente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--disablelockingrange<span class="w"> </span><span class="m">0</span><span class="w"> </span>soyadmin1<span class="w"> </span>/dev/sda
<span class="gp"># </span>sedutil-cli<span class="w"> </span>--setmbrenable<span class="w"> </span>off<span class="w"> </span>soyadmin1<span class="w"> </span>/dev/sda
</pre></div>
</div>
<p>o sea, deshabilitamos en sí el bloqueo y también el <em>Shadow</em> <abbr title="Master Boot Record">MBR</abbr> para que
no moleste, con lo que el estado queda:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--query<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Locked
<span class="go">   Locked = N, LockingEnabled = Y, LockingSupported = Y, MBRDone = N, MBREnabled = N, MediaEncfrypt = Y</span>
</pre></div>
</div>
<p>La operación contraria será:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--enablelockingrange<span class="w"> </span><span class="m">0</span><span class="w"> </span>soyadmin1<span class="w"> </span>/dev/sda
<span class="gp"># </span>sedutil-cli<span class="w"> </span>--setmbrenable<span class="w"> </span>on<span class="w"> </span>soyadmin1<span class="w"> </span>/dev/sda
<span class="gp"># </span>sedutil-cli<span class="w"> </span>--setmbrdone<span class="w"> </span>off<span class="w"> </span>soyadmin1<span class="w"> </span>/dev/sda
</pre></div>
</div>
<p>Y el estado resultante:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--query<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Locked
<span class="go">   Locked = Y, LockingEnabled = Y, LockingSupported = Y, MBRDone = N, MBREnabled = Y, MediaEncfrypt = Y</span>
</pre></div>
</div>
</dd>
</dl>
<dl id="sed-reset">
<dt><strong>Reseteo</strong></dt><dd><p>Por último, puede interesarnos volver a dejar el disco en el estado inicial,
para lo cual antes debemos asegurarnos de que el disco <strong>está desbloqueado</strong>
(<kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">Locked</kbd> <kbd class="kbd docutils literal notranslate">=</kbd> <kbd class="kbd docutils literal notranslate">N</kbd></kbd>). En principio, hay dos posibilidades:</p>
<ol class="loweralpha">
<li><p>Resetearlo eliminando todos los datos que pudiera contener:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--resettper<span class="w"> </span>micontraseña<span class="w"> </span>/dev/sda
</pre></div>
</div>
<p>lo cual provocará el estado inicial:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--query<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Locked
<span class="go">   Locked = N, LockingEnabled = N, LockingSupported = Y, MBRDone = N, MBREnabled = N, MediaEncfrypt = Y</span>
</pre></div>
</div>
<p>esto es, <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">LockingEnable</kbd> <kbd class="kbd docutils literal notranslate">=</kbd> <kbd class="kbd docutils literal notranslate">N</kbd></kbd>.</p>
</li>
<li><p>Resetearlo manteniendo los datos (aunque esto <a class="reference external" href="https://github.com/Drive-Trust-Alliance/sedutil/wiki/Remove-OPAL">pueden no soportarlo todos
los discos y borrarlos igualmente</a>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--revertnoerase<span class="w"> </span>soyadmin1<span class="w"> </span>/dev/sda
</pre></div>
</div>
<p>Ahora debemos comprobar el estado:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--query<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Locked
<span class="go">   Locked = N, LockingEnabled = N, LockingSupported = Y, MBRDone = N, MBREnabled = N, MediaEncfrypt = Y</span>
</pre></div>
</div>
<p>y solo en caso de que esté deshabilitado el bloqueo (<kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">LockingEnable</kbd> <kbd class="kbd docutils literal notranslate">=</kbd> <kbd class="kbd docutils literal notranslate">N</kbd></kbd>), rematar con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--reverttper<span class="w"> </span>soysid<span class="w"> </span>/dev/sda
</pre></div>
</div>
<p>porque, de lo contrario, este último paso <strong>borrará todos los datos</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Lo que sí se borra es el <abbr title="Pre Boot Authorization">PBA</abbr> del <em>Shadow</em> <abbr title="Master Boot Record">MBR</abbr>, por lo que si
vuelve a querer habilitarse el bloqueo, no podremos saltar el paso de
su instalación.</p>
</div>
</li>
</ol>
<p id="sed-psidrevert">Ahora bien, ¿qué pasa si no podemos desbloquearlo ni sabemos las contraseñas?
Entonces tenemos una última posibilidad:</p>
<ol class="loweralpha" start="3">
<li><p>Resetearlo por completo eliminando todos los datos, pero sin conocer las
contraseñas. Esta circunstancia puede darse cuando las hemos olvidado o
recibimos un disco cifrado del no sabemos nada ni nos importa su
conteniedo, pero queremos aprovecharlo como almacenamiento de nuevos datos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--yesireallywanttoeraseallmydatausingthepsid<span class="w"> </span>PSID<span class="w"> </span>/dev/sda
</pre></div>
</div>
<p>Del PSID ya hemos hablado al <a class="reference internal" href="#sed-usuarios"><span class="std std-ref">tratar los usuarios</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Hay una alternartiva bastante más corta:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sedutil-cli<span class="w"> </span>--psidrevert<span class="w"> </span>PSID<span class="w"> </span>/dev/sda
</pre></div>
</div>
</div>
</li>
</ol>
</dd>
</dl>
<p class="rubric">Notas al pie</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id3" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>También podremos encontrar un <strong>12</strong> que indica que soporta tanto la
versión 1.0 como la 2.0.</p>
</aside>
<aside class="footnote brackets" id="id4" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p>Pero sí esta cifrado. En realidad, la información en disco siempre se
cifra. De hecho, gracias a eso <a class="reference internal" href="../../../../05.discos/07.delete/index.html#hdparm"><span class="std std-ref">puede realizarse un borrado seguro y
rápido del disco</span></a>.</p>
</aside>
</aside>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../../../index.html">Tabla de contenido</a></h3>
    <ul>
<li><a class="reference internal" href="#">9.1.3.6.1. Cifrado por <em>hardware</em></a><ul>
<li><a class="reference internal" href="#conceptos-previos">9.1.3.6.1.1. Conceptos previos</a></li>
<li><a class="reference internal" href="#configuracion">9.1.3.6.1.2. Configuración</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Tema anterior</h4>
    <p class="topless"><a href="../06.discos.html"
                          title="capítulo anterior"><span class="section-number">9.1.3.6. </span>Cifrado de discos</a></p>
  </div>
  <div>
    <h4>Próximo tema</h4>
    <p class="topless"><a href="02.luks.html"
                          title="próximo capítulo"><span class="section-number">9.1.3.6.2. </span>Cifrado de bloques</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/98.apendice/01.cryto/03.aplicaciones/06.discos/01.hardware.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Ir a" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="02.luks.html" title="9.1.3.6.2. Cifrado de bloques"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="../06.discos.html" title="9.1.3.6. Cifrado de discos"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">9. </span>Apéndices</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">9.1. </span>Criptografía</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../../03.aplicaciones.html" ><span class="section-number">9.1.3. </span>Aplicaciones de la criptografía</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="../06.discos.html" ><span class="section-number">9.1.3.6. </span>Cifrado de discos</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">9.1.3.6.1. </span>Cifrado por <em>hardware</em></a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright CC BY 4.0, 2016-2025, José Miguel Sánchez Alés.
      Creado usando <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>