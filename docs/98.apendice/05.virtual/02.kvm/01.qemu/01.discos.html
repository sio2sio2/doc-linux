


<!DOCTYPE html>

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>9.2.2.2.1.1. Gestión de discos &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/classic.css" />
    <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
    
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/translations.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <link rel="index" title="Índice" href="../../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../../search.html" />
    <link rel="next" title="9.2.2.2.1.2. Creación de máquinas" href="02.arranque.html" />
    <link rel="prev" title="9.2.2.2. Virtualización nativa" href="../../02.kvm.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="02.arranque.html" title="9.2.2.2.1.2. Creación de máquinas"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="../../02.kvm.html" title="9.2.2.2. Virtualización nativa"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">9. </span>Apéndices</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">9.2. </span>Virtualización</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../../02.kvm.html" accesskey="U"><span class="section-number">9.2.2.2. </span>Virtualización nativa</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">9.2.2.2.1.1. </span>Gestión de discos</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="gestion-de-discos">
<span id="qemu-discos"></span><h1><span class="section-number">9.2.2.2.1.1. </span>Gestión de discos<a class="headerlink" href="#gestion-de-discos" title="Enlazar permanentemente con este título">¶</a></h1>
<p><strong class="program">QEmu</strong> tiene su propio formato nativo de discos llamado <abbr title="Qemu Copy On Write">QCOW</abbr>2 (el
<strong>2</strong> es por la versión) y ese debería ser el que se usara por eficiencia y
rendimiento. Para gestionarlo tenemos fundamentalmente una orden:
<em class="manpage"><a class="manpage reference external" href="https://manpages.debian.org/qemu-img">qemu-img</a></em>.</p>
<section id="creacion">
<h2><span class="section-number">9.2.2.2.1.1.1. </span>Creación<a class="headerlink" href="#creacion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El modo más sencillo de crear un disco es el siguiente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-img create -f qcow2 disco.qcw 4G
</pre></div>
</div>
<p>donde el último parámetro es el tamaño del disco. El archivo, sin embargo, no
ocupará tal cantidad de disco, puesto que el disco es de tamaño dinámico e irá
creciendo según se llene con datos. La expresión del formato (<abbr title="Qemu Copy On Write">QCOW</abbr>2) con la
opcion <kbd class="kbd docutils literal notranslate">-f</kbd> es indispensable, porque de otra forma se creará un disco en
formato &quot;cruda&quot; (<em>raw</em>). Existen otro formatos soportados (como <abbr title="Virtualbox Disk Image">VDI</abbr> de
Virtualbox), pero si nuestra intención es usar este <em>software</em> no tiene sentido
no usar el nativo. Una vez creado, podemos consultar la información sobre el
disco:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-img info disco.qcow2
<span class="go">image: /tmp/caca.qcow2</span>
<span class="go">file format: qcow2</span>
<span class="go">virtual size: 4 GiB (4294967296 bytes)</span>
<span class="go">disk size: 196 KiB</span>
<span class="go">cluster_size: 65536</span>
<span class="go">Format specific information:</span>
<span class="go">    compat: 1.1</span>
<span class="go">    compression type: zlib</span>
<span class="go">    lazy refcounts: false</span>
<span class="go">    refcount bits: 16</span>
<span class="go">    corrupt: false</span>
<span class="go">    extended l2: false</span>
</pre></div>
</div>
<p>Básicamente, este es el modo en que se crea un disco <em>ex novo</em>. Ahora bien, si
se quiere hacer un disco con un tamaño compatible con el antiquísimo
direccionamiento <abbr title="Cylinder-Head-Sector">CHS</abbr> de <abbr title="Basic I/O System">BIOS</abbr>, entonces es necesario mantener la relación de
<strong>512</strong> <em>bytes</em> por sector, <strong>63</strong> sectores por pista  y <strong>255</strong> pistas por
cilindro; y el disco se tendrá que crear así:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-img create -f qcow2 disco.qcw <span class="k">$((</span>x*255*63*512<span class="k">))</span>B
</pre></div>
</div>
<p>donde «x» es un entero que debemos calcular para que el producto de todas las
cantidades sea el tamaño más aproximado al que deseamos (en nuestro ejemplo,
4GiB). Por tanto, <span class="math notranslate nohighlight">\(\frac{4*1024^3}{255*63*512} \approx 523\)</span>.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Esto es lo mínimo que necesitamos saber sobre discos para poder
empezar a usar <strong class="program">QEmu</strong>. Puede ya mismo empezar a <a class="reference internal" href="02.arranque.html#qemu-uso"><span class="std std-ref">crear máquinas
virtuales</span></a> y regresar más tarde a este punto para conocer cómo
pueden manipularse los discos.</p>
</div>
</section>
<section id="derivacion">
<h2><span class="section-number">9.2.2.2.1.1.2. </span>Derivación<a class="headerlink" href="#derivacion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Es posible también crear un disco utilizando como base otro, de manera que el
nuevo disco en vez de partir sin datos, partirá con el contenido del que se tome
como base. Eso sí, deberemos asegurarnos de que el disco base no sufre ninguna
alteración. Tiene especial utilidad si hacemos la instalación de un sistema
operativo en un disco y, a partir de ese momento, queremos tomar esta
instalación como plantilla en varias máquinas virtuales distintas.</p>
<p>Por ejemplo, supongamos que en el disco <code class="file docutils literal notranslate"><span class="pre">bullseye.qcw</span></code> hemos hecho una
instalación básica de la última <em>Debian</em> estable y queremos tomar el disco como
base para dos máquinas: una en la que instalaremos un servidor <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> y otra que
usaremos como cliente para comprobar las configuraciones de la primera:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>chmod <span class="m">440</span> bullseye.qcw
<span class="gp">$ </span>qemu-img create -f qcow2 -F qcow2 servidor.qcw  -b bullseye.qcw
<span class="gp">$ </span>qemu-img create -f qcow2 -F qcow2 cliente.qcw  -b bullseye.qcw
</pre></div>
</div>
<p>La primera orden impide que posteriormente por descuido arranquemos una máquina
con el disco <code class="file docutils literal notranslate"><span class="pre">bullseye.qcw</span></code> y que esta torpeza lo modifique y arruine los
dos discos derivados. Por otra parte debemos declarar explícitamente los
formatos del disco base (el introducido con <kbd class="kbd docutils literal notranslate">-b</kbd>) y el derivado. Si echamos
un vistazo a uno de los dos discos derivados:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-img info servidor.qcw <span class="p">|</span> grep backing
<span class="go">backing file: bullseye.qcw</span>
<span class="go">backing file format: qcow2</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Las rutas relativas (como es el caso del ejemplo) se calculan
respecto de la ubicación del nuevo disco, no respecto del directorio de
trabajo.</p>
</div>
<p>También es interesante cambiar la base de un disco derivado en algunos casos:</p>
<ol class="arabic">
<li><p>Cuando la base ha cambiado de ubicación y la definimos con una ruta relativa,
como en el ejemplo anterior. Supongamos que tiempo después cambiamos de
ubicación <code class="file docutils literal notranslate"><span class="pre">bullseye.qcw</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir Plantillas
<span class="gp">$ </span>mv bullseye.qcw Plantillas/
</pre></div>
</div>
<p>Completado este movimiento, el disco derivado dejará de funcionar, porque
buscará la plantilla en el directorio en que se encuentra y eso ya no es así.
Pero puede solucionarse:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-img rebase -f qcow2 servidor.qcw -F qcow2 -u -b Plantillas/bullseye.qcw
</pre></div>
</div>
<p>Téngase presente la opción <kbd class="kbd docutils literal notranslate">-u</kbd>, que es necesaria en este caso. El
comportamiento del subcomando <strong class="command">rebase</strong> es recalcular la base, pero
en este caso, no se quiere recalcular nada, sino simplemente cambiar la
dirección de la base.</p>
</li>
<li><p>Cuando queremos cambiar realmente el disco base a otro que se encuentre en la
misma cadena de derivación. Supongamos esta situación:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-img info bullseye.qcw <span class="p">|</span> grep backing
<span class="gp">$ </span>qemu-img info servidor.qcw <span class="p">|</span> grep backing
<span class="go">backing file: bullseye.qcw</span>
<span class="go">backing file format: qcow2</span>
<span class="gp">$ </span>qemu-img info servidor2.qcw <span class="p">|</span> grep backing
<span class="go">backing file: servidor.qcw</span>
<span class="go">backing file format: qcow2</span>
</pre></div>
</div>
<p>O sea, tenemos tres discos: <code class="file docutils literal notranslate"><span class="pre">bullseye.qcw</span></code>, que no deriva de ninguno,
<code class="file docutils literal notranslate"><span class="pre">servidor.qcw</span></code> que deriva del anterior; y file:<cite>servidor2.qcw</cite> que
deriva de este último. <strong class="command">rebase</strong> nos permite hacer que
<code class="file docutils literal notranslate"><span class="pre">servidor.qcw</span></code> pueda derivar directamente de <code class="file docutils literal notranslate"><span class="pre">bullseye.qcw</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-img rebase -p -f qcow2  servidor2.qcw -F qcow2 -b bullseye.qcw
</pre></div>
</div>
<p>La opción <kbd class="kbd docutils literal notranslate">-p</kbd> no es necesaria, pero sí muy útil, porque nos mostrará el
porcentaje de progreso mientras dura la operación. Obviamente el disco
<code class="file docutils literal notranslate"><span class="pre">servidor2.qcw</span></code> sufrirá cambios, de modo que se fusionarán en él los
cambios que haya en este propio disco y en <code class="file docutils literal notranslate"><span class="pre">servidor.qcw</span></code>.</p>
<p>Un caso particular es aquel en que se quiere que el disco ya no derive de
ningún otro, para lo cual basta con indicar una base vacía:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-img rebase -p -f qcow2 servidor2.qcw -b <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="instantaneas">
<h2><span class="section-number">9.2.2.2.1.1.3. </span>Instantáneas<a class="headerlink" href="#instantaneas" title="Enlazar permanentemente con este título">¶</a></h2>
</section>
<section id="conversion">
<span id="qemu-discos-conv"></span><h2><span class="section-number">9.2.2.2.1.1.4. </span>Conversión<a class="headerlink" href="#conversion" title="Enlazar permanentemente con este título">¶</a></h2>
</section>
<section id="montaje">
<h2><span class="section-number">9.2.2.2.1.1.5. </span>Montaje<a class="headerlink" href="#montaje" title="Enlazar permanentemente con este título">¶</a></h2>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../../../index.html">Tabla de contenido</a></h3>
    <ul>
<li><a class="reference internal" href="#">9.2.2.2.1.1. Gestión de discos</a><ul>
<li><a class="reference internal" href="#creacion">9.2.2.2.1.1.1. Creación</a></li>
<li><a class="reference internal" href="#derivacion">9.2.2.2.1.1.2. Derivación</a></li>
<li><a class="reference internal" href="#instantaneas">9.2.2.2.1.1.3. Instantáneas</a></li>
<li><a class="reference internal" href="#conversion">9.2.2.2.1.1.4. Conversión</a></li>
<li><a class="reference internal" href="#montaje">9.2.2.2.1.1.5. Montaje</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Tema anterior</h4>
    <p class="topless"><a href="../../02.kvm.html"
                          title="capítulo anterior"><span class="section-number">9.2.2.2. </span>Virtualización nativa</a></p>
  </div>
  <div>
    <h4>Próximo tema</h4>
    <p class="topless"><a href="02.arranque.html"
                          title="próximo capítulo"><span class="section-number">9.2.2.2.1.2. </span>Creación de máquinas</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/98.apendice/05.virtual/02.kvm/01.qemu/01.discos.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Ir a" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="02.arranque.html" title="9.2.2.2.1.2. Creación de máquinas"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="../../02.kvm.html" title="9.2.2.2. Virtualización nativa"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">9. </span>Apéndices</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">9.2. </span>Virtualización</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../../02.kvm.html" ><span class="section-number">9.2.2.2. </span>Virtualización nativa</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">9.2.2.2.1.1. </span>Gestión de discos</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2022, José Miguel Sánchez Alés.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>