


<!DOCTYPE html>

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>9.2.2.2.1.4. Otros aspectos &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/classic.css" />
    <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
    
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/translations.js"></script>
    
    <link rel="index" title="Índice" href="../../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../../search.html" />
    <link rel="next" title="9.2.2.2.1.5. Script de arranque" href="06.script.html" />
    <link rel="prev" title="9.2.2.2.1.3. Red" href="03.red.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="06.script.html" title="9.2.2.2.1.5. Script de arranque"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="03.red.html" title="9.2.2.2.1.3. Red"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">9. </span>Apéndices</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">9.2. </span>Virtualización</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../../02.kvm.html" accesskey="U"><span class="section-number">9.2.2.2. </span>Nativa (<abbr title="Kernel-based Virtual Machine">KVM</abbr>)</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">9.2.2.2.1.4. </span>Otros aspectos</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="otros-aspectos">
<h1><span class="section-number">9.2.2.2.1.4. </span>Otros aspectos<a class="headerlink" href="#otros-aspectos" title="Enlace permanente a este encabezado">¶</a></h1>
<p>Reservamos este epígrafe para aspectos variados que no requieren excesivo
desarrollo, pero pueden resultar muy útiles.</p>
<section id="firmware-de-la-placa-base">
<span id="qemu-efi"></span><h2><span class="section-number">9.2.2.2.1.4.1. </span>Firmware de la placa base<a class="headerlink" href="#firmware-de-la-placa-base" title="Enlace permanente a este encabezado">¶</a></h2>
<p>Por defecto, al virtualizar plataformas x86, <strong class="program">QEmu</strong> utiliza como
firmware la <abbr title="Basic I/O System">BIOS</abbr> de 16 <em>bits</em> proporcionada por el proyecto <a class="reference external" href="https://www.seabios.org/SeaBIOS">SeaBIOS</a>. Esto es
suficiente en la mayoría de los casos (especialmente <em>Linux</em>), pero cuando el
huésped debe correr on sistema operativo que lo exija (el caso de <em>Windows</em> 11)
o quieren precisamente hacerse pruebas sobre el arranque, surge la necesidad
de que el huésped arranque un firmware <abbr title="Extensible Firmware Interface">EFI</abbr>.</p>
<p>Para utilizar <abbr title="Extensible Firmware Interface">EFI</abbr> basta con indicarle un archivo que contenga el <em>firmware</em>
apropiado que habrá de descargarse o instalarse primero en el anfitrión. El
usado habitualmente es <a class="reference external" href="https://github.com/tianocore/tianocore.github.io/wiki/OVMF">OVMF</a> para el que existe el paquete <a class="reference external" href="https://packages.debian.org/stable/ovmf">ovmf</a> en
<em>Debian</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt install ovmf
</pre></div>
</div>
<p>Con el paquete instalado, es tan fácil cambiar el <em>firmware</em> como añadir:</p>
<p><code class="code docutils literal notranslate"><span class="pre">-bios</span> <span class="pre">/usr/share/ovmf/OVMF.fd</span></code></p>
<p>donde la ruta es el lugar donde el paquete almacena el <em>firmware</em>.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Para emular la <abbr title="Non Volatile RAM">NVRAM</abbr>, <abbr title="Open Virtual Machine Firmware">OVMF</abbr> crear un archivo dentro de la partición
<abbr title="EFI System Partition">ESP</abbr> denominado <code class="file docutils literal notranslate"><span class="pre">NvVars</span></code>.</p>
</div>
<p>Es fundamental tener presente que al cargar este <em>firmware</em>, deja de tener
efecto la secuencia de arranque establecida según lo expuesto en el
<a class="reference internal" href="02.arranque.html#qemu-arranque-basico"><span class="std std-ref">arranque básico</span></a>. Para manipular la secuencia es
necesario pulsar <kbd class="kbd docutils literal notranslate">F2</kbd> durante el arranque de la máquina virtual, lo cual
permitirá entrar en un entorno desde el cuál puede escogerse qué sistema
operativo arrancar o alterar permanentemente el orden.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La secuencia de arranque <abbr title="Extensible Firmware Interface">EFI</abbr> también puede manipularse desde un
<em>Linux</em> huésped utilizando la orden <a class="reference external" href="https://www.linuxbabe.com/command-line/how-to-use-linux-efibootmgr-examples">efibootmgr</a>. Hay unos pocos ejemplos de
uso en <a class="reference internal" href="../../../../05.discos/01.division/03.pract.html#efi-entradas-grub"><span class="std std-ref">este epígrafe del manual</span></a>.</p>
</div>
</section>
<section id="usb">
<span id="qemu-usb"></span><h2><span class="section-number">9.2.2.2.1.4.2. </span><abbr title="Universal Serial Bus">USB</abbr><a class="headerlink" href="#usb" title="Enlace permanente a este encabezado">¶</a></h2>
<p>Para habilitar <abbr title="Universal Serial Bus">USB</abbr> en el huésped es necesario arrancar la máquina con:</p>
<p><code class="code docutils literal notranslate"><span class="pre">-device</span> <span class="pre">qemu-xhci</span></code><a class="footnote-reference brackets" href="#id4" id="id1">1</a></p>
<p>Este epígrafe, no obstante, está dedicado a describir cómo hacer que un
dispositivo <abbr title="Universal Serial Bus">USB</abbr> conectado al anfitrión aparezca directamente en el huésped.
Necesitaremos dos cosas:</p>
<ol class="arabic">
<li><p>Si se usa <strong class="program">QEmu</strong> como usuario sin privilegios, permitir que éste
tenga permisos de escritura. Esto se hace de modo análogo a como <a class="reference internal" href="03.red.html#qemu-red-puente-macvtap"><span class="std std-ref">se permite
la escritura en dispositivos TAP de caracteres</span></a>:
definiendo un grupo <em>qemusers</em> donde se encuentren los usuarios que
virtualicen y añadiendo una regla para la creación de dispositivos <abbr title="Universal Serial Bus">USB</abbr>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>cat &gt;&gt; /etc/udev/rules.d/55-qemuperm.rules
<span class="go">SUBSYSTEM==&quot;usb&quot;, ACTION==&quot;add&quot;, GROUP=&quot;qemusers&quot;, MODE=&quot;0660&quot;</span>
</pre></div>
</div>
</li>
<li><p>Pasar al huésped el dispositivo <abbr title="Universal Serial Bus">USB</abbr> que queremos tener disponible en él,
para lo cual tenemos que identificar en el anfitrión tal dispositivo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>lsusb
<span class="go">[...]</span>
<span class="go">Bus 001 Device 007: ID abcd:1234 Unknown UDisk</span>
<span class="go">[...]</span>
</pre></div>
</div>
<p>Supongamos que el dispositivo es éste. Si queremos tener una salida más
prolija de sus características, podemos hacer:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>lsusb -v -s <span class="m">1</span>:7
<span class="go">[...]</span>
<span class="go">    idVendor           0xabcd Unknown</span>
<span class="go">    idProduct          0x1234</span>
<span class="go">[...]</span>
</pre></div>
</div>
<p>donde <kbd class="kbd docutils literal notranslate">1:7</kbd> son el número de bus y dispositivo que se han observado en
la salida sucinta primera. Consultado estos datos podemos pasar la gestión
del dispositivo <abbr title="Universal Serial Bus">USB</abbr> al huésped añadiendo:</p>
<p><code class="code docutils literal notranslate"><span class="pre">-device</span> <span class="pre">usb-host,hostbus=1,hostaddr=7</span></code><a class="footnote-reference brackets" href="#id5" id="id2">2</a></p>
<p>Estos dos números (<strong>1</strong> y <strong>7</strong>) son cambiantes. Una alternativa es
identificar el dispositivo con su código de vendedor y producto que sí son
fijos y, por tanto, no exigirán que los consultemos cada vez que conectamos
el dispositivo al equipo:</p>
<p><code class="code docutils literal notranslate"><span class="pre">-device</span> <span class="pre">usb-host,vendorid=0xabcd,productid=0x1234</span></code></p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>El dispositivo <abbr title="Universal Serial Bus">USB</abbr> no estará disponible en el anfitrión, mientras
esté siendo gestionado por el huésped.</p>
</div>
</li>
</ol>
</section>
<section id="directorio-compartido">
<span id="qemu-virtio-fs"></span><h2><span class="section-number">9.2.2.2.1.4.3. </span>Directorio compartido<a class="headerlink" href="#directorio-compartido" title="Enlace permanente a este encabezado">¶</a></h2>
</section>
<section id="chip-tpm">
<span id="qemu-tpm"></span><h2><span class="section-number">9.2.2.2.1.4.4. </span>Chip <abbr title="Trusted Platform Module">TPM</abbr><a class="headerlink" href="#chip-tpm" title="Enlace permanente a este encabezado">¶</a></h2>
<p>Puede ser muy interesante disponer en el huésped de un <em>chip</em> <abbr title="Trusted Platform Module">TPM</abbr>:</p>
<ol class="arabic">
<li><p>Si el anfitrión es un <em>Linux</em> y dispone de <em>chip</em>, podemos utilizar el <em>chip</em>
también en el huésped añadiendo las siguientes opciones:</p>
<p><code class="code docutils literal notranslate"><span class="pre">-device</span> <span class="pre">tpm-tis,tpmdev=tpm0</span> <span class="pre">-tpmdev</span> <span class="pre">passthrough,id=tpm0</span></code></p>
</li>
<li><p>Si no dispone del <em>chip</em>, aún podemos emularlo del siguiente modo:</p>
<ol class="loweralpha">
<li><p>Instalamos en el anfitrión el <em>software</em> apropiado:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt install swtpm-tools
</pre></div>
</div>
</li>
<li><p>Creamos un directorio donde almacenar los estados del <abbr title="Trusted Platform Module">TPM</abbr>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$  </span>mkdir vmtpm0
</pre></div>
</div>
</li>
<li><p>Lanzamos el <em>software</em> que crea un <em>socket</em> para la comunicación<a class="footnote-reference brackets" href="#id6" id="id3">3</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>swtpm socket --tpmstate <span class="nv">dir</span><span class="o">=</span>vmtpm0 --ctrl <span class="nv">type</span><span class="o">=</span>unixio,path<span class="o">=</span>vmtpm0/swtpm-sock
</pre></div>
</div>
</li>
<li><p>Una vez hechos estos preparativos, ya podremos arrancar máquinas virtuales
con un <em>chip</em> virtual <abbr title="Trusted Platform Module">TPM</abbr> añadiendo lo siguiente:</p>
<p><code class="code docutils literal notranslate"><span class="pre">-chardev</span> <span class="pre">socket,id=chrtpm,path=vmtpm0/swtpm-sock</span> <span class="pre">-tpmdev</span> <span class="pre">emulator,id=tpm0,chardev=chrtpm</span> <span class="pre">-device</span> <span class="pre">tpm-tis,tpmdev=tpm0</span></code></p>
<p>donde el <em>socket</em> es el creado por <strong class="command">swtpm</strong>. Si todo ha ido bien,
el huésped debería disponer de un dispositivo <code class="file docutils literal notranslate"><span class="pre">/dev/tpm0</span></code>. Además,
al apagar la máquina, <strong class="command">swtpm</strong> también completará  su ejecución.</p>
</li>
</ol>
</li>
</ol>
</section>
<section id="compactacion-de-discos">
<span id="qemu-disco-compact"></span><h2><span class="section-number">9.2.2.2.1.4.5. </span>Compactación de discos<a class="headerlink" href="#compactacion-de-discos" title="Enlace permanente a este encabezado">¶</a></h2>
</section>
<section id="cifrado-de-discos">
<span id="qemu-disco-cifrado"></span><h2><span class="section-number">9.2.2.2.1.4.6. </span>Cifrado de discos<a class="headerlink" href="#cifrado-de-discos" title="Enlace permanente a este encabezado">¶</a></h2>
<p class="rubric">Notas al pie</p>
<dl class="footnote brackets">
<dt class="label" id="id4"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>De ahí que tuviéramos que incluir esto al querer emular el comportamiento
del puntero en una pantalla táctil (<kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">-device</kbd> <kbd class="kbd docutils literal notranslate">usb</kbd>-<kbd class="kbd docutils literal notranslate">tablet</kbd></kbd>) tal como
recomienda el manual cuando la salida es <abbr title="Virtual Network Computing">VNC</abbr>.</p>
</dd>
<dt class="label" id="id5"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>Obviamente, el huésped debe tener habilitado el <abbr title="Universal Serial Bus">USB</abbr>, de modo que
también deberá usarse <code class="code docutils literal notranslate"><span class="pre">-device</span> <span class="pre">qemu-xhci</span></code>.</p>
</dd>
<dt class="label" id="id6"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p><strong class="command">swtpm</strong> tiene una opción para correr en segundo plano (<kbd class="kbd docutils literal notranslate">-d</kbd>),
pero <strong class="program">QEmu</strong> no funciona cuando se usa. ?:/</p>
</dd>
</dl>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../../../index.html">Tabla de contenido</a></h3>
    <ul>
<li><a class="reference internal" href="#">9.2.2.2.1.4. Otros aspectos</a><ul>
<li><a class="reference internal" href="#firmware-de-la-placa-base">9.2.2.2.1.4.1. Firmware de la placa base</a></li>
<li><a class="reference internal" href="#usb">9.2.2.2.1.4.2. <abbr title="Universal Serial Bus">USB</abbr></a></li>
<li><a class="reference internal" href="#directorio-compartido">9.2.2.2.1.4.3. Directorio compartido</a></li>
<li><a class="reference internal" href="#chip-tpm">9.2.2.2.1.4.4. Chip <abbr title="Trusted Platform Module">TPM</abbr></a></li>
<li><a class="reference internal" href="#compactacion-de-discos">9.2.2.2.1.4.5. Compactación de discos</a></li>
<li><a class="reference internal" href="#cifrado-de-discos">9.2.2.2.1.4.6. Cifrado de discos</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Tema anterior</h4>
    <p class="topless"><a href="03.red.html"
                          title="capítulo anterior"><span class="section-number">9.2.2.2.1.3. </span>Red</a></p>
  </div>
  <div>
    <h4>Próximo tema</h4>
    <p class="topless"><a href="06.script.html"
                          title="próximo capítulo"><span class="section-number">9.2.2.2.1.5. </span><em>Script</em> de arranque</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/98.apendice/05.virtual/02.kvm/01.qemu/05.misc.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Ir a" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="06.script.html" title="9.2.2.2.1.5. Script de arranque"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="03.red.html" title="9.2.2.2.1.3. Red"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">9. </span>Apéndices</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">9.2. </span>Virtualización</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../../02.kvm.html" ><span class="section-number">9.2.2.2. </span>Nativa (<abbr title="Kernel-based Virtual Machine">KVM</abbr>)</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">9.2.2.2.1.4. </span>Otros aspectos</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2022, José Miguel Sánchez Alés.
      Creado usando <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>