

<!DOCTYPE html>

<html lang="es" data-content_root="../../../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>9.2.2.2.1.1.1. Contenedores privilegiados &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/classic.css?v=514cf933" />
    <link rel="stylesheet" href="../../../../../../_static/custom.css" type="text/css" />
    
    <script src="../../../../../../_static/documentation_options.js?v=a621b78a"></script>
    <script src="../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../_static/translations.js?v=efdbd0b9"></script>
    
    <link rel="index" title="Índice" href="../../../../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../../../../search.html" />
    <link rel="next" title="9.2.2.2.1.1.2. Contenedores no privilegiados" href="02.unpriv.html" />
    <link rel="prev" title="9.2.2.2.1. LXC" href="../../02.lxc.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="02.unpriv.html" title="9.2.2.2.1.1.2. Contenedores no privilegiados"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="../../02.lxc.html" title="9.2.2.2.1. LXC"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../../index.html" ><span class="section-number">9. </span>Apéndices</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../../index.html" ><span class="section-number">9.2. </span>Virtualización</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../../../../02.software.html" ><span class="section-number">9.2.2. </span>Software de virtualización</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="../../02.lxc.html" accesskey="U"><span class="section-number">9.2.2.2.1. </span><abbr title="LinuX Containers">LXC</abbr></a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">9.2.2.2.1.1.1. </span>Contenedores privilegiados</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="contenedores-privilegiados">
<h1><span class="section-number">9.2.2.2.1.1.1. </span>Contenedores privilegiados<a class="headerlink" href="#contenedores-privilegiados" title="Link to this heading">¶</a></h1>
<p>Dedicaremos este epígrafe a la gestión de contenedores privilegiados creados y
gestionados por el propio administrador<a class="footnote-reference brackets" href="#id7" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> y, conocidos estos, introduciremos
en el próximo la dificultad de crear contenedores no privilegiados con un
usuario normal.</p>
<section id="preliminares">
<h2><span class="section-number">9.2.2.2.1.1.1.1. </span>Preliminares<a class="headerlink" href="#preliminares" title="Link to this heading">¶</a></h2>
<p>Al disponer de paquete en <em>Debian</em>, su instalación es sencilla:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>apt<span class="w"> </span>install<span class="w"> </span>lxc
</pre></div>
</div>
<p>Comencemos aclarando, sin embargo, algunas particularidades que nos ayudarán a
entender el desarrollo posterior:</p>
<ol class="arabic">
<li><p>El demonio <strong class="program">lxc-net</strong> gestiona la creación de interfaces puentes (que
se estudiarán bajo el <a class="reference internal" href="#lxc-red"><span class="std std-ref">epígrafe dedicado a la red</span></a>) y,
<a class="reference internal" href="../../../01.completa/02.kvm/02.libvirt/02.gestion.html#virsh-red"><span class="std std-ref">como hace libvirtd</span></a>, proporciona direcciones <abbr title="Internet Protocol">IP</abbr> dinámicas
valiéndose de <a class="reference internal" href="../../../../../../06.infraestructura/02.dhcp/03.dnsmasq.html#dnsmasq-dhcp"><span class="std std-ref">dnsmasq</span></a>.</p></li>
<li><p>Los contenedores contienen un conjunto de archivos y directorios que
constituyen el sistema de archivos del sistema huésped. Por tanto, cada
contenedor recreará una estructura típica de directorios (<code class="file docutils literal notranslate"><span class="pre">/bin</span></code>,
<code class="file docutils literal notranslate"><span class="pre">/etc</span></code>, <code class="file docutils literal notranslate"><span class="pre">/usr</span></code>, etc) que variará según sea la distribución que el
huésped imita.</p></li>
<li><p>Para construir este árbol de directorios, <abbr title="LinuX Containers">LXC</abbr> proporciona <a class="reference external" href="https://uk.lxd.images.canonical.com/">una serie
de plantillas predefinidas</a>.</p></li>
<li><p>Al crear un contenedor con una de ellas, la plantilla se descargará y se
ejecutará un <em>script</em> que preparará el contenedor utilizando la configuración
local y la información de la plantilla. Las plantillas se almacenan en
principio en <code class="file docutils literal notranslate"><span class="pre">/var/cache/lxc</span></code>, aunque pueden borrarse posteriormente
sin escrúpulo.</p></li>
<li><p>A diferencia de <a class="reference internal" href="../../../01.completa/02.kvm.html#qemu"><span class="std std-ref">QEmu</span></a> o <a class="reference internal" href="../../../01.completa/01.virtualbox.html#virtualbox"><span class="std std-ref">Virtualbox</span></a>, no existe
un archivo de disco (<abbr title="Qemu Copy-On-Write">QCOW</abbr>2, <abbr title="Virtual Disk Image">VDI</abbr>) que contenga un sistema de archivos
totalmente ajeno al anfitrión, sino que el contenido del contenedor son
archivos y directorios incluidos en una parte del árbol de directorios del
anfitrión (por defecto, <code class="file docutils literal notranslate"><span class="pre">/var/lib/lxc/nombre_contenedor</span></code>). Esto supone
que <abbr title="LinuX Containers">LXC</abbr> actúe dependiendo de cuál sea el sistema de archivos sobre el que se
encuentra esa parte del árbol, esto es, dependiendo de cuál sea el formato de
su almacenamiento (<em>backing store</em> en su terminología):</p>
<dl class="simple">
<dt>«<em>none</em>» (o también «<em>dir</em>»)</dt><dd><p>este formato es el que se presenta cuando los archivos del contenedor los
trata como archivos sin más consideración. Por ejemplo, si el sistema de
archivos del anfitrión es <em>ext4</em> y <code class="file docutils literal notranslate"><span class="pre">/var/lib/lxc</span></code> forma parte de
este sistema de archivos, no habrá más remedio que usar este formato. No
es lo más apropiado, desde luego:</p>
<ul class="simple">
<li><p>Las instantáneas consisten en hacer una copia completa de todos los
archivos.</p></li>
<li><p>No hay forma de limitar el tamaño del contenedor y, si
<code class="file docutils literal notranslate"><span class="pre">/var/lib/lxc</span></code> no constituye un sistema de archivos aparte, los
contenedores pueden crecer hasta ocupar todo el espacio disponible de
<code class="file docutils literal notranslate"><span class="pre">/</span></code>.</p></li>
</ul>
</dd>
<dt>«<em>btrfs</em>»/«<em>zfs</em>»</dt><dd><p>Si <code class="file docutils literal notranslate"><span class="pre">/var/lib/lxc</span></code> se encuentra en un sistema de archivos <abbr title="B-TRee File System">BTRFS</abbr> o
<abbr title="Zettabyte File System">ZFS</abbr> (p.e. porque hayamos dispuesto esa ruta en partición aparte y le
hayamos dado formato con alguno de estos dos sistemas), entonces podremos
informar a <abbr title="LinuX Containers">LXC</abbr> de que puede hacer uso de sus características especiales
(p.e. soporte nativo para instantáneas, subvolúmenes). Por sus
posibilidades, es la opción más conviente.</p>
</dd>
<dt>«<em>lvm</em>»</dt><dd><p>Podemos optar por incluir cada contenedor en un <a class="reference internal" href="../../../../../../05.discos/01.division/04.virt.html#lvm"><span class="std std-ref">volumen lógico de
LVM</span></a>. <abbr title="Logical Volume Management">LVM</abbr> soporta instantáneas y, si utilizamos
<a class="reference internal" href="../../../../../../05.discos/01.division/04.virt.html#lvm-snapshots"><span class="std std-ref">aprovisionamiento fino</span></a>, las ventajas se
multiplican.</p>
</dd>
<dt>«<em>loop</em>»</dt><dd><p>Este es el formato más cercano al estilo de las dos virtualizaciones
completas que hemos citados anteriormente: los archivos del contenedor se
guardaran dentro de un archivo regular del anfitrión
(<code class="file docutils literal notranslate"><span class="pre">/var/lib/lxc/nombre_contenedor/rootdev</span></code>).</p>
</dd>
</dl>
</li>
</ol>
</section>
<section id="creacion">
<span id="lxc-create"></span><h2><span class="section-number">9.2.2.2.1.1.1.2. </span>Creación<a class="headerlink" href="#creacion" title="Link to this heading">¶</a></h2>
<p>Para la creación de un contenedor tenemos que tener presente de inicio dos
aspectos: qué sistema <em>Linux</em> queremos incluir y cuál será el formato de
almacenamiento. Existe otro más (la limitación de recursos), pero lo trataremos
<a class="reference internal" href="#lxc-limit"><span class="std std-ref">más adelante</span></a>. Comencemos, pues, por lo más sencillo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-create<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-t<span class="w"> </span>download<span class="w"> </span>--<span class="w"> </span>-d<span class="w"> </span>alpine<span class="w"> </span>-r<span class="w"> </span><span class="m">3</span>.17<span class="w"> </span>-a<span class="w"> </span>amd64
</pre></div>
</div>
<p>donde hay que notar:</p>
<ul class="simple">
<li><p>Somos el administrador.</p></li>
<li><p>Nuestro contenedor se llamará «<em>test</em>».</p></li>
<li><p>Hacemos la instalación a través de una plantilla llamada <em>download</em> que facilita
la operación y nos permite seleccionar de forma sencilla una de <a class="reference external" href="https://uk.lxd.images.canonical.com/">las imágenes disponibles en
los servidores</a>. Sin añadir más, la
imagen ejecuta un <em>script</em> que nos muestra y, a continuación, nos permite
seleccionar cuál es la plantilla que deseamos utilizar, pero…</p></li>
<li><p>Tras <kbd class="kbd docutils literal notranslate">--</kbd> se pueden incluir las opciones que permita la plantilla (en
este caso, <em>download</em>). Pues bien, si observamos la lista de plantillas
veremos que cada una se define por cuatro características: <em>distribución</em>
(<kbd class="kbd docutils literal notranslate">-d</kbd>), <em>versión</em> (<kbd class="kbd docutils literal notranslate">-r</kbd>), <em>arquitectura</em> (<kbd class="kbd docutils literal notranslate">-a</kbd>) y variante
(<kbd class="kbd docutils literal notranslate">-v</kbd>), que son precisamente las opciones que permite añadir <em>download</em>
para restringir la lista de selección que nos muestra. Así, si
incluyéramos únicamente <code class="code docutils literal notranslate"><span class="pre">-a</span> <span class="pre">amd64</span></code> aparecerían sólo las plantillas para
esta arquitectura. Si añadimos las opciones suficientes como para restringir
la lista a una sola plantilla, entonces la instalación se realizará
inmediatamente sin más preguntas. Esto es precisamente lo que logra la orden
de arriba, porque aunque falta especificar la variante, cuando esta no se
indica, se entiende que es «<em>default</em>».</p></li>
</ul>
<p>Por tanto, hemos instalado una distribución la variante <em>default</em> de la versión
3.17 de <a class="reference external" href="https://www.alpinelinux.org/">Alpine</a> para arquitectura <a class="reference external" href="https://es.wikipedia.org/wiki/X86-64">x64_64</a><a class="footnote-reference brackets" href="#id8" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>.</p>
<p id="lxc-create-none">Ahora bien, ¿qué pasa con el segundo aspecto, esto es, el formato de
almacenamiento? El formato se introduce con la opción <kbd class="kbd docutils literal notranslate">-B</kbd> antes de
<kbd class="kbd docutils literal notranslate">--</kbd>, puesto que es algo que nada tiene que ver con la plantilla que se
use. Cuando no se especifica nada, <strong class="program">lxc-create</strong> entiende <code class="code docutils literal notranslate"><span class="pre">-B</span>
<span class="pre">none</span></code> (o <code class="code docutils literal notranslate"><span class="pre">-B</span> <span class="pre">dir</span></code>, que es lo mismo) y, por tanto, <abbr title="LinuX Containers">LXC</abbr> entenderá que
nuestro contenedor es una mera colección de archivos y directorios sin nada
especial de lo que pueda aprovecharse. La traducción de esto es que se habrá
creado lo siguiente:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/var/lib/lxc
     +-- test
           +---- config
           +---- rootfs/
                    +-- ...
                    +-- Estructura de directorios de Alpine
                    +-- ...
</pre></div>
</div>
<p>O sea, un directorio dentro de <code class="file docutils literal notranslate"><span class="pre">/var/lib/lxc</span></code> cuyo nombre coincide con el
nombre del contenedor que, a su vez, contiene:</p>
<ul class="simple">
<li><p>Un directorio que incluye la estructura de archivos del contenedor
(<code class="file docutils literal notranslate"><span class="pre">rootfs</span></code>). Cuando entremos en el huésped, nos encontraremos
enjaulados dentro de él.</p></li>
<li><p>Un archivo (<code class="file docutils literal notranslate"><span class="pre">config</span></code>) con la configuración del contenedor para la que se
toma como referencia la que se encuentra en <code class="file docutils literal notranslate"><span class="pre">/etc/lxc/default.conf</span></code>.</p></li>
</ul>
<p id="lxc-create-loop">Probemos crear con otro formato:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-destroy<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w">  </span><span class="c1"># Primero borramos el anterior</span>
<span class="gp"># </span>lxc-create<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-t<span class="w"> </span>download<span class="w"> </span>-B<span class="w"> </span>loop<span class="w"> </span>--fssize<span class="o">=</span>50M<span class="w"> </span>--<span class="w"> </span>-d<span class="w"> </span>alpine<span class="w"> </span>-r<span class="w"> </span><span class="m">3</span>.17<span class="w"> </span>-a<span class="w"> </span>amd64
</pre></div>
</div>
<p>La orden es idéntica a la anterior, pero hemos añadido las opciones para que el
almacenamiento sea un único archivo (<code class="code docutils literal notranslate"><span class="pre">-B</span> <span class="pre">loop</span></code>). <abbr title="LinuX Containers">LXC</abbr> crea un archivo,
pero ¿de qué tamaño y con qué sistema de archivos lo formatea? Para el tamaño
existe la opción <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">-</kbd>-<kbd class="kbd docutils literal notranslate">fssize</kbd></kbd>, que sí se ha indicado porque lo predeterminado
es 1GiB y nosotros no necesitamos tanto para una minidistribución. El sistema de
archivos se especifica con <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">-</kbd>-<kbd class="kbd docutils literal notranslate">fstype</kbd></kbd> y su valor predeterminado es <em>ext4</em>.
Si gulismeamos nos encontraremos lo siguiente:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/var/lib/lxc
     +-- test
           +---- config
           +---- rootdev  [Aquí dentro está nuestra Alpine]
           +---- rootfs/
</pre></div>
</div>
<p>La estructura es semejante, pero ahora <code class="file docutils literal notranslate"><span class="pre">rootfs</span></code> está vacío, puesto que es
el archivo <code class="file docutils literal notranslate"><span class="pre">rootdev</span></code> el que contiene dentro de sí toda la estructura de
directorios. En este caso, cuando arranquemos el contenedor, <abbr title="LinuX Containers">LXC</abbr> montará el
contenido de <code class="file docutils literal notranslate"><span class="pre">rootdev</span></code> sobre <code class="file docutils literal notranslate"><span class="pre">rootfs</span></code>. También es preciso notar que,
si el sistema de archivos lo soporta, el archivo <code class="file docutils literal notranslate"><span class="pre">rootdev</span></code> es <a class="reference internal" href="../../../../../../05.discos/01.division/03.pract.html#truncate"><span class="std std-ref">un
archivo disperso como el que podemos crear nosotros con truncate</span></a>,
por lo que inicialmente no ocupará todo el tamaño que le asignamos, e irá
creciendo según añadamos contenido.</p>
<p id="lxc-create-zfs"><span id="lxc-create-btrfs"></span>Si <code class="file docutils literal notranslate"><span class="pre">/var/lib/lxc</span></code> se encuentra en un sistema de archivos <abbr title="B-TRee File System">BTRFS</abbr>, podremos
indicarle a <abbr title="LinuX Containers">LXC</abbr> que lo tenga en cuenta. Sin embargo, para ello deberemos
tener antes instalado:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>btrfs-progs
</pre></div>
</div>
<p>Ahora sí, procedamos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-destroy<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span>
<span class="gp"># </span>lxc-create<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-t<span class="w"> </span>download<span class="w"> </span>-B<span class="w"> </span>btrfs<span class="w"> </span>--<span class="w"> </span>-d<span class="w"> </span>alpine<span class="w"> </span>-r<span class="w"> </span><span class="m">3</span>.17<span class="w"> </span>-a<span class="w"> </span>amd64
</pre></div>
</div>
<p>En principio, no observaremos diferencias respecto a <a class="reference internal" href="#lxc-create-none"><span class="std std-ref">no especificar
formato</span></a> (la estructura de archivos es idéntica), pero
existen. De hecho:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>btrfs<span class="w"> </span>subvolume<span class="w"> </span>list<span class="w"> </span>/var/lib/lxc
<span class="go">ID 258 gen 102 top level 5 path test/rootfs</span>
</pre></div>
</div>
<p><abbr title="LinuX Containers">LXC</abbr> ha definido un subvolumen para la estructura de directorios del
contenedor. Esta es la clave que permite luego crear instantáneas o limitar el
espacio de disco del contenedor.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Con <abbr title="Zettabyte File System">ZFS</abbr> ocurre algo similar.</p>
</div>
<p id="lxc-create-lvm">Por último, podemos escoger como formato de almacenamiento <abbr title="Logical Volume Management">LVM</abbr>. Para ello es
obvio que necesitamos disponer de un grupo de volúmenes (al que llamaremos
<em>VGtest</em>) y, aunque no es extrictamente necesario, supondremos que dentro de él
también tenemos un pool llamado <em>lxc</em> para aprovisionamiento fino<a class="footnote-reference brackets" href="#id9" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>. En
estas circunstancias, podemos crear un contenedor así:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-destroy<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span>
<span class="gp"># </span>lxc-create<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-t<span class="w"> </span>download<span class="w"> </span>-B<span class="w"> </span>lvm<span class="w"> </span>--vgname<span class="w"> </span>VGtest<span class="w"> </span>--thinpool<span class="w"> </span>lxc<span class="w"> </span>--fssize<span class="o">=</span>50M<span class="w"> </span>--<span class="w"> </span>-d<span class="w"> </span>alpine<span class="w"> </span>-r<span class="w"> </span><span class="m">3</span>.17<span class="w"> </span>-a<span class="w"> </span>amd64
</pre></div>
</div>
<p>Esto supone que dentro del <em>pool</em> <code class="file docutils literal notranslate"><span class="pre">VGtest/lxc</span></code> se cree un volumen lógico
de 50 MiB (<kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">-</kbd>-<kbd class="kbd docutils literal notranslate">fssize</kbd></kbd>) para albergar el contenedor. El nombre del volumen
lógico se toma del nombre del contenedor. Por tanto, si consultamos los
volúmenes existentes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># lvs</span>
<span class="w">  </span>LV<span class="w">        </span>VG<span class="w">     </span>Attr<span class="w">       </span>LSize<span class="w">   </span>Pool<span class="w"> </span>Origin<span class="w"> </span>Data%<span class="w">  </span>Meta%<span class="w">  </span>Move<span class="w"> </span>Log<span class="w"> </span>Cpy%Sync<span class="w"> </span>Convert
<span class="w">  </span>home<span class="w">      </span>VGraid<span class="w"> </span>Vwi-aotz--<span class="w"> </span><span class="m">500</span>,00m<span class="w"> </span>lxc<span class="w">         </span><span class="m">6</span>,45
<span class="w">  </span>log<span class="w">       </span>VGraid<span class="w"> </span>-wi-ao----<span class="w">  </span><span class="m">64</span>,00m
<span class="w">  </span>lxc<span class="w">       </span>VGraid<span class="w"> </span>twi-aotz--<span class="w"> </span><span class="m">768</span>,00m<span class="w">             </span><span class="m">12</span>,59<span class="w">  </span><span class="m">12</span>,40
<span class="w">  </span>mysql<span class="w">     </span>VGraid<span class="w"> </span>Vwi-aotz--<span class="w"> </span><span class="m">500</span>,00m<span class="w"> </span>lxc<span class="w">         </span><span class="m">6</span>,41
<span class="w">  </span>raiz<span class="w">      </span>VGraid<span class="w"> </span>-wi-ao----<span class="w">   </span><span class="m">1</span>,75g
<span class="w">  </span>srv<span class="w">       </span>VGraid<span class="w"> </span>Vwi-aotz--<span class="w"> </span><span class="m">500</span>,00m<span class="w"> </span>lxc<span class="w">         </span><span class="m">6</span>,41
<span class="w">  </span>swap<span class="w">      </span>VGraid<span class="w"> </span>-wc-ao----<span class="w">  </span><span class="m">32</span>,00m
<span class="hll"><span class="w">  </span><span class="nb">test</span><span class="w">      </span>VGraid<span class="w"> </span>Vwi-aotz--<span class="w">  </span><span class="m">50</span>,00m<span class="w"> </span>lxc<span class="w">         </span><span class="m">3</span>,14
</span></pre></div>
</div>
<p>Como no hemos especificado sistema de archivos (<kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">-</kbd>-<kbd class="kbd docutils literal notranslate">fstype</kbd></kbd>), el volumen
lógico se formatea en <em>ext4</em>. La orden crea un estructura como la anterior:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/var/lib/lxc
     +-- test
           +---- config
           +---- rootfs/
</pre></div>
</div>
<p>pero <code class="file docutils literal notranslate"><span class="pre">rootfs</span></code> se encontrará vacío puesto los archivos del contenedor se
encuentran en el volumen lógico.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Como lo habitual es que tanto el grupo de volúmenes como el <em>pool</em>
sean siempre los mismos, es posible definir un archivo
<code class="file docutils literal notranslate"><span class="pre">/etc/lxc/lxc.conf</span></code> donde se definan estos nombres a fin de no tener
que repetirlos constantemente al crear contenedores (véase
<em class="manpage"><a class="manpage reference external" href="https://manpages.debian.org/lxc.system.conf">lxc.system.conf</a></em> para más información).</p>
</div>
</section>
<section id="manejo">
<span id="lxc-manage"></span><h2><span class="section-number">9.2.2.2.1.1.1.3. </span>Manejo<a class="headerlink" href="#manejo" title="Link to this heading">¶</a></h2>
<p>Una vez usado <a class="reference internal" href="#lxc-create"><span class="std std-ref">lxc-create</span></a>, se creará el contenedor:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-ls
<span class="go">test</span>
</pre></div>
</div>
<p>pero se encontrará parado, lo cual puede comprobarse añadiendo la opción
<kbd class="kbd docutils literal notranslate">-f</kbd>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-ls<span class="w"> </span>-f
<span class="go">NAME STATE   AUTOSTART GROUPS IPV4 IPV6 UNPRIVILEGED</span>
<span class="go">test STOPPED 0         -      -    -    false</span>
</pre></div>
</div>
<p>o bien, <strong class="command">lxc-info</strong>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-info<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span>
<span class="go">Name:           test</span>
<span class="go">State:          STOPPED</span>
</pre></div>
</div>
<p>Para <strong>arrancar</strong> el contenedor es preciso:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-start<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>lo cual cambia el estado del contenedor:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-ls<span class="w"> </span>-f
<span class="go">NAME STATE   AUTOSTART GROUPS IPV4          IPV6 UNPRIVILEGED</span>
<span class="go">test RUNNING 0         -      10.0.3.108    -    false</span>
<span class="gp"># </span>lxc-info<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span>
<span class="go">Name:           test</span>
<span class="go">State:          RUNNING</span>
<span class="go">PID:            3156</span>
<span class="go">IP:             10.0.3.108</span>
<span class="go">Link:           vethL6i8cY</span>
<span class="go"> TX bytes:      2.09 KiB</span>
<span class="go"> RX bytes:      2.56 KiB</span>
<span class="go"> Total bytes:   4.65 KiB</span>
</pre></div>
</div>
<p>Esta orden lo arranca, pero por defecto lo deja en segundo plano<a class="footnote-reference brackets" href="#id10" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a>, por lo
que tendremos que conectarnos al contenedor. La manera fetén de hacerlo es
utilizando la orden <em class="manpage"><a class="manpage reference external" href="https://manpages.debian.org/lxc-console">lxc-console</a></em> que nos presentará un <em>login</em> de
acceso. Sin embargo, ¿cuál es la contraseña? Lo primero, pues, es preparar el
acceso para que nos sea posible. Para ello disponemos de <em class="manpage"><a class="manpage reference external" href="https://manpages.debian.org/lxc-attach">lxc-attach</a></em>,
que permite ejecutar directamente órdenes dentro del contenedor, así que podemos
empezar por ponerle una contraseña al administrador:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--<span class="w"> </span>passwd
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>En otras distribuciones bastará con esto, pero en el caso
particular de <em>Alpine</em>, seguiremos teniendo problemas de acceso, porque en
ella, cuando se accede como administrador, se consulta <em class="manpage"><a class="manpage reference external" href="https://manpages.debian.org/securetty">securetty</a></em>
para comprobar si la consola de acceso es considerada segura y las que usamos
con <strong class="command">lxc-console</strong> (<code class="file docutils literal notranslate"><span class="pre">/dev/lxc/tty1</span></code>, <code class="file docutils literal notranslate"><span class="pre">/dev/lxc/tty2</span></code>,
etc.) no están. Podemos optar por crear un usuario sin privilegios (y ya en
el contenedor convertirnos en administrador con <a class="reference internal" href="../../../../../../02.conbas/05.seguridad/05a.usuarios.html#su"><span class="std std-ref">su</span></a>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--<span class="w"> </span>adduser<span class="w"> </span>-s<span class="w"> </span>/bin/ash<span class="w"> </span>-g<span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span>usuario
</pre></div>
</div>
<p>o eliminar el archivo <code class="file docutils literal notranslate"><span class="pre">/etc/securetty</span></code> para evitar la comprobación:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--<span class="w"> </span>mv<span class="w"> </span>/etc/securetty<span class="w"> </span>/etc/securetty.move
</pre></div>
</div>
</div>
<p>Hecho lo cual, podremos ingresar en el contenedor:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-console<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span>

<span class="go">Connected to tty 1</span>
<span class="go">Type &lt;Ctrl+a q&gt; to exit the console, &lt;Ctrl+a Ctrl+a&gt; to enter Ctrl+a itself</span>

<span class="go">Welcome to Alpine Linux 3.17</span>
<span class="go">Kernel 5.10.0-19-amd64 on an x86_64 (/dev/tty1)</span>

<span class="go">test login: root</span>
<span class="go">Password:</span>

<span class="go">[...]</span>

<span class="gp">test:~# </span>_
</pre></div>
</div>
<p>Obsérvese, cómo se nos advierte de que para salir de la consola (que es la
<strong>1</strong>) podemos teclear <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">Ctrl</kbd>-<kbd class="kbd docutils literal notranslate">A</kbd>+<kbd class="kbd docutils literal notranslate">q</kbd></kbd>. Esto se debe a que si cerramos la sesión
(por ejemplo, con <a class="reference internal" href="../../../../../../02.conbas/01.preliminares/index.html#exit"><span class="std std-ref">exit</span></a>), se nos volverá a pedir el <em>login</em> como
ocurre en un sistema habitualmente; y. si optamos por apagar (<a class="reference internal" href="../../../../../../02.conbas/01.preliminares/index.html#poweroff"><span class="std std-ref">poweroff</span></a>). lo que lograremos es apagar el sistema huésped, o sea, parar el
contenedor. La combinación de teclas  nos permite desconectarnos del huésped
para volver al sistema anfitrión. Posteriormente, podremos volver a conectarnos
con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-console<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-t1
</pre></div>
</div>
<p>donde especificamos el número de consola a la que queremos conectar para evitar
que <strong class="command">lxc-console</strong> pueda escoger una distinta<a class="footnote-reference brackets" href="#id11" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a>. También es útil
tener presente que es posible cambiar la tecla de control por si <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">Ctrl</kbd>+<kbd class="kbd docutils literal notranslate">A</kbd></kbd>,
ya la usamos para algo especial en el anfitrión (p.e. porque usemos <a class="reference external" href="https://www.gnu.org/software/screen/">screen</a>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-console<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;^k&#39;</span><span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>El <em>gorrito</em> (<kbd class="kbd docutils literal notranslate">^</kbd>) se ha escrito literalmente.</p>
</div>
<p>Ya sólo nos queda saber cómo parar y eliminar el contenedor. Lo primero se logra
bien apagando el contenedor desde el propio huésped (p.e. con <a class="reference internal" href="../../../../../../02.conbas/01.preliminares/index.html#poweroff"><span class="std std-ref">poweroff</span></a>) como ya hemos visto, o bien desde el anfitrión utilizando la
orden:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-stop<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>Una vez que hayamos parado el contenedor, podremos eliminarlo con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-destroy<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
</section>
<section id="limitacion">
<span id="lxc-limit"></span><h2><span class="section-number">9.2.2.2.1.1.1.4. </span>Limitación<a class="headerlink" href="#limitacion" title="Link to this heading">¶</a></h2>
<p>Al tratar de limitar recursos tenemos que distinguir entre limitar el espacio de
disco, que es algo que dependerá del formato de almacenamiento, y limitar el
resto de recursos (<abbr title="Random Access Memory">RAM</abbr>, <abbr title="Central Processing Unit">CPU</abbr>, etc) que depende de <em>cgroups</em>.</p>
<p class="rubric">Espacio de disco</p>
<p>Dos de los formatos que hemos revisado (<a class="reference internal" href="#lxc-create-loop"><span class="std std-ref">loop</span></a> y
<a class="reference internal" href="#lxc-create-lvm"><span class="std std-ref">lvm</span></a>) ya limitan <em>per se</em> el tamaño del contenedor por
vía de la opción <code class="file docutils literal notranslate"><span class="pre">--fssize</span></code>. <a class="reference internal" href="#lxc-create-none"><span class="std std-ref">none</span></a>, por su parte,
es incapaz de fijar una limitación, puesto que los archivos irán creciendo
mientras haya espacio disponible dentro del sistema de archivos en el que se
encuentre <code class="file docutils literal notranslate"><span class="pre">/var/lib/lxc</span></code>. Por tanto, esta exposición se reduce a conocer
cómo limitarlo con <a class="reference internal" href="#lxc-create-btrfs"><span class="std std-ref">brtfs</span></a> y (<a class="reference internal" href="#lxc-create-zfs"><span class="std std-ref">zfs</span></a>).  En ambos casos, la limitación  se fija haciendo uso de las
herramientas propias del sistema de archivos y no del propio <abbr title="LinuX Containers">LXC</abbr>, así que es
más un problema de conocer tal sistema de archivos que de conocer esta
tecnología de contenedores. Estudiemos cómo hacerlo con <abbr title="B-TRee File System">BTRFS</abbr>.</p>
<p>Ya se adelantó que al crear un contenedor sobre un sistema <abbr title="B-TRee File System">BTRFS</abbr> (e indicarle
con <code class="code docutils literal notranslate"><span class="pre">:B</span> <span class="pre">btrfs</span></code> que así es), se crea automáticamente un subvolumen para el
contenido del contenedor:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>btrfs<span class="w"> </span>subvolume<span class="w"> </span>list<span class="w"> </span>/var/lib/lxc
<span class="go">ID 258 gen 102 top level 5 path test/rootfs</span>
</pre></div>
</div>
<p>Pues bien, para poder limitar el espacio que ocupará este subvolumen,
necesitamos habilitar las cuotas en el sistema de archivos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>btrfs<span class="w"> </span>quota<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>/var/lib/lxc
</pre></div>
</div>
<p>y establecer una cuota para el subvolumen:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>btrfs<span class="w"> </span>qgroup<span class="w"> </span>limit<span class="w"> </span>50m<span class="w"> </span>/var/lib/lxc/test/rootfs
</pre></div>
</div>
<p>con lo cual:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>btrfs<span class="w"> </span>qgroup<span class="w"> </span>show<span class="w"> </span>-r<span class="w"> </span>/var/lib/lxc
<span class="go">qgroupid         rfer         excl     max_rfer</span>
<span class="go">--------         ----         ----     --------</span>
<span class="go">0/5          16.00KiB     16.00KiB         none</span>
<span class="hll"><span class="go">0/258         9.65MiB      9.65MiB     50.00MiB</span>
</span></pre></div>
</div>
<p>Y, efectivamente, si intentamos dentro del huésped escribir 50MiB:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">test:~$  </span>dd<span class="w"> </span>&lt;<span class="w"> </span>/dev/zero<span class="w"> </span>&gt;<span class="w"> </span>ceros<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1M<span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">50</span>
<span class="go">dd: error writing &#39;standard output&#39;: Quota exceeded</span>
<span class="go">41+0 records in</span>
<span class="go">40+0 records out</span>
</pre></div>
</div>
<p>seremos incapaces de completar la operación, porque  ya había más de 9MiB
ocupados por la propia <em>Alpine</em>.</p>
<p>Podemos redefinir cualquier otro valor para la cuota y, si decidimos eliminarla,
basta con usar la palabra <em>none</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>btrfs<span class="w"> </span>qgroup<span class="w"> </span>limit<span class="w"> </span>none<span class="w"> </span>/var/lib/lxc/test/rootfs
</pre></div>
</div>
<p class="rubric">Otros recursos</p>
<p>El resto de recursos (p.e. la memoria <abbr title="Random Access Memory">RAM</abbr>) se limitan haciendo uso de
<em>cgroups</em>. Las modernas versiones de <em>Debian</em> (a partir de <a class="reference external" href="https://www.debian.org/News/2021/20210814">Bullseye</a>) usan
<em>v2</em>, así que sobre esta segunda versión es sobre la que trabajaremos. En
principio, no hay definida ninguna limitación, así que si sobre mi sistema de
512MiB, entro al contenedor y consulto la memoria disponible:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">test:~$  </span>grep<span class="w"> </span>^MemT<span class="w"> </span>/proc/meminfo
<span class="go">MemTotal:         484704 kB</span>
</pre></div>
</div>
<p>obtendremos más o menos esa cantidad de memoria disponible. ¿Cómo establecer las
limitaciones? Para ello debemos hacer uso de <strong class="command">lxc-cgroups</strong> (con la
contenedor arrancado) y saber <a class="reference external" href="https://facebookmicrosites.github.io/cgroup2/docs/memory-controller.html">qué controlador</a>
debemos tocar:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-groups<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>memory.max<span class="w"> </span>100m
<span class="gp"># </span>lxc-groups<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>memory.swap.max<span class="w"> </span>25m
<span class="gp"># </span>lxc-cgroup<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>cpuset.cpus<span class="w"> </span><span class="m">0</span>,2
</pre></div>
</div>
<p>Estos, por ejemplo, limitan la <abbr title="Random Access Memory">RAM</abbr>, la <em>swap</em> y el uso de la <abbr title="Central Processing Unit">CPU</abbr> a solamente
al primero y tercero de los núcleos. Podemos comprobar estos límites
consultando:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>cat<span class="w"> </span>/sys/fs/cgroup/lxc.payload.test/memory.max
<span class="go">104857600</span>
</pre></div>
</div>
<p>o sea, 10MiB expresados en <em>bytes</em>. Los límites, sin embargo, son efímeros y se
perderán al apagar la máquina. Para hacerlos permanentes, pueden añadirse al
archivo de configuración del contenedor (en este caso,
<code class="file docutils literal notranslate"><span class="pre">/var/lib/lxc/test/config</span></code>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>lxc.cgroup2.memory.max<span class="w"> </span><span class="o">=</span><span class="w"> </span>100m
lxc.cgroup2.memory.swap.max<span class="w"> </span><span class="o">=</span><span class="w"> </span>25m
lxc.cgroup2.cpuset.cpus<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>,2
</pre></div>
</div>
<div class="admonition-todo admonition" id="id6">
<p class="admonition-title">Por hacer</p>
<p><a class="reference internal" href="../../../../../../02.conbas/99.misc/01.anahw.html#free"><span class="std std-ref">free</span></a>, sin embargo, devuelve datos del anfitrión. Debe de
ser algo relacionado con el servicio <em>lxcfs</em>. Debe comprobarse si se mantiene
este problema con <abbr title="LinuX containers Daemon">LXD</abbr>.</p>
</div>
</section>
<section id="copias">
<span id="lxc-copy"></span><h2><span class="section-number">9.2.2.2.1.1.1.5. </span>Copias<a class="headerlink" href="#copias" title="Link to this heading">¶</a></h2>
<p>La copia de un contenedor proporciona, en general, un nuevo contenedor
independiente. La herramienta para llevarla a cabo es <em class="manpage"><a class="manpage reference external" href="https://manpages.debian.org/lxc-copy">lxc-copy</a></em>, y su
sintaxis no depende de cuál sea el formato de almacenamiento, aunque los
detalles de cada uno nos pueden resultar interesante. Por tanto, introduciremos
primero su uso y, ya conocido, estudiaremos cómo se comporta con cada uno de los
formatos.</p>
<p>La creación de un nuevo contenedor a partir de otro ya existente es bastante
sencilla:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-copy<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-N<span class="w"> </span>copiatest
<span class="gp"># </span>lxc-ls<span class="w"> </span>-fF<span class="w"> </span>name,state
<span class="go">NAME      STATE</span>
<span class="go">copiatest STOPPED</span>
<span class="go">test      STOPPED</span>
</pre></div>
</div>
<p>Con ello tendremos dos contenedores distintos, aunque exactamente iguales, que
podrán usarse simultáneamente y divergir a partir de ahora. Ambos, además,
tendrán el mismo formato de almacenamiento.</p>
<dl>
<dt><em>none</em></dt><dd><p>Internamente lo que ocurre es que se hace una copia simple de los contenidos
del contenedor, por lo que ocuparemos el doble de espacio. Sin embargo, este
formato, permite al hacer una copia la inclusión de la opción <kbd class="kbd docutils literal notranslate">-s</kbd> (de
<em>snapshot</em>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-copy<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-s<span class="w"> </span>-N<span class="w"> </span>copiatest
</pre></div>
</div>
<p>En este caso, el contenedor resultante depende de la existencia del
original:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>ls<span class="w"> </span>-1<span class="w"> </span>/var/lib/lxc/copiatest/
<span class="go">config</span>
<span class="go">lxc_rdepends</span>
<span class="go">overlay</span>
<span class="go">rootfs</span>
<span class="gp"># </span>grep<span class="w"> </span>rootfs<span class="w"> </span>/var/lib/lxc/copiatest/config
<span class="go">lxc.rootfs.path = overlay:/var/lib/lxc/test/rootfs:/var/lib/lxc/copiatest/overlay/delta</span>
</pre></div>
</div>
<p>ya que se utiliza <a class="reference external" href="https://www.grant.pizza/blog/overlayfs/">overlayfs</a> (un
sistema de archivos de unión) para constituirse. Por ello, el nuevo
contenedor toma como base el antiguo y solamente contiene las diferencias
respecto a éste. Téngase en cuenta que si se manipula el contenedor original,
tales manipulaciones también se reflejan en el nuevo contenedor, por lo que
debería evitarse su ejecución.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Observe que hacer esto es equivalente a crear un disco derivado
<abbr title="Qemu Copy-On-Write">QCOW</abbr>2, o en Virtualbox definir un disco <abbr title="Virtual Disk Image">VDI</abbr> como de <em>multiconexión</em>.</p>
</div>
</dd>
<dt><em>loop</em></dt><dd><p>La copia del contenedor con este formato:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-copy<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-N<span class="w"> </span>copiatest
</pre></div>
</div>
<p>crea un contenedor independiente cuyo formato es también <em>loop</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-ls<span class="w"> </span>-1
<span class="go">copiatest</span>
<span class="go">test</span>
<span class="gp"># </span>ls<span class="w"> </span>-1<span class="w"> </span>/var/lib/lxc/copiatest/
<span class="go">config</span>
<span class="go">rootdev</span>
<span class="go">rootfs</span>
<span class="gp"># </span>grep<span class="w"> </span>rootfs<span class="w"> </span>/var/lib/lxc/copiatest/config
<span class="go">lxc.rootfs.path = loop:/var/lib/lxc/copiatest/rootdev</span>
</pre></div>
</div>
<p>Este formato no soporta la opción <kbd class="kbd docutils literal notranslate">-s</kbd>.</p>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p><strong class="command">lxc-copy</strong> es un comando <em>mudito</em> y deja de mostrar errores
cuando estos se producen, a menos que modifiquemos el nivel de los
mensajes. Es el caso de intentar añadir la opción <kbd class="kbd docutils literal notranslate">-s</kbd> a la copia de
un contenedor con este formato:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-copy<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-s<span class="w"> </span>-N<span class="w"> </span>copiatest
<span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
<span class="go">1</span>
</pre></div>
</div>
<p>y habrá que añadirle la opción <kbd class="kbd docutils literal notranslate">-l</kbd> para que lo haga:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-copy<span class="w"> </span>-l<span class="w"> </span>info<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-s<span class="w"> </span>-N<span class="w"> </span>copiatest
<span class="go">lxc-copy: test: storage/loop.c: loop_clonepaths: 45 The loop storage driver does not support snapshots</span>
<span class="go">lxc-copy: test: storage/storage.c: storage_copy: 412 Failed creating new paths for clone of &quot;/var/lib/lxc/test/rootdev&quot;</span>
<span class="go">lxc-copy: test: lxccontainer.c: copy_storage: 3586 Error copying storage.</span>
<span class="go">lxc-copy: test: tools/lxc_copy.c: do_clone: 358 Failed to clone</span>
</pre></div>
</div>
</div>
</dd>
<dt><abbr title="Logical Volume Management">LVM</abbr></dt><dd><p>La copia, simplemente, crea otro volumen lógico. No soporta la opción
<kbd class="kbd docutils literal notranslate">-s</kbd>.</p>
</dd>
<dt><abbr title="B-TRee File System">BTRFS</abbr></dt><dd><p>Se añade o no la opción <kbd class="kbd docutils literal notranslate">-s</kbd> obra de un mismo modo: crea un nuevo
subvolumen para el nuevo contenedor que es una instantánea del contenedor
original:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-copy<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-N<span class="w"> </span>copiatest
<span class="gp"># </span>btrfs<span class="w"> </span>subvolume<span class="w"> </span>list<span class="w"> </span>-s<span class="w"> </span>/var/lib/lxc<span class="w">  </span><span class="c1"># -s lista sólo subvolúmenes que sean instantáneas</span>
<span class="go">ID 269 gen 314 cgen 313 top level 5 otime 2023-01-13 19:54:20 path copiatest/rootfs</span>
</pre></div>
</div>
<p>lo cual supone que, de principio, no ocupen apenas espacio adicional de disco.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Si el subvolumen asociado al contenedor tiene definido un límite de
cuota, el subvolumen del nuevo  contenedor también tendrá definido ese
mismo límite.</p>
</div>
</dd>
</dl>
</section>
<section id="instantaneas">
<span id="lxc-snapshot"></span><h2><span class="section-number">9.2.2.2.1.1.1.6. </span>Instantáneas<a class="headerlink" href="#instantaneas" title="Link to this heading">¶</a></h2>
<p>Las instantáneas (como en el caso de las herramientas de virtualización
completa) permiten guardar un estado determinado del contenedor a fin de poder
recuperarlo en el futuro. En este caso, la herramienta es <em class="manpage"><a class="manpage reference external" href="https://manpages.debian.org/lxc-snapshot">lxc-snapshot</a></em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-snapshot<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>Esto genera propiamente una instantánea (por eso no tiene nombre propio), no
un nuevo contenedor, que se almacena dentro del propio directorio de
«<em>test</em>»:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-ls
<span class="go">test</span>
<span class="gp"># </span>lxc-snapshot<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-L
<span class="go">snap0 (/var/lib/lxc/test/snaps) 2023:01:13 09:29:44</span>
</pre></div>
</div>
<p>Obviamente, podremos seguir modificando el contenedor con la seguridad de poder
regresar al estado en que sehizo la instantánea:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-start<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span>
<span class="gp"># </span>lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--<span class="w"> </span>touch<span class="w"> </span>/root/saludo.txt
<span class="gp"># </span>lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--<span class="w"> </span>ls<span class="w"> </span>/root/
<span class="go">saludo.txt</span>
<span class="gp"># </span>lxc-stop<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>Y si ahora queremos revertir los cambios:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-snapshot<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-r<span class="w"> </span>snap0
</pre></div>
</div>
<p>el contenedor volverá al estado en que se encontraba al realizar la
instantánea:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-start<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span>
<span class="gp"># </span>lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--<span class="w"> </span>ls<span class="w"> </span>/root/
<span class="gp"># </span>lxc-stop<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>Las instantáneas, por supuesto, pueden borrarse:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-snapshot<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-d<span class="w"> </span>snap0
<span class="gp"># </span>lxc-snapshot<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-L
<span class="go">No snapshots</span>
</pre></div>
</div>
<dl>
<dt><em>none</em></dt><dd><p>La instantánea no es más que una copia simple del contenido del contenedor.
Por tanto, duplicaremos la ocupación del disco.</p>
</dd>
<dt><em>loop</em></dt><dd><p>Como <em>none</em>, se hace una copia completa del contenido:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-snapshot<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span>
<span class="gp"># </span>lxc-snapshot<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-L
<span class="go">snap0 (/var/lib/lxc/test/snaps) 2023:01:13 11:06:39</span>
<span class="gp"># </span>grep<span class="w"> </span>rootfs<span class="w"> </span>/var/lib/lxc/test/snaps/snap0/config
<span class="go">lxc.rootfs.path = dir:/var/lib/lxc/test/snaps/snap0/rootfs</span>
<span class="gp"># </span>ls<span class="w"> </span>/var/lib/lxc/test/snaps/snap0/rootfs/
<span class="go">bin  dev  etc  home  lib  lost+found  media  mnt  opt  proc  root  run sbin  srv  sys  tmp  usr  var</span>
</pre></div>
</div>
</dd>
<dt><abbr title="Logical Volume Management">LVM</abbr></dt><dd><p>No soporta la creación de instantáneas.</p>
</dd>
<dt><abbr title="B-TRee File System">BTRFS</abbr></dt><dd><p>Usa también la técnica de subvolúmenes e instantáneas del sistema de
archivos, por lo que permite ahorrar espacio de disco.</p>
</dd>
</dl>
</section>
<section id="configuracion">
<span id="lxc-conf"></span><h2><span class="section-number">9.2.2.2.1.1.1.7. </span>Configuración<a class="headerlink" href="#configuracion" title="Link to this heading">¶</a></h2>
<p>Cuando se crea un contenedor, dentro de su directorio de definición (p.e.
<code class="file docutils literal notranslate"><span class="pre">/var/lib/lxc/test</span></code> para el contenedor <em>test</em>), hay al menos dos entidades
que se crean:</p>
<ul class="simple">
<li><p>un directorio <code class="file docutils literal notranslate"><span class="pre">rootfs</span></code> en el que se encontrarán los archivos que
constituyen el contenido del contenedor.</p></li>
<li><p>Un archivo <code class="file docutils literal notranslate"><span class="pre">config</span></code> con su definición.</p></li>
</ul>
<p>Este último archivo se genera a partir de dos fuentes:</p>
<ol class="arabic">
<li><p>La que suministra la propia orden <a class="reference internal" href="#lxc-create"><span class="std std-ref">lxc-create</span></a>. Tal es el
caso, por ejemplo, del propio nombre del contenedor. Por ese motivo, el
archivo contiene esta línea:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">lxc.uts.name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">test</span>
</pre></div>
</div>
</li>
<li><p>La configuración predeterminada suministrada a través del contenido del
archivo <code class="file docutils literal notranslate"><span class="pre">/etc/lxc/default.conf</span></code>. El contenido de este archivo en mi
sistema es:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">lxc.net.0.type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">veth</span>
<span class="na">lxc.net.0.link</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">lxcbr0</span>
<span class="na">lxc.net.0.flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">up</span>

<span class="na">lxc.apparmor.profile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">generated</span>
<span class="na">lxc.apparmor.allow_nesting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1</span>
</pre></div>
</div>
<p>razón por la cual todos los contenedores traen en principio una única
interfaz de red conectada a la interfaz puente <em>lxcbr0</em>.</p>
<p>La ruta de este archivo, sin embargo, no es inamovible. <a class="reference internal" href="#lxc-create"><span class="std std-ref">Creación</span></a>
tiene una opción <kbd class="kbd docutils literal notranslate">-f</kbd> que permite introducir una ruta alternativa para
el contenedor que se esté creando en ese momento y, además, es posible crear
un archivo <code class="file docutils literal notranslate"><span class="pre">/etc/lxc/lxc.conf</span></code> en donde se defina otra ruta que se use
permanentemente (consúltese la página de manual <em class="manpage"><a class="manpage reference external" href="https://manpages.debian.org/lxc.system.conf">lxc.system.conf</a></em>).</p>
</li>
</ol>
<p>Analicemos algunos aspectos relacionados con la configuración. La configuración
de la red, que es más enjundiosa, la trataremos bajo epígrafe aparte.</p>
<p class="rubric" id="lxc-groups">Grupos</p>
<p>Los contenedores cuya ejecución esté relacionada entre sí, pueden incluirse
dentro de un mismo grupo con solo añadir <kbd class="kbd docutils literal notranslate">lxc.group</kbd> a la configuración.
Supongamos, por ejemplo, estos dos contenedores:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-create<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-t<span class="w"> </span>download<span class="w"> </span>--<span class="w"> </span>-d<span class="w"> </span>alpine<span class="w"> </span>-r<span class="w"> </span><span class="m">3</span>.17<span class="w"> </span>-a<span class="w"> </span>amd64
<span class="gp"># </span>lxc-copy<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-N<span class="w"> </span>copiatest
</pre></div>
</div>
<p>que hemos configurado de manera que se complementan y ambos deben estar
arrancados. Para ello podemos incluirlos dentro de un mismo grupo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>cat<span class="w"> </span>&gt;&gt;<span class="w"> </span>/var/lib/lxc/test/config

<span class="gp"># </span>Grupo<span class="w"> </span>de<span class="w"> </span>pruebas
<span class="go">lxc.group = pruebas</span>
<span class="go">lxc.start.order = 1</span>
<span class="go">lxc.start.delay = 3</span>

<span class="gp"># </span>cat<span class="w"> </span>&gt;&gt;<span class="w"> </span>/var/lib/lxc/copiatest/config

<span class="gp"># </span>Grupo<span class="w"> </span>de<span class="w"> </span>pruebas
<span class="go">lx.group = pruebas</span>
<span class="go">lxc.start.order = 2</span>
</pre></div>
</div>
<p>Si hemos hecho esta configuración, entonces podremos arrancar el conjunto con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-autostart<span class="w"> </span>-A<span class="w"> </span>-g<span class="w"> </span>pruebas
</pre></div>
</div>
<p>en vez de tener que ir arrancando individualmente cada una de las máquinas.
Gracias a <kbd class="kbd docutils literal notranslate">lxc.start.order</kbd> podremos definir el orden de arranque de los
contenedores y, <kbd class="kbd docutils literal notranslate">lxc.start.delay</kbd> permite introducir unos segundos de
espera para el arranque del siguiente contenedor.</p>
<p>Para apagar el conjunto en una sola orden podemos hacer:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-autostart<span class="w"> </span>-A<span class="w"> </span>-k<span class="w"> </span>-g<span class="w"> </span>pruebas
</pre></div>
</div>
<p class="rubric" id="lxc-autostart">Autoarranque</p>
<p>Podemos configurar <abbr title="LinuX Containers">LXC</abbr> para que un contenedor arranque automáticamente al
iniciarse en anfitrión. Para ello, debemos añadir las siguientes lineas a su
archivo de configuración:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>cat<span class="w"> </span>&gt;&gt;<span class="w"> </span>/var/lib/lxc/test/config

<span class="gp"># </span>Autoarranque
<span class="go">lxc.start.auto = 1</span>
<span class="go">lxc.start.delay = 5</span>
</pre></div>
</div>
<p>Todo esto provocará que el contenedor aparezca como listado entre aquellos que
arrancan automáticamente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-autostart<span class="w"> </span>-L
<span class="go">test 5</span>
</pre></div>
</div>
<p>donde el <strong>5</strong> es el valor de <kbd class="kbd docutils literal notranslate">lxc.start.delay</kbd>. Ahora bien, si tuviéramos
varios contenedores con arranque automático, ¿cuál es su orden de arranque?
Primero arrancará los contenedores con <kbd class="kbd docutils literal notranslate">lxc.start.auto</kbd> puesto a <strong>1</strong> que
además pertenezcan al grupo «<em>onboot</em>», a continuación arrancará los
contenedores que pertenezcan a tal grupo y finalmente aquellos con
<kbd class="kbd docutils literal notranslate">lxc.start.auto</kbd> puesto a <strong>1</strong> que no pertenezcan a él. Para determinar el
orden en contenedores que cumplan las mismas condiciones de arranque se atiende
el valor de <kbd class="kbd docutils literal notranslate">lxc.start.order</kbd>.</p>
<p class="rubric" id="lxc-compartido">Directorios compartidos</p>
<p>Si se quiere compartir un directorio entre anfitrión y huésped puede hacerse lo
siguiente:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lxc</span><span class="o">.</span><span class="n">mount</span><span class="o">.</span><span class="n">entry</span> <span class="o">=</span> <span class="o">/</span><span class="n">tmp</span> <span class="n">mnt</span> <span class="n">none</span> <span class="n">bind</span><span class="p">,</span><span class="n">optional</span> <span class="mi">0</span> <span class="mi">0</span>
</pre></div>
</div>
<p>que es una línea que imita la sintaxis del archivo <a class="reference internal" href="../../../../../../02.conbas/02.informacion/04.devices.html#fstab"><span class="std std-ref">/etc/fstab</span></a>. En
este caso, montaremos el directorio temporal del anfitrión sobre el directorio
<code class="file docutils literal notranslate"><span class="pre">/mnt/</span></code> del huésped, ya que cuando se utilizan rutas relativas, éstas se
toman respecto a la raíz del contenedor. (en nuestro ejemplo,
<code class="file docutils literal notranslate"><span class="pre">/var/lib/lxc/test/rootfs</span></code>).</p>
<p>Como alternativa, si los puntos de montaje son varios, puede utilizarse otra
variable:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lxc</span><span class="o">.</span><span class="n">mount</span><span class="o">.</span><span class="n">fstab</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">lxc</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">fstab</span>
</pre></div>
</div>
<p class="rubric">Ganchos</p>
<p>Es posible definir <em>scripts</em> que se ejecuten ante determinados eventos del
contenedor (arranque, parada, clonado, etc.) a través de de la directiva
<kbd class="kbd docutils literal notranslate">lxc.hook.nombre_evento</kbd>. Basta echarle un vistazo a
<em class="manpage"><a class="manpage reference external" href="https://manpages.debian.org/lxc.container.conf">lxc.container.conf</a></em>.</p>
<p class="rubric">Configuración modular</p>
<p>Podemos separar la configuración en archivos independientes utilizando la
directiva:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lxc</span><span class="o">.</span><span class="n">include</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">lxc</span><span class="o">/</span><span class="n">net</span><span class="o">-</span><span class="n">bridge</span><span class="o">.</span><span class="n">conf</span>
<span class="c1">#lxc.include = /etc/lxc/net-macvlan.conf</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">Ver también</p>
<p>La explicación de todas las directivas que pueden incluirse en el
archivo de configuración se encuentra en la página de manual <em class="manpage"><a class="manpage reference external" href="https://manpages.debian.org/lxc.container.conf">lxc.container.conf</a></em>.</p>
</div>
</section>
<section id="red">
<span id="lxc-red"></span><h2><span class="section-number">9.2.2.2.1.1.1.8. </span>Red<a class="headerlink" href="#red" title="Link to this heading">¶</a></h2>
<p>Para lograr conexión de red los contenedores usan <a class="reference external" href="https://vivek-syngh.medium.com/linux-virtual-ethernet-devices-aba9c3840d0d">interfaces VETH</a>,
puesto que este tipo de interfaces se crean por parejas y permiten la
comunicación de dos espacios de nombres de red distintos (el del contenedor y el
del anfitrión) al encontrarse cada miembro de la pareja en uno de ellos.</p>
<img alt="../../../../../../_images/veth.png" src="../../../../../../_images/veth.png" />
<p>Sobre la base de este tipo de interfaces, podemos hacer la configuración de red:</p>
<ol class="arabic simple">
<li><p>Si queremos que el contenedor comparta red con la interfaz de red de la
máquina, podemos incluir la interfaz <abbr title="Virtual ETHernet">VETH</abbr> en una interfaz puente que
comparta con la interfaz real del anfitrión. Este es el caso ilustrado en la
figura anterior y que se corresponde con el caso de <a class="reference internal" href="../../../01.completa/02.kvm/01.qemu/03.red.html#qemu-red-puente-tap"><span class="std std-ref">adaptador puente
mediante puente en QEmu</span></a>.</p></li>
<li><p>Como alternativa a lo anterior, para lograr el mismo efecto podemos utilizar
interfaces macvlan, de modo semejante al caso de <a class="reference internal" href="../../../01.completa/02.kvm/01.qemu/03.red.html#qemu-red-puente-macvtap"><span class="std std-ref">adaptador puente
mediante interfaz macvtap en QEmu</span></a></p></li>
<li><p>Si queremos crear redes independientes a la del anfitrión, podemos crear
interfaces puente, una por cada una de esas redes, del mismo modo que
<a class="reference internal" href="../../../01.completa/02.kvm/01.qemu/03.red.html#qemu-red-tap"><span class="std std-ref">hacíamos en QEmu al crear interfaces puente</span></a>.</p></li>
</ol>
<p>Nuestro estudio analizará primero cómo está configurada la red de forma
predeterminada para después poder profundizar en los tres clases planteados.</p>
<section id="red-predefinida">
<span id="lxc-red-predeterminada"></span><h3><span class="section-number">9.2.2.2.1.1.1.8.1. </span>Red predefinida<a class="headerlink" href="#red-predefinida" title="Link to this heading">¶</a></h3>
<p>Al arrancar <abbr title="LinuX Containers">LXC</abbr> (en <em>Debian</em> al menos) se crea automáticamente una interfaz
puente <em>lxcbr0</em> con dirección <abbr title="Internet Protocol">IP</abbr> <em>10.0.3.1/24</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>ip<span class="w"> </span>addr<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>lxcbr0
<span class="go">3: lxcbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN</span>
<span class="go">group default qlen 1000</span>
<span class="go">    link/ether 00:16:3e:00:00:00 brd ff:ff:ff:ff:ff:ff</span>
<span class="go">    inet 10.0.3.1/24 brd 10.0.3.255 scope global lxcbr0</span>
<span class="go">       valid_lft forever preferred_lft forever</span>
</pre></div>
</div>
<p>Los contenedores creados añaden una única interfaz a este puente y reciben
automáticamente una dirección <abbr title="Internet Protocol">IP</abbr> dentro de la red ya dicha. Además, se añaden
algunas reglas en el cortafuegos para asegurar la conectividad. Este es el
comportamiento observable, pero ¿a qué se debe?</p>
<p>Para entender qué está ocurriendo es conveniente acudir a
<code class="file docutils literal notranslate"><span class="pre">/etc/default/lxc</span></code> que a su vez remite a
<code class="file docutils literal notranslate"><span class="pre">/etc/default/lxc-net</span></code>. Ahí se encuentra la línea:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">USE_LXC_BRIDGE</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>
</pre></div>
</div>
<p>que, obviamente, es la responsable de que se cree la interfaz puente. En
realidad, este línea no la lee el servicio <em>lxc</em> sino otro llamado <em>lxc-net</em>. De
hecho, si ponemos la línea anterior a <em>false</em> y reiniciamos el servicio:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>invoke.rc.d<span class="w"> </span>lxc-net<span class="w"> </span>restart
</pre></div>
</div>
<p>observaremos cómo desaparece la interfaz. Este red predeterminada es del tercer
tipo que enumeramos al comienzo del epígrafe: una red independiente que, sin
embargo, tiene comunicación con el anfitrión ya que a <em>lxcbr0</em> se le define
dirección <abbr title="Internet Protocol">IP</abbr>.</p>
<p>Sea como sea, ¿por qué la interfaz se llama <em>lxcbr0</em> y por qué se usa la la red
<em>10.0.3.0/24</em>? La respuesta está en el <em>script</em> <code class="file docutils literal notranslate"><span class="pre">/usr/libexec/lxc/lxc-net</span></code>
en cuyo comienzo se definen esos valores, pero de modo que pueden sobrescribirse
redefiniéndolos en el archivo de configuración <code class="file docutils literal notranslate"><span class="pre">/etc/default/lxc-net</span></code>. Por
tanto, mirando cuál es el nombre de la variable en el <em>script</em>, podremos cambiar
esos valores en <code class="file docutils literal notranslate"><span class="pre">/etc/default/lxc-net</span></code>. Por ejemplo:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">USE_LXC_BRIDGE</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>
<span class="nv">LXC_BRIDGE</span><span class="o">=</span><span class="s2">&quot;lxcnet0&quot;</span>
<span class="nv">LXC_ADDR</span><span class="o">=</span><span class="s2">&quot;10.0.10.1&quot;</span>
<span class="nv">LXC_NETMASK</span><span class="o">=</span><span class="s2">&quot;255.255.255.0&quot;</span>
<span class="nv">LXC_NETWORK</span><span class="o">=</span><span class="s2">&quot;10.0.10.0/24&quot;</span>
<span class="nv">LXC_DHCP_RANGE</span><span class="o">=</span><span class="s2">&quot;10.0.10.100,10.0.10.150&quot;</span>
</pre></div>
</div>
<p>Como puede verse hay una variable que define cuál es el rango de direcciones que
se facilitan por <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> a los contenedores. ¿Esto significa que el <em>software</em>
<abbr title="LinuX Containers">LXC</abbr> hace de servidor <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>? La respuesta es no. El <em>script</em> ya citado se
encarga de levantar <a class="reference internal" href="../../../../../../06.infraestructura/02.dhcp/03.dnsmasq.html#dnsmasq-dhcp"><span class="std std-ref">dnsmasq</span></a> para que escuche
exclusivamente en la interfaz definida por <em>LXC_BRIDGE</em>. Por esa razón el
paquete <a class="reference external" href="https://packages.debian.org/stable/lxc">lxc</a> tiene como dependencia <a class="reference external" href="https://packages.debian.org/stable/dnsmasq-base">dnsmasq-base</a>, que incluye los
ejecutables de <strong class="command">dnsmasq</strong>, pero no los archivos que permiten usarlo como
servicio, que se incluyen en el paquete <a class="reference external" href="https://packages.debian.org/stable/dnsmasq">dnsmasq</a>.</p>
<p>Por último, ¿por qué los contenedores, si no se manipula su configuración, tiene
una interfaz en esta red? La razón se encuentra en
<code class="file docutils literal notranslate"><span class="pre">/etc/lxc/default.conf</span></code>, que incluye las siguientes líneas:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">veth</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">lxcbr0</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">up</span>
</pre></div>
</div>
<p>las cuales determinan que todo contenedor las copie en su configuración
adicional y, en consecuencia, presenten una único interfaz de tipo <abbr title="Virtual ETHernet">VETH</abbr> cuya
pareja se encuentra incluida en la interfaz puente <em>lxcbr0</em> que crea <abbr title="LinuX Containers">LXC</abbr>.
Con esta configuración la interfaz creada dentro del contenedor tiene una
dirección <abbr title="Media Access Control">MAC</abbr> cualquiera y, además, cambia cada vez que arranquemos el
contenedor. Si queremos que sea fija, podemos añadir al archivo
<code class="file docutils literal notranslate"><span class="pre">default.conf</span></code> la siguiente línea:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#lxc.network.hwaddr = 00:16:3e:xx:xx:xx</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">hwaddr</span> <span class="o">=</span> <span class="n">de</span><span class="p">:</span><span class="n">ad</span><span class="p">:</span><span class="n">be</span><span class="p">:</span><span class="n">ef</span><span class="p">:</span><span class="n">xx</span><span class="p">:</span><span class="n">xx</span>
</pre></div>
</div>
<p>Esta línea, a diferencia de las anteriores no se copiará exactamente igual en
el archivo de configuración del contenedor, sino que las <kbd class="kbd docutils literal notranslate">xx:xx</kbd> se
sustituirán por números hexadecimales con lo que cada contenedor acabará
teniendo una <abbr title="Media Access Control">MAC</abbr> fija.</p>
<p>Ahora que hemos tratado la dirección <abbr title="Media Access Control">MAC</abbr> del contenedor, es bueno momento para
discutir qué ocurre con su dirección <abbr title="Internet Protocol">IP</abbr>. En principio no tiene, pero si el
contenedor está preparado para pedir por defecto una por <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> (como es el caso
del de <a class="reference external" href="https://www.alpinelinux.org/">Alpine</a>), la obtendrá. Si, en cambio, se quiere una dirección fija puede
establecerse añadiendo al archivo de configuración del contenedor (p.e.
<code class="file docutils literal notranslate"><span class="pre">/var/lib/lxc/test/config</span></code>) lo siguiente:</p>
<div class="highlight-python notranslate" id="lxc-red-ip-fija"><div class="highlight"><pre><span></span><span class="n">lxc</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="mf">10.0.10.5</span><span class="o">/</span><span class="mi">24</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Podría ocurrir que la propia configuración del contenedor eliminara
esta dirección proporcionada por <abbr title="LinuX Containers">LXC</abbr> a la interfaz. Es el caso del contenedor
de <a class="reference external" href="https://www.alpinelinux.org/">Alpine</a>, que desecha la <abbr title="Internet Protocol">IP</abbr> fija al pedir una dirección
dinámica. En su caso particular, para evitarlo tendrá que modificar tal
configuración:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;/^iface/s:dhcp$:manual:&#39;</span><span class="w"> </span>/etc/network/interfaces
</pre></div>
</div>
</div>
<p>En cualquier caso, nuestro propósito es desechar la configuración de red
predeterminada y hacerla toda manualmente para tener mayor control sobre ella.
En consecuencia, debemos hacer tres cosas:</p>
<ol class="arabic">
<li><p>Evitar la creación de la interfaz puente editando <code class="file docutils literal notranslate"><span class="pre">/etc/default/lxc-net</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">USE_LXC_BRIDGE</span><span class="o">=</span><span class="s2">&quot;false&quot;</span>
</pre></div>
</div>
<p>o como alternativa, deshabilitar el servicio <em>lxc-net.service</em>.</p>
</li>
<li><p>Instalar el paquete <a class="reference external" href="https://packages.debian.org/stable/dnsmasq">dnsmasq</a> para que actúe como servicio:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>dnsmasq
</pre></div>
</div>
</li>
<li><p>Reorganizaremos la configuración de <code class="file docutils literal notranslate"><span class="pre">/etc/lxc/</span></code> del siguiente modo:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/etc/lxc
      +---- lxc.conf
      +---- common.conf
      +---- lxe-net.conf
      +---- [.. otras configuraciones de red ..]
</pre></div>
</div>
<p>donde <code class="file docutils literal notranslate"><span class="pre">lxc.conf</span></code> es:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lxc</span><span class="o">.</span><span class="n">default_config</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">lxc</span><span class="o">/</span><span class="n">lxe</span><span class="o">-</span><span class="n">net</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>o otro archivo de red que se decida, tal como se definirán a continuación.
<code class="file docutils literal notranslate"><span class="pre">common.conf</span></code> por su parte contiene la parte de
<code class="file docutils literal notranslate"><span class="pre">/etc/lxc/default.conf</span></code> que no refiere configuración de red:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lxc</span><span class="o">.</span><span class="n">apparmor</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">generated</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">apparmor</span><span class="o">.</span><span class="n">allow_nesting</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Y, finalmente, <code class="file docutils literal notranslate"><span class="pre">lxe-net.conf</span></code> la configuración de red que espera el
servicio <em>lxc-net</em> que acabamos de deshabilitar:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">veth</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">lxcbr0</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">up</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">hwaddr</span> <span class="o">=</span> <span class="n">de</span><span class="p">:</span><span class="n">ad</span><span class="p">:</span><span class="n">be</span><span class="p">:</span><span class="n">ef</span><span class="p">:</span><span class="n">xx</span><span class="p">:</span><span class="n">xx</span>

<span class="n">lxc</span><span class="o">.</span><span class="n">include</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">lxc</span><span class="o">/</span><span class="n">common</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="interfaz-puente-con-puente">
<span id="lxc-red-puente-br"></span><h3><span class="section-number">9.2.2.2.1.1.1.8.2. </span>Interfaz puente con puente<a class="headerlink" href="#interfaz-puente-con-puente" title="Link to this heading">¶</a></h3>
<p>En este caso se supone que el anfitrión está configurado de modo que hay
definida una interfaz puente (<em>br0</em>) dentro de la cual se encuentra la interfaz
física (<em>eth0</em>) con lo que su file:<cite>/etc/network/interfaces</cite> tendrá el aspecto
<a class="reference internal" href="../../../01.completa/02.kvm/01.qemu/03.red.html#qemu-red-puente-tap"><span class="std std-ref">referido en QEmu para este caso</span></a>.</p>
<p>Si es así podemos definir el siguiente archivo <code class="file docutils literal notranslate"><span class="pre">/etc/lxc/bridge.conf</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">veth</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">br0</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">up</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">hwaddr</span> <span class="o">=</span> <span class="n">de</span><span class="p">:</span><span class="n">ad</span><span class="p">:</span><span class="n">be</span><span class="p">:</span><span class="n">ef</span><span class="p">:</span><span class="n">xx</span><span class="p">:</span><span class="n">xx</span>

<span class="n">lxc</span><span class="o">.</span><span class="n">include</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">lxc</span><span class="o">/</span><span class="n">common</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>Con esto debería ser suficiente, aunque si queremos que esta sea la
configuración predeterminada, aún tendremos que editar <code class="file docutils literal notranslate"><span class="pre">lxc.conf</span></code> para que
<kbd class="kbd docutils literal notranslate">lxc.default_config</kbd> señale este archivo.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Hemos supuesto que en la red del anfitrión ya existe un servidor
<abbr title="Dynamic Host Configuration Protocol">DHCP</abbr>, así que no nos hemos preocupado por definir uno.</p>
</div>
</section>
<section id="interfaz-puente-con-macvlan">
<span id="lxc-red-macvlan"></span><h3><span class="section-number">9.2.2.2.1.1.1.8.3. </span>Interfaz puente con macvlan<a class="headerlink" href="#interfaz-puente-con-macvlan" title="Link to this heading">¶</a></h3>
<p>De nuevo, vuelve a ser pertinente lo expuesto <a class="reference internal" href="../../../01.completa/02.kvm/01.qemu/03.red.html#qemu-red-puente-macvtap"><span class="std std-ref">sobre QEmu para interfaces
macvtap</span></a>, aunque en este caso la interfaz sea de tipo
<em>macvlan</em>. Como con <em>macvtap</em>, la configuración en el anfitrión puede ser nula,
aunque de ser así no habrá conectividad de red entre anfitrión y huésped.
Lo mejor, pues, es alterar la configuración del anfitrión para permitirlo:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># The primary network interface
allow-hotplug eth0
iface eth0 inet manual
        up   ip link set $IFACE up
        down ip link set $IFACE down

auto macvlan0
iface macvlan0 inet dhcp
        pre-up    ip link add link eth0 name $IFACE type macvlan mode bridge
        post-down ip link del dev $IFACE
</pre></div>
</div>
<p>Sea como sea, deberemos crear un archivo <code class="file docutils literal notranslate"><span class="pre">/etc/lxc/macvlan.conf</span></code> con la
siguiente configuración:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">macvlan</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">macvlan</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">bridge</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">eth0</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">up</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">hwaddr</span> <span class="o">=</span> <span class="n">de</span><span class="p">:</span><span class="n">ad</span><span class="p">:</span><span class="n">be</span><span class="p">:</span><span class="n">ef</span><span class="p">:</span><span class="n">xx</span><span class="p">:</span><span class="n">xx</span>

<span class="n">lxc</span><span class="o">.</span><span class="n">include</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">lxc</span><span class="o">/</span><span class="n">common</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Es de notar que esta configuración no provocará la aparición de
ninguna interfaz en el anfitrión, como sí ocurre en el caso de usar
interfaces <abbr title="Virtual ETHernet">VETH</abbr>. Para una explicación de ello, puede consultar <a class="reference external" href="https://developers.redhat.com/blog/2018/10/22/introduction-to-linux-interfaces-for-virtual-networking#macsec">este
interesante artículo de RedHat sobre interfaces virtuales en Linux</a>.</p>
</div>
</section>
<section id="red-independiente">
<h3><span class="section-number">9.2.2.2.1.1.1.8.4. </span>Red independiente<a class="headerlink" href="#red-independiente" title="Link to this heading">¶</a></h3>
<p>No es más que la configuración manual de la estrategia que usa la <a class="reference internal" href="#lxc-red-predeterminada"><span class="std std-ref">red
predeterminada</span></a>. Para ello necesitamos definir una
interfaz puente en <code class="file docutils literal notranslate"><span class="pre">/etc/network/interfaces.d/lxc</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>auto lxcnet0
iface lxcnet0 inet manual
   bridge_ports    none
   bridge_maxwait  2
   hwaddress ether de:ad:be:ef:00:00
</pre></div>
</div>
<p>Y a esta interfaz asociaremos las interfaces <abbr title="Virtual ETHernet">VETH</abbr> que vayamos creando para los
contenedores. Para ello podemos crear <code class="file docutils literal notranslate"><span class="pre">/etc/lxc/lxcnet0.conf</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">veth</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">lxcnet0</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">up</span>
<span class="n">lxc</span><span class="o">.</span><span class="n">net</span><span class="mf">.0</span><span class="o">.</span><span class="n">hwaddr</span> <span class="o">=</span> <span class="n">de</span><span class="p">:</span><span class="n">ad</span><span class="p">:</span><span class="n">be</span><span class="p">:</span><span class="n">ef</span><span class="p">:</span><span class="n">xx</span><span class="p">:</span><span class="n">xx</span>
</pre></div>
</div>
<p>El problema de esta configuración es que cualquier contenedor que se cree con
ella, estará totalmente aislado y, además, ni siquiera tendrá una <abbr title="Internet Protocol">IP</abbr>. Incluso
<a class="reference internal" href="#lxc-red-ip-fija"><span class="std std-ref">definiéndole una dirección</span></a>, seguirá aislado. A partir
de aquí tebemos varias soluciones:</p>
<ol class="arabic simple">
<li><p>Si no nos importa que la red no esté aislada, podemos asignar una dirección
<abbr title="Internet Protocol">IP</abbr> a <em>lxcnet0</em> y configurar <strong class="program">dnsmasq</strong> para que sirva direcciones a
través de ella. De este modo, todos los contenedores en la red se configurarán
dinámicamente.</p></li>
<li><p>Si queremos que la red esté aislada a toda costa, podemos dejar sin
configurar <em>lxcnet0</em> y crear un contenedor que sirva de puerta de enlace con
dos interfaces de red: una puesta como adaptador puente (véanse los dos
epígrafes anteriores) y otra en esta red independiente. Si a este contenedor
le instalamos, además, <strong class="program">dnsmasq</strong> podremos configurarlo para que
proporcione direcciones <abbr title="Internet Protocol">IP</abbr> al resto.</p></li>
</ol>
<p class="rubric">Notas al pie</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id7" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>Si un contenedor privilegiado no lo gestiona un administrador, no
podremos actuar dentro de él como tal y, en consecuencia, es imposible que
gestione un sistema completo.</p>
</aside>
<aside class="footnote brackets" id="id8" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p><em>Alpine</em> es una distribución mínima con lo cual es ideal para hacer
crear nuestros contenedores de prueba.</p>
</aside>
<aside class="footnote brackets" id="id9" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">3</a><span class="fn-bracket">]</span></span>
<p>Se supone que estamos <a class="reference internal" href="../../../../../../05.discos/01.division/04.virt.html#lvm"><span class="std std-ref">familiarizados con estos conceptos</span></a>.</p>
</aside>
<aside class="footnote brackets" id="id10" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">4</a><span class="fn-bracket">]</span></span>
<p>En versiones antiguas, el comportamiento predeterminado era justamente el
contrario y para no conectarse al contenedor había que añadir la opción
<kbd class="kbd docutils literal notranslate">-d</kbd>.</p>
</aside>
<aside class="footnote brackets" id="id11" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">5</a><span class="fn-bracket">]</span></span>
<p>Circunstancia que en este caso particular no ocurrirá, pero que podría
ocurrir cuando la situación fuera distinta.</p>
</aside>
</aside>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../../../../../index.html">Tabla de contenido</a></h3>
    <ul>
<li><a class="reference internal" href="#">9.2.2.2.1.1.1. Contenedores privilegiados</a><ul>
<li><a class="reference internal" href="#preliminares">9.2.2.2.1.1.1.1. Preliminares</a></li>
<li><a class="reference internal" href="#creacion">9.2.2.2.1.1.1.2. Creación</a></li>
<li><a class="reference internal" href="#manejo">9.2.2.2.1.1.1.3. Manejo</a></li>
<li><a class="reference internal" href="#limitacion">9.2.2.2.1.1.1.4. Limitación</a></li>
<li><a class="reference internal" href="#copias">9.2.2.2.1.1.1.5. Copias</a></li>
<li><a class="reference internal" href="#instantaneas">9.2.2.2.1.1.1.6. Instantáneas</a></li>
<li><a class="reference internal" href="#configuracion">9.2.2.2.1.1.1.7. Configuración</a></li>
<li><a class="reference internal" href="#red">9.2.2.2.1.1.1.8. Red</a><ul>
<li><a class="reference internal" href="#red-predefinida">9.2.2.2.1.1.1.8.1. Red predefinida</a></li>
<li><a class="reference internal" href="#interfaz-puente-con-puente">9.2.2.2.1.1.1.8.2. Interfaz puente con puente</a></li>
<li><a class="reference internal" href="#interfaz-puente-con-macvlan">9.2.2.2.1.1.1.8.3. Interfaz puente con macvlan</a></li>
<li><a class="reference internal" href="#red-independiente">9.2.2.2.1.1.1.8.4. Red independiente</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Tema anterior</h4>
    <p class="topless"><a href="../../02.lxc.html"
                          title="capítulo anterior"><span class="section-number">9.2.2.2.1. </span><abbr title="LinuX Containers">LXC</abbr></a></p>
  </div>
  <div>
    <h4>Próximo tema</h4>
    <p class="topless"><a href="02.unpriv.html"
                          title="próximo capítulo"><span class="section-number">9.2.2.2.1.1.2. </span>Contenedores no privilegiados</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../../../_sources/98.apendice/05.virtual/02.software/03.contenedores/02.lxc/01.nativas/01.priv.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Ir a" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="02.unpriv.html" title="9.2.2.2.1.1.2. Contenedores no privilegiados"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="../../02.lxc.html" title="9.2.2.2.1. LXC"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../../index.html" ><span class="section-number">9. </span>Apéndices</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../../index.html" ><span class="section-number">9.2. </span>Virtualización</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../../../../02.software.html" ><span class="section-number">9.2.2. </span>Software de virtualización</a> &#187;</li>
          <li class="nav-item nav-item-4"><a href="../../02.lxc.html" ><span class="section-number">9.2.2.2.1. </span><abbr title="LinuX Containers">LXC</abbr></a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">9.2.2.2.1.1.1. </span>Contenedores privilegiados</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright CC BY 4.0, 2016-2023, José Miguel Sánchez Alés.
      Creado usando <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>