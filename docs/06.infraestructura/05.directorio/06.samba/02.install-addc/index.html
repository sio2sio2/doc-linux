


<!DOCTYPE html>

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>6.4.2.2. Controlador de dominio &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/classic.css" />
    <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
    
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/translations.js"></script>
    
    <link rel="index" title="Índice" href="../../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../../search.html" />
    <link rel="next" title="6.4.2.3. Clientes" href="../03.clientes/index.html" />
    <link rel="prev" title="6.4.2.1. Preliminares" href="../01.prologo/index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="../03.clientes/index.html" title="6.4.2.3. Clientes"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="../01.prologo/index.html" title="6.4.2.1. Preliminares"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">6. </span>Servicios de infraestructura</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">6.4. </span>Servicio de directorio</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" accesskey="U"><span class="section-number">6.4.2. </span>Samba</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">6.4.2.2. </span>Controlador de dominio</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="controlador-de-dominio">
<span id="smb-addc"></span><h1><span class="section-number">6.4.2.2. </span>Controlador de dominio<a class="headerlink" href="#controlador-de-dominio" title="Enlace permanente a este encabezado">¶</a></h1>
<p>Bajo este epígrafe recogeremos todas las acciones que permiten convertir nuestro
servidor en un <em>controlador de dominio para directorio activo</em> y las pruebas que
nos asegurarán que lo es.</p>
<p>El <em>directorio activo</em> exige <abbr title="Domain Name Server">DNS</abbr>. <em>samba</em> proporciona un servidor <abbr title="Domain Name Server">DNS</abbr>
interno que puede usarse para ello. Otra opción, si ya se dispone de servidor
DNS, es usar <em>bind9</em> y hacer que éste use la base de datos de <em>samba</em>.</p>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Para el directorio activo es indistinto el uso de mayúsculas y
minúsculas. Así pues, «<em>Administrator</em>», «<em>administrator</em>» o
«<em>ADMINISTRATOR</em>» son el mismo usuario.</p>
</div>
<section id="instalacion">
<h2><span class="section-number">6.4.2.2.1. </span>Instalación<a class="headerlink" href="#instalacion" title="Enlace permanente a este encabezado">¶</a></h2>
<p>Son necesarios tres paquetes y opcionalmente otros dos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt-get install samba winbind sssd smbclient krb5-user acl
</pre></div>
</div>
<p>Desglosadamente:</p>
<dl class="simple">
<dt><strong>samba</strong></dt><dd><p>Es el paquete que permite instalar el servidor en el sistema.</p>
</dd>
<dt><strong>winbind</strong></dt><dd><p>Necesario para poder autenticarse usando la base de datos de samba.</p>
</dd>
<dt><strong>sssd</strong></dt><dd><p>Permite que los usuarios y grupos de samba pueden usarse para la autenticación
(<em>libpam-sss</em>) y en el servicio <em>nss</em> configurado con <a class="reference internal" href="../../../../04.servidor/09.autenticacion/index.html#nsswitch"><span class="std std-ref">/etc/nsswitch.conf</span></a> (<em>libnss-sss</em>). Además, permite guarda una caché, lo que permite
que el usuario pueda validarse incluso cuando se halle caído el servidor.</p>
</dd>
<dt><strong>smbclient</strong></dt><dd><p>Es un cliente de línea de comandos para <em>samba</em>. No es necesario, pero puede
ayudarnos en las comprobaciones.</p>
</dd>
<dt><strong>krb5-user</strong></dt><dd><p>Contiene una serie de programas que permite ser clientes de un servidor
<em>kerberos</em>. Como en el caso anterior, no es necesario, pero nos permite
realizar comprobaciones.</p>
</dd>
<dt><strong>acl</strong></dt><dd><p>Las herramientas para manejar los permisos basados en <abbr title="Access Control List">ACL</abbr>. Son útiles si se
crean a mano los perfiles de los usuarios.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Es importar estar atento a los mensajes del proceso de
<em>post-instalación</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Samba is not being run as an AD Domain Controller, masking samba-ad-dc-service.</span>
</pre></div>
</div>
<p>La configuración predeterminada no es la de un
<em>controlador de dominio para directorio activo</em>, sino la de un servidor
<em>samba</em> <em>independiente</em> (<em>standalone</em>). Esto hace que se habiliten los servicios
<em>smbd</em> y <em>nmbd</em>; y se deshabilite (y enmascare) <em>samba-ad-dc</em>, que es el que
nos interesa.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La instalación de <em>krb5-config</em> (dependencia de <em>krb5-user</em>) nos
obliga a configurar el cliente <em>kerberos</em>. No tiene demasiada importancia lo
que respondamos, ya que la configuración de <em>samba</em> nos proporcionará el
fichero de configuración adecuado.</p>
</div>
</section>
<section id="configuracion">
<h2><span class="section-number">6.4.2.2.2. </span>Configuración<a class="headerlink" href="#configuracion" title="Enlace permanente a este encabezado">¶</a></h2>
<p>Trataremos bajo este epígrafe como transformar el servidor <em>samba</em> en un
controlador de dominio para directorio activo. La instalación presupone que lo
utilizaremos como servidor independiente, así que debemos desechar los
<em>scripts</em> de arranque habilitados:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>invoke-rc.d smbd stop
<span class="gp"># </span>invoke-rc.d winbind stop
<span class="gp"># </span>invoke-rc.d nmbd stop
<span class="gp"># </span>systemctl mask smbd
<span class="gp"># </span>systemctl mask nmbd
<span class="gp"># </span>systemctl mask winbind
</pre></div>
</div>
<p>Además, debemos deshacernos del fichero de configuración antiguo para no tener
problemas al generar la nueva configuración:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mv /etc/samba/smb.conf<span class="o">{</span>,.dpkg-dist<span class="o">}</span>
</pre></div>
</div>
<p>Como servidor <abbr title="Domain Name Server">DNS</abbr> cabe la posibilidad de usar el básico que facilita <em>samba</em> o
usar <em>bind9</em>.</p>
<dl>
<dt><strong>Con DNS interno</strong></dt><dd><p>El primer paso es constituir la base de datos (un <em>LDAP</em> interno):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>samba-tool domain provision  --host-ip<span class="o">=</span><span class="m">192</span>.168.255.1 --use-rfc2307 --interactive
<span class="go">Realm [IESPJM.DOMUS]:</span>
<span class="go"> Domain [IESPJM]:</span>
<span class="go"> Server Role (dc, member, standalone) [dc]:</span>
<span class="go"> DNS backend (SAMBA_INTERNAL, BIND9_FLATFILE, BIND9_DLZ, NONE) [SAMBA_INTERNAL]:</span>
<span class="go"> DNS forwarder IP address (write &#39;none&#39; to disable forwarding) [80.58.61.250]:</span>
<span class="go">Administrator password:</span>
<span class="go">Retype password:</span>
<span class="go">[...]</span>
<span class="go">Server Role:           active directory domain controller</span>
<span class="go">Hostname:              dc</span>
<span class="go">NetBIOS Domain:        IESPJM</span>
<span class="go">DNS Domain:            iespjm.domus</span>
<span class="go">DOMAIN SID:            S-1-5-21-967385316-1535922226-3155704407</span>
</pre></div>
</div>
<p>Como ya hemos preparado el servidor, basta con aceptar todas las opciones.
Obsérvese que se ha elegido como servidor <abbr title="Domain Name Server">DNS</abbr> el interno. Esta elección
conlleva que se nos pregunte el <em>forwarder</em> que usará tal servidor interno
para resolver las direcciones que no sean del dominio propio. Se sugiere el
servidor que se esté usando, con lo que debería bastar con aceptarlo. Nótese
que se ha incluido la <em>IP</em> por la que queremos prestar el servicio y a cuya
red queremos asociar el dominio, ya que en nuestro sistema hay dos ips
distintas.</p>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>No vale cualquier contraseña. <em>samba</em> tiene habilitadas unas
reglas para evitar contraseñas demasiado sencillas. Para estas pruebas se
ha introducido «<kbd class="kbd docutils literal notranslate">Passw0rd</kbd>» (la letra <em>o</em> se susutituye por el
dígito <em>0</em>), que la acepta sin problemas.</p>
</div>
</dd>
<dt><strong>Con bind9</strong></dt><dd><p>Si queremos usar <em>bind</em> es obvio que lo debemos tener instalado ya (véase
<a class="reference internal" href="../../../03.dns/index.html#dns"><span class="std std-ref">cómo</span></a>) y elegir <kbd class="kbd docutils literal notranslate">BIND9_DLZ</kbd> al generar la configuración.
Además, a la instalación estándar de <em>bind</em> habría que hacer simplemente
dos cambios:</p>
<ol class="arabic">
<li><p>Incluir en el bloque <code class="code docutils literal notranslate"><span class="pre">options</span></code> de
file:<cite>/etc/bind/named.conf.options</cite> la línea:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">tkey-gssapi-keytab &quot;/var/lib/samba/private/dns.keytab&quot;;</span>
</pre></div>
</div>
</li>
<li><p>Incluir en <code class="file docutils literal notranslate"><span class="pre">/etc/bind9/named.conf</span></code> la línea:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">include &quot;/var/lib/samba/private/named.conf&quot;;</span>
</pre></div>
</div>
</li>
</ol>
<p>Ambas ficheros deben poder ser leídos por <em>bind</em>, pero en ambos casos es así.</p>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Con <em>bin9</em> no se debe generar configuración para la zona
<strong>iespjm.domus</strong>, ya que de ello se encargar el propio samba.</p>
</div>
</dd>
</dl>
<p>Utilicemos <em>bind9</em> o el servidor interno<a class="footnote-reference brackets" href="#id4" id="id1">1</a>, toca tras la configuración, echar a
andar el servidor, pero antes añadiremos a la sección <code class="code docutils literal notranslate"><span class="pre">[global]</span></code> de
<code class="file docutils literal notranslate"><span class="pre">/etc/samba/smb.conf</span></code> la siguiente directiva, que permite usar las
herramientas del paquete <em>ldap-tools</em> para hacer consultas:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ldap server require strong auth = No</span>
</pre></div>
</div>
<p>Hecho lo cual, sí podemos reiniciar (y habilitar de paso el servicio para que
arranque automáticamente durante el inicio):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>systemctl unmask samba-ad-dc.service
<span class="gp"># </span>systemctl <span class="nb">enable</span> samba-ad-dc.service
<span class="gp"># </span>invoke-rc.d samba-ad-dc start
<span class="gp"># </span>wbinfo -D iespjm.domus
<span class="go">Name              : IESPJM</span>
<span class="go">Alt_Name          : iespjm.domus</span>
<span class="go">SID               : S-1-5-21-967385316-1535922226-3155704407</span>
<span class="go">Active Directory  : Yes</span>
<span class="go">Native            : Yes</span>
<span class="go">Primary           : Yes</span>
</pre></div>
</div>
<p>Y, ahora que ya tenemos servidor <abbr title="Domain Name Server">DNS</abbr>, modificar <code class="file docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> para
que sea la propia máquina el servidor de nombres:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">domain iespjm.domus</span>
<span class="go">search iespjm.domus</span>
<span class="go">nameserver 127.0.0.1</span>
</pre></div>
</div>
<p>Además, <em>samba</em> ha generado una configuración para el cliente <em>kerberos</em>
apropiada, que debemos usar:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>ln -sf /var/lib/samba/private/krb5.conf /etc
</pre></div>
</div>
<p>Debemos tocar, además, rematar la configuración del servidor de hora y
descomentar la línea que dejamos comentada:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ntpsigndsocket /var/lib/samba/ntp_signd</span>
</pre></div>
</div>
<p>Hecho esto, es necesario cambiar el grupo propietario de
<code class="file docutils literal notranslate"><span class="pre">/var/lib/samba/ntp_signd</span></code> para que el demonio pueda leer el <em>socket</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>chgrp ntp /var/lib/samba/ntp_signd
</pre></div>
</div>
<p>Y reiniciar el servicio:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>invoke-rc.d ntp restart
</pre></div>
</div>
<p>Finalmente, silo deseamos podemos añadir la zona para la resolución inversa al
servidor <abbr title="Domain Name Server">DNS</abbr> interno, aunque <em>samba</em> no actualiza esta zona como sí hace con
la directa:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>samba-tool dns zonecreate localhost <span class="m">255</span>.168.192.in-addr.arpa -U Administrator
<span class="go">Zone 1.168.192.in-addr.arpa created successfully</span>
</pre></div>
</div>
<p>En principio, todo debería marchar, pero conviene cerciorarnos de que es así.
Sin embargo, antes, vamos a eliminar la complejidad de las contraseñas a fin de
que la configuración a partir de ahora, nos sea menos molesta:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>samba-tool domain passwordsettings <span class="nb">set</span> --min-pwd-length <span class="m">4</span>
<span class="gp"># </span>samba-tool domain passwordsettings <span class="nb">set</span> --complexity off
<span class="gp"># </span>samba-tool domain passwordsettings <span class="nb">set</span> --min-pwd-age <span class="m">0</span>
<span class="gp"># </span>samba-tool domain passwordsettings show
<span class="go">Password informations for domain &#39;DC=iespjm,DC=domus&#39;</span>

<span class="go">Password complexity: off</span>
<span class="go">Store plaintext passwords: off</span>
<span class="go">Password history length: 24</span>
<span class="go">Minimum password length: 4</span>
<span class="go">Minimum password age (days): 0</span>
<span class="go">Maximum password age (days): 42</span>
<span class="go">Account lockout duration (mins): 30</span>
<span class="go">Account lockout threshold (attempts): 0</span>
<span class="go">Reset account lockout after (mins): 30</span>
</pre></div>
</div>
<p>Obsérvese que las contraseñas, además, tienen una caducidad de 42 días. Ahora
podemos simplifcar nuestra contraseña de administrador de <em>samba</em>, cuyo nombre
es <em>Administrator</em> (en inglés):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>samba-tool user setpassword Administrator
<span class="go">New Password:</span>
<span class="go">Retype Password:</span>
<span class="go">Changed password OK</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Lo que se acaba de hacer, NO SE DEBE HACER JAMÁS en un servidor en
producción. Las contraseñas, en ese caso, debe ser cuanto más seguras mejor;
y es muy aconsejable obligar al usuario a que así las elija.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Tenga en cuenta que, si como se aconseja, no se hace lo indicado las
contraseñas tendrán un vida mínima de un día, con lo que no podremos hacer
pruebas repetidas de ir cambiando la contraseña a un mismo usuario.</p>
</div>
<p id="smb-part-indep">Es más que probable que, en algún momento, queramos crear usuarios que tengan
ficheros almacenados en el servidor, así que lo más recomendable es dedicar a
ello una partición (en nuestro caso, un volumen lógico para el grupo de
volúmenes <em>VGserver</em>)<a class="footnote-reference brackets" href="#id5" id="id2">2</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lvcreate -L250M VGserver -n samba
<span class="gp"># </span>mkfs.ext4 -L SAMBA /dev/VGserver/samba
</pre></div>
</div>
<p>Además deberemos añadir la entrada al fichero <code class="file docutils literal notranslate"><span class="pre">/etc/fstab</span></code> para que se
monte automáticamente con cada arranque:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span><span class="nb">echo</span> <span class="s2">&quot;/dev/mapper/VGserver-samba   /srv/samba  ext4  defaults   0  2&quot;</span> &gt;&gt; /etc/fstab
</pre></div>
</div>
<p>y, finalmente, montarlo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mount /srv/samba
</pre></div>
</div>
</section>
<section id="comprobaciones">
<h2><span class="section-number">6.4.2.2.3. </span>Comprobaciones<a class="headerlink" href="#comprobaciones" title="Enlace permanente a este encabezado">¶</a></h2>
<p>Preguntemos algo de información a nuestro servidor recién configurado:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>samba-tool domain info <span class="m">127</span>.0.0.1
<span class="go">Forest           : iespjm.domus</span>
<span class="go">Domain           : iespjm.domus</span>
<span class="go">Netbios domain   : IESPJM</span>
<span class="go">DC name          : dc.iespjm.domus</span>
<span class="go">DC netbios name  : DC</span>
<span class="go">Server site      : Default-First-Site-Name</span>
<span class="go">Client site      : Default-First-Site-Name</span>
</pre></div>
</div>
<p>Bien, según lo que pretendíamos. Echemos un vistazo a qué los usuarios que hay
en nuestra base:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>samba-tool user list
<span class="go">Administrator</span>
<span class="go">krbtgt</span>
<span class="go">Guest</span>
</pre></div>
</div>
<p>y a los grupos, que son unos cuantos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>samba-tool group list
<span class="go">[...]</span>
</pre></div>
</div>
<p>Esto es lo mínimo para que el controlador de dominio funcione como tal. También
podemos comprobar cómo se ha creado nuestro <abbr title="Domain Name Server">DNS</abbr>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>samba-tool dns serverinfo localhost -U Administrator
<span class="go">Password for [IESPJM\Administrator]:</span>
<span class="go">[...]</span>
</pre></div>
</div>
<p>Y cuáles son las zonas que gestionamos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>samba-tool dns zonelist localhost -U Administrator
<span class="go">Password for [IESPJM\Administrator]:</span>
<span class="go">  3 zone(s) found</span>

<span class="go">  pszZoneName                 : 1.168.192.in-addr.arpa</span>
<span class="go">  Flags                       : DNS_RPC_ZONE_DSINTEGRATED DNS_RPC_ZONE_UPDATE_SECURE</span>
<span class="go">  ZoneType                    : DNS_ZONE_TYPE_PRIMARY</span>
<span class="go">  Version                     : 50</span>
<span class="go">  dwDpFlags                   : DNS_DP_AUTOCREATED DNS_DP_DOMAIN_DEFAULT DNS_DP_ENLISTED</span>
<span class="go">  pszDpFqdn                   : DomainDnsZones.iespjm.domus</span>

<span class="go">  pszZoneName                 : iespjm.domus</span>
<span class="go">  Flags                       : DNS_RPC_ZONE_DSINTEGRATED DNS_RPC_ZONE_UPDATE_SECURE</span>
<span class="go">  ZoneType                    : DNS_ZONE_TYPE_PRIMARY</span>
<span class="go">  Version                     : 50</span>
<span class="go">  dwDpFlags                   : DNS_DP_AUTOCREATED DNS_DP_DOMAIN_DEFAULT DNS_DP_ENLISTED</span>
<span class="go">  pszDpFqdn                   : DomainDnsZones.iespjm.domus</span>

<span class="go">  pszZoneName                 : _msdcs.iespjm.domus</span>
<span class="go">  Flags                       : DNS_RPC_ZONE_DSINTEGRATED DNS_RPC_ZONE_UPDATE_SECURE</span>
<span class="go">  ZoneType                    : DNS_ZONE_TYPE_PRIMARY</span>
<span class="go">  Version                     : 50</span>
<span class="go">  dwDpFlags                   : DNS_DP_AUTOCREATED DNS_DP_FOREST_DEFAULT DNS_DP_ENLISTED</span>
<span class="go">  pszDpFqdn                   : ForestDnsZones.iespjm.domus</span>
</pre></div>
</div>
<p>Obsérvese que se incluye la zona de resolución inversa que creamos antes. Por
último, comprobemos si el servidor <abbr title="Domain Name Server">DNS</abbr> resuelve convenientemente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>host dc
<span class="go">dc.iespjm.domus has address 192.168.1.20</span>
<span class="gp">$ </span>host -t srv _ldap._tcp.iespjm.domus
<span class="go">_ldap._tcp.iespjm.domus has SRV record 0 100 389 dc.iespjm.domus.</span>
<span class="gp">$ </span>host -t srv _kerberos._udp.iespjm.domus
<span class="go">_kerberos._udp.iespjm.domus has SRV record 0 100 88 dc.iespjm.domus.</span>
</pre></div>
</div>
<p>También podemos conectarnos con el cliente <strong class="program">smbclient</strong> para ver los
recursos compartidos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>smbclient -L localhost -U Administrator
<span class="go">Enter Administrator&#39;s password:</span>
<span class="go">Domain=[IESPJM] OS=[Windows 6.1] Server=[Samba 4.5.2-Debian]</span>

<span class="go">        Sharename       Type      Comment</span>
<span class="go">        ---------       ----      -------</span>
<span class="go">        netlogon        Disk</span>
<span class="go">        sysvol          Disk</span>
<span class="go">        IPC$            IPC       IPC Service (Samba 4.5.2-Debian)</span>
<span class="go">Domain=[IESPJM] OS=[Windows 6.1] Server=[Samba 4.5.2-Debian]</span>

<span class="go">        Server               Comment</span>
<span class="go">        ---------            -------</span>

<span class="go">        Workgroup            Master</span>
<span class="go">        ---------            -------</span>
<span class="go">        WORKGROUP            DC</span>
</pre></div>
</div>
<p>O entrar en una de las unidades compartidas:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>smbclient //localhost/sysvol -U Administrator
<span class="go">Enter Administrator&#39;s password:</span>
<span class="go">Domain=[IESPJM] OS=[Windows 6.1] Server=[Samba 4.5.2-Debian]</span>
<span class="go">smb: \&gt; ls</span>
<span class="go">  .                                   D        0  Tue Dec 27 18:49:29 2016</span>
<span class="go">  ..                                  D        0  Tue Dec 27 20:46:47 2016</span>
<span class="go">  iespjm.domus                           D        0  Tue Dec 27 18:49:27 2016</span>

<span class="go">                1733064 blocks of size 1024. 673972 blocks available</span>
<span class="go">smb: \&gt;</span>
</pre></div>
</div>
<span class="target" id="kinit"></span><p id="index-0">Aún, sin embargo, no hemos usado la autenticación con <em>kerberos</em>, para lo cual
primero hay que conseguir un <em>ticket</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kinit Administrator@IESPJM.DOMUS
<span class="go">Password for Administrator@IESPJM.DOMUS:</span>
<span class="go">Warning: Your password will expire in 41 days on mar 07 feb 2017 19:09:36 CET</span>
</pre></div>
</div>
<span class="target" id="klist"></span><p id="index-1">Ahora ya tenemos credenciales para <em>Administrator</em><a class="footnote-reference brackets" href="#id6" id="id3">3</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>klist -l
<span class="go">Principal name                 Cache name</span>
<span class="go">--------------                 ----------</span>
<span class="go">Administrator@IESPJM.DOMUS        FILE:/tmp/krb5cc_0</span>
</pre></div>
</div>
<p>Así que podremos usar <strong class="command">samba-tool</strong> o <strong class="command">smbclient</strong> sin indicar
usuario, ya que este será aquel del que tenemos la credencial. Con el primero:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>samba-tool dns zonelist dc.iespjm.domus
<span class="go">[...]</span>
</pre></div>
</div>
<p>Obsérvese que no se usa <em>localhost</em>, sino el nombre de la máquina, aunque
podríamos habernos ahorrado el dominio:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>samba-tool dns zonelist dc
</pre></div>
</div>
<p>Con <strong class="program">smbclient</strong> debemos tener la precaución de añadir la opción <code class="docutils literal notranslate"><span class="pre">-k</span></code>
que indica que usaremos <em>kerberos</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>smbclient -L dc -k
<span class="go">[...]</span>
</pre></div>
</div>
<p>O bien, si preferimos acceder al disco:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>smbclient //DC/sysvol -k
<span class="go">smb: \&gt;</span>
</pre></div>
</div>
<p>Aún podemos hacer más pruebas, porque el <em>directorio activo</em> se caracteriza por
ser una implementación compatible con <em>LDAP</em>. Por tanto, podremos hacer
consultas con las herramientas del paquete <em>ldap-utils</em> (que se debe haber
intalado como dependencia). Usando la autenticación con contraseña, podemos
consultar los atributos del administrador:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ldapsearch -LLL -h dc -D <span class="s1">&#39;cn=Administrator,cn=Users,dc=iespjm,dc=domus&#39;</span> -W <span class="se">\</span>
   -b <span class="s1">&#39;dc=iespjm,dc=domus&#39;</span> <span class="nv">cn</span><span class="o">=</span>Administrator
<span class="go">Enter LDAP Password:</span>
<span class="go">dn: CN=Administrator,CN=Users,DC=iespjm,DC=domus</span>
<span class="go">objectClass: top</span>
<span class="go">objectClass: person</span>
<span class="go">objectClass: organizationalPerson</span>
<span class="go">objectClass: user</span>
<span class="go">cn: Administrator</span>
<span class="go">description: Built-in account for administering the computer/domain</span>
<span class="go">instanceType: 4</span>
<span class="go">whenCreated: 20161228130519.0Z</span>
<span class="go">uSNCreated: 3545</span>
<span class="go">name: Administrator</span>
<span class="go">objectGUID:: VPawBTKfx0+sCWj1mZtipw==</span>
<span class="go">userAccountControl: 512</span>
<span class="go">badPwdCount: 0</span>
<span class="go">codePage: 0</span>
<span class="go">countryCode: 0</span>
<span class="go">badPasswordTime: 0</span>
<span class="go">lastLogoff: 0</span>
<span class="go">primaryGroupID: 513</span>
<span class="go">objectSid:: AQUAAAAAAAUVAAAA7Wn7kfRzi7GK+ngk9AEAAA==</span>
<span class="go">adminCount: 1</span>
<span class="go">accountExpires: 9223372036854775807</span>
<span class="go">sAMAccountName: Administrator</span>
<span class="go">sAMAccountType: 805306368</span>
<span class="go">objectCategory: CN=Person,CN=Schema,CN=Configuration,DC=iespjm,DC=domus</span>
<span class="go">isCriticalSystemObject: TRUE</span>
<span class="go">memberOf: CN=Administrators,CN=Builtin,DC=iespjm,DC=domus</span>
<span class="go">memberOf: CN=Group Policy Creator Owners,CN=Users,DC=iespjm,DC=domus</span>
<span class="go">memberOf: CN=Enterprise Admins,CN=Users,DC=iespjm,DC=domus</span>
<span class="go">memberOf: CN=Schema Admins,CN=Users,DC=iespjm,DC=domus</span>
<span class="go">memberOf: CN=Domain Admins,CN=Users,DC=iespjm,DC=domus</span>
<span class="go">pwdLastSet: 131274042783321350</span>
<span class="go">lastLogonTimestamp: 131274042965165270</span>
<span class="go">whenChanged: 20161228131136.0Z</span>
<span class="go">uSNChanged: 3774</span>
<span class="go">lastLogon: 131274275990954850</span>
<span class="go">logonCount: 10</span>
<span class="go">distinguishedName: CN=Administrator,CN=Users,DC=iespjm,DC=domus</span>
</pre></div>
</div>
<p>Y si tenemos las credenciales del administrador, con <em>kerberos</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ldapsearch -h dc -LLLQY GSSAPI -b <span class="s1">&#39;dc=iespjm,dc=domus&#39;</span> <span class="nv">cn</span><span class="o">=</span>Administrator
<span class="go">[...]</span>
</pre></div>
</div>
<p class="rubric"><strong>Enlaces de interés</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="http://wiki.eri.ucsb.edu/stadm/AD_Samba4">AD Samba4</a></p></li>
<li><p><a class="reference external" href="https://wiki.samba.org/index.php/Setting_up_Samba_as_an_Active_Directory_Domain_Controller">Setting up Samba as an Active Directory Domain Controller</a></p></li>
</ul>
<p class="rubric">Notas al pie</p>
<dl class="footnote brackets">
<dt class="label" id="id4"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Si en algún momento, se desea cambiar entre uno y otro, se puede usar
<strong class="command">samba_dnsupgrade</strong>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>samba_upgradedns --dns-backend<span class="o">=</span>BIND9_DLZ
</pre></div>
</div>
<p>nos permitiría cambiar del servidor interno a <em>bind9</em>. Habría que cerciorarse
también de cuál es el valor de la directivo <code class="docutils literal notranslate"><span class="pre">server</span> <span class="pre">services</span></code> para que no
incluya el <abbr title="Domain Name Server">DNS</abbr>. Puede obtenerse más información <a class="reference external" href="https://wiki.samba.org/index.php/Changing_the_DNS_Back_End_of_a_Samba_AD_DC">aquí</a>.</p>
</dd>
<dt class="label" id="id5"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>El tamaño del volumen lógico es ridículamente pequeño. De hecho. este es
un sistema de ficheros en el que presumiblemente se almacenarán muchos datos.
Pero esto sólo es una prueba y nuestro sistema es una máquian virtual.</p>
</dd>
<dt class="label" id="id6"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p>Si queremos eliminar estas credenciales basta con hacer:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>kdestroy
</pre></div>
</div>
</dd>
</dl>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../../../index.html">Tabla de contenido</a></h3>
    <ul>
<li><a class="reference internal" href="#">6.4.2.2. Controlador de dominio</a><ul>
<li><a class="reference internal" href="#instalacion">6.4.2.2.1. Instalación</a></li>
<li><a class="reference internal" href="#configuracion">6.4.2.2.2. Configuración</a></li>
<li><a class="reference internal" href="#comprobaciones">6.4.2.2.3. Comprobaciones</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Tema anterior</h4>
    <p class="topless"><a href="../01.prologo/index.html"
                          title="capítulo anterior"><span class="section-number">6.4.2.1. </span>Preliminares</a></p>
  </div>
  <div>
    <h4>Próximo tema</h4>
    <p class="topless"><a href="../03.clientes/index.html"
                          title="próximo capítulo"><span class="section-number">6.4.2.3. </span>Clientes</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/06.infraestructura/05.directorio/06.samba/02.install-addc/index.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Ir a" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="../03.clientes/index.html" title="6.4.2.3. Clientes"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="../01.prologo/index.html" title="6.4.2.1. Preliminares"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" ><span class="section-number">6. </span>Servicios de infraestructura</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../index.html" ><span class="section-number">6.4. </span>Servicio de directorio</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../index.html" ><span class="section-number">6.4.2. </span>Samba</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">6.4.2.2. </span>Controlador de dominio</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2022, José Miguel Sánchez Alés.
      Creado usando <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>