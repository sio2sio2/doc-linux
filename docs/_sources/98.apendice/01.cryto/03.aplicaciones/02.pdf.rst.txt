.. _firm-doc:

Firma de documentos
*******************
Según :ref:`se presentó en un principio <firma-digital>`, puede firmarse
cualquier archivo o flujo de datos y a ressultas de ello se obtendrá un archivo
de firma que contiene el resumen cifrado con la la clave privada del firmante
junto a metainformación sobre el proceso. Dedicamos, no obstante, el epígrafe a
la forma de documentos de carácter oficial (contratos, solicitudes, decretos,
etc.) para lo cual se usa el formato |PDF|. Su especificación recoge cómo
firmarlos:

+ incluyendo la firma (o las firmas si se requiere la firma de varios)
  en un campo interno.
+ Utilizando :ref:`certificados digitales X.509 <cert-digital>`.

A resultas de firmarlos se obtendrá un archivo |PDF| firmado cuya firma(s)
puede(n) validarse fehacientemente.

.. note:: Aunque pueden llevarse a cabo marcas visibles (imprimibles) en el
   documento que denoten quién y cuándo ha sido firmado, la firma digital en sí
   no es visible y se verifica utilizando una herramienta de verificación sobre
   el archivo.

.. _firma-legal:

Estatus legal
=============
La validez legal de la firma digital está desarrollada en España a través de la
`Ley 6/2020`_, de 11 de noviembre, *reguladora de determinados aspectos de los
servicios electrónicos de confianza*, y  el `Reglamento eIDAS`_ (*Reglamento
910/2014*, conocidos por sus siglas en ingles |eIDAS|). La normativa establece
dos tipos de *prestadores de servicios de confianza* (esto es, de |CA|):

- :dfn:`Prestadores cualificados`, que son aquellos reconocidos como tales por
  un organismo supervisor\ [#]_. Las obligaciones a los que están sujetos se
  encuentran enumeradas en el artículo **9** de la `Ley 6/2020`_.
- :dfn:`Prestadores no cualificados`, que son aquellos que no gozan de este
  reconocimiento, aunque se encuentran inscritos para el ejercicio de su
  actividad.

Esta distinción origina que haya :dfn:`certificados digitales cualificados` y
:dfn:`certificados digitales no cualificados` y, consecuentemente, una
:dfn:`firma electrónica cualificada` y una :dfn:`firma electrónica no
cualificada`. La diferencia legal entre una y otra firma es que la primera tiene
los mismos efectos juridicos que la firma manuscrita, mientras que la segunda
no, aunque puede ser admitida en un juicio\ [#]_.

El Ministerio publica en su web la `lista de prestadores cualificados y no
cualificados de confianza
<https://avancedigital.mineco.gob.es/es-es/Servicios/FirmaElectronica/Paginas/Prestadores.aspx>`_.
Como todos los países de la Unión tiene la obligación de remitir estas listas
también es posible la `consulta de todos los prestadores europeos
<https://digital-strategy.ec.europa.eu/en/policies/eu-trusted-lists>`_.

.. _pdfsig:

Apéndice práctico
=================
Hay varias aplicaciones que permiten la firma y verificación de
firmas de documentos |PDF|:

* LibreOffice_ (dentro del menú "Archivo").
* MuPDF_\ [#]_.
* Poppler_ y todas las aplicaciones gráficas que lo usen como base (Xpdf_, Evince_).

Nos centraremos en el uso por línea de órdenes de esta última.

.. note:: El Gobierno de España proporciona dos buenas herramientas:

   * Para la **firma**, la aplicación `Autofirma
     <https://firmaelectronica.gob.es/Home/Descargas.html>`_, escrita en *Java*.
   * Tanto para **firma** como para **validación** de documentos firmados con
     certificados expedidos por algunas |CA| reconocidos por el `Ministerio de
     Industria, Comercio y Turismo <https://mincotur.gob.es>`_, la página
     `Valide <https://valide.redsara.es/>`_.

Validación
----------
Puede comprobarse la validez de la firma de un |PDF| con :manpage:`pdfsig`
(incluido en el paquete :deb:`poppler-utils`)::

   $ pdfsig -nocert documento.pdf

La orden de arriba, sin embargo, no comprobará la fiabilidad del certificado
firmante (:kbd:`-nocert`). Para hacerlo, es necesario que el programa utilice un
almacén de claves que disponga de toda la cadena de confianza. Este almacén de
claves es :ref:`un almacen NSS <cert-nss>` como los que usa Firefox_ o
Chromium_. Supuesto que dispongamos de ese almacén, entonces podremos comprobar
la firma y cerciorarnos de la fiabilidad del certificado::

   $ pdfsig -nssdir ~/.pki/nssdb documento.pdf

Firma
-----
.. warning:: Para poder firmar documentos es necesario utilizar al menos la
   versión **21.01** de :deb:`poppler-utils`, y preferentemente al menos la
   **21.10** que permite añadir nuevos campos de firma.

Supuesto que dispongamos de un almacén |NSS| con nuestro certificado y su cadena
de confianza::

   $ pdfsig -nssdir ~/.pki/nssdb -add-signature -nick 'CADENA-EN-NSSDB-DEL-CERT' doc.pdf doc_firmado.pdf

.. rubric:: Notas al pie

.. [#] La `Secretaria de Estado de Telecomunicaciones e
   Infraestructuras Digitales`_ dependiente del `Ministerio de Asuntos Económicos
   y Transformación Digital`_. La variabilidad política hará que este párrafo
   quede pronto obsoleto y el nombre del Ministerio y de la Secretaría de Estado
   cambie de nombre y *dirección web*.

.. [#] Puede hacerse una lectura del artículo `Terceros de confianza y
   certificación de prueba electrónica. Una nueva frontera en materia de
   probática <http://e-procesal.com/dterceros-de-confianza-y-certificacion-de-prueba-electronica-una-nueva-frontera-en-materia-de-probatica-2109>`_.

.. [#] ¿Alguien sabe cómo se firma con :command:`mutools`? No parece funcionar,
   al menos con certificados en formato |PKCS| #12.

.. |PDF| replace:: :abbr:`PDF (Portable Dcument Format)`
.. |NSS| replace:: :abbr:`NSS (Network Secure Services)`
.. |CA| replace:: :abbr:`CA (Certification Authority)`
.. |PKCS| replace:: :abbr:`PKCS (Public-Key Cryptography Standards)`
.. |eIDAS| replace:: :abbr:`eIDAS (Electronic IDentification, Authentication and trust Services)`

.. _LibreOffice: https://www.libreoffice.org
.. _MuPDF: https://mupdf.com
.. _Poppler: https://poppler.freedesktop.org
.. _Xpdf: https://www.xpdfreader.com
.. _Evince: https://wiki.gnome.org/Apps/Evince
.. _Ley 6/2020: https://www.boe.es/eli/es/l/2020/11/11/6/con
.. _Reglamento eIDAS: https://www.boe.es/buscar/doc.php?id=DOUE-L-2014-81822
.. _Ministerio de Asuntos Económicos y Transformación Digital: https://portal.mineco.gob.es/es-es/Paginas/default.aspx
.. _Secretaria de Estado de Telecomunicaciones e Infraestructuras Digitales: https://avancedigital.mineco.gob.es/es-es/Paginas/index.aspx
.. _Firefox: https://www.mozilla.org
.. _Chromium: https://www.chromium.org
