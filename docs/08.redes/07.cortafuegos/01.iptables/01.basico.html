


<!DOCTYPE html>

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>8.7.3.1.1. Conceptos básicos &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/translations.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Índice" href="../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../search.html" />
    <link rel="next" title="8.7.3.1.2. Uso práctico" href="02.conn.html" />
    <link rel="prev" title="8.7.3.1. IPtables" href="index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="02.conn.html" title="8.7.3.1.2. Uso práctico"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="index.html" title="8.7.3.1. IPtables"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" ><span class="section-number">8. </span>Conceptos avanzados de redes</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" ><span class="section-number">8.7. </span>Cortafuegos</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="index.html" accesskey="U"><span class="section-number">8.7.3.1. </span>IPtables</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">8.7.3.1.1. </span>Conceptos básicos</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="conceptos-basicos">
<h1><span class="section-number">8.7.3.1.1. </span>Conceptos básicos<a class="headerlink" href="#conceptos-basicos" title="Enlazar permanentemente con este título">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Centraremos las explicaciones en la principal herramienta:
<strong class="program">iptables</strong>, y añadiremos al final algunas notas para
<strong class="program">ebtables</strong> y <strong class="program">arptables</strong>.</p>
</div>
<p>Partiendo de lo explicado, en general, para <strong class="program">netfilter</strong>, es fácil
particularizar para <strong class="program">iptables</strong>.</p>
<div class="section" id="conceptos">
<h2><span class="section-number">8.7.3.1.1.1. </span>Conceptos<a class="headerlink" href="#conceptos" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En <strong class="program">iptables</strong> casi todos los <a class="reference internal" href="../index.html#netfilter-conceptos"><span class="std std-ref">conceptos de netfilter</span></a> (excepto las propias reglas) están predefinidos de
antemano.</p>
<div class="section" id="familias">
<h3><span class="section-number">8.7.3.1.1.1.1. </span>Familias<a class="headerlink" href="#familias" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Se usa una u otra aplicación dependiendo de cuál sea el tipo de tráfico
(<a class="reference internal" href="../index.html#netfilter-families"><span class="std std-ref">familia</span></a>) que queramos fiscalizar:</p>
<ul class="simple">
<li><p>Para tráfico <abbr>Address Resolution Protocol</abbr> usaremos <strong class="command">arptables</strong>.</p></li>
<li><p>Para la manipulación en capa 2 de trafico que entra o sale por interfaces
<em>bridge</em> debe usarse <strong class="command">ebtables</strong>.</p></li>
<li><p>Para el resto de tráfico, manipulable en capa de red y de transporte, usaremos
<strong class="program">iptables</strong> (<abbr title="Internet Protocol">IP</abbr>v4) o <strong class="program">ip6tables</strong> (<abbr title="Internet Protocol">IP</abbr>v6).</p></li>
</ul>
</div>
<div class="section" id="tablas">
<h3><span class="section-number">8.7.3.1.1.1.2. </span>Tablas<a class="headerlink" href="#tablas" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Ya está predefinidas sin posibilidad de añadir más:</p>
<dl>
<dt><strong>filter</strong></dt><dd><p>Es la tabla que incluye las cadenas dedicadas a contener las reglas de
filtrado, (o sea, de tipo <em>filter</em>) habituales.</p>
</dd>
<dt><strong>nat</strong></dt><dd><p>Es la tabla que incluye las cadenas dedicadas a contener reglas de tipo
<em>nat</em>.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Recuérdese que este tipo de reglas sólo se aplican al primer
paquete de la conexión.</p>
</div>
</dd>
<dt><strong>mangle</strong></dt><dd><p>Es una tabla que incluye cadenas con reglas de filtrado, dedicadas
fundamentalmente a alternar algunos de los campos de cabecera <abbr title="Internet Protocol">IP</abbr> (p.e.
el <abbr title="Time To Live">TTL</abbr> o el <abbr title="Type Of Service">TOS</abbr>). También se usan para alterar la <em>marca</em> del paquete, esto
es, una marca que no se encuentra en el propio paquete, sino en la
representación que el kernel hace del paquete, A efecto prácticos, dónde se
encuentre realmente la marca nos importa poco.</p>
</dd>
<dt><strong>raw</strong></dt><dd><p>Es la tabla que incluye cadenas con reglas de filtrado utilizada básicamente
para marcar paquetes a fin de evitar el seguimiento de la conexión, o bien,
para desecharlos antes de cualquier otra decisión. Para el tráfico con que
hagamos esto, <strong class="program">iptables</strong> se comportará como un <a class="reference internal" href="../../../guias/02.seg/04.redes/02.sistemas.html#fw-stateless"><span class="std std-ref">cortafuegos sin
inspección de estado</span></a>.</p>
</dd>
<dt><strong>security</strong></dt><dd><p>Es la tabla que incluye cadenas con reglas de filtrado para crear reglas de
seguridad <abbr title="Media Access Control">MAC</abbr>. Véase para más información <a class="reference external" href="https://www.linux.com/tutorials/using-selinux-and-iptables-together/">este artículo</a>.</p>
</dd>
</dl>
</div>
<div class="section" id="enganches">
<h3><span class="section-number">8.7.3.1.1.1.3. </span>Enganches<a class="headerlink" href="#enganches" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Dado que son cosa de <strong class="program">netfilter</strong>, son los <a class="reference internal" href="../index.html#netfilter-hooks"><span class="std std-ref">ya expuestos</span></a>. Ahora bien, puesto que, por ahora nos centramos
exclusivamente en <strong class="program">iptables</strong>, podemos simplificar el esquema:</p>
<img alt="../../../_images/iptables.png" id="iptables-flowchart" src="../../../_images/iptables.png" />
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>En este diagrama, los colores no identifican familias de tráfico, sino
caminos del paquete.</p>
</div>
</div>
<div class="section" id="cadenas">
<h3><span class="section-number">8.7.3.1.1.1.4. </span>Cadenas<a class="headerlink" href="#cadenas" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Podemos definir las <em>cadenas de usuario</em> que queramos, pero las <em>cadenas base</em>
están prestablecidas y lo único que nos será posible definir en ellas es la
política predeterminada de aceptación (<em>accept</em>) o rechazo (<em>drop</em>). Por
defecto, es <em>accept</em>.</p>
<p>Es fácil identificar las características de una <em>cadena base</em>, puesto que:</p>
<ul class="simple">
<li><p>Su nombre, aunque en mayúsculas, indica el <a class="reference internal" href="../index.html#netfilter-hooks"><span class="std std-ref">enganche</span></a>
al que se asocia (p.e. una cadena <em>PREROUTING</em> se engancha a <em>prerouting</em>).
Por ello y porque no hay posibilidad de crear más <em>cadenas base</em> de las
predefinadas, podemos fundir en uno los conceptos de <em>enganche</em> y de <em>cadena
base</em>. De hecho, eso es lo que se ha hecho al pintar el <a class="reference internal" href="#iptables-flowchart"><span class="std std-ref">diagrama de
flujo simplificado</span></a> en el que se representan <em>cadenas
base</em> y no <em>enganches</em>.</p></li>
<li><p>La tabla a la que pertenece nos refiere su <a class="reference internal" href="../index.html#netfilter-prio"><span class="std std-ref">prioridad</span></a>
(p.e. las cadenas de la tabla <em>mangle</em> tienen prioridad -150).</p></li>
<li><p>También la tabla refiere el tipo de reglas: las que pertenecen a <em>nat</em> son
cadenas de tipo de <em>nat</em> y las que pertenecen a todas las demás, de filtrado<a class="footnote-reference brackets" href="#id6" id="id1">1</a>.</p></li>
</ul>
<p>Las cadenas predefinadas son las siguientes:</p>
<table class="chains-tables docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 20%" />
<col style="width: 12%" />
<col style="width: 15%" />
<col style="width: 14%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head"><p>PREROUTING</p></th>
<th class="head"><p>INPUT</p></th>
<th class="head"><p>FORWARD</p></th>
<th class="head"><p>OUTPUT</p></th>
<th class="head"><p>POSTROUTING</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>raw</p></td>
<td><p>Sí</p></td>
<td></td>
<td></td>
<td><p>Sí</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>mangle</p></td>
<td><p>Sí</p></td>
<td><p>Sí</p></td>
<td><p>Sí</p></td>
<td><p>Sí</p></td>
<td><p>Sí</p></td>
</tr>
<tr class="row-even"><td><p>nat</p></td>
<td><p>Sí</p></td>
<td><p>Sí</p></td>
<td></td>
<td><p>Sí</p></td>
<td><p>Sí</p></td>
</tr>
<tr class="row-odd"><td><p>filter</p></td>
<td></td>
<td><p>Sí</p></td>
<td><p>Sí</p></td>
<td><p>Sí</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>security</p></td>
<td></td>
<td><p>Sí</p></td>
<td><p>Sí</p></td>
<td><p>Sí</p></td>
<td></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Como puede verse no hay ninguna cadena <em>INGRESS</em> lo que significa que
no hay forma de utilizar ese enganche con <strong class="program">iptables</strong>. De ahí, que no
se haya representado en el diagrama simplificado.</p>
</div>
<p>Es preciso puntualizar por qué existen cadenas en <em>nat</em> enganchadas a <em>input</em> y
<em>output</em>. Las cadenas de esta tabla sirven, fundamentalmente, para acciones de
<abbr title="Source NAT">SNAT</abbr> y <abbr title="Destination NAT">DNAT</abbr>. Para un paquete entrante, podemos llevar a cabo <abbr title="Destination NAT">DNAT</abbr> en el
enganche <em>prerouting</em>, porque el paquete pasa por ahí. En cambio, un paquete
creado por un proceso interno, no pasa por ese enganche, y es en <em>output</em> donde
de ser necesario, se puede hacer el <abbr title="Destination NAT">DNAT</abbr><a class="footnote-reference brackets" href="#id7" id="id2">2</a>. Por otro lado, para los paquetes
salientes se puede hacer <abbr title="Source NAT">SNAT</abbr> en <em>postrouting</em>, pero si una
aplicación local se comunica con otra aplicación local, el paquete nunca pasa
por ese enganche y es en <em>input</em> donde puede llevarse a cabo la operación<a class="footnote-reference brackets" href="#id8" id="id3">3</a>.</p>
</div>
</div>
<div class="section" id="funcionamiento">
<h2><span class="section-number">8.7.3.1.1.2. </span>Funcionamiento<a class="headerlink" href="#funcionamiento" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Si volvemos la vista al <a class="reference internal" href="#iptables-flowchart"><span class="std std-ref">diagrama simplificado de flujo</span></a>, comprobaremos que los paquetes siguen tres caminos:</p>
<dl class="simple">
<dt><strong>Paquetes destinados al cortafuegos</strong></dt><dd><p>Representados por la línea roja, el primer conjunto de reglas que se
comprueba con ellos son las incluidas en la cadena <em>PREROUTING</em>, llamada así
porque se aplican tales reglas antes de tomar la decisión de encaminamiento.
Pasadas las reglas, se toma la decisión que por nuestra suposición será un
proceso interno, lo que implica comprobar las reglas de la cadena <em>INPUT</em>. Si
el paquete no es filtrado por alguna de estas últimas reglas, el paquete
alcanzará el proceso al que iba destinado y ahí acabará su vida.</p>
</dd>
<dt><strong>Paquetes en tránsito</strong></dt><dd><p>Representados por la línea verde, son los paquetes que alcanzan el
cortafuegos, pero cuyo destino es otra máquina, por lo que utilizarán otra
interfaz de red (excepcionalmente puede que sea la misma) para salir hacia su
destino. En su caso la <em>decisión de encaminamiento</em> hace que sigan su curso
atravesando la cadena <em>FORWARD</em>. Si logra atravesar esta cadena, comprobará
a continuación <em>POSTROUTING</em>, pasada la cual se escoge según la dirección de
destino la interfaz de salida y en paquete abandona la máquina.</p>
</dd>
<dt><strong>Paquetes generados por el cortafuegos</strong></dt><dd><p>Representados por la línea azul, son los paquetes originados por un proceso
interno del cortafuegos. En este caso se comprueban primero las reglas de la
cadena <em>OUTPUT</em>. Si el paquete no es filtrado por alguna de sus reglas,
alcanzará la cadena <em>POSTROUTING</em>, a partir de la cual se obrará de la misma
forma que con el tipo anterior de paquetes.</p>
</dd>
</dl>
<p id="iptables-packet-type">Además, en lo referente a la conexión, hay siete estados distintos</p>
<dl class="simple">
<dt><strong>NEW</strong></dt><dd><p>Que es el estado del paquete que origina la conexión.</p>
</dd>
<dt><strong>ESTABLISHED</strong></dt><dd><p>Que es el estado del paquete que pertenece a una conexión establecida.</p>
</dd>
<dt><strong>RELATED</strong></dt><dd><p>Que es el estado del paquete que origina una conexión que se puede relacionar
con otra que ya ha sido establecida. Por ejemplo, imaginemos que intentamos establecer
una conexión <abbr title="Transmission Control Protocol">TCP</abbr> con un servidor remoto y este nos responde con un paquete <abbr title="Unternet Control Message Protocol">ICMP</abbr> de rechazo.
El estado de este segundo paquete sería <strong>RELATED</strong>, ya que no forma parte de la conexión
anterior, pero está relacionado con ella. También en el <a class="reference internal" href="02.conn.html#iptables-ftp"><span class="std std-ref">tráfico FTP</span></a> el paquete
que abre la conexión de datos es es <strong>RELATED</strong> puesto que tal conexión está relacionada con la
conexión de control.</p>
</dd>
<dt><strong>INVALID</strong></dt><dd><p>Que es el estado de los paquetes que no se pueden relacionar con ninguna conexión establecida.</p>
</dd>
<dt><strong>UNTRACKED</strong></dt><dd><p>Que es el estado de los paquetes de los que se decidió no hacer seguimiento
de la conexión (con <em>NOTRACK</em>).</p>
</dd>
<dt><strong>SNAT</strong></dt><dd><p>Que es el estado de los paquetes sobre los que se llevó a cabo un cambio
en la <abbr title="Internet Protocol">IP</abbr> de origen. También tiene este estado los paquetes de respuesta.</p>
</dd>
<dt><strong>DNAT</strong></dt><dd><p>Que es el estado de los paquetes sobre los que se llevó a cabo un cambio
en la <abbr title="Internet Protocol">IP</abbr> de destinoo. También tiene este estado los paquetes de respuesta.</p>
</dd>
</dl>
<p>Estos estados no son excluyentes en todos los casos. Por ejemplo, un paquete
puede a la vez ser parte de una conexión establecida a la que se aplica
enmascaramiento (o sea, <abbr title="Source NAT">SNAT</abbr>)<a class="footnote-reference brackets" href="#id9" id="id4">4</a>.</p>
</div>
<div class="section" id="sintaxis">
<span id="iptables-sintaxis"></span><h2><span class="section-number">8.7.3.1.1.3. </span>Sintaxis<a class="headerlink" href="#sintaxis" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Dado que la estructura de tablas y cadenas está ya predefinida, las reglas de
<strong class="program">iptables</strong> consiste básicamente en definir las reglas.
Por ejemplo, esta es una sentencia válida:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> iptables -A FORWARD -p tcp --dport <span class="m">25</span> -j DROP
</pre></div>
</div>
<p>El primer <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">A</kbd> <kbd class="kbd docutils literal notranslate">FORWARD</kbd></kbd>, indica que vamos a añadir esta regla al final de la
cadena <em>FORWARD</em>. La acción es <em>DROP</em>, o sea, desechar; y la condición es
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">p</kbd> <kbd class="kbd docutils literal notranslate">tcp</kbd> <kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">dport</kbd> <kbd class="kbd docutils literal notranslate">25</kbd></kbd>, o sea, protocolo <abbr title="Transmission Control Protocol">TCP</abbr> con puerto de destino el 25.
Esto quiere decir que cualquier paquete que cumpla con esto (posiblemente sea
tráfico <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> de salida), está vetado y no atravesará nuestro cortafuegos. ¿Qué
pasa con el tráfico web? Como el tráfico web es bastante improbable que tenga
como destino el puerto 25, no cumplirá la condición, y no será desechado; al
menos por esta regla.</p>
<p>Es muy importante recordar que dentro de una cadena las reglas se comprueban
siguiendo un orden, y que las acciones pueden ser terminales (se dejan de
comparar el resto de las reglas) como en el caso de ejemplo, o no serlo como por
ejemplo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> iptables -A FORWARD -p tcp --dport <span class="m">25</span> -j LOG --log-prefix <span class="s2">&quot;Cliente hace petición SMTP&quot;</span>
<span class="gp">#</span> iptables -A FORWARD -p tcp --dport <span class="m">25</span> -j DROP
</pre></div>
</div>
<p>En este caso primero se registra el paquete, pero como la regla no es termina,
la siguiente desecha el paquete.</p>
<p>En general las sentencia que crean reglas tiene este aspecto:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> iptables <span class="o">[</span>-t TABLA<span class="o">]</span> <span class="o">[</span>opciones<span class="o">]</span> -ACCIÓN CADENA <span class="o">[</span>condiciones<span class="o">]</span> <span class="o">[</span>-j OBJETIVO <span class="o">[</span>opciones_del_objetivo<span class="o">]]</span>
</pre></div>
</div>
<p>en donde se observa que hay cuatro partes fundamentales:</p>
<ul class="simple">
<li><p>la elección de la tabla,</p></li>
<li><p>Cuál es la acción que se quiere llevar a cabo y sobre qué cadena.</p></li>
<li><p>La condición o condiciones que debe cumplir un paquete para que se le apliqye la regla;</p></li>
<li><p>El objetivo u acción.</p></li>
</ul>
<div class="section" id="accion">
<h3><span class="section-number">8.7.3.1.1.3.1. </span>Acción<a class="headerlink" href="#accion" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Básicamente indican qué se quiere hacer con la regla: si añadirla, borrarla o
alternarla y sobre qué cadena se lleva a cabo tal acción:</p>
<table class="iptables-action docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 72%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Acción</p></th>
<th class="head"><p>Descripción</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td rowspan="2"><p>-A &lt;cadena&gt;</p></td>
<td><p>Añade la nueva regla al final de la cadena</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -A INPUT -p tcp –dport 80 -j DROP</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>-I &lt;cadena&gt; [N]</p></td>
<td><p>Añade la nueva regla a la cadena en la posición que se especifique. Si no se
expresa ninguna, se sobreentiente que en la primera.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -I INPUT -p tcp –dport 80 -j DROP</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>-D &lt;cadena&gt; [N]</p></td>
<td><p>Borrar una regla de la cadena indicada. Hay dos formas de indicar cuál:</p>
<ul class="simple">
<li><p>Volverla a escribir tal y como se definió.</p></li>
<li><p>Indicar su número de posición dentro de la cadena.</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>iptables -D INPUT -p tcp –dport 80 -j DROP
iptables -D INPUT 1</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>-R &lt;cadena&gt; [N]</p></td>
<td><p>Reemplaza una regla por otra. Se indica la posición de la regla a reemplazar y
a continuación la regla sustituta.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -R INPUT 1 -p tcp –dport 8080 -j DROP</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>-F [&lt;cadena&gt;]</p></td>
<td><p>Borrar todas las reglas referentes a una tabla de la cadena. Si no se indica la
cadena, borra todas las reglas de todas las cadenas de una tabla.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -t nat -F PREROUTING</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>-Z [&lt;cadena&gt;]</p></td>
<td><p>Pone a cero los contadores de paquetes de la cadena especificada. Si no se
indica cadena, se aplica a todas las de la tabla. Los contadores muestran el
número de paquetes que han cumplido las condiciones de la regla.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -Z</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>-N &lt;cadena_de_usaurio&gt;</p></td>
<td><p>Crea una nueva cadena. Para que los paquetes comprueben sus reglas, será
necesario saltar a ella desde una de las cadenas predefinidas. Hay un objetivo
para ello.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -N proxy</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>-X &lt;cadena_de_usuario&gt;</p></td>
<td><p>Borra una cadena creada anteriormente.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -X proxy</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>-P [&lt;cadena&gt;] [ACCEPT|DROP]</p></td>
<td><p>Establece la política predeterminada de filtrado:</p>
<ul class="simple">
<li><p>Lista blanca: <em>DROP</em>.</p></li>
<li><p>Lista negra: <em>ACCEPT</em>.</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>iptables -P INPUT ACCEPT</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>-L [&lt;cadena&gt;]</p></td>
<td><p>Muestra las reglas añadidas a una cadena. Si no se especifica ninguna, muestra
todas las cadenas de la tabla. Son útiles para esta acción, <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">v</kbd></kbd>, que
muestra los contadores de paquetes, <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">n</kbd></kbd> que muestra direcciones <abbr title="Internet Protocol">IP</abbr> y no
nombres de máquinas y <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">line</kbd>-<kbd class="kbd docutils literal notranslate">numbers</kbd></kbd> que muestra la posición de la regla
y puede ser usada en las acciones de borrado, inserción y remplazo.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -t nat –line-numbers -nvL PREROUTING</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="objetivo">
<h3><span class="section-number">8.7.3.1.1.3.2. </span>Objetivo<a class="headerlink" href="#objetivo" title="Enlazar permanentemente con este título">¶</a></h3>
<p>El <em class="dfn">objetivo</em> es la operación que se lleva a cabo sobre el paquete en caso
de que le sea aplicable la regla.</p>
<table class="iptables-objetivo docutils align-default">
<colgroup>
<col style="width: 7%" />
<col style="width: 13%" />
<col style="width: 17%" />
<col style="width: 63%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Tabla</p></th>
<th class="head"><p>Objetivo</p></th>
<th class="head" colspan="2"><p>Descripción</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td rowspan="8"><p>filter</p></td>
<td rowspan="2"><p>ACCEPT</p></td>
<td colspan="2"><p>Se acepta el paquete y no se analizan más reglas de las cadenas de la tabla.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -A INPUT -p icmp -j ACCEPT</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>DROP</p></td>
<td colspan="2"><p>Desecha el paquete sin informar al emisor. Por ello, sólo considerará fallida la
conexión tras un tiempo de espera. Obviamente, no es revisada ninguna regla posterior.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -A INPUT -p icmp -j DROP</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>REJECT</p></td>
<td colspan="2"><p>Rechaza un paquete enviando al emisor el aviso del rechazo mediante un paquete <abbr title="Unternet Control Message Protocol">ICMP</abbr>.
Se puede especificar el tipo de <abbr title="Unternet Control Message Protocol">ICMP</abbr> mediante <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">reject</kbd>-<kbd class="kbd docutils literal notranslate">with</kbd></kbd> y, en el caso,
de conexiones <abbr title="Transmission Control Protocol">TCP</abbr> se puedfe usar <em>tcp-reset</em> para enviar un paquete <em>RST</em> que cierre
elegantemente la conexión. Si no se incluye la opción se envía <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate">port</kbd>-<kbd class="kbd docutils literal notranslate">unreachable</kbd></kbd>.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -A FORWARD -p tcp –dport 25 -j REJECT –reject-with tcp-reset</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>LOG</p></td>
<td colspan="2"><p>Registra en un archivo el paquete que cumple las condiciones de la regla. De las
opciones posibles la más útil es <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">log</kbd>-<kbd class="kbd docutils literal notranslate">prefix</kbd></kbd> que permite añadir un prefijo a
las anotaciones, lo cual puede ser útil para filtrar esas anotaciones. Vea más
adelante <a class="reference internal" href="03.ext.html#iptables-log"><span class="std std-ref">como realizar anotaciones en el registro</span></a>. El objetivo
no altera la comprobación de las reglas posteriores.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><div class="line-block">
<div class="line">iptables -A FORWARD -p tcp –dport 25 -j LOG –log-prefix=»[netfilter]</div>
<div class="line">iptables -A FORWARD -p tcp –dport 25 -j REJECT –reject-with tcp-reset</div>
</div>
</td>
</tr>
<tr class="row-even"><td rowspan="8"><p>nat</p></td>
<td rowspan="2"><p>SNAT</p></td>
<td colspan="2"><p>Cambia la <abbr title="Internet Protocol">IP</abbr> de origen del paquete. Sólo está disponible en las cadenas
<em>POSTROUTING</em> e <em>INPUT</em> de la tabla <em>nat</em>. Necesita la opción <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">to</kbd>-<kbd class="kbd docutils literal notranslate">source</kbd></kbd> para
indicar cuál es la <abbr title="Internet Protocol">IP</abbr> sustituta.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -t nat -A POSTROUTING -o eth0 -j SNAT –to-source 172.22.0.2</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>MASQUERADE</p></td>
<td colspan="2"><p>Cambia la <abbr title="Internet Protocol">IP</abbr> de origen del paquete por la <abbr title="Internet Protocol">IP</abbr> de salida del cortafuegos. Útil
cuando la <abbr title="Internet Protocol">IP</abbr> es dinámica.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>DNAT</p></td>
<td colspan="2"><p>Cambia la <abbr title="Internet Protocol">IP</abbr> de destino del paquete. Debe hacerse en la cadena <em>PREROUTING</em> o en
<em>OUTPUT</em> de la tabla <em>nat</em>. Necesita la opción <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">to</kbd>-<kbd class="kbd docutils literal notranslate">destination</kbd></kbd> para indicar la
<abbr title="Internet Protocol">IP</abbr> sustituta. Puede además modificarse el puerto de destino separándolo con dos
puntos («<kbd class="kbd docutils literal notranslate">:</kbd>»).</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -t nat -A PREROUTING -p udp –dport 53 -j DNAT –to-destination 172.22.0.1</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>REDIRECT</p></td>
<td colspan="2"><p>Cambia la <abbr title="Internet Protocol">IP</abbr> de destino a <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code>. Puede añadirse la opción <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">to</kbd>-<kbd class="kbd docutils literal notranslate">port</kbd></kbd>
para modificar el puerto de destino. Puede usarse en <em>PREROUTING</em> o en <em>OUTPUT</em>.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -t nat -A PREROUTING -p tcp –dport 80 -j REDIRECT –to-port 3128</p></td>
</tr>
<tr class="row-even"><td rowspan="6"><p>mangle</p></td>
<td rowspan="2"><p>MARK</p></td>
<td colspan="2"><p>Sirve para marcar la representanción del paquete en el núcleo de <em>Linux</em>, con el fin
de que más adelante el propio <strong class="program">iptables</strong> u otro proceso reconozca la marca.
Debe usarse con la opción <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">set</kbd>-<kbd class="kbd docutils literal notranslate">mark</kbd></kbd> para fijar la marca (un byte).</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -t nat -A PREROUTING -p tcp –dport 22 -j MARK –set-mark 0x2</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>TOS</p></td>
<td colspan="2"><p>Cambia el <abbr title="Type Of Service">TOS</abbr> del paquete.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -t nat -A PREROUTING -p tcp –dport 22 -j TOS –set-tos 0x10</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>TTL</p></td>
<td colspan="2"><p>Cambia el <abbr title="Time To Live">TTL</abbr> del paquete.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -t nat -A PREROUTING -p tcp –dport 22 -j TTL –set-ttl 64</p></td>
</tr>
<tr class="row-even"><td rowspan="4"><p>raw</p></td>
<td rowspan="2"><p>NOTRACK</p></td>
<td colspan="2"><p>Evitar hacer el seguimiento de la conexión. Puede usarse en las cadenas <em>PREROUTING</em> y
<em>OUTPUT</em>.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -t raw -A PREROUTING -p udp –dport 53 -j NOTRACK</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>DROP</p></td>
<td colspan="2"><p>Como lo anterior, pero descarta el paquete en vez de dejarlo pasar y no hacerle
seguimiento. Si nuestra intención es filtrar un tráfico vaya a la máquina o pretenda
atravesarlo, este el mejor momento, ya que sólo requiere una regla en vez de dos, una
para cada tabla y, además, se realiza antes de tomar ninguna decisión con lo que es
más eficiente.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -t raw -A PREROUTING -p udp –dport 53 -j DROP</p></td>
</tr>
<tr class="row-even"><td rowspan="11"><p>Todas</p></td>
<td rowspan="2"><p>nueva_cadena</p></td>
<td colspan="2"><p>Hace que la comprobación de reglas salte a la nueva cadena, que previamente tuvo que
ser definida. Si esto ocurre, se comprobarán las reglas incluidas en esta cadena y, si
se agotan, se volverá a la cadena en la que se incluyó el salto justamente tras la
regla que provocó el salto.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -A INPUT -j indeseables</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>RETURN</p></td>
<td colspan="2"><p>Hace que el paquete cese la comprobación de las reglas de la cadena y vuelva a la
cadena de orden superior (p.e. un <em>RETURN</em> en indeseables, provoca el regreso a INPUT).
Si no hay cadena de orden superior, se aplica la política predefinida de la cadena.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -t nat -A PREROUTING -i eth1 -s 192.168.9.208/28 -p tcp –dport 80 -j RETURN</p></td>
</tr>
<tr class="row-even"><td rowspan="7"><p>CONNMARK</p></td>
<td colspan="2"><p>Define marcas para una conexión. La diferencia entre <em>MARK</em> y <em>CONNMARK</em> es que la
primera marca paquetes individuales, mientras que la segunda, una vez usada, marcará
todos los paquetes que pertenezcan a la misma conexión. Las marcas de paquete y de
conexión son dos campos independientes. Tiene dos grandes utilidades: por un lado,
posibilita tener marcados los paquetes de vuelta o incluso paquetes de una conexión
relacionada; por otro. Se usa fundamentalmente en la tabla <em>nat</em>, ya que de esta forma
se lleva a cabo la definición sólo en el primer paquete.</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>–set-mark</p></td>
<td><p>Fija la marca de conexión.</p></td>
</tr>
<tr class="row-even"><td><p>iptables -t nat -A PREROUTING -i eth1 -j CONNMARK –set-mark 1</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>–restore-mark</p></td>
<td><p>Copia el valor de la marca de conexión en la marca de paquete.</p></td>
</tr>
<tr class="row-even"><td><p>iptables -t mangle -A FORWARD -j CONNMARK –restore-mark-mark 1</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>–save-mark</p></td>
<td><p>Guarda la marca de paquete en la marca de conexión</p></td>
</tr>
<tr class="row-even"><td><p>iptables -t nat -A POSTROUTING -j CONNMARK –save-mark</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="condicion">
<h3><span class="section-number">8.7.3.1.1.3.3. </span>Condición<a class="headerlink" href="#condicion" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Hace aplicable la regla sobre el paquete, de suerte que todos aquellos paquetes
que la cumplan realizarán el objetivo expresado en la regla. A cuenta de las
condiciones es conveniente saber que:</p>
<ul>
<li><p>Pueden expresarse varias condiciones lo que implica que deban cumplirse
todas. Por ejemplo, en:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> iptables -t nat -A PREROUTING -i eth1 -s <span class="m">192</span>.168.9.208/28 -p tcp --dport <span class="m">80</span> -j RETURN
</pre></div>
</div>
<p>hay tres condiciones independientes: <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">i</kbd> <kbd class="kbd docutils literal notranslate">eth1</kbd></kbd> que expresa cuál es la
interfaz de entrada, <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">s</kbd> <kbd class="kbd docutils literal notranslate">192.168.9.208/28</kbd></kbd>, que expresa cuál es la red
de origen, y <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">p</kbd> <kbd class="kbd docutils literal notranslate">tcp</kbd> <kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">dport</kbd> <kbd class="kbd docutils literal notranslate">80</kbd></kbd>, que fuerza a que el puerto de destino
sea el 80/<abbr title="Transmission Control Protocol">TCP</abbr>. Si no se cumplen las condiciones, el paquete no llevará a
cabo el objetivo (<strong>RETURN</strong>).</p>
</li>
<li><p>Las condiciones pueden admitir el uso de opciones. En el ejemplo, la
condición es <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">p</kbd> <kbd class="kbd docutils literal notranslate">tcp</kbd></kbd> (protocolo <abbr title="Transmission Control Protocol">TCP</abbr>), pero esta condición admite como
opción que se especifique un puerto, de ahí que hayamos podido añadir
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">dport</kbd> <kbd class="kbd docutils literal notranslate">80</kbd></kbd>.</p></li>
<li><p>Las condiciones pueden negarse anteponiendo el carácter <kbd class="kbd docutils literal notranslate">!</kbd>. Por
ejemplo, <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate">!</kbd> <kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">i</kbd> <kbd class="kbd docutils literal notranslate">eth1</kbd></kbd> significa cualquier interfaz de entrada, excepto la <em>eth1</em>;
o <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">p</kbd> <kbd class="kbd docutils literal notranslate">tcp</kbd> <kbd class="kbd docutils literal notranslate">!</kbd> <kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">dport</kbd> <kbd class="kbd docutils literal notranslate">80</kbd></kbd> cualquier puerto <abbr title="Transmission Control Protocol">TCP</abbr> excepto el 80.</p></li>
<li><p>Podemos distinguir dos tipos de condiciones:</p>
<ul class="simple">
<li><p>Las condiciones <em>simples</em> que son aquellas que se refieren al origen o
destino del paquete (ya sea referido a la interfaz o a su dirección <abbr title="Internet Protocol">IP</abbr>) o a su
protocolo de capa de red (<abbr title="Internet Protocol">IP</abbr>, <abbr title="Unternet Control Message Protocol">ICMP</abbr>) o de transporte (<abbr title="Transmission Control Protocol">TCP</abbr>, <abbr title="User Datagram Protocol">UDP</abbr>). En este
último caso, podremos inquirir sobre sus puertos de origen o destino.</p></li>
<li><p>Las condiciones que requieren un módulo o extensión, las cuales requieren
que se especifique qué`extensión es la que se usa a través de la opción
<kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">m</kbd></kbd> o <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">match</kbd></kbd>.</p></li>
</ul>
</li>
</ul>
<p class="rubric">Condiciones simples</p>
<table class="iptables-simpl-cond docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 28%" />
<col style="width: 51%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Opción</p></th>
<th class="head" colspan="2"><p>Descripción</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td rowspan="10"><p>-p, –protocol</p></td>
<td colspan="2"><p>Protocolo de capa de transporte del paquete. Los valores posibles son
<kbd class="kbd docutils literal notranslate">udp</kbd>, <kbd class="kbd docutils literal notranslate">tcp</kbd>, <kbd class="kbd docutils literal notranslate">icmp</kbd> o <kbd class="kbd docutils literal notranslate">all</kbd> (o sea, todos).</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -A FORWARD -p icmp -j REJECT</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>–sport, –source-port</p></td>
<td><p>Para <abbr title="Transmission Control Protocol">TCP</abbr> o <abbr title="User Datagram Protocol">UDP</abbr>, indicar puerto de origen.
Para indicar im rango, úsense dos puntos:
<kbd class="kbd docutils literal notranslate">80:100</kbd>.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -A FORWARD -p tcp –sport 80 -j ACCEPT</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>–dport, –destination-port</p></td>
<td><p>Para <abbr title="Transmission Control Protocol">TCP</abbr> o <abbr title="User Datagram Protocol">UDP</abbr>, indica puerto de destino.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -A FORWARD ! -p tcp –dport 80 -j ACCEPT</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>–tcp-flags</p></td>
<td><p>Para <abbr title="Transmission Control Protocol">TCP</abbr>,  permite seleccionar paquetes según
sus <em>flags</em>: <em>SYN</em>, <em>ACK</em>, <em>FIN</em>, <em>RST</em>, <em>ALL</em>
(todas) o <em>NONE</em> (ninguna). Si quieren expresarse
varias pueden separarse por comas. Admite dos
parámetros el primero cuáles se buscan y el
segundo cuáles se esperan encontrar. <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">syn</kbd></kbd>
equivale a <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">tcp</kbd>-<kbd class="kbd docutils literal notranslate">flags</kbd> <kbd class="kbd docutils literal notranslate">SYN,RST,ACK,FIN</kbd> <kbd class="kbd docutils literal notranslate">SYN</kbd></kbd>.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -A INPUT -p tcp –tcp-flags ALL SYN -j DROP</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>–icmp-type</p></td>
<td><p>Para <abbr title="Unternet Control Message Protocol">ICMP</abbr>, especifica el tipo de paquete <abbr title="Unternet Control Message Protocol">ICMP</abbr>
<span class="target" id="index-0"></span><a class="rfc reference external" href="https://tools.ietf.org/html/rfc792.html"><strong>RFC 792</strong></a>.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -A FORWARD -p icmp ! –icmp-type 8 -j DROP</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>-s, –source</p></td>
<td colspan="2"><p><abbr title="Internet Protocol">IP</abbr> de origen que puede ser una dirección simple o una red en notación <abbr title="Classless Inter-Domain Routing">CIDR</abbr>
(p.e. <code class="docutils literal notranslate"><span class="pre">192.168.0.0/24</span></code>) o expresando la máscara <code class="docutils literal notranslate"><span class="pre">192.168.0.0/255.255.255.0</span></code>.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -A INPUT -s 192.168.0.0/24 -j DROP</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>-d, –destination</p></td>
<td colspan="2"><p><abbr title="Internet Protocol">IP</abbr> de destino.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -A FORWARD -d 192.168.0.0/24 -j DROP</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>-i, –in-interface</p></td>
<td colspan="2"><p>Interfaz de entrada del paquete. Válida sólo en <em>PREROUTING</em>, <em>INPUT</em> y <em>FORWARD</em>.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -A FORWARD -i eth0 -p tcp –tcp-flags SYN -j DROP</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>-o, –out-interface</p></td>
<td colspan="2"><p>Interfaz de salida del paquete. Válida sólo en <em>POSTROUTING</em>, <em>OUTPUT</em> y <em>FORWARD</em>.</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</p></td>
</tr>
</tbody>
</table>
<p class="rubric">Extensiones</p>
<p>Cualquier otra condición no incluida en las simplas que refiere la tabla
anterior, son condiciones que requieren de un módulo invocado a través de las
opciones <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">m</kbd></kbd> o <kbd class="kbd docutils literal notranslate"><kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate"></kbd>-<kbd class="kbd docutils literal notranslate">match</kbd></kbd>. No trataremos todas y algunas muy
específicas las referiremos en epígrafe aparte.</p>
<table class="iptables-ext docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 19%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Extension</p></th>
<th class="head"><p>Opción</p></th>
<th class="head"><p>Descripción</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td rowspan="4"><p>multiport</p></td>
<td rowspan="2"><p>–sports</p></td>
<td><p>Lista de puertos de origen. Admite comas y dos puntos para rangos.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -A FORWARD –p tcp -m multiport –source-port 22,23,80:100 -j DROP</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>–dports</p></td>
<td><p>Lista de puertos de destino. Admite comas y dos puntos para rangos.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -A FORWARD –p tcp -m multiport –source-port 22,23,80:100 -j DROP</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>mark</p></td>
<td rowspan="2"><p>–mark</p></td>
<td><p>Marca del paquete.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -A INPUT -m mark –mark 1 -j DROP</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>connmark</p></td>
<td rowspan="2"><p>–connmark</p></td>
<td><p>Marca de la conexión.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -t nat -A POSTROUTING -o eth0 -m connmark –mark 0x2 -j MASQUERADE</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>mac</p></td>
<td rowspan="2"><p>–mac-source</p></td>
<td><p>Mac de origen.</p></td>
</tr>
<tr class="row-odd"><td><p>iptables -A INPUT -m mac –mac-source 00:11:22:33:44:55 -j DROP</p></td>
</tr>
<tr class="row-even"><td rowspan="7"><p>physdev</p></td>
<td colspan="2"><p>Sirve para manipular de modo muy limitado <strong>tráfico conmutado</strong>, no encaminado.</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>-physdev-in</p></td>
<td><p>Interfaz de entrada.</p></td>
</tr>
<tr class="row-even"><td><p>iptables -A INPUT -p tcp –dport 25 -m physdev –physdev-in eth1 -j DROP</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>-physdev-out</p></td>
<td><p>Interfaz de salida.</p></td>
</tr>
<tr class="row-even"><td><p>iptables -A OUTPUT -p tcp –dport 25 -m physdev –physdev-out eth0 -j DROP</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>-physdev-is-bridged</p></td>
<td><p>Comprueba si el tráfico es conmutado  Solo en <em>FORWARD</em> y <em>POSTROUTING</em>.</p></td>
</tr>
<tr class="row-even"><td><p>iptables -A FORWARD -m physdev –physdev-is-bridged -o br0 -j ACCEPT</p></td>
</tr>
<tr class="row-odd"><td rowspan="4"><p>string</p></td>
<td colspan="2"><p>Su contenido incluye una cadena.</p></td>
</tr>
<tr class="row-even"><td><p>–algo bm|kmp</p></td>
<td><p>Algoritmo de búsqueda. <em>bm</em> es más rápido pero menos exhaustivo</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>–string</p></td>
<td><p>Cadena a comprobar.</p></td>
</tr>
<tr class="row-even"><td><p>iptables -A FORWARD -m string –string «facebook» –algo bm -j DROP</p></td>
</tr>
</tbody>
</table>
<p>Además, trataremos más adelante:</p>
<ul class="simple">
<li><p><a class="reference internal" href="02.conn.html#iptables-conn"><span class="std std-ref">state y conntrack</span></a>.</p></li>
<li><p><a class="reference internal" href="03.ext.html#iptables-limit"><span class="std std-ref">limit</span></a>.</p></li>
<li><p><a class="reference internal" href="03.ext.html#iptables-recent"><span class="std std-ref">recent</span></a>.</p></li>
<li><p><a class="reference internal" href="03.ext.html#ipt-ipset"><span class="std std-ref">set</span></a>.</p></li>
</ul>
</div>
</div>
<div class="section" id="persistencia">
<h2><span class="section-number">8.7.3.1.1.4. </span>Persistencia<a class="headerlink" href="#persistencia" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Las reglas de <strong class="program">iptables</strong> no son permanentes, por lo que cualquier
apagado de la máquina las limpia por completo. Por ello, cuando se han definido
todas las reglas adecuadas, es muy importante buscar un buen método para
recuperarñas tras cada arranque. Tenemos varias alternativas:</p>
<dl>
<dt><strong>Restauración</strong></dt><dd><p>Las órdenes <strong class="command">iptables-save</strong> e <strong class="command">iptables-restore</strong> permiten
guardar y recuperar respectivamente las reglas de <strong class="command">iptables</strong>. Así,
una vez que tenemos perfectamente configurado el cortafuegos puede hacerse:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> iptables-save &gt; /etc/iptables.rules
</pre></div>
</div>
<p>Para recuperar estas reglas tras un reinicio, es preciso ejecutar
automáticamente <strong class="command">iptables-restore</strong>, lo cual podemos lograr
incluyéndo est linea en <code class="file docutils literal notranslate"><span class="pre">/etc/tc.local</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>iptables-restore &lt; /etc/iptables.rules
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p><strong class="command">ebtables</strong> y <strong class="command">arptables</strong> tienen órdenes
equivalentes.</p>
</div>
</dd>
<dt><strong>Script</strong></dt><dd><p>Consiste en crear un script de la <em>shell</em> en que se introduzcan las órdenes
que generan la configuración deseada:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

iptables -P INPUT DROP
iptables -P OUTPUT DROP
iptables -P FORWARD DROP

<span class="c1"># etc...</span>
</pre></div>
</div>
<p>Para que el <em>script</em> se ejecute al arrancar se puede invocar desde
<code class="file docutils literal notranslate"><span class="pre">/etc/rc.local</span></code>.</p>
</dd>
</dl>
<p><strong>Script para interfaces</strong> (sólo debian)</p>
<blockquote>
<div><div class="admonition-todo admonition" id="id5">
<p class="admonition-title">Por hacer</p>
<p>Por escribir.</p>
</div>
</div></blockquote>
<p class="rubric">Notas al pie</p>
<dl class="footnote brackets">
<dt class="label" id="id6"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>No hay reglas de tipo <em>route</em>.</p>
</dd>
<dt class="label" id="id7"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>Porque queremos engañar a la máquina con la que nos comunicamos
haciéndole creer que somos otra. Obviamente, la única manera de que esto
funcione, es que los paquetes que nuestra comunicamte envía a la máquina
suplantada, pasen forzosamente por la nuestra.</p>
</dd>
<dt class="label" id="id8"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p>En este caso, para hacer crear a nuestra aplicación que se comunica con
una aplicación externa.</p>
</dd>
<dt class="label" id="id9"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p>De hecho, en <strong class="program">nftables</strong> se distingue entre <kbd class="kbd docutils literal notranslate">state</kbd> (<em>new</em>,
<em>established</em>, <em>related</em>, <em>invalid</em> o <em>untracked</em>) y <kbd class="kbd docutils literal notranslate">status</kbd> (<em>snat</em> o
<em>dnat</em>).</p>
</dd>
</dl>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../index.html">Tabla de contenido</a></h3>
  <ul>
<li><a class="reference internal" href="#">8.7.3.1.1. Conceptos básicos</a><ul>
<li><a class="reference internal" href="#conceptos">8.7.3.1.1.1. Conceptos</a><ul>
<li><a class="reference internal" href="#familias">8.7.3.1.1.1.1. Familias</a></li>
<li><a class="reference internal" href="#tablas">8.7.3.1.1.1.2. Tablas</a></li>
<li><a class="reference internal" href="#enganches">8.7.3.1.1.1.3. Enganches</a></li>
<li><a class="reference internal" href="#cadenas">8.7.3.1.1.1.4. Cadenas</a></li>
</ul>
</li>
<li><a class="reference internal" href="#funcionamiento">8.7.3.1.1.2. Funcionamiento</a></li>
<li><a class="reference internal" href="#sintaxis">8.7.3.1.1.3. Sintaxis</a><ul>
<li><a class="reference internal" href="#accion">8.7.3.1.1.3.1. Acción</a></li>
<li><a class="reference internal" href="#objetivo">8.7.3.1.1.3.2. Objetivo</a></li>
<li><a class="reference internal" href="#condicion">8.7.3.1.1.3.3. Condición</a></li>
</ul>
</li>
<li><a class="reference internal" href="#persistencia">8.7.3.1.1.4. Persistencia</a></li>
</ul>
</li>
</ul>

  <h4>Tema anterior</h4>
  <p class="topless"><a href="index.html"
                        title="capítulo anterior"><span class="section-number">8.7.3.1. </span>IPtables</a></p>
  <h4>Próximo tema</h4>
  <p class="topless"><a href="02.conn.html"
                        title="próximo capítulo"><span class="section-number">8.7.3.1.2. </span>Uso práctico</a></p>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/08.redes/07.cortafuegos/01.iptables/01.basico.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Ir a" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="02.conn.html" title="8.7.3.1.2. Uso práctico"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="index.html" title="8.7.3.1. IPtables"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" ><span class="section-number">8. </span>Conceptos avanzados de redes</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" ><span class="section-number">8.7. </span>Cortafuegos</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="index.html" ><span class="section-number">8.7.3.1. </span>IPtables</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">8.7.3.1.1. </span>Conceptos básicos</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2021, José Miguel Sánchez Alés.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
    </div>
  </body>
</html>