


<!DOCTYPE html>

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>8.7.3.2.4. Uso avanzado &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/translations.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Índice" href="../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../search.html" />
    <link rel="next" title="8.8. Calidad de servicio" href="../../08.qos/index.html" />
    <link rel="prev" title="8.7.3.2.3. Uso práctico" href="03.conn.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="../../08.qos/index.html" title="8.8. Calidad de servicio"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="03.conn.html" title="8.7.3.2.3. Uso práctico"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" ><span class="section-number">8. </span>Conceptos avanzados de redes</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" ><span class="section-number">8.7. </span>Cortafuegos</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="index.html" accesskey="U"><span class="section-number">8.7.3.2. </span>nftables</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="uso-avanzado">
<h1><span class="section-number">8.7.3.2.4. </span>Uso avanzado<a class="headerlink" href="#uso-avanzado" title="Enlazar permanentemente con este título">¶</a></h1>
<div class="section" id="marcas">
<span id="nftables-marcas"></span><h2><span class="section-number">8.7.3.2.4.1. </span>Marcas<a class="headerlink" href="#marcas" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Las <em class="dfn">marcas</em> son señales que pueden establecerse sobre los paquetes a fin
de reconocerlos más adelante en el flujo. Por ejemplo, en un enganche de la
familia <em>bridge</em> somos capaces de reconocer cuál es la interfaz física (el
puerto) por el que entró un paquete, mientras que un enganche de la familia
<em>ip</em>, sólo somos capaces de reconocer la <a class="reference internal" href="../../03.bridge.html#bridge"><span class="std std-ref">interfaz bridge</span></a>
virtual. Si marcamos los paquetes en el primer enganche, seremos capaces de
reconocer el puerto de entrada en el segundo consultando la marca.</p>
<p>Hay dos tipos de marcas:</p>
<ul class="simple">
<li><p>La <em class="dfn">marca de paquete</em> que es aquella que se establece individualmente
para cada paquete. En realidad, las marcas no se escriben sobre el propio
paquete, sino sobre su representación en <strong class="program">netfilter</strong>, por lo que no
podrá ser consultada fuera del propio cortafuegos.</p></li>
<li><p>La <em class="dfn">marca de conexión</em> que es aquella que se establece sobre la conexión
a la que pertenece un paquete. En consecuencia, es consultable desde el resto
de paquetes que pertenecen a la marca. Es común que se establezca en un
enganche de tipo <em>nat</em> en el primer paquete.</p></li>
</ul>
<table class="nftables-matches docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 21%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Criterio</p></th>
<th class="head"><p>Argumento</p></th>
<th class="head"><p>Descripción</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td rowspan="4"><p>meta</p></td>
<td rowspan="2"><p>mark</p></td>
<td><p>Comprueba la marca del paquete.</p></td>
</tr>
<tr class="row-odd"><td><p>meta mark 0x1</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>mark set</p></td>
<td><p>Establece la marca sobre el paquete.</p></td>
</tr>
<tr class="row-odd"><td><p>meta mark set 0x1</p></td>
</tr>
<tr class="row-even"><td rowspan="4"><p>ct</p></td>
<td rowspan="2"><p>mark</p></td>
<td><p>Comprueba la marca de la comexión.</p></td>
</tr>
<tr class="row-odd"><td><p>ct mark 0x1</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>mark set</p></td>
<td><p>Establece la marca sobre la conexión.</p></td>
</tr>
<tr class="row-odd"><td><p>ct mark set 0x1</p></td>
</tr>
</tbody>
</table>
<p>Por ejemplo, si queremos limitar el caudal de tráfico <abbr title="Security SHell">SSH</abbr>, pero sólo de los
clientes que se conectan a nuestro servidor por <em>eth0</em>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>table netdev filter <span class="o">{</span>
   chain INGRESS <span class="o">{</span>
      <span class="nb">type</span> filter hook ingres device eth0 priority filter

      tcp dport ssh meta mark <span class="nb">set</span> <span class="m">1</span>
   <span class="o">}</span>

   chain INPUT <span class="o">{</span>
      <span class="nb">type</span> filter hook input priority filter

      meta mark <span class="m">1</span> limit over <span class="m">512</span> kbytes/second drop
   <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="colecciones">
<h2><span class="section-number">8.7.3.2.4.2. </span>Colecciones<a class="headerlink" href="#colecciones" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Incluimos bajo este epígrafe las herramientas de que dispone <strong class="program">nftables</strong>
para agrupar elementos</p>
<div class="section" id="conjuntos">
<span id="nftables-sets"></span><h3><span class="section-number">8.7.3.2.4.2.1. </span>Conjuntos<a class="headerlink" href="#conjuntos" title="Enlazar permanentemente con este título">¶</a></h3>
<p>En <strong class="program">nftables</strong> hay dos tipos de conjuntos:</p>
<ul>
<li><p><strong>Anónimos</strong> que son aquellos invariables que se añaden directamente a las
reglas y, sin ponerles nombre, ya se han introducidos en algunos ejemplos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add rule filter INPUT tcp dport <span class="o">{</span>http, https<span class="o">}</span> accept
</pre></div>
</div>
<p>este, por ejemplo, es un conjunto anónimimo que almacena dos puertos: el
<strong>80</strong> y el <strong>443</strong>. El conjunto se ha creado así y así permanecerá mientras
exista la regla.</p>
</li>
<li><p><strong>Nominados</strong>, que se asocian a tablas y pueden usarse en las reglas. Estos
conjuntos implementan las posibilidades de <a class="reference internal" href="../01.iptables/03.ext.html#ipset"><span class="std std-ref">ipset</span></a> en
<strong class="command">iptables</strong>. A ellos dedicaremos el epígrafe.</p></li>
</ul>
<p>Los <em>conjuntos nominados</em> se crean asociándole una tabla, dotándolos de un
nombre y declarando qué tipo de dato contendrán. Por ejemplo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add table filter
<span class="gp">#</span> nft add <span class="nb">set</span> filter www <span class="o">{</span><span class="nb">type</span> inet_service<span class="se">\;</span><span class="o">}</span>
</pre></div>
</div>
<p>Por ahora nos hemos limitado a crear un conjunto llamado «www» que puede
contener puertos. Podría haber contenido también:</p>
<table class="nftables-set-type docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Tipo</p></th>
<th class="head"><p>Descripción</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ipv4_address</p></td>
<td><p>Direcciones <abbr title="Internet Protocol">IP</abbr>v4</p></td>
</tr>
<tr class="row-odd"><td><p>ipv6_address</p></td>
<td><p>Direcciones <abbr title="Internet Protocol">IP</abbr>v6</p></td>
</tr>
<tr class="row-even"><td><p>ether_address</p></td>
<td><p>Direcciones <abbr title="Media Access Control">MAC</abbr>.</p></td>
</tr>
<tr class="row-odd"><td><p>inet_proto</p></td>
<td><p>Protocolos</p></td>
</tr>
<tr class="row-even"><td><p>inet_service</p></td>
<td><p>Puertos de conexión.</p></td>
</tr>
<tr class="row-odd"><td><p>mark</p></td>
<td><p>Marcas.</p></td>
</tr>
<tr class="row-even"><td><p>ifname</p></td>
<td><p>Nombres de interfaces.</p></td>
</tr>
</tbody>
</table>
<p>Para usarlo basta anteponer una arroba al nombre:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add chain filter INPUT <span class="s2">&quot;{type filter hook input priority 0;}&quot;</span>
<span class="gp">#</span> nft add rule filter INPUT tcp dport @www counter
</pre></div>
</div>
<p>aunque aún no contiene ningún puerto. Además del tipo, pueden añadirse otras
características al crear el conjunto:</p>
<table class="nftables-set-caract docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 9%" />
<col style="width: 77%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Característica</p></th>
<th class="head"><p>Opción</p></th>
<th class="head"><p>Descripción</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>type</p></td>
<td colspan="2"><p>Tipo de los elementos que constituyen el conjunto.</p></td>
</tr>
<tr class="row-odd"><td><p>timeout</p></td>
<td colspan="2"><p>Tiempo de vida de los elementos que se añaden. Pasado éste, desaparecen automáticamente.
Implica que se puedan indicar tiempo de vida al añadir elementos.</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><p>elements</p></td>
<td colspan="2"><p>Añade los elementos de la lista al conjunto</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>nft add set filter hosts &quot;{type ipv4_addr; elements={1.1.1.1, 1.0.0.1};}&quot;</p></td>
</tr>
<tr class="row-even"><td rowspan="5"><p>flags</p></td>
<td><p>constant</p></td>
<td><p>El contenido del conjunto no puede cambiar mientras esté vinculado a alguna regla.</p></td>
</tr>
<tr class="row-odd"><td><p>dynamic</p></td>
<td><p>Crea conjuntos dinámicos, que añaden elementos directamente desde las reglas. Lo
trataremos en el <a class="reference internal" href="#nftables-meters"><span class="std std-ref">epígrafe dedicado a meters</span></a>.</p></td>
</tr>
<tr class="row-even"><td><p>interval</p></td>
<td><p>El conjunto contiene intervalos, no elementos individuales.</p></td>
</tr>
<tr class="row-odd"><td><p>timeout</p></td>
<td><p>Al añadir elementos, se puede indicar el tiempo de vida de cada elemento</p></td>
</tr>
<tr class="row-even"><td colspan="2"><div class="line-block">
<div class="line">nft add set filter hosts &quot;{type ipv4_addr; flags constant, timeout;}&quot;</div>
<div class="line">nft add element filter hosts {1.1.1.1 timeout 1m}</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>size</p></td>
<td colspan="2"><p>Cantidad máxima de elementos que puede contener el conjunto.</p></td>
</tr>
</tbody>
</table>
<p>Podemos añadir elementos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add element filter www <span class="o">{</span>http, https<span class="o">}</span>
<span class="gp">#</span> nft list <span class="nb">set</span> filter www
<span class="go">table ip filter {</span>
<span class="go">   set www {</span>
<span class="go">      type inet_service</span>
<span class="go">      elements = { http, https }</span>
<span class="go">   }</span>
<span class="go">}</span>
</pre></div>
</div>
<p>aunque también pueden añadirse automáticamente a través de las reglas. Por
ejemplo, así controlaríamos las máquinas que nos ha hecho <strong class="program">ping</strong> en la
última hora:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add <span class="nb">set</span> filter pines <span class="o">{</span><span class="nb">type</span> ipv4_addr<span class="p">;</span> timeout 1h<span class="p">;</span> size <span class="m">65535</span><span class="o">}</span>
<span class="gp">#</span> nft add rule filter INPUT icmp <span class="nb">type</span> echo-request add @pines <span class="o">{</span>ip saddr<span class="o">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Cuando se añaden elementos de este modo, es más que conveniente
fijar un tamaño máximo y un tiempo de vida del elemento en el conjunto.</p>
</div>
<p>Los conjuntos con nombre puede eliminarse:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft delete <span class="nb">set</span> filter www
</pre></div>
</div>
<p>siempre y cuando no estén vinculados a ninguna regla.</p>
</div>
<div class="section" id="concatenaciones">
<span id="nftables-concat"></span><h3><span class="section-number">8.7.3.2.4.2.2. </span>Concatenaciones<a class="headerlink" href="#concatenaciones" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Las <em class="dfn">concatenaciones</em> permiten agrupar selectores (o sea, condiciones) para
tratarlas de modo conjunto. Como operador se usa el punto («.»). Por ejemplo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add filter FORWARD ip saddr . ip daddr <span class="o">{</span><span class="m">10</span>.0.0.4 . <span class="m">10</span>.0.0.8, <span class="m">10</span>.0.0.5 . <span class="m">10</span>.0.0.10<span class="o">}</span> counter
</pre></div>
</div>
<p>En este caso, el selector vandŕa tanto para si la conexión es entre <em>10.0.0.4</em> y
<em>10.0.0.8</em> como si es entre <em>10.0.0.5</em> y <em>10.0.0.10</em>.</p>
<p>Esta es una expresión literal, pero podría haberse construido también un
conjunto nomimal concatenado los dos valores necesarios:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add <span class="nb">set</span> filter orig-dest <span class="o">{</span><span class="nb">type</span> ipv4_addr . ipv4_addr<span class="se">\;</span><span class="o">}</span>
<span class="gp">#</span> nft add element filter orig-dest <span class="o">{</span><span class="m">10</span>.0.0.4 . <span class="m">10</span>.0.0.8, <span class="m">10</span>.0.0.5 . <span class="m">10</span>.0.0.10<span class="o">}</span>
<span class="gp">#</span> nft add filter FORWARD ip saddr . ip daddr @orig-dest counter
</pre></div>
</div>
<p>También es posible concatenar las claves en los mapas y disccionarios.</p>
<div class="admonition seealso">
<p class="admonition-title">Ver también</p>
<p>Échele un vistazo al <a class="reference external" href="https://wiki.nftables.org/wiki-nftables/index.php/Concatenations">epigrafe de concatenaciones de la wiki de
nftables</a>.</p>
</div>
</div>
<div class="section" id="mapas">
<span id="nftables-maps"></span><h3><span class="section-number">8.7.3.2.4.2.3. </span>Mapas<a class="headerlink" href="#mapas" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Los <em class="dfn">mapas</em> son conjuntos de valores a los que se accede a través de una clave.
Como en el caso de los conjuntos:</p>
<ul class="simple">
<li><p>Pueden ser <strong>anónimos</strong> o <strong>nominados</strong>.</p></li>
<li><p>Pueden utilizarse en las sentencias de las reglas.</p></li>
<li><p>Puede modificarse su contenido manualmente.</p></li>
</ul>
<p>Y a diferencia de ellos, no pueden añadirse elementos a través de reglas. Para
utilizarlos debe hacerse lo siguiente:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dnat to tcp dport map {80: 192.168.1.100, 8888: 192.168.1.101}</span>
<span class="go">counter name tcp dport map @conn</span>
</pre></div>
</div>
<p>es decir, debe colocarse primero la expresión que define el valor y después la
expresión que define la clave. El primero es un ejemplo de mapa anónimo y el
segundo de mapa con nombre don se requiere hacer algunas definiciones previas:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add counter filter c22
<span class="gp">#</span> nft add counter filter c28
<span class="gp">#</span> nft add map filter conn <span class="o">{</span><span class="nb">type</span> inet_service: counter<span class="o">}</span>
<span class="gp">#</span> nft add element filter conn <span class="o">{</span>ssh: c22, http: c80<span class="o">}</span>
</pre></div>
</div>
<p>Y ahora sí, podria usarse el mapa:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add rule filter INPUT ct state new counter name tcp dport map @conn
</pre></div>
</div>
</div>
<div class="section" id="diccionarios">
<span id="nftables-vmap"></span><h3><span class="section-number">8.7.3.2.4.2.4. </span>Diccionarios<a class="headerlink" href="#diccionarios" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Los <em class="dfn">diccionarios</em> son mapas en que los valores son acciones terminalesi (excepto
<em>reject</em>). Por ejemplo, esta regla salta dependiendo del tipo de tráfico a una u
otra cadena de usuario:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add rule filter ct state new tcp port vmap <span class="o">{</span>ssh: jump SSH, ftp: jump FTP<span class="o">}</span>
</pre></div>
</div>
<p>También es posible hacer diccionarios nominados.</p>
</div>
<div class="section" id="conjuntos-dinamicos">
<span id="nftables-meters"></span><h3><span class="section-number">8.7.3.2.4.2.5. </span>Conjuntos dinámicos<a class="headerlink" href="#conjuntos-dinamicos" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Cuando en las reglas usamos <a class="reference internal" href="02.reglas.html#nftables-stateful-objects"><span class="std std-ref">objetos de inspección de estado</span></a>, en particular, <a class="reference internal" href="02.reglas.html#nftables-limit"><span class="std std-ref">caudales</span></a> y
<a class="reference internal" href="02.reglas.html#nftables-quota"><span class="std std-ref">cuotas</span></a>, como por ejemplo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add rule filter output tcp sport ssh quota over <span class="m">100</span> mbytes drop
</pre></div>
</div>
<p>el objeto (la cuota en este caso) se actualiza y se comprueba cada vez que se
hay tráfico de descarga que provocan nuestro clientes del servicio <abbr title="Security SHell">SSH</abbr>. Esta
cuota es general y, cualquier cliente que descargue algo, contribuirá a
aumentarla. En principio, si nuestra intención fuera establecer una cuota
individual por cliente, deberíamos incluir tantas regla distintas como clientes
tengamos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add rule filter output tcp sport ssh ip daddr <span class="m">1</span>.1.1.1 quota over <span class="m">10</span> mbytes drop
<span class="gp">#</span> nft add rule filter output tcp sport ssh ip daddr <span class="m">1</span>.1.1.2 quota over <span class="m">10</span> mbytes drop
<span class="gp">#</span> etc...
</pre></div>
</div>
<p>esto es inviable, pero los <em>conjuntos dinámicos</em> vienen a resolvernos la
papeleta. Un <em class="dfn">conjunto dinámico</em> es aquel conjunto que relaciona un
elemento con un objeto de inspección de estado, de manera que al actualizar
la presencia del objeto en el conjunto actualiza también su objeto
correspondiente.</p>
<p>Tienen dos formas de expresarse:</p>
<ul class="simple">
<li><p>Hasta la versión <em>0.9.0</em> (que es precisamente la que trae <em>Buster</em>) a través
de la palabra clave <kbd class="kbd docutils literal notranslate">meter</kbd>.</p></li>
<li><p>A partir de la <em>0.9.1</em> a través del <em>flag</em> <kbd class="kbd docutils literal notranslate">dynamic</kbd> al crear conjuntos.</p></li>
</ul>
<p>Aunque <kbd class="kbd docutils literal notranslate">meter</kbd> sigue existiendo, esta marcada como obsoleta por lo que
podría ocurrir que en el futuro desapareciera. Sea como sea, trataremos ambas
notaciones.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La comprobación de la <a class="reference internal" href="02.reglas.html#nftables-ctcount"><span class="std std-ref">cantidad de conexiones simultáneas</span></a> también es susceptible de usarse en conjuntos dinámicos.
De hecho, es la que se usará para <a class="reference internal" href="#nftables-connlimit"><span class="std std-ref">emular el módulo connlimit de
iptables</span></a>.</p>
</div>
<p class="rubric">dynamic</p>
<p>La nueva sintaxis es la que mejor ilustra el concepto que acabamos de explicar,
así que la expondremos antes. Definimos primero el conjunto:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add <span class="nb">set</span> filter sshquota <span class="s2">&quot;{type ipv4_addr; timeout 1h; flags dynamic; size 65535}&quot;</span>
</pre></div>
</div>
<p>para añadir después los elementos en la regla correspondiente. Con una política de <em>lista
blanca</em>, la regla quedaría así:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add filter OUTPUT tcp sport ssh add @sshquota <span class="o">{</span>ip saddr quota <span class="m">10</span> mbytes<span class="o">}</span> accept
</pre></div>
</div>
<p>Y si fuera de <em>lista negra</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add filter OUTPUT tcp sport ssh add @sshquota <span class="o">{</span>ip saddr quota over <span class="m">10</span> mbytes<span class="o">}</span> drop
</pre></div>
</div>
<p class="rubric">meter</p>
<p>La obsoleta sintaxis con <kbd class="kbd docutils literal notranslate">meter</kbd> no es excesivamente diferente, aunque no
defina explícitamente un conjunto. Con <em>lista blanca</em>, deberíamos hacer:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add filter OUTPUT tcp sport ssh <span class="se">\</span>
   meter sshquota size <span class="m">65535</span> <span class="o">{</span>ip saddr timeout 5s quota <span class="m">10</span> mbytes<span class="o">}</span> accept
</pre></div>
</div>
<p>Con <em>lista negra</em>, el equivalente será:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add filter OUTPUT tcp sport ssh <span class="se">\</span>
   meter sshquota size <span class="m">65535</span> <span class="o">{</span>ip saddr timeout 5s quota over <span class="m">10</span> mbytes<span class="o">}</span> drop
</pre></div>
</div>
<p>Em ambos casos, podremos consultar el contenido de «sshquota» con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft list meter filter sshquota
</pre></div>
</div>
<p>En conjunción con las concatenaciones los <em>conjuntos dinámicos</em> permiten la
implementación de las funcionalidades que ofrecen los módulos <a class="reference internal" href="../01.iptables/03.ext.html#iptables-limit"><span class="std std-ref">hashlimit y
connlimit</span></a> de <strong class="program">iptables</strong>.</p>
<div class="section" id="connlimit">
<span id="nftables-connlimit"></span><h4><span class="section-number">8.7.3.2.4.2.5.1. </span>connlimit<a class="headerlink" href="#connlimit" title="Enlazar permanentemente con este título">¶</a></h4>
<p>Dependiendo de cuáles sean las conexiones que queremos limitar, así tendremos
que obrar. Consideraremos una política de <em>lista blanca</em> en nuestro servidor:</p>
<dl>
<dt><strong>Conexiones totales de un servicio</strong></dt><dd><p>Para limitar el número máximo de conexiones simultáneas a un servicio (p.e.
un máximo de 5 conexiones a <abbr title="Security SHell">SSH</abbr>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add rule filter INPUT ct state new tcp dport ssh <span class="se">\</span>
   meter sshconn size <span class="m">65535</span> <span class="o">{</span>tcp dport ct count <span class="m">5</span><span class="o">}</span> accept
</pre></div>
</div>
</dd>
<dt><strong>Conexiones totales de un cliente</strong></dt><dd><p>Para limitar el número máximo de conexiones que un cliente puede hacer
a cualquier servicio:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add rule filter INPUT ct state new tcp dport ssh <span class="se">\</span>
   meter sshconn size <span class="m">65535</span> <span class="o">{</span>ip saddr ct count <span class="m">5</span><span class="o">}</span> accept
</pre></div>
</div>
</dd>
<dt><strong>Conexiones totales desde un cliente a un servicio</strong></dt><dd><p>Para limitar el número máximo de conexiones que un mismo cliente puede
hacer a un servicio:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add rule filter INPUT ct state new tcp dport ssh <span class="se">\</span>
   meter sshconn size <span class="m">65535</span> <span class="o">{</span>ip saddr . tcp dport ct count <span class="m">2</span><span class="o">}</span> accept
</pre></div>
</div>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Se usa <kbd class="kbd docutils literal notranslate">meter</kbd> por compacidad. A partir de los ejemplos, la
implementación con <em>dynamic</em> es trivial.</p>
</div>
</div>
<div class="section" id="hashlimit">
<span id="nftables-hashlimit"></span><h4><span class="section-number">8.7.3.2.4.2.5.2. </span>hashlimit<a class="headerlink" href="#hashlimit" title="Enlazar permanentemente con este título">¶</a></h4>
<p>El <a class="reference internal" href="../01.iptables/03.ext.html#iptables-limit"><span class="std std-ref">módulo hashlimit de iptables</span></a> permite limitar el
flujo de paquete según cuál sea el origen o destino de las conexión. A
diferencia de <em>limit</em>, que limita el flujo de paquetes global. Para implementar
esta funcionalidad en <strong class="program">nftables</strong> basta con utilizar <em>limit</em> en
conjunción con los conjuntos dinámicos y la concatenación. Por ejemplo, para
limitar la descarga a través de <abbr title="Security SHell">SSH</abbr> con cada cliente podemos hacer:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add rule filter OUTPUT tcp sport ssh <span class="se">\</span>
   meter sshlimit size <span class="m">65535</span> <span class="o">{</span>tcp sport . ip daddr timeout 10s limit rate over 100kbytes/second<span class="o">}</span> drop
</pre></div>
</div>
<p>que limitará a 100 KiB/s el tráfico de descarga para cada uno de los clientes.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p><strong class="program">nftables</strong> no tiene ningún equivalente exacto para el
<a class="reference internal" href="../01.iptables/03.ext.html#iptables-recent"><span class="std std-ref">modulo recent de iptables</span></a>, pero usar esta técnica se
aproxima mucho. Recordemos que <em>recent</em> permite comprobar si en un periodo de
tiempo determinado se ha accedido un determinado número de veces (p.e. haber
accedido más de 5 veces al servicio <abbr title="Security SHell">SSH</abbr> en el último minito). Aplicando
conjuntos dinámicos podríamos establecer un caudal límite de 5 conexiones por
minuto con una ráfaga de 5. No es exactamente lo mismo, porque si
inmediatamente consumimos las 5 conexiones, con <em>recent</em> deberíamos esperar
el minuto entero, mientras que aplicando el caudal límite no debemos esperar
el minuto completo, sino que a los veinte segundos ya podríamos establecer
una conexión más. Véase la aplicación de estas técnicas para evitar
<a class="reference internal" href="../../99.ataques/02.tecnicas/03.brute.html#nftables-bruta"><span class="std std-ref">ataques de fuerza bruta con nftables</span></a>.</p>
</div>
</div>
</div>
<div class="section" id="flowtables">
<span id="nftables-flowtables"></span><h3><span class="section-number">8.7.3.2.4.2.6. </span>flowtables<a class="headerlink" href="#flowtables" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Las <em class="dfn">flowtables</em> son un mecanismo para acelerar el paso de los paquetes
por la máquina haciendo que fluyan directamente entre la entrada (el enganche
<em>ingress</em>) y la interfaz de salida sin tener que atravesar todo los enganches
intermedios:</p>
<img alt="../../../_images/netfilter-flowtable.png" src="../../../_images/netfilter-flowtable.png" />
<p>Para lograrlo, el paquete que abre conexión sí debe realizar el camino habitual,
especificar que los paquetes utilizarán el atajo y, obviamente lograr alcanzar
su destino.</p>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Hasta la versión 0.8.0, los <a class="reference internal" href="#nftables-meters"><span class="std std-ref">conjuntos dinámicos</span></a> se denominaron <em>flowtables</em> y se usaba la palabra
<kbd class="kbd docutils literal notranslate">flowtable</kbd> en vez de <kbd class="kbd docutils literal notranslate">meter</kbd>. Pese a ello, son dos conceptos
absolutamente distintos: téngalo en cuenta si ve en internet algún ejemplo de
uso antiguo.</p>
</div>
<p>Para ilustrarlo supongamos que a través del cortafuegos deseamos alcanzar un
servidor <abbr title="Security SHell">SSH</abbr> que se encuentra en el otro extremo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">table ip filter {</span>
<span class="go">   flowtable sshpass {</span>
<span class="go">      hook ingress priority 0</span>
<span class="go">      devices = {eth0, eth1}</span>
<span class="go">   }</span>

<span class="go">   chain FORWARD {</span>
<span class="go">      type filter hook forward priority 0</span>
<span class="go">      policy drop</span>

<span class="go">      tcp dport ssh flow add @sshpass</span>
<span class="go">      tcp dport ssh counter accept</span>

<span class="go">   }</span>
<span class="go">}</span>
</pre></div>
</div>
<p>donde se ha supuesto que <em>eth0</em> y <em>eth1</em> son las interfaces del router. En la
cadena <em>FORWARD</em>, declaramos que queremos que el tráfico <abbr title="Security SHell">SSH</abbr> use «sshpass» y,
además, aceptamos el paquete para que llegue a su destino. Incluímos un contador
para comprobar que los siguientes paquetes de la conexión no lo aumentan, ya que
jamás pasan por la cadena. Si incluyeremas un contador para el tráfico de
réplica, veríamos que ocurre otro tanto.</p>
<p>La técnica también soporta <abbr title="Network Address Translation">NAT</abbr>, de modo que si el servidor se encontrara en
una red interna que el cortafuegos oculta haciendo enmascaramiento a la salida
de <em>eth0</em>, seguiríamos pudiendo acelerar la intermediación de los paquetes:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">table ip filter {</span>
<span class="go">   flowtable sshpass {</span>
<span class="go">      hook ingress priority 0</span>
<span class="go">      devices = { eth0, eth1 }</span>
<span class="go">   }</span>

<span class="go">   chain POSTROUTING {</span>
<span class="go">      type nat hook postrouting priority 100</span>

<span class="go">      oif &quot;eth0&quot; masquerade comment &quot;Ocultamos la red 192.168.255.0/24&quot;</span>
<span class="go">   }</span>

<span class="go">   chain PREROUTING {</span>
<span class="go">      type nat hook prerouting priority -100</span>

<span class="go">      iif &quot;eth0&quot; tcp dport 10022 dnat to 192.168.255.2:22 comment &quot;DNAT al servidor SSH&quot;</span>
<span class="go">   }</span>

<span class="go">   chain FORWARD {</span>
<span class="go">      type filter hook forward priority filter</span>
<span class="go">      policy drop</span>

<span class="go">      ct status dnat flow add @sshpass comment &quot;Aceleramos el tránsito hacia los servidores&quot;</span>
<span class="go">      ct status dnat accept</span>
<span class="go">   }</span>
<span class="go">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="zonas">
<span id="nftables-zones"></span><h2><span class="section-number">8.7.3.2.4.3. </span>Zonas<a class="headerlink" href="#zonas" title="Enlazar permanentemente con este título">¶</a></h2>
</div>
<div class="section" id="bridges">
<span id="nftables-bridge"></span><h2><span class="section-number">8.7.3.2.4.4. </span>Bridges<a class="headerlink" href="#bridges" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El tratamiento de las <a class="reference internal" href="../../03.bridge.html#bridge"><span class="std std-ref">interfaces bridge</span></a> se hace también con
<strong class="command">nft</strong>. Ahora bien, si se observa el <a class="reference internal" href="../index.html#netfilter-hooks"><span class="std std-ref">diagrama de flujo</span></a> (eliminando el flujo para tráfico <abbr title="Address Resolution Protocol">ARP</abbr>):</p>
<img alt="../../../_images/ebtables1.png" src="../../../_images/ebtables1.png" />
<p>se comprobará que el tráfico que circula entre dos puertos de un mismo <em>bridge</em>
no se ve afectado por las reglas que se escriban para los puntos de enganche del
resto de las familias (excepto <em>netdev</em>, claro está). Podemos ratificarlo si
para una máquina con dos interfaces en puente definimos estar reglas:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>table ip filter <span class="o">{</span>
   chain FORWARD <span class="o">{</span>
      <span class="nb">type</span> filter hook forward priority filter<span class="p">;</span>

      ip protocol icmp counter
   <span class="o">}</span>
<span class="o">}</span>

table bridge filter <span class="o">{</span>
   chain FORWARD <span class="o">{</span>
      <span class="nb">type</span> filter hook forward priority filter<span class="p">;</span>

      ip protocol icmp counter
      iif eth0 ip protocol icmp counter
   <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Al enviar un paquete <abbr title="Internet Control Message Protocol">ICMP</abbr> desde una máquina conectada en un extremo a otra
colocada en el otro extremo, el contador de la tabla de la familia <em>ip</em> no
detectará ningún paquete, mientras que los contadores de la familia <em>bridge</em>,
sí.</p>
<p>Otro aspecto a tener en cuenta es que en las reglas que se encuentren en cadenas
de la familia <em>bridge</em> las interfaces serán los puertos del puente, es decir, si
se pretende establecer una condición con <kbd class="kbd docutils literal notranslate">iif</kbd> la interfaz que deberá
proporcionarse será aquel puerto físico del puente por el que entró el paquete
(p.e. <em>eth0</em>). Sin embargo, si ese mismo paquete, estaba destinado para la propia
máquina que hace de puente y, en consecuencia, atraviesa enganches de la familia
<em>ip</em> (en concreto <em>prerouting</em> e <em>înput</em>) en las cadenas asociadas a tales
enganches, la interfaz de entrada no será el puerto físico, sino la interfaz
virtual <em>bridge</em>. Por tanto, la condición con <kbd class="kbd docutils literal notranslate">iif</kbd> deberá hacerse con
<em>br0</em> (o comoquiera que se llame la interfaz).</p>
<p>Finalmente, si nuestra intención es forzar a que los paquetes sean encaminados,
no conmutados, la estrategia con <strong class="command">nftables</strong> es alterar en el paquete la
<abbr title="Media Access Control">MAC</abbr> de destino para que coincida con la de la interfaz <em>bridge</em>, obviamente
antes de que <strong class="program">netfilter</strong> lleve a cabo la comprobación para dirigir el
paquete hacia en enganche <em>forward</em> de la familia <em>bridge</em>. Así pues, si nuestra
intención fuera encaminar siempre el tráfico <abbr title="Internet Control Message Protocol">ICMP</abbr> que entra por el puerto
<em>eth0</em>, podríamos hacer:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>table bridge filter <span class="o">{</span>
   chain PREROUTING <span class="o">{</span>
      <span class="nb">type</span> filter hook prerouting priority dstnat

      iif eth0 icmp <span class="nb">type</span> echo-request ether daddr <span class="nb">set</span> de:ad:be:ef:27:d4 <span class="se">\</span>
                                      meta pkttype <span class="nb">set</span> unicast <span class="se">\</span>
                                      meta mark <span class="nb">set</span> 0x1
   <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>suponiendo que <em>de:ad:be:ef:27:d4</em> sea la <abbr title="Media Access Control">MAC</abbr> de nuestra interfaz puente.
Hemos aprovechado, además, para marcar tales paquetes por si más adelante
necesitamos hacer referencia a tales paquetes.</p>
<p>Sí, además, tuviéramos intención de apropiarnos del paquete podríamos
redirigirlo:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>table ip nat <span class="o">{</span>
   chain PREROUTING <span class="o">{</span>
      <span class="nb">type</span> nat hook prerouting priority dstnat
      meta mark <span class="m">1</span> redirect
   <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>A fecha de redacción<a class="footnote-reference brackets" href="#id2" id="id1">1</a>, no hay soporte aún para manipular el
tráfico <abbr title="Address Resolution Protocol">ARP</abbr> que accede por un <a class="reference internal" href="../../03.bridge.html#bridge"><span class="std std-ref">bridge</span></a> (<kbd class="kbd docutils literal notranslate">arpreply</kbd>).
Véase <a class="reference external" href="https://wiki.nftables.org/wiki-nftables/index.php/Supported_features_compared_to_xtables#arpreply">esta referencia</a>.</p>
</div>
</div>
<div class="section" id="trafico-arp">
<span id="nftables-arp"></span><h2><span class="section-number">8.7.3.2.4.5. </span>Tráfico <abbr title="Address Resolution Protocol">ARP</abbr><a class="headerlink" href="#trafico-arp" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Lo que podemos hacer con este tráfico es, básicamente, dejar de responder a
peticiones <abbr title="Address Resolution Protocol">ARP</abbr> o evitar aceptar respuestas <abbr title="Address Resolution Protocol">ARP</abbr>.</p>
<img alt="../../../_images/arptables.png" src="../../../_images/arptables.png" />
<p>Son interesantes para este tráfico las siguientes condiciones:</p>
<table class="nftables-matches docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 21%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Criterio</p></th>
<th class="head"><p>Argumento</p></th>
<th class="head"><p>Descripción</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td rowspan="4"><p>arp</p></td>
<td rowspan="2"><div class="line-block">
<div class="line">ip daddr</div>
<div class="line">ip saddr</div>
</div>
</td>
<td><p><abbr title="Internet Protocol">IP</abbr> de origen o destino.</p></td>
</tr>
<tr class="row-odd"><td><p>arp ip saddr != 192.168.0.5</p></td>
</tr>
<tr class="row-even"><td rowspan="2"><div class="line-block">
<div class="line">ether daddr</div>
<div class="line">ether saddr</div>
</div>
</td>
<td><p><abbr title="Media Access Control">MAC</abbr> de origen o destino</p></td>
</tr>
<tr class="row-odd"><td><p>arp ether saddr ab:cd:ef:01:23</p></td>
</tr>
</tbody>
</table>
<p>Por ejemplo, si queremos forzar a que la máquina con <abbr title="Internet Protocol">IP</abbr> tenga el <abbr title="Media Access Control">MAC</abbr>
<em>2e:ee:c5:01:23:45</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> nft add table arp filter
<span class="gp">#</span> nft add chain arp filter INPUT
<span class="gp">#</span> nft add rule arp filter INPUT arp operation request <span class="se">\</span>
                                arp saddr ip <span class="m">192</span>.168.0.1 <span class="se">\</span>
                                arp saddr ether !<span class="o">=</span> 2e:ee:c5:01:23:45 counter drop
</pre></div>
</div>
<p class="rubric">Notas al pie</p>
<dl class="footnote brackets">
<dt class="label" id="id2"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Febrero de 2020</p>
</dd>
</dl>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../index.html">Tabla de contenido</a></h3>
  <ul>
<li><a class="reference internal" href="#">8.7.3.2.4. Uso avanzado</a><ul>
<li><a class="reference internal" href="#marcas">8.7.3.2.4.1. Marcas</a></li>
<li><a class="reference internal" href="#colecciones">8.7.3.2.4.2. Colecciones</a><ul>
<li><a class="reference internal" href="#conjuntos">8.7.3.2.4.2.1. Conjuntos</a></li>
<li><a class="reference internal" href="#concatenaciones">8.7.3.2.4.2.2. Concatenaciones</a></li>
<li><a class="reference internal" href="#mapas">8.7.3.2.4.2.3. Mapas</a></li>
<li><a class="reference internal" href="#diccionarios">8.7.3.2.4.2.4. Diccionarios</a></li>
<li><a class="reference internal" href="#conjuntos-dinamicos">8.7.3.2.4.2.5. Conjuntos dinámicos</a><ul>
<li><a class="reference internal" href="#connlimit">8.7.3.2.4.2.5.1. connlimit</a></li>
<li><a class="reference internal" href="#hashlimit">8.7.3.2.4.2.5.2. hashlimit</a></li>
</ul>
</li>
<li><a class="reference internal" href="#flowtables">8.7.3.2.4.2.6. flowtables</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zonas">8.7.3.2.4.3. Zonas</a></li>
<li><a class="reference internal" href="#bridges">8.7.3.2.4.4. Bridges</a></li>
<li><a class="reference internal" href="#trafico-arp">8.7.3.2.4.5. Tráfico <abbr title="Address Resolution Protocol">ARP</abbr></a></li>
</ul>
</li>
</ul>

  <h4>Tema anterior</h4>
  <p class="topless"><a href="03.conn.html"
                        title="capítulo anterior"><span class="section-number">8.7.3.2.3. </span>Uso práctico</a></p>
  <h4>Próximo tema</h4>
  <p class="topless"><a href="../../08.qos/index.html"
                        title="próximo capítulo"><span class="section-number">8.8. </span>Calidad de servicio</a></p>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/08.redes/07.cortafuegos/02.nftables/04.ext.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Ir a" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="../../08.qos/index.html" title="8.8. Calidad de servicio"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="03.conn.html" title="8.7.3.2.3. Uso práctico"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" ><span class="section-number">8. </span>Conceptos avanzados de redes</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" ><span class="section-number">8.7. </span>Cortafuegos</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="index.html" ><span class="section-number">8.7.3.2. </span>nftables</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2020, José Miguel Sánchez Alés.
      Creado con <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.3.
    </div>
  </body>
</html>