


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="es">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>8.9.2.4. Ataques contra la autenticación &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Índice" href="../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../search.html" />
    <link rel="next" title="8.9.2.5. Ataques de modificación" href="04.mitm.html" />
    <link rel="prev" title="8.9.2.3. Envenamiento ARP" href="02.arp.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="04.mitm.html" title="8.9.2.5. Ataques de modificación"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="02.arp.html" title="8.9.2.3. Envenamiento ARP"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >8. Conceptos avanzados de redes</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" >8.9. Ataques</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="index.html" accesskey="U">8.9.2. Técnicas</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ataques-contra-la-autenticacion">
<h1>8.9.2.4. Ataques contra la autenticación<a class="headerlink" href="#ataques-contra-la-autenticacion" title="Enlazar permanentemente con este título">¶</a></h1>
<p>Uno de los tipos de ataques más socorridos son aquellos destinados a la
obtención de una clave acceso a un sistema, que hemos denominado aquí
<em class="dfn">ataques contra la autenticación</em>. De entre ellos, podemos distinguir:</p>
<ol class="arabic simple">
<li>El <em class="dfn">ataque de fuerza bruta</em>, que se basa en la obtención de una clave
mediante la prueba masiva de todas las combinaciones posibles. En la práctica
se suelen limitar las combinaciones posibles restringiendo los caracteres
posibles o la longitud mínima o máxima de la clave.</li>
<li>El <em class="dfn">ataque de diccionario</em>, que consiste en reducir las pruebas a las
palabras que se encuentran en un diccionario de palabras o a una variación
sobre las mismas.</li>
<li>El <em class="dfn">ataque por deducción</em> que consiste en intentar obtener la contraseña
deduciéndola a partir de la información personal que se tiene del usuario
(por ejemplo, la información <em>GECOS</em> o el propio nombre de cuenta).</li>
<li>El <em class="dfn">ataque por ingeniería social</em> que consiste en engañar al usuario
para que el mismo sea el que proporcione las claves de acceso. Un
<a class="reference internal" href="01.dns.html#dns-spoofing"><span class="std std-ref">envenenamiento DNS</span></a> o un <a class="reference internal" href="02.arp.html#arp-spoofing"><span class="std std-ref">envenamuiento ARP</span></a> pueden ser parte de un ataque de este tipo.</li>
</ol>
<p>Estudiaremos en este apartado los tres primeros tipos.</p>
<div class="section" id="metodos">
<h2>8.9.2.4.1. Métodos<a class="headerlink" href="#metodos" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Para poner en práctica un ataque de estas características debemos distinguir
entre:</p>
<dl class="docutils">
<dt>Ataque <strong>local</strong></dt>
<dd><p class="first">En este caso disponemos del fichero con la clave ofuscada (mediante una
<a class="reference internal" href="../../../09.apendice/01.cryto/02.algo.html#hash"><span class="std std-ref">función de hash</span></a> generalmente) y el propósito es llegar a
conocer cuál es la clave sin ofuscar. La <em>suite</em> más socorrida para esta
tarea es <a class="reference external" href="https://www.openwall.com/john/">john the ripper</a>, aunque existen otras como <a class="reference external" href="https://hashcat.net/hashcat/">hashcat</a>.</p>
<p class="last">Obsérvese que el ataque no se denomina <em>local</em> porque se realice contra la
propia máquina, sino porque se dispone del fichero de contraseñas (p.e.
porque se haya robado de un servidor) y el <em>software</em> de averiguación actúa
sobre el propio fichero sin necesidad de hacer uso de ningún sistema de
autenticación.</p>
</dd>
<dt>Ataque <strong>remoto</strong></dt>
<dd>Que consiste en la averiguación de la clave intentando autenticaciones
sucesivas sobre el servicio remoto, muy comúnmente <abbr title="Security SHell">SSH</abbr> o <abbr title="Simple Mail Transfer Protocol">SMTP</abbr>. Para esta
tarea podemos usar una aplicación como <a class="reference external" href="https://github.com/vanhauser-thc/thc-hydra">THC-Hydra</a>.</dd>
</dl>
<p>Echaremos un vistazo a cómo se realizan estos ataques para conocer las ténicas y
ponen en práctica más eficazmente las contramedidas adecuadas.</p>
<div class="section" id="john-the-ripper">
<span id="john"></span><h3>8.9.2.4.1.1. John the Ripper<a class="headerlink" href="#john-the-ripper" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Hay paquete en <em>debian</em> para su instalación:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> apt install john
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Advertencia</p>
<p><a class="reference external" href="https://www.openwall.com/john/">John the Ripper</a> tiene dos versiones: la oficial que es la
incluida en la distribución y la <a class="reference external" href="https://github.com/magnumripper/JohnTheRipper">versión Jumbo</a>, con ampliaciones de su
comunidad de usuarios y que tiene algunos añadidos bastantes interesantes.
Para no complicarnos usaremos la versión oficial incluida en el repositorio
oficial de <em>debian</em>. No obstante, puede instalarse la versión de la comunidad
usando los repositorios de <a class="reference external" href="https://www.kali.org/">Kali</a>:</p>
<div class="last highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> cat &gt; /etc/apt/sources.list.d/kali.list
<span class="go">deb http://http.kali.org/kali kali-rolling main contrib non-free</span>
<span class="gp">#</span> cat &gt; /etc/apt/preferences.d/kali
<span class="go">Explanation: Paquetes de auditoría procedentes de Kali Linux</span>
<span class="go">Package: *</span>
<span class="go">Pin: release o=Kali</span>
<span class="go">Pin-Priority: 50</span>
<span class="gp">#</span> apt update
<span class="gp">#</span> apt install -t <span class="nv">o</span><span class="o">=</span>kali john
</pre></div>
</div>
</div>
<p>Además, generaremos un fichero de contraseñas para nuestras pruebas con cuatro
usuarios:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cat &lt;&lt;EOF &gt; passwords.txt
<span class="go">tester1:$(openssl passwd -1 -salt a secreta)</span>
<span class="go">tester2:$(openssl passwd -1 -salt a Secreta2.)</span>
<span class="go">tester3:$(openssl passwd -1 -salt a tester3)</span>
<span class="go">tester4:$(openssl passwd -1 -salt a Tester4)</span>
<span class="go">tester5:$(openssl passwd -1 -salt a 1234)</span>
<span class="go">EOF</span>
</pre></div>
</div>
<p>El programa tiene <a class="reference external" href="https://www.openwall.com/john/doc/MODES.shtml">cuatro modos</a> de funcionamiento:</p>
<dl class="docutils">
<dt><strong>single</strong> (ataque <em>por deducción</em>)</dt>
<dd><p class="first">Toma el nombre de usuario y la información <em>GECOS</em> como base para intentar
averiguar la contraseña. A esta información aplicará las reglas de
transformación listadas en la sección <code class="docutils literal notranslate"><span class="pre">[List.Rules:Single]</span></code> del fichero de
configuración (en principio, <code class="file docutils literal notranslate"><span class="pre">/etc/john/john.conf</span></code>).</p>
<p class="last">En nuestro fichero de contreseñas no disponemos de la información <em>GECOS</em><a class="footnote-reference" href="#id9" id="id1">[1]</a>, así que sólo será posible usar el nombre de usuario. Es bastante
evidente que con este modo podremos obtener las contraseñas de usuarios
<em>tester3</em> y <em>tester4</em>.</p>
</dd>
<dt><strong>wordlist</strong> (ataque <em>de diccionario</em>)</dt>
<dd><p class="first">Realiza un ataque con el diccionario que proporcionemos. A las palabras del
diccionario podremos aplicarles transformaciones (añadir números, signos de
puntuación, etc.) a fin de mejorar la efectividad. Estas reglas de
transformación se listan en la sección <code class="docutils literal notranslate"><span class="pre">[List.Rules:Wordlist]</span></code> del ficheron
de configuración.</p>
<p>Con un diccionario de palabras castellanas podríamos obtener las contraseñas
de los otros dos usuarios.</p>
<div class="last admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Las dos técnicas <strong>single</strong> y <strong>wordlist</strong> comparten la sintaxis
para definbir las reglas de transformación. De hecho, podríamos considerar
el ataque <strong>single</strong> como un ataque de diccionario en que, para cada
usuario, el diccionario está compuesto únicamente por el nombre de usuario
(y la información gecos si la hay).</p>
</div>
</dd>
<dt><strong>incremental</strong> (ataque <em>de fuerza bruta</em>)</dt>
<dd>Realiza un ataque de fuerza bruta en sí, aunque estableciendo una serie de
reglas (caracteres válidos, longitud mínima, longitud máxima). Podríamos
intentar este último ataque para averiguar la contraseña de <em>tester5</em>.</dd>
<dt><strong>external</strong> (estilo &quot;libre&quot;)</dt>
<dd>Utiliza para la generación de palabras una función escrita en un subconjunto
del lenguaje <strong>C</strong>.</dd>
</dl>
<p>Empecemos por aplicar el ataque <em>single</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> john -single passwords.txt
<span class="go">Created directory: /root/.john</span>
<span class="go">Loaded 5 password hashes with 2 different salts (md5crypt [MD5 32/64 X2])</span>
<span class="go">Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status</span>
<span class="go">tester3          (tester3)</span>
<span class="go">Tester4          (tester4)</span>
<span class="go">2g 0:00:00:00 100% 4.651g/s 5869p/s 5874c/s 9797C/s tester51901..tester51900</span>
<span class="go">Use the &quot;--show&quot; option to display all of the cracked passwords reliably</span>
<span class="go">Session completed</span>
<span class="gp">$</span> john -show passwords.txt
<span class="go">tester3:tester3</span>
<span class="go">tester4:Tester4</span>

<span class="go">2 password hashes cracked, 3 left</span>
</pre></div>
</div>
<p>Bien, hemos logrado averiguar 2 de las 5 contraseñas: aquellas que eran muy
semejantes al nombre de usuario. Pasemos a realizar un ataque de diccionario<a class="footnote-reference" href="#id10" id="id2">[2]</a> y, de paso, hagamos trampa ya que conocemos de antemano las contraseñas.
Por un lado restringamos mucho el diccionario a unas pocas palabras:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> grep secret /usr/share/dict/spanish &gt;&gt; /tmp/words.list
</pre></div>
</div>
<p>y, por otro, apliquemos unas reglas de transformación bastante simplificadas.
El modo de crear estas reglas diferenciados, depende de si usamos la versión
oficial o la <em>Jumbo</em>:</p>
<dl class="docutils">
<dt><strong>Versión oficial</strong></dt>
<dd><p class="first">Las reglas se encuentran definidas en la sección <code class="docutils literal notranslate"><span class="pre">[List.Rules:Wordlist]</span></code>
y no hay forma de definir reglas con otro nombre distinto y aplicarlas. Lo
más limpio, en este caso, es crear un fichero alternativo de configuración:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cat &gt; ~/.john/john.conf
<span class="go">[List.Rules:Wordlist]</span>
<span class="go">:</span>
<span class="go">cAz&quot;[0-9][.#_\-]&quot;</span>
</pre></div>
</div>
<p>en que se define esta sólo regla.</p>
<div class="admonition warning">
<p class="first admonition-title">Advertencia</p>
<p class="last">Hecho esto, <strong class="program">john</strong> dejará de leer el fichero original
<code class="file docutils literal notranslate"><span class="pre">/etc/john/john.conf</span></code>, por lo que al acabar este tipo de ataque
deberíamos borrar el fichero creado o moverlo a otra ubicación</p>
</div>
<p>Las reglas de transformación posibilidad que para cada palabra, se pruebe:</p>
<ul class="simple">
<li>La palabra sin transformar.</li>
<li>La palabra con la primera en mayúscula (<em>c</em>) y la adición al final (<em>Az</em>) de
una cadena compuesta por un número cualquiera y un signo.</li>
</ul>
<p>Ahora podemos practicar el ataque de diccionario:</p>
<div class="last highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> john -wordlist:/tmp/words.list -rules passwords.txt
<span class="go">Loaded 5 password hashes with 2 different salts (md5crypt [MD5 32/64 X2])</span>
<span class="go">Remaining 3 password hashes with 2 different salts</span>
<span class="go">Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status</span>
<span class="go">secreta          (tester1)</span>
<span class="go">Secreta2.        (tester2)</span>
<span class="go">2g 0:00:00:00 100% 5.405g/s 2216p/s 2708c/s 2713C/s</span>
<span class="go">Vicesecretaría..Vicesecretario9</span>
<span class="go">Use the &quot;--show&quot; option to display all of the cracked passwords reliably</span>
<span class="go">Session completed</span>
<span class="gp">$</span> john -show passwords.txt
<span class="go">tester1:secreta</span>
<span class="go">tester2:Secreta2.</span>
<span class="go">tester3:tester3</span>
<span class="go">tester4:Tester4</span>

<span class="go">4 password hashes cracked, 1 left</span>
</pre></div>
</div>
</dd>
<dt><strong>Versión Jumbo</strong></dt>
<dd><p class="first">En esta versión sí podemos crear nuevas secciones con otras reglas y
aplicarlas. Para ello, lo más conveniente es añadir un <code class="code docutils literal notranslate"><span class="pre">.include</span></code> al
fichero de configuración para que podamos añadir nuestras reglas personales
aparte:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> cat &gt;&gt; /etc/john/john.conf

<span class="go">.include &quot;~/.john/john-local.conf&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Deje una línea en blanco antes y detrás del <code class="code docutils literal notranslate"><span class="pre">.include</span></code></p>
</div>
<p>Hecho lo cual podemos hacer nuestros añadidos en tal fichero:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> cat &gt; ~/.john/john-local.conf
<span class="go">[List.Rules:MisReglas]</span>
<span class="go">:</span>
<span class="go">cAz&quot;[0-9][.#_\-]&quot;</span>
</pre></div>
</div>
<p>que podemos comprobar que están disponibles obteniendo la lista completa de
reglas:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> john -list<span class="o">=</span>rules <span class="p">|</span> grep -i MisR
<span class="go">misreglas</span>
</pre></div>
</div>
<p>En este caso, el ataque se hace exactamente igual que en la versión oficial,
pero indicando qué conjunto de reglas quieren aplicarse:</p>
<div class="last highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> john -wordlist:/tmp/words.list -rules:misreglas passwords.txt
</pre></div>
</div>
</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p>Tanto para este tipo de ataque como para el siguiente, en el que se
generan automáticamente contraseñas, podemos comprobar cuáles son las
generadas añadiendo la opción <code class="docutils literal notranslate"><span class="pre">-stdout</span></code> y eliminando el fichero objetivo:</p>
<div class="last highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> john -wordlist:/tmp/words.list -rules -stdout
<span class="gp">$</span> john -incremental:Digits -stdout
</pre></div>
</div>
</div>
<p>Por último, ilustraremos un ataque incremental usando digitos como caracteres
válidos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cat &gt;&gt; ~/.john/john.conf

<span class="go">[Incremental:Digits]</span>
<span class="go">File = $JOHN/digits.chr</span>
<span class="go">MinLen = 3</span>
<span class="go">MaxLen = 10</span>
<span class="go">CharCount = 10</span>
</pre></div>
</div>
<p>En realidad, esta definición (aunque con distinto mínimo y máximo) ya está hecha
en el fichero de configuración <code class="file docutils literal notranslate"><span class="pre">/etc/john.john.conf</span></code>, pero establecerla
nosotros mismos en nuestro fichero de configuración nos permite echar un vistazo
a como se construyen estos ataques de fuerza bruta. Además, de no obrar así,
deberiamos deshacernos de <code class="file docutils literal notranslate"><span class="pre">~/.john/john.conf</span></code> ya que su existencia, anula
la lectura del fichero general. Aplicando este ataque incremental:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> john -incremental:Digits passwords.txt
<span class="go">Loaded 5 password hashes with 2 different salts (md5crypt [MD5 32/64 X2])</span>
<span class="go">Remaining 1 password hash</span>
<span class="go">Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status</span>
<span class="go">1234             (tester5)</span>
<span class="go">1g 0:00:00:00 5.000g/s 1340p/s 1340c/s 1340C/s 1234..123321</span>
<span class="go">Use the &quot;--show&quot; option to display all of the cracked passwords reliably</span>
<span class="go">Session completed</span>
<span class="gp">$</span> john -show passwords.txt
<span class="go">tester1:secreta</span>
<span class="go">tester2:Secreta2.</span>
<span class="go">tester3:tester3</span>
<span class="go">tester4:Tester4</span>
<span class="go">tester5:1234</span>

<span class="go">5 password hashes cracked, 0 left</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Con la <a class="reference external" href="https://github.com/magnumripper/JohnTheRipper">versión Jumbo</a>, el <em>software</em> también es capaz de <a class="reference external" href="https://bytesoverbombs.io/cracking-everything-with-john-the-ripper-d434f0f6dc1c#ba66">atacar
contraseñas de ficheros rar</a>
o claves simétricas de <a class="reference external" href="https://bytesoverbombs.io/cracking-everything-with-john-the-ripper-d434f0f6dc1c#59e5">claves SSH</a>
o <a class="reference external" href="https://www.busindre.com/fuerza_bruta_a_llaves_privadas_pem_ssh_https#john_the_ripper">certificados en formato PEM</a>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last"><a class="reference external" href="https://www.openwall.com/john/">John the Ripper</a> puede usarse como herramienta para comprobar la
robustez de las contraseñas de nuestros usuarios y enviar un mensaje de
correo a aquellos usuarios de los que hayamos sido capaces de averiguar la
contraseña. Para ello la <em>suite</em> trae un <em>script</em> llamado <strong class="command">mailer</strong>
que automatiza la tarea.</p>
</div>
</div>
<div class="section" id="thc-hydra">
<span id="hydra"></span><h3>8.9.2.4.1.2. THC-Hydra<a class="headerlink" href="#thc-hydra" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Cuando no se dispone del fichero de contraseñas, es obvio que el único modo de
averiguar una, es intentado repetidamente la autenticación hasta dar con una
pareja usuario/contraseña que permita el acceso. <a class="reference external" href="https://github.com/vanhauser-thc/thc-hydra">THC-Hydra</a> permite automatizar
los intentos de acceso a <a class="reference external" href="https://github.com/vanhauser-thc/thc-hydra/blob/master/README.md">distintos tipos de servidores</a> (entre
ellos <abbr title="File Transfer Protocol">FTP</abbr>, <abbr title="Internet Message Access Protocol">IMAP</abbr>, <em>MySQL</em>, <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> o <abbr title="Security SHell">SSH</abbr>).</p>
<p>A diferencia del caso anterior, el objetivo no es sólo averiguar contraseñas,
sino también usuarios, por lo que el programa permite tanto facilitar el usuario
como la contraseña. Por ello:</p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">-l</span> <span class="pre">&lt;usuario&gt;</span></code></dt>
<dd>Permite facilitar el nombre de usuario.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">-L</span> <span class="pre">&lt;fichero&gt;</span></code></dt>
<dd>Permite facilitar la lista de usuarios expresada en el fichero indicado (un
usuario por línea).</dd>
<dt><code class="docutils literal notranslate"><span class="pre">-p</span> <span class="pre">&lt;contraseña&gt;</span></code></dt>
<dd>Permite facilitar una contraseña.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">-P</span> <span class="pre">&lt;fichero&gt;</span></code></dt>
<dd>Permite facilitar la lista de contraseñas expresada en el fichero indicado (una
contraseña por línea).</dd>
<dt><code class="docutils literal notranslate"><span class="pre">-C</span> <span class="pre">&lt;fichero&gt;</span></code></dt>
<dd>Permite facilitar la lista de tuplas usuario/contraseña expresada en el
fichero indicado (cada línea debe ser de la forma
<code class="code docutils literal notranslate"><span class="pre">usuario:contraseña</span></code>).</dd>
<dt><code class="docutils literal notranslate"><span class="pre">-x</span> <span class="pre">&lt;min:max:charset&gt;</span></code></dt>
<dd>Genera todas las combinaciones posibles entre una longitud mínima y una
longitud máxima de los caracteres definidos con <em>charset</em>. En la definición
del <em>charset</em> «1» representan digitos, «a» letras minúsculas, «A» letras
mayúsculas y cualquier otro caracter debe expresarse explícitamente. Por
tanto, <code class="code docutils literal notranslate"><span class="pre">-x</span> <span class="pre">'4:8:a1.-'</span></code> generará todas las claves posibles de entre 4 y
8 caracteres que contengan letras minúsculas, números, puntos y guiones.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">-e</span> <span class="pre">&lt;nsr&gt;</span></code></dt>
<dd>Permite añadir a las pruebas de contraseña que provequen <code class="docutils literal notranslate"><span class="pre">-p</span></code>, <code class="docutils literal notranslate"><span class="pre">-P</span></code> o
<code class="docutils literal notranslate"><span class="pre">-x</span></code>, la contraseña nula (<em>n</em>), la contraseña que coincida con el <em>login</em>
(<em>s</em>) y la contraseña que sea el <em>login</em> puesto del revés (<em>r</em>). Así, por
ejemplo, <code class="code docutils literal notranslate"><span class="pre">-e</span> <span class="pre">ns</span></code> probaría como contraseña la vacía y el <em>login</em>.</dd>
</dl>
<p>Así pues, <code class="docutils literal notranslate"><span class="pre">-p</span></code>, <code class="docutils literal notranslate"><span class="pre">-P</span></code> y <code class="docutils literal notranslate"><span class="pre">-C</span></code> nos permiten realizar ataques de diccionario y
<code class="docutils literal notranslate"><span class="pre">-x</span></code> ataques de fuerza bruta con restricciones (equivalentes a los
incrementales de <a class="reference internal" href="#john"><span class="std std-ref">john</span></a>).</p>
<p>Si se facilitan varios usuarios y varias contraseñas se probarán todas las
combinaciones posibles, de modo que para el primer usuarios se prueban todas las
contraseñas, para el segundo, todas; y así sucesivamente. Si quiere hacerse la
combinación de manera que para la primera contraseña se prueben todos los
usuarios, para la segunda, todos, etc. puede añadirse la opción <code class="docutils literal notranslate"><span class="pre">-u</span></code>.</p>
<p>Otras opciones de interés son:</p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">-f</span></code></dt>
<dd>Abandona el ataque cuando se consigue obtener la primera pareja
usuario/contraseña.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">-t</span> <span class="pre">N</span></code></dt>
<dd>Fija el número de intentos simultáneos que, por defecto, es <strong>16</strong>.</dd>
</dl>
<p>Con estos mimbres es fácil hacer un ataque:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> hydra -l usuario -P /tmp/passwords.txt -e nsr -t <span class="m">4</span> -vV VICTIMA ssh
</pre></div>
</div>
<p>o si se prefiere:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> hydra -l usuario -P /tmp/passwords.txt -e nsr -t <span class="m">4</span> -vV ssh::/VICTIMA
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p>¿Hay alguna manera de tomar un diccionario y probar no sólo las
palabras que contiene, sino también otras contraseñas generadas a partir de
esas palabras? Algo así a lo que hace <a class="reference internal" href="#john"><span class="std std-ref">john</span></a> al añadir
<code class="docutils literal notranslate"><span class="pre">-rules</span></code>. Desgraciadamente, no. O no al menos exclusivamente con
<strong class="program">hydra</strong>. Sí podemos, sin embargo, generar las transformaciones con
<strong class="program">john</strong> y su opción <code class="docutils literal notranslate"><span class="pre">-stdout</span></code> y el diccionario resultante pasárselo
a <strong class="program">hydra</strong>, haciendo uso de una tubería:</p>
<div class="last highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> john -wordlist:/tmp/words.list -rules -stdout <span class="p">|</span> hydra -l usuario -P /dev/fd/0 -e nsr -t <span class="m">4</span> -vV ssh::/VICTIMA
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="contramedidas">
<span id="contra-bruta"></span><h2>8.9.2.4.2. Contramedidas<a class="headerlink" href="#contramedidas" title="Enlazar permanentemente con este título">¶</a></h2>
<p>De los métodos de ataque anteriores, debemos de entresacar dos enseñanzas:</p>
<ul>
<li><p class="first">Hemos de evitar el robo de ficheros de contraseñas, aunque éstas estén
ofuscadas, ya que existen herramientas como <a class="reference internal" href="#john"><span class="std std-ref">john</span></a> para intentar
averiguarlas.</p>
</li>
<li><p class="first">Deben evitarse los nombres de usuarios que por defecto nos sugieran las
aplicaciones, porque son esos usuarios los que suelen probarse con
herramientas como <a class="reference internal" href="#hydra"><span class="std std-ref">hydra</span></a>.</p>
</li>
<li><p class="first">Hemos de defender los servicios accesibles de ataques automatizados como los
realizados por <a class="reference internal" href="#hydra"><span class="std std-ref">hydra</span></a>. Enfocaremos esta sección en ver cómo
hacerlo mediante dos alternativas:</p>
<ol class="arabic">
<li><p class="first">Ocultamiento del servicio mediante <em>port-knocking</em>, de manera que el
servicio será accesible sólo si previamente se ha dado el «santo y seña».</p>
</li>
<li><p class="first">Veto al acceso para aquellas máquinas cuya actividad las vuelva
sospechosas de estar intentando un ataque contra la autenticación. Para
practicar este veto, <em>linux</em> provee dos mecanismos:</p>
<dl class="docutils">
<dt><strong>hosts.deny</strong></dt>
<dd><p class="first">Toda dirección <abbr title="Internet Protocol">IP</abbr> listada en <code class="file docutils literal notranslate"><span class="pre">/etc/hosts.deny</span></code> no podrá acceder
a ningún servicio que use <cite>TCP Wrappers
&lt;https://es.wikipedia.org/wiki/TCP_Wrapper&gt;</cite>. El mecanismo es poco
versátil, porque se denegará el acceso a todos los servicios que lo
usen y no a algunos individuales, y porque los servicios ajenos al
mecanismo no se verá afectados en ningún caso. Para conocerse si un
servicio usa este mecanismo basta con comprobar si el ejecutable enlaza
con la librería <code class="file docutils literal notranslate"><span class="pre">libwrap.so</span></code>:</p>
<div class="last highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ldd /usr/sbin/sshd <span class="p">|</span> grep -q <span class="s1">&#39;libwrap.so&#39;</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;SI&quot;</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;NO&quot;</span>
<span class="go">SI</span>
<span class="gp">$</span> ldd /usr/sbin/nginx <span class="p">|</span> grep -q <span class="s1">&#39;libwrap.so&#39;</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;SI&quot;</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;NO&quot;</span>
<span class="go">NO</span>
</pre></div>
</div>
</dd>
</dl>
<p>Por tanto, este método serviría para impedir el acceso al servidor <abbr title="Security SHell">SSH</abbr>,
pero no al servidor web. Este mecanismo de veto era el que usaba
<a class="reference external" href="http://denyhosts.sourceforge.net/">denyhosts</a><a class="footnote-reference" href="#id11" id="id3">[3]</a>.</p>
<dl class="docutils">
<dt><strong>Cortafuegos</strong> (por lo general, <a class="reference internal" href="../../07.cortafuegos/01.iptables/index.html#iptables"><span class="std std-ref">iptables</span></a>)</dt>
<dd><p class="first last">Consiste en crear reglas para las máquinas sospechosas que impidan el
acceso a los servicios disponibles. El mecanismo es mucho más versátil ya
que se podrá aplicar a servicios individuales y será aplicable a todo
servicio<a class="footnote-reference" href="#id12" id="id4">[4]</a>. Las soluciones con <a class="reference internal" href="#ipt-limit"><span class="std std-ref">el módulo recent de iptables</span></a> y <a class="reference internal" href="#fail2ban"><span class="std std-ref">fail2ban</span></a> usan esta técnica.</p>
</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Se use uno u otro mecanismo, las listas de direcciones vetadas
son dinámicas, así que debe habilitarse algún medio para
gestionarlas.</p>
</div>
</li>
</ol>
</li>
</ul>
<div class="section" id="iptables">
<span id="iptables-bruta"></span><h3>8.9.2.4.2.1. IPtables<a class="headerlink" href="#iptables" title="Enlazar permanentemente con este título">¶</a></h3>
<p>El <a class="reference internal" href="../../07.cortafuegos/01.iptables/03.ext.html#iptables-recent"><span class="std std-ref">módulo recent de iptables</span></a> es muy apropiado tanto
para limitar los atanques de fuerza bruta como para implementar la técnica del
<em>port-knocking</em>.</p>
<div class="section" id="limitacion-de-accesos">
<span id="ipt-limit"></span><h4>8.9.2.4.2.1.1. Limitación de accesos<a class="headerlink" href="#limitacion-de-accesos" title="Enlazar permanentemente con este título">¶</a></h4>
<p>Es obvio que en condiciones normales un uso legítimo de algunos de nuestros
servicios no implica que una misma dirección <abbr title="Internet Protocol">IP</abbr> abra muchas conexiones en un
corto espacio de tiempo. Por ejemplo, al servidor <abbr title="Security SHell">SSH</abbr> accederá de vez en
cuando un usuario por lo que muy de vez en cuando se abrirá una conexión al
puerto <abbr title="Security SHell">SSH</abbr>. Con el servicio <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> que escucha en los puertos <strong>587</strong> o
<strong>465</strong> ocurrirá básicamente lo mismo: un usuario, cada cierto tiempo, mandará
un mensaje, pero es bastante improbable que lo haga repetidamente en un corto
espacio de tiempo.</p>
<p>Nuestro propósito, pues, es vetar el acceso a aquellas direcciones que, durante
un espacio de tiempo que establezcamos, sobrepasen un umbral de conexiones
nuevas, porque si lo hacen, sospechamos que se trata de intentos automatizados
de acceso que pretenden encontrar una pareja usuario/contraseña válida.</p>
<p>Veamos cómo asegurar los servicios <abbr title="Security SHell">SSH</abbr> y <abbr title="Simple Mail Transfer Protocol">SMTP</abbr> de ataques de fuerza bruta
para impedir que desde una misma <abbr title="Internet Protocol">IP</abbr> se pueda abrir más de <strong>6</strong> conexiones
nuevas en un periodo menor a <strong>5</strong> minutos:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Para desechar paquetes registrando el rechazo</span>
iptables -N LOGDROP
iptables -A LOGDROP -j LOG --log-level warning --log-prefix <span class="s2">&quot;Ataque fuerza bruta: &quot;</span>
iptables -A LOGDROP -j DROP

<span class="c1"># Anti ataques de fuerza bruta contra SSH</span>
iptables -N SSH
iptables -A SSH -m recent --name brute-ssh --update --seconds <span class="m">300</span> --hitcount <span class="m">6</span> --reap -j LOGDROP
iptables -A SSH -m recent --name brute-ssh --set -j ACCEPT

<span class="c1"># Anti ataques de fuerza bruta contra SMTP</span>
iptables -N SMTP
iptables -A SMTP -m recent --name brute-smtp --update --seconds <span class="m">300</span> --hitcount <span class="m">6</span> --reap -j LOGDROP
iptables -A SMTP -m recent --name brute-smtp --set -j ACCEPT

iptables -A INPUT -p tcp --dport ssh --syn -m conntrack --ctstate NEW -j SSH
iptables -A INPUT -p tcp -m multiport --dport urd,submission --syn -m conntrack --ctstate NEW -j SMTP
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Suponemos que seguimos una política de lista blanca y que por el
puerto <strong>25</strong> no se realizan conexiones autenticadas, tal como <a class="reference internal" href="../../../07.serre/03.mail/02-smtp/01-inst.html#postfix-25-465-587"><span class="std std-ref">se
propugna aquí</span></a>.</p>
</div>
<p>Obsérvese, porque es importante que, usando esta estrategia, el tiempo de
comprobación del accesos y el tiempo de veto debe coincidir. En nuestra
propuesta, son 5 minutos. Cuanto mayor sea este tiempo, mayor es el tiempo de
veto, pero también mayor el número de falsos positivos. Por tanto, una mejora a
lo anterior consiste en independizar ambos tiempos, de modo que el de
comprobación podamos reducirlo (por ejemplo, 30 segundos) y el de veto podamos
ampliarlo (por ejemplo, 10 minutos). Para ello podemos crear dos conjuntos
distintos: uno que apunte accesos y otro que apunte vetos (<em>banned</em>). Por
ejemplo:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Para desechar paquetes registrando el rechazo</span>
iptables -N LOGDROP
iptables -A LOGDROP -j LOG --log-level warning --log-prefix <span class="s2">&quot;Ataque fuerza bruta: &quot;</span>
iptables -A LOGDROP -m recent --name banned --set -j DROP

<span class="c1"># Anti ataques de fuerza bruta contra SSH</span>
iptables -N SSH
iptables -A SSH -m recent --name access-ssh --update --seconds <span class="m">30</span> --hitcount <span class="m">5</span> --reap -j LOGDROP
iptables -A SSH -m recent --name access-ssh --set -j ACCEPT

<span class="c1"># Anti ataques de fuerza bruta contra SMTP</span>
iptables -N SMTP
iptables -A SMTP -m recent --name access-smtp --update --seconds <span class="m">30</span> --hitcount <span class="m">5</span> --reap -j LOGDROP
iptables -A SMTP -m recent --name access-smtp --set -j ACCEPT

iptables -A INPUT -m conntrack --ctstate NEW -m recent --name banned --update --seconds <span class="m">600</span> --reap -j DROP
iptables -A INPUT -p tcp --dport ssh --syn -m conntrack --ctstate NEW -j SSH
iptables -A INPUT -p tcp -m multiport --dport urd,submission --syn -m conntrack --ctstate NEW -j SMTP
</pre></div>
</div>
<p>En la propuesta, los accesos a los distintos servicios se apuntan por separado
(<em>access-ssh</em>, <em>access-smtp</em>), así que se pueden establecer distintas
limitaciones según el servicio, pero una vez que un cliente alcanza la
limitación en uno de ellos, se apunta en una lista única (<em>banned</em>): eso
facilita las reglas a costa de que el tiempo de veto sea uno con independencia
de por qué puerto se haya recibido el ataque. Además, el cliente vetado no podrá
acceder a ningún servicio y, si lo intenta durante el tiempo de veto, se renovará
el tiempo de veto.</p>
</div>
<div class="section" id="port-knocking">
<span id="id5"></span><h4>8.9.2.4.2.1.2. Port-knocking<a class="headerlink" href="#port-knocking" title="Enlazar permanentemente con este título">¶</a></h4>
<p><em class="dfn">Port knocking</em> (<em class="dfn">golpeteo de puertos</em>, en castellano) es una técnica
que permite abrir desde el exterior en el <em>firewall</em> el puerto en el que escucha
algún servicio mediante una secuencia preestablecida de intentos de conexión a
puertos cerrados. Con ello se logra que un escaneo de puertos no detecte los
servicios realmente ofrecidos.</p>
<p>En consecuencia, el acceso al servicio oculto se realiza del siguiente modo:</p>
<ul class="simple">
<li>En principio, el cortafuegos impiede el acceso al servicio.</li>
<li>Un cliente que conoce la secuencia que permite abrir el puerto de escucha, la
lleva a cabo.</li>
<li>El servicio de <em>port-knocking</em> intercepta esta secuencia y, sin aviso al
cliente (nunca lo hay) abre durante un tiempo limitado el acceso a ese
cliente.</li>
<li>El cliente realiza la conexión al servicio.</li>
</ul>
<p>Para ponerlo en práctica puede usarse un servicio independiente como <a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-use-port-knocking-to-hide-your-ssh-daemon-from-attackers-on-ubuntu">knockd</a>,
pero aquí trataremos de hacerlo exclusivamente con <a class="reference internal" href="../../07.cortafuegos/01.iptables/index.html#iptables"><span class="std std-ref">iptables</span></a>.</p>
<p>Para nuestro ejemplo, el golpeteo será de tres golpes: el primero al puerto
<em>11111/UDP</em>, el segundo al puerto <em>22222/UDP</em> y el tercero al puerto
<em>33333/UDP</em>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Las máquinas dan el primer toque (debe ser al puerto 11111/UDP)</span>
iptables -N toc
iptables -A toc -p udp --dport <span class="m">11111</span> -m recent --set --name toc -j DROP

<span class="c1"># Las máquinas dan el segundo toque (debe ser al puerto 22222/UDP)</span>
iptables -N toctoc
iptables -A toctoc -p udp --dport <span class="m">22222</span> -m recent --set --name toctoc -j DROP

<span class="c1"># Las máquinas dan el tercer toque (debe ser al puerto 33333/UDP)</span>
iptables -N toctoctoc
iptables -A toctoctoc -p udp --dport <span class="m">33333</span> -m recent --set --name toctoctoc -j DROP

<span class="c1"># Máquinas con el paso concedido</span>
iptables -N paso
iptables -A paso -p tcp --dport ssh -j ACCEPT
<span class="c1"># ... y otros posibles servicios también ocultos</span>


iptables -A INPUT -m recent --remove --name toctoctoc -j paso
iptables -A INPUT -m recent --remove --name toctoc -j toctoctoc
iptables -A INPUT -m recent --remove --name toc -j toctoc
iptables -A INPUT -j toc
</pre></div>
</div>
<p>Obsérvese que cada vez que damos un toque, borramos el toque anterior (p.e. al
hacer «toctoc» borramos «toc») y que finalmente tras «toctoctoc» el siguiente
paquete enviado borra el último «toctoctoc». En consecuencia, para conectar al
servicio debemos mandar en orden y exclusivamente «toc», «toctoc», «toctoctoc» y
el paquete que inicia la conexión. Si no seguimos la secuencia o intercalamos
otro paquete entre medias, la apertura se malogrará.</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p>Suponemos una política de lista blanca y que todas estas reglas
sustituyen a la repla única:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>iptables -p tcp --dport ssh -j ACCEPT
</pre></div>
</div>
<p class="last">es obvio que nuestro conjunto de reglas deberá incluir todas las demas
necesarias (permitir el tráfico de la interfaz loopback, permitir el tráfico
establecido, etc.)</p>
</div>
<p>De este modo, para que una máquina pudiera acceder al servicio <abbr title="Security SHell">SSH</abbr> debería
antes hacer <a class="reference download internal" download="" href="../../../_downloads/6723be13d88e443d4290b0a158f867c7/ssh.sh"><code class="xref download docutils literal notranslate"><span class="pre">lo</span> <span class="pre">siguiente</span></code></a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="c1">#</span>
<span class="c1"># Accede al servicio SSH, tocando primero</span>

<span class="nv">TOC</span><span class="o">=</span><span class="s2">&quot;11111 22222 33333&quot;</span>

get_server<span class="o">()</span> <span class="o">{</span>
   ssh -G <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span> <span class="p">|</span> awk <span class="s1">&#39;$1==&quot;hostname&quot; {print $2}&#39;</span>
<span class="o">}</span>

<span class="nv">server</span><span class="o">=</span><span class="k">$(</span>get_server <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="k">)</span>
<span class="k">for</span> p in <span class="nv">$TOC</span><span class="p">;</span> <span class="k">do</span>
   <span class="nb">printf</span> <span class="s2">&quot;toc... &quot;</span>
   <span class="nb">echo</span> <span class="s2">&quot;x&quot;</span> <span class="p">|</span> nc -u -q1 <span class="s2">&quot;</span><span class="nv">$server</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$p</span><span class="s2">&quot;</span>
<span class="k">done</span>
<span class="nb">echo</span>
ssh <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p>Si decidimos abrir el servicio con el golpeo del mismo puerto un
número determinado de golpes (en el ejemplo, 3), podemos simplificar las
reglas:</p>
<div class="last highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="c1"># Repique en el puerto</span>
iptables -N toc
iptables -A toc -p udp --dport <span class="m">11111</span> -m recent --set --name toc -j DROP
iptables -A toc -m recent --remove --name toc

<span class="c1"># Ya repicado lo suficiente</span>
iptables -N paso
iptables -A paso -m recent --remove --name toc
iptables -A paso -p tcp --dport ssh -j ACCEPT
<span class="c1"># ... y otros posibles servicios también ocultos</span>


iptables -A INPUT -m recent --rcheck --hitcount <span class="m">3</span> --name toc -j paso
iptables -A INPUT -j toc
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="nftables">
<h3>8.9.2.4.2.2. nftables<a class="headerlink" href="#nftables" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Por hacer</p>
<p class="last">Por estudiar las soluciones equivalentes con <a class="reference internal" href="../../07.cortafuegos/02.nftables/index.html#nftables"><span class="std std-ref">nftables</span></a>.</p>
</div>
</div>
<div class="section" id="fail2ban">
<span id="id6"></span><h3>8.9.2.4.2.3. fail2ban<a class="headerlink" href="#fail2ban" title="Enlazar permanentemente con este título">¶</a></h3>
<p><strong class="program">fail2ban</strong> (<a class="reference external" href="https://www.fail2ban.org/wiki/index.php/Main_Page">página web</a>) es una aplicación escrita
en <em>python</em> que escruta los accesos a distintos servicios, identifica cuáles de
ellos son fallidos y, aplicando ciertas reglas de tolerancia (p.e. 5 accesos
fallidos en los últimos 5 minutos desde una misma dirección) impide el acceso al
servidor desde la dirección desde la que se realizan tales accesos durante un
espacio de tiempo determinado. Para vetar el acceso crea dinámicamente reglas de
<a class="reference internal" href="../../07.cortafuegos/01.iptables/index.html#iptables"><span class="std std-ref">iptables</span></a>.</p>
<p>Por tanto, persigue el mismo objetivo que la <a class="reference internal" href="#ipt-limit"><span class="std std-ref">limitación de accesos que
practicamos con iptables</span></a>, pero no del mismo modo, por lo que
presenta ventajas y inconvenientes:</p>
<dl class="docutils">
<dt><strong>Ventajas</strong></dt>
<dd><ul class="first last simple">
<li>Al escudriñar si el acceso ha tenido éxito, sólo contabiliza como accesos
sospechos los fallidos. Por tanto, es más improbable que obtengamos con él
falsos positivos.</li>
<li>Es una solución más general. El módulo <em>recent</em> no sirve para evitar ataques
de fuerza bruta a servidores web, por ejemplo, ya que por la naturaleza de
este protocolo, un cliente puede abrir muchas conexiones seguidas (o
incluso simultáneas) con el servidor. Por tanto, limitar el acceso no es
solución. En cambio, sí lo es detectar acceso fallidos.</li>
</ul>
</dd>
<dt><strong>Desventajas</strong></dt>
<dd><ul class="first last simple">
<li>Debemos instalar <em>software</em> adicional y mantenerlo en ejecución.</li>
<li>El desempeño de la solución que usa el módulo <em>recent</em> de <strong class="program">iptables</strong>
es muchísimo mejor ya que, por su naturaleza, <strong class="program">fail2ban</strong> debe
hacer muchas más tareas y tareas más pesadas: cada cierto tiempo debe
buscar en uno o varios registros accesos restringidos y añadir o eliminar
reglas de <strong class="program">iptables</strong>.</li>
<li>Cada servidor requiere una configuración de búsqueda de fallos diferente,
puesto que registra los acceso fallidos con un formato diferente y,
posiblemene, en un lugar diferente.</li>
</ul>
</dd>
</dl>
<p>La instalación es sencilla puesto que se dispone de paquete en <em>debian</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> apt install fail2ban
</pre></div>
</div>
<div class="section" id="estructura-de-la-configuracion">
<h4>8.9.2.4.2.3.1. Estructura de la configuración<a class="headerlink" href="#estructura-de-la-configuracion" title="Enlazar permanentemente con este título">¶</a></h4>
<p>Toda la configuración se encuentra dentro de <code class="file docutils literal notranslate"><span class="pre">/etc/fail2ban</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">/etc/fail2ban/</span>
<span class="go">|-- action.d</span>
<span class="go">|   |-- iptables.conf</span>
<span class="go">|   `-- ...</span>
<span class="go">|-- fail2ban.conf</span>
<span class="go">|-- fail2ban.d</span>
<span class="go">|-- filter.d</span>
<span class="go">|   |-- sshd.conf</span>
<span class="go">|   `-- ...</span>
<span class="go">|-- jail.conf</span>
<span class="go">`-- jail.d</span>
<span class="go">    |-- sshd.conf</span>
<span class="go">    `-- ...</span>
</pre></div>
</div>
<p>Las claves de esta configuración modular son las siguientes:</p>
<ul>
<li><p class="first">Los ficheros de configuración son ficheros <a class="reference external" href="https://es.wikipedia.org/wiki/INI_(extensi%C3%B3n_de_archivo)">ini</a> con
extensión <em>.conf</em>. Ahora bien, si en el mismo directorio se encuentra un
fichero extensión <em>.local</em>, <strong class="program">fail2ban</strong> leerá el fichero <em>.conf</em>
primero y usará el fichero <em>.local</em> para añadir más opciones o sobreescribir
las que incluyera <em>.conf</em>. Por tanto, es mejor no modificar nunca los
ficheros <em>.conf</em> ya que son los que distribuye <em>debian</em> con su paquete.</p>
</li>
<li><p class="first">El fichero <code class="file docutils literal notranslate"><span class="pre">fail2ban.conf</span></code> incluye opciones para controlar cómo arranca
el demonio (p.e. podríamos cambiar el nombre del fichero donde
<strong class="program">fail2ban</strong> apunta sus propios registros). En realidad, la definición
de estas opciones no se circunscribe exclusivamente al fichero, sino que hay toda
una estructura modular de ficheros que se leen en el siguiente orden:</p>
<ol class="arabic simple">
<li><code class="file docutils literal notranslate"><span class="pre">fail2ban.conf</span></code>.</li>
<li><code class="file docutils literal notranslate"><span class="pre">fail2ban.d/*.conf</span></code>, en orden alfabético.</li>
<li><code class="file docutils literal notranslate"><span class="pre">fail2ban.local</span></code></li>
<li><code class="file docutils literal notranslate"><span class="pre">fail2ban.d/*.local</span></code>, en orden alfabético.</li>
</ol>
<p>de manera que lecturas posteriores añaden nuevas opciones y sobreescriben las
ya existentes.</p>
</li>
<li><p class="first">El fichero <code class="file docutils literal notranslate"><span class="pre">jail.conf</span></code> (y toda su estructura correspondiente) es lo que
nos toca modificar fundamentalmente para ajustarlo a nuestro servidor. Aquí
es donde se define cada <em>jail</em>, o sea, cada tarea de vigilancia que consiste en:</p>
<ul class="simple">
<li>Reconocer en la fuente correcta (un registro de <em>syslog</em>, por ejemplo) los
intentos fallidos de conexión. El reconocimiento de estos intentos se
logra aplicando expresiones regulares sobre los registros, la definición
de las cuales se denomina <em>filtro</em> en la jerga de <strong class="program">fail2ban</strong>.</li>
<li>En base a lo anterior, establecer cuáles son los ataques sufridos por la máquina.
Lo habitual es que <strong class="program">fail2ban</strong> considere ataque la existencia de
una cantidad prefijada de conexiones fallidas en un periodo también
prefijado de tiempo.</li>
<li>En caso de detectar uno o más ataques, desencadenar una <em>acción</em> de veto (la
adición de una regla de <strong class="program">iptables</strong>, por ejemplo).</li>
</ul>
<p>Por tanto, la escritura de un <em>jail</em> supone definir:</p>
<ul class="simple">
<li>Qué filtro queremos aplicar.</li>
<li>Qué condiciones se deben cumplir para encontrarnos ante un ataque. Por
ejemplo, la opción <code class="docutils literal notranslate"><span class="pre">maxretry</span></code> indica el máximo número de intentos
fallidos que toleramos o <code class="docutils literal notranslate"><span class="pre">findtime</span></code> el periodo de tiempo en que deben
buscarse esos intentos.</li>
<li>Qué acción debe desencadenarse. Por ejemplo, <code class="file docutils literal notranslate"><span class="pre">iptables.conf</span></code> crea
reglas de <strong class="program">iptables</strong>, <code class="file docutils literal notranslate"><span class="pre">iptables-ipset-proto4.conf</span></code> crea
reglas de <strong class="program">iptables</strong> que aprovechan las capacidades del
<a class="reference internal" href="../../07.cortafuegos/01.iptables/03.ext.html#ipt-ipset"><span class="std std-ref">módulo set</span></a>, <code class="file docutils literal notranslate"><span class="pre">hostsdeny.conf</span></code> añade entradas en
<code class="file docutils literal notranslate"><span class="pre">/etc/hosts.deny</span></code>, etc.</li>
</ul>
</li>
<li><p class="first">En <code class="file docutils literal notranslate"><span class="pre">action.d</span></code> se definen las acciones.</p>
</li>
<li><p class="first">En <code class="file docutils literal notranslate"><span class="pre">filter.d</span></code> se definen los filtros.</p>
</li>
</ul>
</div>
<div class="section" id="configuracion-basica">
<h4>8.9.2.4.2.3.2. Configuración básica<a class="headerlink" href="#configuracion-basica" title="Enlazar permanentemente con este título">¶</a></h4>
<p>El paquete trae un fichero <code class="file docutils literal notranslate"><span class="pre">jail.conf</span></code> que incluye entre otras cosas
los valores de la configuración por defecto en la sección <code class="docutils literal notranslate"><span class="pre">[DEFAULT]</span></code>. Esto
es así, porque el fichero es de tipo <em>INI</em> y cada <em>jail</em> se define en una
sección distinta.</p>
<p>Si echamos un ojo veremos que en la referida sección hay opción que dice:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">maxretry</span> <span class="o">=</span> <span class="s">6</span>
</pre></div>
</div>
<p>Esto significa que, a menos que en un <em>jail</em> en particular redefinamos
la opción con otro valor, para todos los servicios en umbral máximo de fallos
que toleraremos será <strong>6</strong>.</p>
<p>Empecemos por crear un <code class="file docutils literal notranslate"><span class="pre">jail.local</span></code> para redefinir a nuestro gusto las
opciones comunes:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[DEFAULT]</span>
<span class="na">ignoreip</span>   <span class="o">=</span> <span class="s">127.0.0.0/8 192.168.0.0/16</span>
<span class="na">bantime</span>    <span class="o">=</span> <span class="s">1200    ; 20m</span>
<span class="na">findtime</span>   <span class="o">=</span> <span class="s">120    ; 2m</span>
<span class="na">destemail</span>  <span class="o">=</span> <span class="s">root@localhost</span>
<span class="na">sendermail</span> <span class="o">=</span> <span class="s">root@localhost</span>
</pre></div>
</div>
<p>Hemos modificado:</p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">ignoreip</span></code></dt>
<dd>Para que se evite crear reglas de veto a máquinas locales.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">bantime</span></code></dt>
<dd>Tiempo en segundo que se mantendrá vetada a la máquina.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">findtime</span></code></dt>
<dd>Periodo de tiempo hacia atrás en que se restrean accesos fallidos.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">destemail</span></code>, <code class="docutils literal notranslate"><span class="pre">sendermail</span></code></dt>
<dd>Direcciones de correo que se usan como destinatario y remitente para el
envío de avisos cuando se ha realizado un veto. <strong class="program">fail2ban</strong> no tiene
una opción que habilite o deshabilite estos mensajes, sino que está definida
la acción <code class="file docutils literal notranslate"><span class="pre">action.d/sendmail.conf</span></code> que no realiza veto alguno, sino
que simplemente manda el aviso. Si nuestra intención es que el <em>jail</em> avise,
deberá de definirse con dos acciones: la que propiamente realiza el veto y
ésta.</dd>
</dl>
<p>Bien, pero ¿qué hay de los <em>jails</em>? Vale. Pues hagamos (o mejor, modifiquemos)
un <em>jail</em> para <abbr title="Security SHell">SSH</abbr>. Si el servicio es habitual, es más que probable que ya
tenga una sección en la configuración. La de este servicio se llama <code class="docutils literal notranslate"><span class="pre">[sshd]</span></code> y
estudiaremos bajo el próximo epígrafe por qué es así y por qué ya viene activo
este <em>jail</em>. Ahora nos limitaremos a establecer las opciones particulares para
este <em>jail</em>. Lo más adecuado es crear <code class="file docutils literal notranslate"><span class="pre">jail.d/ssh.local</span></code> con un contenido
como éste:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[sshd]</span>
<span class="c1">;enable = true</span>
<span class="na">maxretry</span> <span class="o">=</span> <span class="s">5</span>
<span class="na">findtime</span> <span class="o">=</span> <span class="s">90     ; 1.5m</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">No lo habilitamos, porque ya está activo.</p>
</div>
</div>
<div class="section" id="funcionamiento">
<h4>8.9.2.4.2.3.3. Funcionamiento<a class="headerlink" href="#funcionamiento" title="Enlazar permanentemente con este título">¶</a></h4>
<p>Es obvio que cada vez que hagamos un cambio como en la configuración anterior,
podremos reiniciar el servicio con la herramienta habitual de <em>debian</em>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1"># invoke-rc.d fail2ban restart</span>
</pre></div>
</div>
<p>Además, podemos comprobar de forma genérica cuales son los servicios protegidos
o, más precisamente dicho, los <em>jails</em> activos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> fail2ban-client status
<span class="go">Status</span>
<span class="go">|- Number of jail:      1</span>
<span class="go">`- Jail list:   sshd</span>
</pre></div>
</div>
<p>Para consultar el estado de un <em>jail</em> particular:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> fail2ban-client status sshd
<span class="go">Status for the jail: sshd</span>
<span class="go">|- Filter</span>
<span class="go">|  |- Currently failed: 0</span>
<span class="go">|  |- Total failed:     2</span>
<span class="go">|  `- File list:        /var/log/auth.log</span>
<span class="go">`- Actions</span>
<span class="go">   |- Currently banned: 1</span>
<span class="go">   |- Total banned:     1</span>
<span class="go">   `- Banned IP list:   192.168.1.241</span>
</pre></div>
</div>
</div>
<div class="section" id="hurgando-en-la-configuracion">
<h4>8.9.2.4.2.3.4. Hurgando en la configuración<a class="headerlink" href="#hurgando-en-la-configuracion" title="Enlazar permanentemente con este título">¶</a></h4>
<p>Hasta ahora, nos hemos limitado a modificar a tientas un <em>jail</em> ya creado
(<code class="docutils literal notranslate"><span class="pre">[sshd]</span></code>). Ahora bien, más allá de que por su nombre parezca que
efectivamente vigila el servicio <abbr title="Security SHell">SSH</abbr>, ¿por qué realmente vigila tal servicio?
¿Cómo lo hace? ¿Cómo lo defiende? Para resolver las preguntas lo mejor es hacer
un poco de <em>ingeniera inversa</em> sobre la configuración. Si revisamos
<code class="file docutils literal notranslate"><span class="pre">jail.conf</span></code> descubriremos la siguiente sección:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[sshd]</span>

<span class="na">port</span>    <span class="o">=</span> <span class="s">ssh</span>
<span class="na">logpath</span> <span class="o">=</span> <span class="s">%(sshd_log)s</span>
<span class="na">backend</span> <span class="o">=</span> <span class="s">%(sshd_backend)s</span>
</pre></div>
</div>
<p>en donde está claro que parece un <em>jail</em> que actúa sobre el puerto <strong>22</strong> (ya
veremos qué signifca eso). Por otro lado, se fija <code class="docutils literal notranslate"><span class="pre">backend</span></code> que si seguimos la
madeja de variables nos lleva a un valor de «<em>auto</em>». Leyendo los comentarios en
el propio fichero llegaremos a la conclusión de que esto implica usar como
<em>backend</em> «<em>polling</em>», que significa que se leen registros del fichero indicado
con <code class="docutils literal notranslate"><span class="pre">logpath</span></code>. De nuevo, siguiendo valores, veremos que en este caso tal
fichero es <code class="file docutils literal notranslate"><span class="pre">/var/log/auth.log</span></code>, valor que es correcto si está activo
<a class="reference internal" href="../../../04.servidor/08.monitorizacion/01.logs/01.classic.html#rsyslog"><span class="std std-ref">syslog</span></a>, como es el caso de <em>stretch</em> o <em>buster</em>.</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Desde las últimas versiones de <strong class="program">fail2ban</strong> es posible también
usar como <em>backend</em> para los registros <a class="reference internal" href="../../../04.servidor/03.init/index.html#systemd"><span class="std std-ref">systemd</span></a>, aunque esto
exige definir la opción <code class="docutils literal notranslate"><span class="pre">journalmatch</span></code> y no <code class="docutils literal notranslate"><span class="pre">logpath</span></code>.</p>
</div>
<p>Bien, sabemos qué registros revisa <strong class="program">fail2ban</strong>, pero ¿qué filtros usa
este <em>jail</em>? Es obvio que, si la respuesta no está en su sección, se tiene que
hallar en la sección <code class="docutils literal notranslate"><span class="pre">[DEFAULT]</span></code>, y efectivamente así es:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">filter</span> <span class="o">=</span> <span class="s">%(__name__)s</span>
</pre></div>
</div>
<p>que implica de modo predeterminado que el filtro se llama como el nombre de la
sección, en este caso, <em>sshd</em>. Por tanto, el filtro se encuentra en
<code class="file docutils literal notranslate"><span class="pre">filter.d/sshd.conf</span></code>. Si echamos un ojo al filtro, encontraremos las
expresiones regulares que concuerdan con los mensajes de acceso fallido que el
demonio del servicio escribe en los registros. Además, está definida la opción
<code class="docutils literal notranslate"><span class="pre">journalmatch</span></code> apropiada, de modo que hacer que el <em>jail</em> use
<strong class="program">systemd</strong> en vez de <strong class="program">syslog</strong> se limita a escribir:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[sshd]</span>
<span class="c1"># ... configuración personalizada ...</span>
<span class="na">backend</span> <span class="o">=</span> <span class="s">systemd</span>
</pre></div>
</div>
<p>Resuelto el asunto del filtro, ¿cuál es la <em>acción</em> que se lleva a cabo? La
respuesta de nuevo está en la sección <code class="docutils literal notranslate"><span class="pre">[DEFAULT]</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">banaction</span> <span class="o">=</span> <span class="s">iptables-multiport</span>
<span class="na">action_</span> <span class="o">=</span> <span class="s">%(banaction)s[name=%(__name__)s, bantime=&quot;%(bantime)s&quot;,</span>
<span class="s">                        port=&quot;%(port)s&quot;, protocol=&quot;%(protocol)s&quot;, chain=&quot;%(chain)s&quot;]</span>
<span class="na">action_mw</span> <span class="o">=</span> <span class="s">%(banaction)s[name=%(__name__)s, bantime=&quot;%(bantime)s&quot;,</span>
<span class="s">                          port=&quot;%(port)s&quot;, protocol=&quot;%(protocol)s&quot;, chain=&quot;%(chain)s&quot;]</span>
<span class="s">            %(mta)s-whois[name=%(__name__)s, sender=&quot;%(sender)s&quot;,</span>
<span class="s">                          dest=&quot;%(destemail)s&quot;, protocol=&quot;%(protocol)s&quot;, chain=&quot;%(chain)s&quot;]</span>

<span class="c1"># ... otras variantes de la acción ...</span>

<span class="na">action</span> <span class="o">=</span> <span class="s">%(action_)s</span>
</pre></div>
</div>
<p>La configuración está desgranada de esta forma para simplificar las
modificaciones:</p>
<ul>
<li><p class="first">La opción que define cuál es la acción a realizar es <code class="docutils literal notranslate"><span class="pre">action</span></code>, que se apoya
en <code class="docutils literal notranslate"><span class="pre">action_</span></code>, que a su vez usa <code class="docutils literal notranslate"><span class="pre">banaction</span></code>. Una alternativa podría haber
sido:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[sshd]</span>
<span class="na">action</span> <span class="o">=</span> <span class="s">iptables-allports[name=%(__name__)s, chain=INPUT]</span>
</pre></div>
</div>
<p>que veta a la máquina sospechosa el acceso a todos los puertos. En este caso,
no es necesaria la inclusión de <em>port</em> o <em>protocol</em>.</p>
</li>
<li><p class="first">La razón de la existencia de <code class="docutils literal notranslate"><span class="pre">action_</span></code> es que es necesario pasar a la acción
algunos datos necesarios como el puerto, por ejemplo. Lo cierto es que se
pasan parámetros muy generosamente, porque no todos son necesarios y pasar de
más no provoca ningún fallo.</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">El valor predeterminado de <code class="docutils literal notranslate"><span class="pre">chain</span></code> está definido en
<code class="file docutils literal notranslate"><span class="pre">action.d/iptables-common.conf</span></code> y es <em>INPUT</em>.</p>
</div>
</li>
<li><p class="first">La acción definida en <code class="file docutils literal notranslate"><span class="pre">action.d/</span></code> que usaremos viene definida por
<code class="docutils literal notranslate"><span class="pre">banaction</span></code> y será <code class="file docutils literal notranslate"><span class="pre">action.d/iptables-multiport.conf</span></code>. Si echamos un
vistazo a ese fichero, es fácil darse cuenta de que para vetar se usa
<strong class="program">iptables</strong> usando el módulo <em>multiport</em><a class="footnote-reference" href="#id13" id="id7">[5]</a> y se veta
exclusivamente el acceso a los puertos del servicio.</p>
<p>Así, podríamos hacer:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[sshd]</span>
<span class="c1"># ... otra configuración adicional ...</span>
<span class="na">banaction</span> <span class="o">=</span> <span class="s">iptables-allports</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div>y todo funcionaría perfectamente, ya que esta acción requiere aún menos
parámetros que <em>iptables-multiport</em> y, por tanto, el valor de <code class="docutils literal notranslate"><span class="pre">action_</span></code>
seguirá siendo válido.</div></blockquote>
<ul>
<li><p class="first">Otros <code class="docutils literal notranslate"><span class="pre">action_*</span></code> añaden alguna acción extra. Por ejemplo, si hiciéramos:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[sshd]</span>
<span class="c1"># ... otra configuración adicional ...</span>
<span class="na">action</span> <span class="o">=</span> <span class="s">%(action_mw)s</span>
</pre></div>
</div>
<p>Además de vetar, se enviaría un mensaje de aviso cada vez que se produjera
un veto.</p>
</li>
</ul>
<p>Por último, afirmamos rotundamente al principio que <code class="docutils literal notranslate"><span class="pre">[sshd]</span></code> estaba activo;
pero, ¿por qué es así? De hecho, en la sección <code class="docutils literal notranslate"><span class="pre">[DEFAULT]</span></code> se dice sin
ambages:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">enabled</span> <span class="o">=</span> <span class="s">False</span>
</pre></div>
</div>
<p>La razón de ello es que <code class="file docutils literal notranslate"><span class="pre">jail.d/</span></code> viene de serie con un <em>jail</em> llamado
<code class="file docutils literal notranslate"><span class="pre">jail.d/defaults-debian.conf</span></code> con este contenido:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[sshd]</span>
<span class="na">enabled</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>
</div>
<p>Por lo general, si los ataques son frecuentes es conveniente hacer<a class="footnote-reference" href="#id14" id="id8">[6]</a>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">banaction</span> <span class="o">=</span> <span class="s">iptables-ipset-proto6</span>
</pre></div>
</div>
<p>que usa el <a class="reference internal" href="../../07.cortafuegos/01.iptables/03.ext.html#ipt-ipset"><span class="std std-ref">módulo ipset de iptables</span></a> para gestionar la lista
de direcciones <abbr title="Internet Protocol">IP</abbr> vetadas.</p>
<div class="admonition warning">
<p class="first admonition-title">Advertencia</p>
<p>Es bastante probable que <strong class="command">ipset</strong> no esté instalado en su
sistema:</p>
<div class="last highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt install ipset</span>
</pre></div>
</div>
</div>
<p class="rubric">Ejemplo de aplicación</p>
<p>Si quisiéramos vetar con <code class="file docutils literal notranslate"><span class="pre">/etc/hosts.deny</span></code>, en vez de hacerlo con el
cortafuegos y leer registros con <strong class="program">systemd</strong>, podríamos ensayar la
siguiente configuración:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[sshd]</span>
<span class="na">enabled</span> <span class="o">=</span> <span class="s">false</span>

<span class="k">[sshd-denyhosts]</span>
<span class="na">enabled</span> <span class="o">=</span> <span class="s">true</span>

<span class="na">port</span>    <span class="o">=</span> <span class="s">ssh</span>
<span class="na">backend</span> <span class="o">=</span> <span class="s">systemd</span>

<span class="na">filter</span> <span class="o">=</span> <span class="s">sshd</span>
<span class="c1">;banaction = hostsdeny[daemon_list=sshd]</span>
<span class="na">banaction</span> <span class="o">=</span> <span class="s">hostsdeny</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Advertencia</p>
<p class="last">Usar <code class="file docutils literal notranslate"><span class="pre">/etc/hosts.deny</span></code> es sólo una excentricidad para jugar
un poco más con la configuración: no imite esta idea en un servisdor real. De
hecho, <strong class="program">fail2ban</strong> no parece andar del todo fino usando este modo de
veto.</p>
</div>
<p class="rubric">Notas al pie</p>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><p class="first">Suponiendo que dispongamos de un file:<cite>/etc/passwd</cite> y un
<code class="file docutils literal notranslate"><span class="pre">/etc/shadown</span></code> completos, <strong class="program">john</strong> trae el ejecutable
<strong class="command">unshadow</strong> para combinar ambos y obtener un único fichero en que el
segundo campo de <code class="file docutils literal notranslate"><span class="pre">/etc/password</span></code> se sustituye por la contraseña del
usuarios:</p>
<div class="last highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1"># unshadow /etc/passwd /etc/shadow &gt; ~/passwords.txt</span>
</pre></div>
</div>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>En el ejemplo usamos un diccionario de palabras castellanas, que es muy
probable que ya esté instalado en el sistema. En <a class="reference external" href="https://wiki.skullsecurity.org/Passwords">esta página</a> pueden obtenerse diccionarios de
con muy habituales en sitios de internet.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="http://denyhosts.sourceforge.net/">denyhosts</a> lleva más de una década abandonado y <em>wheezy</em> fue la última
versión estable de <em>debian</em> que lo soportó.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td>Salvo <a class="reference external" href="https://unix.stackexchange.com/questions/447440/ufw-iptables-not-blocking-dhcp-udp-port-67">si se trata del servidor DHCP</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[5]</a></td><td><p class="first">Precisamente esto es lo que permite que se pueda usar como valor de la
opción <code class="docutils literal notranslate"><span class="pre">port</span></code> algo así:</p>
<div class="last highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[apache-auth]</span>
<span class="na">port</span>     <span class="o">=</span> <span class="s">http,https</span>
<span class="na">logpath</span>  <span class="o">=</span> <span class="s">%(apache_error_log)s</span>
</pre></div>
</div>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id14" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[6]</a></td><td><em>proto6</em> (hay también <em>proto4</em>) no hace referencia a la versión de
<abbr title="Internet Protocol">IP</abbr> sino a la versión de <em>ipset</em>.</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">8.9.2.4. Ataques contra la autenticación</a><ul>
<li><a class="reference internal" href="#metodos">8.9.2.4.1. Métodos</a><ul>
<li><a class="reference internal" href="#john-the-ripper">8.9.2.4.1.1. John the Ripper</a></li>
<li><a class="reference internal" href="#thc-hydra">8.9.2.4.1.2. THC-Hydra</a></li>
</ul>
</li>
<li><a class="reference internal" href="#contramedidas">8.9.2.4.2. Contramedidas</a><ul>
<li><a class="reference internal" href="#iptables">8.9.2.4.2.1. IPtables</a><ul>
<li><a class="reference internal" href="#limitacion-de-accesos">8.9.2.4.2.1.1. Limitación de accesos</a></li>
<li><a class="reference internal" href="#port-knocking">8.9.2.4.2.1.2. Port-knocking</a></li>
</ul>
</li>
<li><a class="reference internal" href="#nftables">8.9.2.4.2.2. nftables</a></li>
<li><a class="reference internal" href="#fail2ban">8.9.2.4.2.3. fail2ban</a><ul>
<li><a class="reference internal" href="#estructura-de-la-configuracion">8.9.2.4.2.3.1. Estructura de la configuración</a></li>
<li><a class="reference internal" href="#configuracion-basica">8.9.2.4.2.3.2. Configuración básica</a></li>
<li><a class="reference internal" href="#funcionamiento">8.9.2.4.2.3.3. Funcionamiento</a></li>
<li><a class="reference internal" href="#hurgando-en-la-configuracion">8.9.2.4.2.3.4. Hurgando en la configuración</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Tema anterior</h4>
  <p class="topless"><a href="02.arp.html"
                        title="capítulo anterior">8.9.2.3. Envenamiento <abbr title="Address Resolution Protocol">ARP</abbr></a></p>
  <h4>Próximo tema</h4>
  <p class="topless"><a href="04.mitm.html"
                        title="próximo capítulo">8.9.2.5. Ataques de modificación</a></p>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/08.redes/99.ataques/02.tecnicas/03.brute.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Ir a" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="04.mitm.html" title="8.9.2.5. Ataques de modificación"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="02.arp.html" title="8.9.2.3. Envenamiento ARP"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >8. Conceptos avanzados de redes</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" >8.9. Ataques</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="index.html" >8.9.2. Técnicas</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2020, José Miguel Sánchez Alés.
      Creado con <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>