


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="es">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>4.4. Autenticación &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Índice" href="../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../search.html" />
    <link rel="next" title="4.4.4.1. pam_permit" href="pam_modules/01.pam_permit.html" />
    <link rel="prev" title="4.3.3. Sistema de monitorización (nagios)" href="../08.monitorizacion/03.nagios/index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="pam_modules/01.pam_permit.html" title="4.4.4.1. pam_permit"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="../08.monitorizacion/03.nagios/index.html" title="4.3.3. Sistema de monitorización (nagios)"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">4. Gestión del servidor</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="autenticacion">
<span id="pam"></span><h1>4.4. Autenticación<a class="headerlink" href="#autenticacion" title="Enlazar permanentemente con este título">¶</a></h1>
<p>La autenticación y, más en general, el ingreso de un usuario al sistema está
estandarizado en los sistemas <em>linux</em> gracias a <abbr title="Pluggable Authentication Modules">PAM</abbr>. Es importante que
sea así, porque el acceso se puede lograr a través de distintos servicios y
esto facilita que cada servicio no tenga que implementar el mecanismo de acceso,
sino simplemente pasar las credenciales a <abbr title="Pluggable Authentication Modules">PAM</abbr> y que este se encargue de
decidir si el usuario debe tener o no acceso.</p>
<p>Como es probable que distintos servicios establezcan distintas políticas de
acceso, <abbr title="Pluggable Authentication Modules">PAM</abbr> permite particularizar la configuración según el servicio.</p>
<div class="admonition warning">
<p class="first admonition-title">Advertencia</p>
<p class="last">La configuración de la autenticación es bastante delicada, por
cuanto una mala configuración puede dejarnos sin acceso al sistema.</p>
</div>
<div class="section" id="estructura">
<h2>4.4.1. Estructura<a class="headerlink" href="#estructura" title="Enlazar permanentemente con este título">¶</a></h2>
<p>La configuración de <abbr title="Pluggable Authentication Modules">PAM</abbr>, pues, consiste en definir cuáles son operaciones
que deberá ejecutar cada servicio que requiere autenticación. Para ello puede
usarse un único fichero <code class="file docutils literal notranslate"><span class="pre">/etc/pam.conf</span></code>, o una colección contenida en el
directorio <code class="file docutils literal notranslate"><span class="pre">/etc/pam.d</span></code>. Si existe este segundo directorio, que es lo
habitual, no se analiza el primer fichero; así que explicaremos este segundo
método de configuración.</p>
<p>Si echamos un vistazo al contenido de <code class="file docutils literal notranslate"><span class="pre">/etc/pam.d</span></code> nos toparemos algo
así:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ls /etc/pam.d
<span class="go">atd             common-auth                    login     runuser-l</span>
<span class="go">chfn            common-password                newusers  sshd</span>
<span class="go">chpasswd        common-session                 other     su</span>
<span class="go">chsh            common-session-noninteractive  passwd    systemd-user</span>
<span class="go">common-account  cron                           runuser</span>
</pre></div>
</div>
<p>Se pueden distintiguir tres clases de ficheros:</p>
<ul class="simple">
<li>Los ficheros <code class="file docutils literal notranslate"><span class="pre">common-*</span></code>, que contienen directivas que suelen usarse
como base para la autenticación en la mayoría de los servicios (véase
<a class="reference internal" href="#pam-auth-update"><span class="std std-ref">pam-auth-update</span></a> más adelante). Esto es
posible debido a que para incluir las directivas de un fichero en otro
existe la directiva <code class="code docutils literal notranslate"><span class="pre">&#64;include</span></code>).</li>
<li>Una serie de ficheros que representan distintos programas que requieren
autenticación (en el listado antes indicado <code class="file docutils literal notranslate"><span class="pre">passwd</span></code>, <code class="file docutils literal notranslate"><span class="pre">sshd</span></code> o
<code class="file docutils literal notranslate"><span class="pre">su</span></code>, por ejemplo). Los programas usarán su fichero correspondiente
en caso de que exista.</li>
<li>El fichero <code class="file docutils literal notranslate"><span class="pre">other</span></code> usado por los programas a los que no se les ha
creado fichero particular.</li>
</ul>
</div>
<div class="section" id="funcionamiento">
<h2>4.4.2. Funcionamiento<a class="headerlink" href="#funcionamiento" title="Enlazar permanentemente con este título">¶</a></h2>
<p><abbr title="Pluggable Authentication Modules">PAM</abbr> distingue entre cuatro tipo de tareas:</p>
<dl class="docutils">
<dt><strong>Autenticación</strong> (<code class="docutils literal notranslate"><span class="pre">auth</span></code>)</dt>
<dd>Determina si las credenciales proporcionadas (habitualmente un nombre y una
contraseña) pertenecen a un usuario existente y son válidas.</dd>
<dt><strong>Cuenta</strong> (<code class="docutils literal notranslate"><span class="pre">account</span></code>)</dt>
<dd>Determina si el usuario cuya identidad se ha ya comprobado, tiene permiso
para acceder a la máquina o no (por una limitación horaria, porque no
pertenezca al grupo adecuado, etc.)</dd>
<dt><strong>Password</strong> (<code class="docutils literal notranslate"><span class="pre">password</span></code>)</dt>
<dd>Relacionado con la modificación de la contraseña de usuario.</dd>
<dt><strong>Sesión</strong> (<code class="docutils literal notranslate"><span class="pre">session</span></code>)</dt>
<dd>Tareas que deben realizarse antes de que el usuario abre la sesión o después
de que la cierre (por ejemplo, crear un directorio personal, montar sistemas
de ficheros remotos etc.)</dd>
</dl>
<p>Una aplicación que utilice <abbr title="Pluggable Authentication Modules">PAM</abbr> puede requerir la realización de uno o varios
tipos de estas tareas. Cada tipo de tarea se divide en módulos, cada uno de los
cuales se encarga de realizar algo. Como se ejecutan secuencialmente según el
orden en el que aparecen en la configuración, todos los módulos de un mismo
tipo, forman una <em>pila</em> y devuelven un resultado de éxito o error que contribuye
al resultado global de la pila. Cuando <abbr title="Pluggable Authentication Modules">PAM</abbr> devuelve éxito para todas las pilas
que la aplicación ha requerido, ésta permitirá el ingreso del usuario.</p>
</div>
<div class="section" id="sintaxis">
<h2>4.4.3. Sintaxis<a class="headerlink" href="#sintaxis" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Los ficheros de configuración de <abbr title="Pluggable Authentication Modules">PAM</abbr> contienen líneas de tres tipos:</p>
<ol class="arabic">
<li><p class="first">Líneas de comentario, que son aquellas que comienzan con almohadilla.</p>
</li>
<li><p class="first">Líneas que permiten incluir las directivas de otros ficheros:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">@include common-auth</span>
</pre></div>
</div>
<p>donde <code class="file docutils literal notranslate"><span class="pre">common-auth</span></code> es el fichero del que se desean incluir las
directivas.</p>
</li>
<li><dl class="first docutils">
<dt>Líneas de directiva, que son aquellas que definen la ejecución de un</dt>
<dd><p class="first">y que requieren una explicación detallada:</p>
<div class="last highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&lt;tipo&gt; &lt;control&gt; &lt;modulo&gt; [&lt;opciones&gt;]</span>
</pre></div>
</div>
</dd>
</dl>
<p>Las líneas de directiva se evalúan en el orden en que se leen y sus
componentes son los siguientes:</p>
<dl class="docutils">
<dt><strong>Tipo</strong></dt>
<dd><p class="first last">El tipo de módulo del que ya se discutió bajo el epígrafe anterior. Por
tanto, define la pila en la que se ejecuta el módulo.</p>
</dd>
<dt><strong>Control</strong></dt>
<dd><p class="first">Determina cómo contribuye el resultado de la ejecución del módulo
al resultado global de la pila.
directiva y cómo influirá esto en el proceso global de autenticación.
Hay cuatro indicadores básicos de control:</p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">required</span></code></dt>
<dd><p class="first last">Exige que tenga éxito la directiva, pero no interrumpe la ejecución
de la pila de módulos.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">requisite</span></code></dt>
<dd><p class="first last">Como <code class="docutils literal notranslate"><span class="pre">required</span></code>, pero interrumpe la ejecución de la pila
provocando un error.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">sufficient</span></code></dt>
<dd><p class="first last">Su éxito es suficiente, así que interrumpe la ejecución de la pila
devolviendo éxito.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">optional</span></code></dt>
<dd><p class="first last">El éxito o fracaso no influye en el resultado de la pila.</p>
</dd>
</dl>
<p>Alternativamente a estos términos, se puede utilizar una sucesión
de parejas resultado/acción, que permiten un control más preciso. Los
resultados son muy variados:</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parámetro</th>
<th class="head">Significado</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>abort</td>
<td>Error crítico.</td>
</tr>
<tr class="row-odd"><td>acct_expired</td>
<td>La cuenta de usuario ha expirado.</td>
</tr>
<tr class="row-even"><td>auth_err</td>
<td>Fallo en la autenticación.</td>
</tr>
<tr class="row-odd"><td>authinfo_unavail</td>
<td>No puede accederse a la información de autenticación.</td>
</tr>
<tr class="row-even"><td>authtok_disable_aging</td>
<td>Authentication token aging disabled.</td>
</tr>
<tr class="row-odd"><td>authtok_err</td>
<td>Error en la manipulación del token de autenticación.</td>
</tr>
<tr class="row-even"><td>authtok_expired</td>
<td>Token de autenticación caducado.</td>
</tr>
<tr class="row-odd"><td>authtok_lock_busy</td>
<td>Ocupado el bloqueo del token de autenticación.</td>
</tr>
<tr class="row-even"><td>authtok_recover_err</td>
<td>No puede recuperarse la información de autenticación.</td>
</tr>
<tr class="row-odd"><td>bad_item</td>
<td>Item incorrecto.</td>
</tr>
<tr class="row-even"><td>buf_err</td>
<td>Error en el <em>buffer</em> de memoria.</td>
</tr>
<tr class="row-odd"><td>conv_again</td>
<td>Conversation function is event driven and data is not available yet.</td>
</tr>
<tr class="row-even"><td>conv_err</td>
<td>Error en la conversación.</td>
</tr>
<tr class="row-odd"><td>cred_err</td>
<td>Error al fijar las credenciales de usuario.</td>
</tr>
<tr class="row-even"><td>cred_expired</td>
<td>Credenciales de usuario caducadas.</td>
</tr>
<tr class="row-odd"><td>cred_insufficient</td>
<td>Sin acceso a los datos de autenticación por falta de credenciales.</td>
</tr>
<tr class="row-even"><td>cred_unavail</td>
<td>Credenciales de usuario no disponibles.</td>
</tr>
<tr class="row-odd"><td>default</td>
<td>Cualquier valor no mencionado implícitamente.</td>
</tr>
<tr class="row-even"><td>ignore</td>
<td>No considerar el módulo.</td>
</tr>
<tr class="row-odd"><td>incomplete</td>
<td>Reiniciar el módulo para que se complete.</td>
</tr>
<tr class="row-even"><td>maxtries</td>
<td>Máximo número de intentos.</td>
</tr>
<tr class="row-odd"><td>module_unknown</td>
<td>El módulo no existe o no se conoce.</td>
</tr>
<tr class="row-even"><td>new_authtok_reqd</td>
<td>Se requiere un nuevo token de autenticación.</td>
</tr>
<tr class="row-odd"><td>no_module_data</td>
<td>Módulo sin datos.</td>
</tr>
<tr class="row-even"><td>open_err</td>
<td>El módulo no debe cargarse.</td>
</tr>
<tr class="row-odd"><td>perm_denied</td>
<td>Permiso denegado.</td>
</tr>
<tr class="row-even"><td>service_err</td>
<td>Error de servicio en el módulo.</td>
</tr>
<tr class="row-odd"><td>session_err</td>
<td>Error de sesión.</td>
</tr>
<tr class="row-even"><td>success</td>
<td>Acaba con éxito</td>
</tr>
<tr class="row-odd"><td>symbol_err</td>
<td>Símbolo no encontrado.</td>
</tr>
<tr class="row-even"><td>system_err</td>
<td>Error de sistema.</td>
</tr>
<tr class="row-odd"><td>try_again</td>
<td>Preliminary check by password service.</td>
</tr>
<tr class="row-even"><td>user_unknown</td>
<td>Usuario desconocido.</td>
</tr>
</tbody>
</table>
<p>Los valores que pueden adoptar estos resultados son los siguientes:</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="91%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Valor</th>
<th class="head">Significado</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ignore</td>
<td>El resultado del módulo no afecta al resultado global del proceso.</td>
</tr>
<tr class="row-odd"><td>bad</td>
<td>El resultado supone fallo del módulo.</td>
</tr>
<tr class="row-even"><td>die</td>
<td>Como el anterior, pero no se siguen comprobando módulos.</td>
</tr>
<tr class="row-odd"><td>ok</td>
<td>El módulo acaba con éxito.</td>
</tr>
<tr class="row-even"><td>done</td>
<td>Se acaba con éxito y no se siguen comprobando más módulos.</td>
</tr>
<tr class="row-odd"><td>reset</td>
<td>Se resetea el resultado global del proceso de autenticación.</td>
</tr>
<tr class="row-even"><td>N</td>
<td>Número de directivas siguientes que se saltarán.</td>
</tr>
</tbody>
</table>
<p>Los indicadores básicos de control equivalen a lo siguiente:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">required</span></code>: <code class="code docutils literal notranslate"><span class="pre">[success=ok</span> <span class="pre">new_authtok_reqd=ok</span> <span class="pre">ignore=ignore</span> <span class="pre">default=bad]</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">requisite</span></code>: <code class="code docutils literal notranslate"><span class="pre">[success=ok</span> <span class="pre">new_authtok_reqd=ok</span> <span class="pre">ignore=ignore</span> <span class="pre">default=die]</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">sufficiente</span></code>: <code class="code docutils literal notranslate"><span class="pre">[success=done</span> <span class="pre">new_authtok_reqd=done</span> <span class="pre">default=ignore]</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">optional</span></code>: <code class="code docutils literal notranslate"><span class="pre">[success=ok</span> <span class="pre">new_authtok_reqd=ok</span> <span class="pre">default=ignore]</span></code></li>
</ul>
<p>Obsérvese que los valores se ajustan a la definición que se ha dado de
los indicadores. Por ejemplo, un módulo con el indicador <code class="docutils literal notranslate"><span class="pre">requisite</span></code>
acaba inmediatamente la ejecución de la pila. Esto es debido a que el
valor predeterminado es <em>die</em>.</p>
<p>En el caso de que se use como valor un número, este indicará el número
e directivas de <em>pam</em> que se saltarán. Es importante tener en cuenta
que no se verá afectado el resultado de la línea: si acabó con éxito la
línea contribuirá al resultado global de la autenticación con un éxito;
y, si acabó con fracasó, contribuirá con un frcaso. Este valor es
bastante útil cuando tenemos varias fuentes para la obtención de las
credenciales. Por ejemplo, un servicio <abbr title="Lightweight Directory Access Protocol">LDAP</abbr> y los ficheros locales ya vistos
(<code class="file docutils literal notranslate"><span class="pre">/etc/passwd</span></code>, etc.). Como es obvio que para que el usuario sea
válido sólo debe estar en una de las fuentes, podemos encontrarnos con
configuraciones como la que sigue:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">auth     [success=2 default=ignore]    pam_unix.so nullok_secure</span>
<span class="go">auth     [success=1 default=ignore]    pam_ldap.so use_first_pass minimum_uid=1000 debug</span>
<span class="go">auth     requisite            pam_deny.so</span>
<span class="go">auth     required          pam_permit.so</span>
</pre></div>
</div>
<p class="last">O sea, si el usuario es local y la autenticación ha tenido éxito, se
saltan las dos siguientes directivas y se ejecuta la cuarta, que
incluye un módulo que, simplemente, tiene siempre éxito. Si falla, en
cambio, nos descuidamos del fallo (<code class="code docutils literal notranslate"><span class="pre">default=ignore</span></code>) y se analiza
si el usuario está definido en la base <em>ldap</em> y sus credenciales son
correctas. SI es así, saltamos una directiva, con lo que acabaremos en
el módulo <em>promiscuo</em> que siempre permite acceso. Por contra, si falla,
desatendemos el error (<code class="code docutils literal notranslate"><span class="pre">default=ignore</span></code>), pero caemos en la
siguiente directiva, que siempre falla y, además, está como <em>requisite</em>,
con lo que la autenticación fallará inmediatamente.</p>
</dd>
<dt><strong>Módulo</strong></dt>
<dd><p class="first">Módulo que se usa en la directiva. <abbr title="Pluggable Authentication Modules">PAM</abbr> está constituido por un
conjunto de módulos, cada uno de los cuales se encarga de un aspecto
distinto. Por ejemplo, <code class="file docutils literal notranslate"><span class="pre">pam_unix.so</span></code> es el módulo que se
encarga de hacer comprobaciones usando la información de
<code class="file docutils literal notranslate"><span class="pre">/etc/passwd</span></code> y <code class="file docutils literal notranslate"><span class="pre">/etc/shadow</span></code>.</p>
<p class="last">Bajo el epígrafe siguiente describiremos el uso de los más habituales.</p>
</dd>
<dt><strong>Opciones</strong></dt>
<dd><p class="first last">Opciones con las que se ejecuta el módulo. Por ejemplo
<code class="file docutils literal notranslate"><span class="pre">pam_unix.so</span></code> no permite acceder al servicio si el usuario tiene
una contraseña vacía. Sin embargo, si se incluye la opcion
<kbd class="kbd docutils literal notranslate">nullok</kbd>, sí podrá.</p>
</dd>
</dl>
</li>
</ol>
<p id="pam-auth-update">A pesar de que la configuración consiste en escribir apropiadamente las líneas
para que el proceso de autenticación sea el adecuado, las distribuciones
derivadas de <em>debian</em> tienen un <span class="target" id="index-0"></span>programa llamado
<strong class="program">pam-auth-update</strong> que permite mediante menú generar automáticamente las
líneas de los ficheros <code class="file docutils literal notranslate"><span class="pre">common-*</span></code>. De esta forma, la instalación de
servicios que aportan usuarios y grupos al sistema (como <em>samba</em> u <em>openldap</em>)
es bastante sencilla<a class="footnote-reference" href="#id4" id="id1">[1]</a>.</p>
<div class="admonition warning">
<p class="first admonition-title">Advertencia</p>
<p class="last">La modificación de los ficheros <code class="file docutils literal notranslate"><span class="pre">common-*</span></code> es algo delicada
por cuanto estos ficheros se generan con <strong class="command">pam-auth-update</strong>. Por lo
general, añadir alguna directiva al final es posible sin que
<strong class="command">pam-auth-update</strong> plantee problemas. Ahora bien, si lo que se desea
es modificar argumentos de líneas que genera la utilidad, entonces es
conveniente modificar los ficheros de los perfiles de
<strong class="command">pam-auth-update</strong> (véase la nota anterior).</p>
</div>
</div>
<div class="section" id="modulos">
<h2>4.4.4. Módulos<a class="headerlink" href="#modulos" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Hay muchos módulos para <em>pam</em>. Bajo este epígrafe sólo se comentarán los más
habituales y se explicarán brevemente algunos de sus argumentos. Suelen tener
página de manual, así que es recomendable consultarla.</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/01.pam_permit.html">4.4.4.1. <code class="docutils literal notranslate"><span class="pre">pam_permit</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/02.pam_deny.html">4.4.4.2. <code class="docutils literal notranslate"><span class="pre">pam_deny</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/03.pam_unix.html">4.4.4.3. <code class="docutils literal notranslate"><span class="pre">pam_unix</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/04.pam_cracklib.html">4.4.4.4. <code class="docutils literal notranslate"><span class="pre">pam_cracklib</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/05.pam_nologin.html">4.4.4.5. <code class="docutils literal notranslate"><span class="pre">pam_nologin</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/06.pam_access.html">4.4.4.6. <code class="docutils literal notranslate"><span class="pre">pam_access</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/07.pam_mail.html">4.4.4.7. <code class="docutils literal notranslate"><span class="pre">pam_mail</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/08.pam_limits.html">4.4.4.8. <code class="docutils literal notranslate"><span class="pre">pam_limits</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/09.pam_env.html">4.4.4.9. <code class="docutils literal notranslate"><span class="pre">pam_env</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/10.pam_umask.html">4.4.4.10. <code class="docutils literal notranslate"><span class="pre">pam_umask</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/11.pam_time.html">4.4.4.11. <code class="docutils literal notranslate"><span class="pre">pam_time</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/12.pam_succeed.html">4.4.4.12. <code class="docutils literal notranslate"><span class="pre">pam_succeed_if</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/13.pam_wheel.html">4.4.4.13. <code class="docutils literal notranslate"><span class="pre">pam_wheel</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/14.pam_userdb.html">4.4.4.14. <code class="docutils literal notranslate"><span class="pre">pam_userdb</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/15.pam_groups.html">4.4.4.15. <code class="docutils literal notranslate"><span class="pre">pam_group</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/16.pam_motd.html">4.4.4.16. <code class="docutils literal notranslate"><span class="pre">pam_motd</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/17.pam_issue.html">4.4.4.17. <code class="docutils literal notranslate"><span class="pre">pam_issue</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/18.pam_mkhomedir.html">4.4.4.18. <code class="docutils literal notranslate"><span class="pre">pam_mkhomedir</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/19.pam_mount.html">4.4.4.19. <code class="docutils literal notranslate"><span class="pre">pam_mount</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/20.pam_exec.html">4.4.4.20. <code class="docutils literal notranslate"><span class="pre">pam_exec</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/21.pam_listfile.html">4.4.4.21. <code class="docutils literal notranslate"><span class="pre">pam_listfile</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/22.pam_ssh.html">4.4.4.22. <code class="docutils literal notranslate"><span class="pre">pam_ssh</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="pam_modules/99.pam_sss.html">4.4.4.23. <code class="docutils literal notranslate"><span class="pre">pam_sss</span></code></a></li>
</ul>
</div>
</div>
<div class="section" id="ejemplo-ilustrativo">
<h2>4.4.5. Ejemplo ilustrativo<a class="headerlink" href="#ejemplo-ilustrativo" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El mejor método para entender cómo actúa <em>pam</em> es tomar algunos de sus ficheros
de configuración reales y analizarlos.</p>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Por hacer</p>
<p class="last">Revisar este apartado cuando se tenga configurado un servidor samba.</p>
</div>
<p>Empecemos con los ficheros <em>comunes</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> /etc/pam.d/common-auth

<span class="go">auth	[success=1 default=ignore]	pam_unix.so nullok_secure</span>
<span class="go">auth	requisite			pam_deny.so</span>
<span class="go">auth	required			pam_permit.so</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> /etc/pam.d/common-password

<span class="go">password	[success=1 default=ignore]	pam_unix.so obscure sha512</span>
<span class="go">password	requisite			pam_deny.so</span>
<span class="go">password	required			pam_permit.so</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> /etc/pam.d/common-account

<span class="go">account	[success=1 new_authtok_reqd=done default=ignore]	pam_unix.so </span>
<span class="go">account	requisite			pam_deny.so</span>
<span class="go">account	required			pam_permit.so</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> /etc/pam.d/common-session

<span class="go">session	[default=1]			pam_permit.so</span>
<span class="go">session	requisite			pam_deny.so</span>
<span class="go">session	required			pam_permit.so</span>
<span class="go">session	required	pam_unix.so </span>
</pre></div>
</div>
<p>Los ficheros los genera automáticamente <a class="reference internal" href="#pam-auth-update"><span class="std std-ref">pam-auth-update</span></a>, de ahí que sean algo más complicados de lo que podrían ser.
Los grupos <em>auth</em> y <em>password</em> tienen una estructura que hace que se prueben
sucesivamente distintos mecanismos de manera que si se tiene éxito se salta al
módulo <em>pam_permit</em> y si no se tiene se prueba con el siguiente. El fallo de
todos ellos hace que se acabe entrando en <em>pam_deny</em>, que malogra la
autenticación.</p>
<p>Por su parte, <code class="file docutils literal notranslate"><span class="pre">/etc/pam.d/sshd</span></code> tiene este contenido:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">@include common-auth</span>
<span class="go">account    required     pam_nologin.so</span>
<span class="go">@include common-account</span>
<span class="go">session [success=ok ignore=ignore module_unknown=ignore default=bad]        pam_selinux.so close</span>
<span class="go">session    required     pam_loginuid.so</span>
<span class="go">session    optional     pam_keyinit.so force revoke</span>
<span class="go">@include common-session</span>
<span class="go">session    optional     pam_motd.so  motd=/run/motd.dynamic</span>
<span class="go">session    optional     pam_motd.so noupdate</span>
<span class="go">session    optional     pam_mail.so standard noenv # [1]</span>
<span class="go">session    required     pam_limits.so</span>
<span class="go">session    required     pam_env.so # [1]</span>
<span class="go">session    required     pam_env.so user_readenv=1 envfile=/etc/default/locale</span>
<span class="go">session [success=ok ignore=ignore module_unknown=ignore default=bad]        pam_selinux.so open</span>
<span class="go">@include common-password</span>
</pre></div>
</div>
</div>
<div class="section" id="nss">
<span id="nsswitch"></span><span id="id2"></span><h2>4.4.6. NSS<a class="headerlink" href="#nss" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El servicio <abbr title="Name Service Switch">NSS</abbr> es una herramienta que permite
resolver nombres (de usuarios, de grupos, de máquinas, etc.) a través de
distintos mecanismos. Por ejemplo, en un sistema básico, gracias a este servicio
se obtiene la información sobre usuarios y grupos de los ficheros
<code class="file docutils literal notranslate"><span class="pre">/etc/passwd</span></code>, <code class="file docutils literal notranslate"><span class="pre">/etc/group</span></code> y <code class="file docutils literal notranslate"><span class="pre">/etc/shadow</span></code>. También gracias a
él se resuelven los nombres de máquinas acudiendo primero a <code class="file docutils literal notranslate"><span class="pre">/etc/hosts</span></code> y
a continuación a un servidor <em>dns</em>, si esta disponible. De hecho, el comando
<a class="reference internal" href="../../02.conbas/05.seguridad/05a.usuarios.html#getent"><span class="std std-ref">getent</span></a> usa este servicio para devolver sus resultados:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> getent passwd usuario
<span class="go">usuario:x:1000:1000:Usuario pedestre,,,:/home/usuario:/bin/bash</span>
<span class="gp">$</span> getent hosts choquereta
<span class="go">127.0.1.1       minilleta.domus minilleta choquereta.domus choquereta</span>
<span class="gp">$</span> getent hosts www.iescdl.es
<span class="go">80.32.8.158     www.iescdl.es</span>
</pre></div>
</div>
<p>No forma parte en absoluto de la <em>PAM</em> ni de la autenticación, pero está ligado
en la medida en que permite resolver cualquier nombre del sistema. De no
existir, el sistema sería incapaz de saber quiénes somos una vez dentro.</p>
<p>Su configuración se hace a través del fichero <code class="file docutils literal notranslate"><span class="pre">/etc/nsswitch.conf</span></code> que
tiene este aspecto:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># /etc/nsswitch.conf
#
# Example configuration of GNU Name Service Switch functionality.
# If you have the `glibc-doc-reference&#39; and `info&#39; packages installed, try:
# `info libc &quot;Name Service Switch&quot;&#39; for information about this file.

passwd:         compat
group:          compat
shadow:         compat
gshadow:        files

hosts:          files dns
networks:       files

protocols:      db files
services:       db files
ethers:         db files
rpc:            db files

netgroup:       nis
</pre></div>
</div>
<p>Obsérvese que se declaran los <em>objetos</em> (a la izquierda) y de dónde se obtendrá
su información (a la derecha). Para el caso de los usuarios (<em>passwd</em>, <em>group</em>,
etc.) la fuente son únicamente los ficheros locales<a class="footnote-reference" href="#id5" id="id3">[2]</a>, pero esta fuente no
tiene por qué ser única. Este es un sistema básico, pero incluso en un sistema
básico la resolución de nombres de máquinas tiene una doble fuente: el fichero
:<cite>/etc/hosts</cite> y el servicio <em>dns</em>. Por ese motivo, vemos la línea:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">hosts:          files dns</span>
</pre></div>
</div>
<p>El orden es importante. En este caso se mirará primero en los ficheros (o sea,
en <code class="file docutils literal notranslate"><span class="pre">/etc/hosts</span></code>) y si no existe en ellos, se pasará a intentar resolver a
través del servicio <em>dns</em>.</p>
<p class="rubric">Notas al pie</p>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Para la configuración <strong class="command">pam-auth-update</strong> usa <em>perfiles</em> que se
activan o desactivan a través del menú. Estos perfiles configuran distintos
aspectos de la configuración. Por ejemplo, la <em>autenticación unix</em> o la
<em>autenticación con LDAP</em> son perfiles distintos, de manera que si activamos
ambos, usaremos ambas fuentes para obtener usuarios válidos. La definición de
los perfiles se realiza a través de sendos ficheros contenidos en
<code class="file docutils literal notranslate"><span class="pre">/usr/share/pam-configs</span></code>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>La razón de que diga <code class="code docutils literal notranslate"><span class="pre">compat</span></code> y no <code class="code docutils literal notranslate"><span class="pre">files</span></code> es la <em>compat</em>ilibidad con una sintaxis particular de los ficheros <code class="file docutils literal notranslate"><span class="pre">/etc/passwd</span></code>,
etc. que permite añadir a los usuarios y grupos locales los definidos a
través de un servidor <a class="reference external" href="https://es.wikipedia.org/wiki/Network_Information_Service">NIS</a>.  Sin embargo,
esto mismo se puede lograr con <code class="code docutils literal notranslate"><span class="pre">files</span> <span class="pre">nis</span></code> sin necesidad de tal sintaxis
y, además, este servidor ha caído en desuso ante soluciones como <em>LDAP</em> o <em>samba</em>.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4.4. Autenticación</a><ul>
<li><a class="reference internal" href="#estructura">4.4.1. Estructura</a></li>
<li><a class="reference internal" href="#funcionamiento">4.4.2. Funcionamiento</a></li>
<li><a class="reference internal" href="#sintaxis">4.4.3. Sintaxis</a></li>
<li><a class="reference internal" href="#modulos">4.4.4. Módulos</a></li>
<li><a class="reference internal" href="#ejemplo-ilustrativo">4.4.5. Ejemplo ilustrativo</a></li>
<li><a class="reference internal" href="#nss">4.4.6. NSS</a></li>
</ul>
</li>
</ul>

  <h4>Tema anterior</h4>
  <p class="topless"><a href="../08.monitorizacion/03.nagios/index.html"
                        title="capítulo anterior">4.3.3. Sistema de monitorización (nagios)</a></p>
  <h4>Próximo tema</h4>
  <p class="topless"><a href="pam_modules/01.pam_permit.html"
                        title="próximo capítulo">4.4.4.1. <code class="docutils literal notranslate"><span class="pre">pam_permit</span></code></a></p>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/04.servidor/09.autenticacion/index.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Ir a" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="pam_modules/01.pam_permit.html" title="4.4.4.1. pam_permit"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="../08.monitorizacion/03.nagios/index.html" title="4.3.3. Sistema de monitorización (nagios)"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >4. Gestión del servidor</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2020, José Miguel Sánchez Alés.
      Creado con <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>