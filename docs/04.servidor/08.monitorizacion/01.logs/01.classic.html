


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="es">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>4.3.1.1. Sistema tradicional &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Índice" href="../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../search.html" />
    <link rel="next" title="4.3.1.2. SystemD" href="02.journalctl.html" />
    <link rel="prev" title="4.3.1. Ficheros logs" href="index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="02.journalctl.html" title="4.3.1.2. SystemD"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="index.html" title="4.3.1. Ficheros logs"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >4. Gestión del servidor</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" >4.3. Monitorización</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="index.html" accesskey="U">4.3.1. Ficheros <em>logs</em></a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="sistema-tradicional">
<span id="rsyslog"></span><h1>4.3.1.1. Sistema tradicional<a class="headerlink" href="#sistema-tradicional" title="Enlazar permanentemente con este título">¶</a></h1>
<p>En este sistema los registros se almacenan bajo <code class="file docutils literal notranslate"><span class="pre">/var/log</span></code> a través de una
doble vía:</p>
<ol class="arabic simple">
<li>Los mensajes de algunas aplicaciones se envían a un demonio encargado de
procesarlos para que este los escriba en el <em>log</em> correspondiente.</li>
<li>Otras aplicaciones escriben directamente los mensajes en sus propios
ficheros de registro (que, por lo general, también están bajo
<code class="file docutils literal notranslate"><span class="pre">/var/log</span></code>).</li>
</ol>
<p>En los sistemas <em>debian</em> este demonio se llama <strong class="command">rsyslog</strong>, que es una
variante avanzada del tradicional <strong class="command">syslogd</strong>. El resto del epígrafe se
dedicará a describir cómo se clasifican los <em>logs</em> y qué hace con ellos el
deminio que los gestiona.</p>
<div class="section" id="clasificacion">
<h2>4.3.1.1.1. Clasificación<a class="headerlink" href="#clasificacion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Es obvio que todos los mensajes ni tienen la misma naturaleza ni tienen la misma
gravedad. Por este motivo, cada mensaje es de una determinada <em>facility</em> (o sea,
de una determinada categoría o naturaleza, si queremos traducir libremente al
término inglés) y de un determinado nivel.</p>
<p>Según su naturaleza los mensajes pueden ser de los siguientes tipos:</p>
<table border="1" class="docutils" id="id8">
<caption><span class="caption-text"><strong>Categorías (facility)</strong></span><a class="headerlink" href="#id8" title="Enlace permanente a esta tabla">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="11%" />
<col width="8%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Código</th>
<th class="head">Término</th>
<th class="head">Linux</th>
<th class="head">Descripción</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td>kern</td>
<td>Sí</td>
<td>Mensajes del núcleo</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>user</td>
<td>Sí</td>
<td>Mensajes de procesos de usuario</td>
</tr>
<tr class="row-even"><td>2</td>
<td>mail</td>
<td>Sí</td>
<td>Mensajes del sistema de correo</td>
</tr>
<tr class="row-odd"><td>3</td>
<td>daemon</td>
<td>Sí</td>
<td>Mensajes de los demonios del sistema</td>
</tr>
<tr class="row-even"><td>4</td>
<td>auth</td>
<td>Sí</td>
<td>Mensajes de procesos de autenticación<a class="footnote-reference" href="#id4" id="id1">[1]</a></td>
</tr>
<tr class="row-odd"><td>5</td>
<td>syslog</td>
<td>Sí</td>
<td>Mensajes del propio sistema de <em>logs</em></td>
</tr>
<tr class="row-even"><td>6</td>
<td>lpr</td>
<td>Sí</td>
<td>Mensajes del sistema de impresión</td>
</tr>
<tr class="row-odd"><td>7</td>
<td>news</td>
<td>Sí</td>
<td>Mensajes del sistema encargado de acceder a USENET<a class="footnote-reference" href="#id5" id="id2">[2]</a></td>
</tr>
<tr class="row-even"><td>8</td>
<td>uucp</td>
<td>Sí</td>
<td>Mensajes relacionados con el antiguo protocolo <em>UUCP</em></td>
</tr>
<tr class="row-odd"><td>9</td>
<td>cron</td>
<td>Sí</td>
<td>Mensajes de los demonios de planificación de tareas.</td>
</tr>
<tr class="row-even"><td>10</td>
<td>authpriv</td>
<td>Sí</td>
<td>Mensajes de procesos de autenticación</td>
</tr>
<tr class="row-odd"><td>11</td>
<td>ftp</td>
<td>Sí</td>
<td>Mensaje del servicio de FTP.</td>
</tr>
<tr class="row-even"><td>12</td>
<td>ntp</td>
<td>No</td>
<td>Mensajes del servicio NTP.</td>
</tr>
<tr class="row-odd"><td>13</td>
<td>logaudit</td>
<td>No</td>
<td>Mensajes del servicio <a class="reference internal" href="../02.audit/index.html#audit"><span class="std std-ref">audit</span></a>.</td>
</tr>
<tr class="row-even"><td>14</td>
<td>logalert</td>
<td>No</td>
<td>log alert</td>
</tr>
<tr class="row-odd"><td>15</td>
<td>clock</td>
<td>No</td>
<td>Mensajes del demonio del reloj.</td>
</tr>
<tr class="row-even"><td>16</td>
<td>local0</td>
<td>Sí</td>
<td>Uso local (0)</td>
</tr>
<tr class="row-odd"><td>17</td>
<td>local1</td>
<td>Sí</td>
<td>Uso local (1)</td>
</tr>
<tr class="row-even"><td>18</td>
<td>local2</td>
<td>Sí</td>
<td>Uso local (2)</td>
</tr>
<tr class="row-odd"><td>19</td>
<td>local3</td>
<td>Sí</td>
<td>Uso local (3)</td>
</tr>
<tr class="row-even"><td>20</td>
<td>local4</td>
<td>Sí</td>
<td>Uso local (4)</td>
</tr>
<tr class="row-odd"><td>21</td>
<td>local5</td>
<td>Sí</td>
<td>Uso local (5)</td>
</tr>
<tr class="row-even"><td>22</td>
<td>local6</td>
<td>Sí</td>
<td>Uso local (6)</td>
</tr>
<tr class="row-odd"><td>23</td>
<td>local7</td>
<td>Sí</td>
<td>Uso local (7)</td>
</tr>
</tbody>
</table>
<p>Y según su nivel:</p>
<table border="1" class="docutils" id="id9">
<caption><span class="caption-text"><strong>Nivel (level)</strong></span><a class="headerlink" href="#id9" title="Enlace permanente a esta tabla">¶</a></caption>
<colgroup>
<col width="9%" />
<col width="9%" />
<col width="81%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Valor</th>
<th class="head">Término</th>
<th class="head">Descripción</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td>emerg</td>
<td>Aciso de circunstancia que vuelve inservible el sistema.</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>alert</td>
<td>Aviso de circunstancia que debe ser inmediatamente subsanada.</td>
</tr>
<tr class="row-even"><td>2</td>
<td>crit</td>
<td>Aviso de error crítico.</td>
</tr>
<tr class="row-odd"><td>3</td>
<td>err</td>
<td>Aviso de error.</td>
</tr>
<tr class="row-even"><td>4</td>
<td>warning</td>
<td>Advertencia de que algo puede ir mal o acabar mal.</td>
</tr>
<tr class="row-odd"><td>5</td>
<td>notice</td>
<td>Notificación de que ocurre algo anormal.</td>
</tr>
<tr class="row-even"><td>6</td>
<td>info</td>
<td>Notificación de funcionamiento normal.</td>
</tr>
<tr class="row-odd"><td>7</td>
<td>debug</td>
<td>Notificaciones para depurar el comportamiento de un programa.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="ficheros">
<h2>4.3.1.1.2. Ficheros<a class="headerlink" href="#ficheros" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Bajo <code class="file docutils literal notranslate"><span class="pre">/var/log</span></code> hay distintos ficheros: algunos debidos a la activdad de
servicios que escriben sus propios registros al margen de <strong class="command">rsyslogd</strong> y
otros debidos a la actividad de este.</p>
<p>En principio, <strong class="command">rsyslog</strong> registra todos los mensajes en el fichero
<strong class="command">/var/log/syslog</strong>, pero mediante su <a class="reference internal" href="#rsyslog-conf"><span class="std std-ref">configuración</span></a>
puede hacerse que los mensajes dependiendo de su categoría y nivel se escriban
en uno u otro fichero particular. Lo habitual es lo siguiente:</p>
<dl class="docutils">
<dt><code class="file docutils literal notranslate"><span class="pre">syslog</span></code></dt>
<dd>Contiene todos los mensajes, excepto los de autenticación.</dd>
<dt><code class="file docutils literal notranslate"><span class="pre">auth.log</span></code></dt>
<dd>Contiene los mensajes de autenticación.</dd>
<dt><code class="file docutils literal notranslate"><span class="pre">kern.log</span></code></dt>
<dd>Contiene todos los mensajes del núcleo<a class="footnote-reference" href="#id6" id="id3">[3]</a>.</dd>
<dt><code class="file docutils literal notranslate"><span class="pre">messages</span></code></dt>
<dd>Contiene los mensajes del núcleo de los niveles 4-6 (<em>warning</em>, <em>notice</em> e
<em>info</em>).</dd>
<dt><code class="file docutils literal notranslate"><span class="pre">daemon.log</span></code></dt>
<dd>Contiene los mensajes de la <em>facility</em> <em>daemon</em>.</dd>
<dt><code class="file docutils literal notranslate"><span class="pre">mail.log</span></code></dt>
<dd>Contiene todos los mensajes relativos al funcionamiento del servicio de
correo. Hay otros, <code class="file docutils literal notranslate"><span class="pre">mail.info</span></code>, <code class="file docutils literal notranslate"><span class="pre">mail.err</span></code> y <code class="file docutils literal notranslate"><span class="pre">mail.warn</span></code>
que almacenan su <em>facility</em> correspondiente.</dd>
<dt><code class="file docutils literal notranslate"><span class="pre">user.log</span></code></dt>
<dd>Contiene todos los mensajes de las aplicaciones de usuario.</dd>
<dt><code class="file docutils literal notranslate"><span class="pre">lpr.log</span></code></dt>
<dd>Contiene todos los mensajes referentes al servicio de impresión.</dd>
</dl>
<p>Esta es la configuración pretederminada en <em>debian</em>. El resto de ficheros que
encontramos, bien se debe a que se haya alterado esta configuración, bien a que
haya otros servicios que registren por su cuenta. Dentro de <code class="file docutils literal notranslate"><span class="pre">/var/log</span></code> y
entre los ficheros que no gestiona <em>rsyslog</em>, se cuentan:</p>
<dl class="docutils">
<dt><code class="file docutils literal notranslate"><span class="pre">btmp</span></code></dt>
<dd>Que registra los accesos fallidos al sistema.</dd>
<dt><code class="file docutils literal notranslate"><span class="pre">wtmp</span></code></dt>
<dd>Que registra los accesos al sistema.</dd>
</dl>
<p id="index-0">Estos ficheros, a diferencia de los restantes, tienen un formato binario y
pueden leerse a través del comando <strong class="command">utmpdump</strong>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> utmpdump /var/log/btmp <span class="p">|</span> more
</pre></div>
</div>
</div>
<div class="section" id="consulta">
<span id="rsyslog-conf"></span><h2>4.3.1.1.3. Consulta<a class="headerlink" href="#consulta" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Los registros son ficheros de texto plano de modo que el acceso a los mensajes
se puede realizar con cualquier orden que permite acceder a su contenido. El
simple <a class="reference internal" href="../../../02.conbas/02.informacion/03.ficheros.html#cat"><span class="std std-ref">cat</span></a> (o <a class="reference internal" href="../../../02.conbas/02.informacion/03.ficheros.html#more"><span class="std std-ref">more</span></a> o <a class="reference internal" href="../../../02.conbas/02.informacion/03.ficheros.html#less"><span class="std std-ref">less</span></a>, si se quiere
paginar) sirve para este propósito. Sin embargo, estos ficheros suelen contener
gran cantidad de mensajes de distintos servicios, por lo que lo más adecuado es
buscar herramientas que nos permitan filtrar mediante el uso de expresiones
regulares.</p>
<p>Para esta labor de filtrado, conviene conocer cuál es el formato que el demonio
da a estos mensajes. Tal formato se puede configurar al gusto, pero <em>rsyslog</em>
tiene configuradas algunas plantillas de las cuales la predefinida en <em>debian</em>
es <span class="var">RSYSLOG_TradicionalFileFormat</span>, que presenta el siguiente aspecto:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&lt;fecha y hora&gt; &lt;nombre_maquina&gt; &lt;nombre_proceso&gt;[&lt;PID&gt;]: &lt;texto del mensaje&gt;</span>
</pre></div>
</div>
<p>Cuando filtramos, necesitamos conocer cuál es el fichero adecuado y cuál es el
conjunto de mensajes que deseamos ver. Por ejemplo, si nuestra intención fuera
mirar los mensajes que genera el servidor <em>DHCP</em>, podríamos filtrar del
siguiente modo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> egrep <span class="s1">&#39;\bdhcpd\b&#39;</span> /var/log/syslog <span class="p">|</span> more
</pre></div>
</div>
<p>La información que obtenemos de los registros puede ser muy precisa: basta con
ser capaz de formar la expresión regular adecuada. Por ejemplo, todas las IP
que ha concedido el servidor DHCP podrían mostrarse de esta forma:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> sed -r <span class="s1">&#39;/\bdhcpd\b.*DHCPACK on/!d ; s:.*DHCPACK on ([^ ]+).*:\1:&#39;</span> /var/log/syslog <span class="p">|</span> sort <span class="p">|</span> uniq
</pre></div>
</div>
<p>Aunque hay que tener cierto espíritu crítico con lo obtenido. Saldrán en este
listado todas las IPs concedidas desde que se empezó a escribir el fichero, con
lo que el listado puede no coincidir en absoluto con direcciones IP ocupadas.</p>
</div>
<div class="section" id="configuracion">
<h2>4.3.1.1.4. Configuración<a class="headerlink" href="#configuracion" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="admonition note" id="logger">
<p class="first admonition-title">Nota</p>
<p>Para hacer probaturas es muy útil el <span class="target" id="index-1"></span>comando
<strong class="command">logger</strong> que permite enviar al demonio mensajes de la categoría y
nivel que indiquemos:</p>
<div class="last highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> logger -p mail.info -s <span class="s2">&quot;Esto es un mensaje manual que escribo yo&quot;</span>
</pre></div>
</div>
</div>
<p>El demonio lee su configuración del fichero <code class="file docutils literal notranslate"><span class="pre">/etc/rsyslog.conf</span></code>. Sin
embargo, puede tener una directiva <em>IncludeConfig</em> que permite leer el
contenido de otros ficheros, de suerte que es común que también exista un
directorio <code class="file docutils literal notranslate"><span class="pre">/etc/rsyslog.d</span></code>, en el que incluir configuración adicional de
forma modular.</p>
<p>Otro aspecto a tener en cuenta en la definición de este fichero es que desde la
versión <em>6</em>, hay dos sintaxis para el fichero, la tradicional y una nueva.</p>
<div class="section" id="tradicional">
<h3>4.3.1.1.4.1. Tradicional<a class="headerlink" href="#tradicional" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Existen tres tipos de líneas:</p>
<ul class="simple">
<li>Los comentarios, que todas aquellas líneas que empiezan por un asterisco.</li>
<li>Las directivas que empiezan por un dolar.</li>
<li>Las reglas que permiten indicar qué hacer con cada mensaje.</li>
</ul>
<div class="section" id="directivas">
<h4>4.3.1.1.4.1.1. Directivas<a class="headerlink" href="#directivas" title="Enlazar permanentemente con este título">¶</a></h4>
<p>Hay de muy diversos tipos. Algunas muy útiles son:</p>
<ol class="arabic">
<li><p class="first">Hacer escuchar al demonio en un <em>socket</em> adicional (útil cuando tenemos
demonios enjaulados):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>AddUnixListenSocket /var/spool/postfix/dev/log
</pre></div>
</div>
</li>
<li><p class="first">Define el propietario y los permisos de los ficheros (y directorios) que
puedan crear las <em>acciones</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> Definimos esta máscara inicial para que
<span class="gp">#</span> los permisos definidos a continuación sean
<span class="gp">#</span> los que expresamente indicamos.
<span class="gp">$</span>Umask <span class="m">0000</span>
<span class="gp">$</span>FileOwner root
<span class="gp">$</span>FileGroup adm
<span class="gp">$</span>FileCreateMode <span class="m">0640</span>
<span class="gp">$</span>DirCreateMode <span class="m">0755</span>
</pre></div>
</div>
<p>Estas directivas afectan a todas las acciones que tengan por debajo.
Pueden volver a definirse más adelante otra vez y, en ese caso, afectarán
a las <em>acciones</em> que se añadan a continuación. Por ejemplo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>FileCreateMode <span class="m">0640</span>
<span class="go">*.*     /var/log/log1</span>

<span class="gp">$</span>FileCreateMode <span class="m">0644</span>
<span class="go">*.*     /var/log/log2</span>
</pre></div>
</div>
<p><code class="file docutils literal notranslate"><span class="pre">log1</span></code> se creará con permisos <em>0640</em> y <code class="file docutils literal notranslate"><span class="pre">log2</span></code> con permisos
<em>0644</em>.</p>
</li>
<li><p class="first">Cargar los ficheros contenidos en <code class="file docutils literal notranslate"><span class="pre">/etc/rsyslog.d</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>IncludeConfig /etc/rsyslog.d/*.conf
</pre></div>
</div>
</li>
<li><p class="first">Define una plantilla predeterminada para el formato de línea de los
ficheros:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="reglas">
<h4>4.3.1.1.4.1.2. Reglas<a class="headerlink" href="#reglas" title="Enlazar permanentemente con este título">¶</a></h4>
<p>Las reglas indican qué se hará con cada mensaje. Cada regla consta de dos
partes: el <em class="dfn">selector</em>, que indica a qué mensajes afecta; y la
<em class="dfn">acción</em>, qeu indica qué hacer (habitualmente, escribirlos en un
fichero de registro bajo <code class="file docutils literal notranslate"><span class="pre">/var/log</span></code>.</p>
<p>Para seleccionar mensajes se usan la categoría y el nivel:</p>
<ul>
<li><p class="first">Todos los mensajes:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">*.*</span>
</pre></div>
</div>
</li>
<li><p class="first">Todos los mensajes de nivel <em>info</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">*.=info</span>
</pre></div>
</div>
</li>
<li><p class="first">Todos los mensajes hasta el nivel <em>info</em> (es decir, que sólo quedan fuera
los de nivel debug*):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">*.info</span>
</pre></div>
</div>
</li>
<li><p class="first">Todos los mensajes de la categoría <em>mail</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mail.*</span>
</pre></div>
</div>
</li>
<li><p class="first">Los mensajes de la categoría <em>mail</em> y la prioridad <em>info</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mail.=info</span>
</pre></div>
</div>
</li>
<li><p class="first">Todos los mensajes de las categorías <em>mail</em> y <em>news</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mail,news.*</span>
</pre></div>
</div>
</li>
<li><p class="first">Los mensajes de las categorías <em>mail</em> y <em>news</em> hasta <em>notice</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mail,news.notice</span>
</pre></div>
</div>
</li>
<li><p class="first">Los mensajes de la categoría <em>mail</em> y nivel <em>info</em>,  y de la categoría
<em>news</em> y nivel <em>err</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mail.info;news.=err</span>
</pre></div>
</div>
</li>
</ul>
<p>Este último ejemplo muestra como hacer la unión de dos selectores
independientes: separarlos con punto y coma. Ahora bien hay forma también de
hacer la diferencia entre dos selectores. Para ello hay que seleccionar primero
un conjunto de mensajes y, tras el punto y coma, seleccionar otro conjunto que
lo contiene, añadiendo a la parte correspondiente al nivel la exclamación (<code class="docutils literal notranslate"><span class="pre">!</span></code>)
o el nivel especial <em>none</em>, que implica que se desechan todos los mensajes de la
categoría:</p>
<ul>
<li><p class="first">Todos los mensajes exceptos los de <em>authpriv</em> y <em>auth</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">*.*;auth,authpriv.none</span>
</pre></div>
</div>
</li>
<li><p class="first">Todos los mensajes, excepto los de la depuración:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">*.*;*.!=debug</span>
</pre></div>
</div>
</li>
<li><p class="first">Todos los mensajes, excepto los de <em>news</em> hay que estén entre el nivel
<em>emerg</em> al nivel <em>warning</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">*.*;*.!warning</span>
</pre></div>
</div>
</li>
</ul>
<p>Por su parte la acción, si lo que se quiere es enviar los ficheros exige
escribir la ruta absoluta. Una regla completa quedaría pues así:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">auth,authpriv.*       /var/log/auth.log</span>
</pre></div>
</div>
<p>A veces se encuentra antepuesto un signo menos (<code class="docutils literal notranslate"><span class="pre">-</span></code>) a la ruta. Esto indicaba
que se quería deshabilitar la sincronización del fichero en cada escritura. En
las versiones modernas de <em>rsyslog</em> la sincronización está deshabilitada por
defecto, con lo que el signo, no tiene ninguna relevancia.</p>
<p>Es importante tener presente que el hecho de que un mensaje se seleccione en una
regla, no significa que el demonio ejecute la acción y deje de probar las reglas
siguientes. Por ejemplo, las líneas:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">auth,authpriv.*        /var/log/auth.log</span>
<span class="go">*.*                    /var/log/syslog</span>
</pre></div>
</div>
<p>provocarían que los mensajes relacionados con la autenticación se escribieran
también en <code class="file docutils literal notranslate"><span class="pre">/var/sys/log</span></code>. Ahora bien, si se usa como acción la virgulilla
(<code class="docutils literal notranslate"><span class="pre">~</span></code>), entonces sí se desechan los mensajes:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">auth,authpriv.*        /var/log/auth.log</span>
<span class="go">auth,authoriv.*        ~</span>
<span class="go">*.*                    /var/log/syslog</span>
</pre></div>
</div>
<p>Sí impediría que se escribieran los mensajes en el segundo registro (y en todos
los que se mentaran sucesivamente).</p>
<p>Además, se puede sustituir el selector por el ampersand (<code class="docutils literal notranslate"><span class="pre">&amp;</span></code>), lo que
significa que para la nueva acción se usará el mismo selector que para la
anterior. las siguientes líneas tienen el mismo efecto que las anteriores:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">auth,authpriv.*        /var/log/auth.log</span>
<span class="go">      &amp;                ~</span>
<span class="go">*.*                    /var/log/syslog</span>
</pre></div>
</div>
<p>Por último, para usar un formato de línea distinto en un fichero en particular
puede usarse la siguiente sintaxis:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">auth,authpriv.*        /var/log/auth.log;RSYSLOG_TraditionalFileFormat</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-2">
<p class="first admonition-title">Por hacer</p>
<p class="last">Filtros más complejos</p>
</div>
</div>
<div class="section" id="nuevo-formato">
<h4>4.3.1.1.4.1.3. Nuevo formato<a class="headerlink" href="#nuevo-formato" title="Enlazar permanentemente con este título">¶</a></h4>
<p>A partir de su versión 6, <em>rsyslog</em> usa un nuevo formato (<em>RainerScript</em>) para
escribir su configuración, aunque se puede seguir usando el antiguo e incluso
incluir sentencias de uno u otro estilo dentro del mismo fichero.</p>
<div class="admonition-todo admonition" id="index-3">
<p class="first admonition-title">Por hacer</p>
<p class="last">Escribir una pequeña guía al respecto.</p>
</div>
<span class="target" id="logrotate"></span></div>
</div>
</div>
<div class="section" id="rotacion">
<span id="index-4"></span><h2>4.3.1.1.5. Rotación<a class="headerlink" href="#rotacion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Los registros dentro de <code class="file docutils literal notranslate"><span class="pre">/var/log</span></code> son persistentes, de manera que crecen
indefinidamente, a menos que pongamos los medios para evitarlo. Con este
propósito existe el servicio <strong class="command">logrotate</strong>.</p>
<p>La <em class="dfn">rotación de logs</em> consiste en copiar cada cierto tiempo los registros
antiguos a otro fichero y vaciar el fichero de registro. Por ejemplo, supongamos
que definimos que todos los días se realiza esta rotación. En ese caso ocurrirá
lo siguiente:</p>
<ul class="simple">
<li>El primer día tendremos un único fichero <code class="file docutils literal notranslate"><span class="pre">syslog</span></code>.</li>
<li>El segundo día tendremos dos ficheros <code class="file docutils literal notranslate"><span class="pre">syslog.1</span></code>, que contendrá los
registros del día anterior; y <code class="file docutils literal notranslate"><span class="pre">syslog</span></code>, sin estos registros, empezará
a recoger los del día presente.</li>
<li>El tercer día, se comprimirá y renombrará <code class="file docutils literal notranslate"><span class="pre">syslog.1</span></code> a
<code class="file docutils literal notranslate"><span class="pre">syslog.2.gz</span></code>, el contenido de <code class="file docutils literal notranslate"><span class="pre">syslog</span></code> pasará a
<code class="file docutils literal notranslate"><span class="pre">syslog.1</span></code> y, una vez vaciado <code class="file docutils literal notranslate"><span class="pre">syslog</span></code> se comenzará a
registrar en él.</li>
<li>El proceso antes descrito se repite todos los días, de manera que cada vez
aparecen más ficheros que almacenan registros antiguos de <code class="file docutils literal notranslate"><span class="pre">syslog</span></code>.
Sin embargo, al programa de <em>rotación</em> se le puede indicar un límite máximo
de manera que, pasado este, se desecharán los registros. Si este límite
fueran diez días, entonces nunca se llegaría a crear <code class="file docutils literal notranslate"><span class="pre">syslog.10.gz</span></code>.</li>
</ul>
<p><strong class="command">logrotate</strong> no es un demonio que se ejecute permanentemente en el
ordenador, sino que en <code class="file docutils literal notranslate"><span class="pre">/etc/cron.daily</span></code> hay un <em>script</em> que lo invoca a
diario. Su configuración se hace en <code class="file docutils literal notranslate"><span class="pre">/etc/logrotate.conf</span></code> o, de forma
modular, en ficheros creados dentro de <code class="file docutils literal notranslate"><span class="pre">/etc/logrotate.d</span></code>.</p>
<p>En <code class="file docutils literal notranslate"><span class="pre">logrotate.conf</span></code> suele guardarse la configuración predeterminada para
la rotación, mientras que en cada fichero de file:<cite>/etc/logrotate.d</cite> se guarda
la configuración particular para un registro que no queremos que siga la
predeterminada. Es bastante común que los paquetes de aplicaciones que generan
<em>logs</em> incluyan un fichero particular para los suyos propios.</p>
<p>En <code class="file docutils literal notranslate"><span class="pre">/etc/logrotate.conf</span></code> podríamos encontrar el siguiente contenido:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> Rotación semanal
<span class="go">weekly</span>

<span class="gp">#</span> Conserva <span class="m">4</span> semanas
<span class="go">rotate 4</span>

<span class="gp">#</span> Compresión <span class="o">(</span>con xz, pero no se comprime por defecto<span class="o">)</span>
<span class="gp">#</span>compress
<span class="go">compresscmd /usr/bin/xz</span>
<span class="go">compressext .xz</span>

<span class="gp">#</span> Ficheros de configuración modular:
<span class="go">include /etc/logrotate.d</span>

<span class="gp">#</span> Rotación para los ficheros wtmp y btmp
<span class="gp">#</span> <span class="o">[</span>...<span class="o">]</span>
</pre></div>
</div>
<p>La rotación de los registros de cada servicio es probable que la encontremos en
un fichero propio dentro de <code class="file docutils literal notranslate"><span class="pre">/etc/logrotate.d</span></code>. Por ejemplo:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> /etc/logrotate.d/apt

<span class="go">/var/log/apt/*.log {</span>
<span class="go">   rotate 12</span>
<span class="go">   monthly</span>
<span class="go">   compress</span>
<span class="go">   notifempty</span>
<span class="go">}</span>
</pre></div>
</div>
<p>En este ejemplo, cualquier fichero <em>log</em> dentro de <code class="file docutils literal notranslate"><span class="pre">/var/log/apt</span></code>,
queremos que rote mensualmente (<em>monthly</em>), que se compriman los registros
rotados, y que si el fichero de log está vacío, no se realice rotación
(<em>notifempty</em>).</p>
<p>Algunas de las directivas que podemos incluir son las siguientes:</p>
<dl class="docutils">
<dt><code class="code docutils literal notranslate"><span class="pre">hourly</span></code>, <code class="code docutils literal notranslate"><span class="pre">daily</span></code>, <code class="code docutils literal notranslate"><span class="pre">weekly</span></code>, <code class="code docutils literal notranslate"><span class="pre">monthly</span></code>, <code class="code docutils literal notranslate"><span class="pre">yearly</span></code></dt>
<dd>Frecuencia con la que se realizará la rotación.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">copytruncate</span></code></dt>
<dd>En vez de mover el fichero y crear uno nuevo, hace copia y trunca a 0. Con
esto se consigue que el fichero en el que el servicio apunta los registros
sea el mismo, lo cual es necesario si el servicio está activo en todo momento
y no podemos reiniciarlo.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">create</span></code> &lt;permisos&gt; &lt;usuario&gt; &lt;grupo&gt;</dt>
<dd><p class="first">Indica cómo crear el nuevo fichero después de haber movido el anterior:</p>
<div class="last highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">create 0640 root adm</span>
</pre></div>
</div>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">delaycompress</span></code></dt>
<dd>Retrasa un ciclo la compresión. Esto hace que la rotación <em>.1</em> no esté
comprimida.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">maxsize</span></code> &lt;tamaño&gt;</dt>
<dd><p class="first">Tamaño máximo en bytes que puede alcanzar el registro. Si lo alcanza, se
rotará el fichero, aunque no se haya cumplido la frencuencia. Pueden
usarse las unidades <em>k</em>, <em>M</em> o <em>G</em>:</p>
<div class="last highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">maxsize 1M</span>
</pre></div>
</div>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">minsize</span></code> &lt;tamaño&gt;</dt>
<dd>Tamaño mínimo en bytes a partir del cual se procederá a la rotación. Si no se
ha llegado a este tamaño, no se rotará, aunque toque según la frecuencia.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">size</span></code> &lt;tamaño&gt;</dt>
<dd>Tamaño a partir del cual se procederá a la rotación. La diferencia con
<em>maxsize</em> es que con esta opción no se atiende a la frecuencia en absoluto.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">missingok</span></code></dt>
<dd>Si no existe el fichero <em>log</em> no se produce ningún error.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">rotate</span></code> N</dt>
<dd>Número de rotaciones que sufren los registros.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">prerotate</span></code>/<code class="code docutils literal notranslate"><span class="pre">endscript</span></code></dt>
<dd>Ejecuta las órdenes entre estas dos directivas antes de proceder a la
rotación.</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">postrotate</span></code>/<code class="code docutils literal notranslate"><span class="pre">endscript</span></code></dt>
<dd><p class="first">Ejecuta las órdenes entre estas dos directivas tras realizar a la
rotación:</p>
<div class="last highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">postrotate</span>
<span class="go">   invoke-rc.d nginx rotate &gt;/dev/null 2&gt;&amp;1</span>
<span class="go">endscript</span>
</pre></div>
</div>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">sharedscripts</span></code></dt>
<dd>Está relacionado con las dos directivas anteriores. Cuando se incluye, no
ejecuta los comandos para la rotación de cada fichero, sino una sola vez para
todos los ficheros que se han expresado en el bloque.</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Es preciso indicar explícitamente a través de la configuración que se
quiere rotar un fichero de registro. Dicho de otro modo, <strong class="command">logrotate</strong>
no rota cualquier fichero que se encuentre bajo <code class="file docutils literal notranslate"><span class="pre">/var/log</span></code>, sino sólo
aquellos explicitamente citados en su configuración.</p>
</div>
<p class="rubric">Notas al pie</p>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Citado en la página de manual de <em>syslog</em>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Hay otra categoría, <em>authpriv</em>, para mensajes de este mismo tipo. La
página de manual de <em>syslog</em> indica que se desaprueba el uso de <em>auth</em> en
favor de <em>authpriv</em>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="https://es.wikipedia.org/wiki/Usenet">USENET</a> ha ido en los últimos
años reduciendo significativamente su tráfico ante el empuje de la web (los
foros ocupan su mismo nicho de servicio). Pero hemos de tener en cuenta que
todo este sistema que se explica se ideó a principio de los años 80.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[4]</td><td><p class="first">Los mensajes del núcleo también pueden ser revisados gracias al
index:<cite>comando &lt;dmesg&gt;</cite> <strong class="command">dmesg</strong>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> dmesg
</pre></div>
</div>
<p>En <em>jessie</em>, la consulta con <strong class="command">dmesg</strong> puede realizarla cualquier
usuario. Sin embargo, en <em>stretch</em> requerirá los permisos de <em>root</em>.</p>
<p class="last">Otro aspecto a tener en cuenta es que <strong class="command">dmesg</strong> puede no mostrar todos
los mensajes desde el arranque, ya que lo que hace es leer del <em>buffer</em>
circular del núcleo.  Como todo <em>búffer</em> circular, tiene un tamaño fijo, de
manera que al llenarse por completo, comienza a reescribir las primeras
entradas. Para ver todos los mensajes hay que recurrir a la lectura de
<code class="file docutils literal notranslate"><span class="pre">/var/log/kern.log</span></code>, que, además, al ser persistente, podrá contener
mensajes de arranques anteriores.</p>
</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4.3.1.1. Sistema tradicional</a><ul>
<li><a class="reference internal" href="#clasificacion">4.3.1.1.1. Clasificación</a></li>
<li><a class="reference internal" href="#ficheros">4.3.1.1.2. Ficheros</a></li>
<li><a class="reference internal" href="#consulta">4.3.1.1.3. Consulta</a></li>
<li><a class="reference internal" href="#configuracion">4.3.1.1.4. Configuración</a><ul>
<li><a class="reference internal" href="#tradicional">4.3.1.1.4.1. Tradicional</a><ul>
<li><a class="reference internal" href="#directivas">4.3.1.1.4.1.1. Directivas</a></li>
<li><a class="reference internal" href="#reglas">4.3.1.1.4.1.2. Reglas</a></li>
<li><a class="reference internal" href="#nuevo-formato">4.3.1.1.4.1.3. Nuevo formato</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#rotacion">4.3.1.1.5. Rotación</a></li>
</ul>
</li>
</ul>

  <h4>Tema anterior</h4>
  <p class="topless"><a href="index.html"
                        title="capítulo anterior">4.3.1. Ficheros <em>logs</em></a></p>
  <h4>Próximo tema</h4>
  <p class="topless"><a href="02.journalctl.html"
                        title="próximo capítulo">4.3.1.2. SystemD</a></p>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/04.servidor/08.monitorizacion/01.logs/01.classic.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Ir a" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="02.journalctl.html" title="4.3.1.2. SystemD"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="index.html" title="4.3.1. Ficheros logs"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >4. Gestión del servidor</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" >4.3. Monitorización</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="index.html" >4.3.1. Ficheros <em>logs</em></a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2020, José Miguel Sánchez Alés.
      Creado con <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>