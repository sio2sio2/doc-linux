


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="es">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>9.4.2.3.4. Ejemplos &#8212; documentación de Linuxnomicón - rolling</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Índice" href="../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../search.html" />
    <link rel="next" title="10. Guías para ciclos formativos" href="../../../10.guias/index.html" />
    <link rel="prev" title="9.4.2.3.3. Composición" href="04.compose.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="../../../10.guias/index.html" title="10. Guías para ciclos formativos"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="04.compose.html" title="9.4.2.3.3. Composición"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >9. Apéndices</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" >9.4. Virtualización</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../03.docker.html" accesskey="U">9.4.2.3. Docker</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ejemplos">
<span id="docker-ejemplos"></span><h1>9.4.2.3.4. Ejemplos<a class="headerlink" href="#ejemplos" title="Enlazar permanentemente con este título">¶</a></h1>
<p>Dedicaremos este último epígrafe a resolver algunos problemas usando
contenedores de <strong class="program">Docker</strong>.</p>
<div class="section" id="dnsmasq">
<h2>9.4.2.3.4.1. dnsmasq<a class="headerlink" href="#dnsmasq" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El propósito es ejecutar un contenedor con <a class="reference internal" href="../../../06.infraestructura/02.dhcp/03.dnsmasq.html#dnsmasq"><span class="std std-ref">dnsmasq</span></a> capaz de
proporcionar resolución de nombres y configuración dinámica de direcciones a los
equipos de la red. Esto último nos obliga a que el contenedor comporta la red
con el anfitrión.</p>
<p>Aunque no usaremos <a class="reference internal" href="04.compose.html#docker-compose"><span class="std std-ref">docker-compose</span></a>, puesto que sólo
necesitamos un contenedor, Debemos preparar un directorio de trabajo con el
siguiente contenido:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+ workdir
   +-- dnsmasq.d
   |     +-- dns.conf
   |     +-- dhcp.conf
   +-- Dockerfile
</pre></div>
</div>
<p>El subdirectorio <code class="file docutils literal notranslate"><span class="pre">dnsmasq.d</span></code> contendrá la configuración que deseamos para
nuestro <a class="reference internal" href="../../../06.infraestructura/02.dhcp/03.dnsmasq.html#dnsmasq"><span class="std std-ref">dnsmasq</span></a>. Por ejemplo:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># dns.conf</span>
no-resolv
<span class="nv">server</span><span class="o">=</span><span class="m">1</span>.0.0.1
<span class="nv">server</span><span class="o">=</span><span class="m">1</span>.1.1.
</pre></div>
</div>
<p>y:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># dhcp.conf</span>
log-dhcp
dhcp-range<span class="o">=</span><span class="m">192</span>.168.255.64,192.168.255.127,5m
<span class="nv">domain</span><span class="o">=</span>internal.vm,192.168.255.0/24
</pre></div>
</div>
<p>Y el <code class="file docutils literal notranslate"><span class="pre">Dockerfile</span></code> la forma en construir una imagen con <a class="reference internal" href="../../../06.infraestructura/02.dhcp/03.dnsmasq.html#dnsmasq"><span class="std std-ref">dnsmasq</span></a> a partir de <a class="reference external" href="https://alpinelinux.org/">Alpine</a>:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s">    alpine</span>
<span class="k">RUN</span>     apk update <span class="o">&amp;&amp;</span> apk add dnsmasq<span class="p">;</span> <span class="se">\</span>
        <span class="nb">echo</span> <span class="s1">&#39;conf-dir=/etc/dnsmasq.d/,*.conf&#39;</span> &gt; /etc/dnsmasq.conf
<span class="k">EXPOSE</span><span class="s">  53/UDP 67/UDP 69/UDP</span>
<span class="k">CMD</span>     <span class="p">[</span><span class="s2">&quot;dnsmasq&quot;</span><span class="p">,</span> <span class="s2">&quot;--no-daemon&quot;</span><span class="p">,</span> <span class="s2">&quot;-z&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Con ello, podemos construir la imagen:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> docker build -t dnsmasq:alpine .
</pre></div>
</div>
<p>Y ejecutar el contenedor basado en esa imagen:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> docker run --rm --network host -v /workdir/dnsmasq.d:/etc/dnsmasq.d dnsmasq:alpine
</pre></div>
</div>
</div>
<div class="section" id="wordpress">
<h2>9.4.2.3.4.2. Wordpress<a class="headerlink" href="#wordpress" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Nuestra intención ahora es instalar un <a class="reference external" href="https://wordpress.org/">Wordpress</a>, para lo cual utilizaremos
la siguiente infraestructura:</p>
<img alt="../../../_images/wordpress.png" src="../../../_images/wordpress.png" />
<p>es decir, tres contenedores diferentes cada uno de los cuales levanta los tres
servicios en que se puede descomponer la aplicación: la base de datos, la
aplicación <abbr title="PHP Hypertext Preprocessor">PHP</abbr> (con el intérprete incluido) y un servidor web que sea el que
ofrezca la aplicación. Además, es necesario almacenar los ficheros de la base de
la datos y los datos de la aplicación, por lo que se requerirán dos volúmenes de
datos.</p>
<p>Los tres contenedores que utilizaremos son:</p>
<ul>
<li><p class="first">La <cite>imagen oficial de mariaDB &lt;https://hub.docker.com/_/mariadb&gt;</cite>, que se
caracteriza porque al generar un contenedor, crea los ficheros necesarios del
gestor de bases de datos, según los valores de las variables de entorno que
se proporcionen (véase el <code class="file docutils literal notranslate"><span class="pre">docker-compose.yaml</span></code> más adelante). Esta
característica nos permite preparar la base de datos para <em>wordpress</em> y el
usuario que la maneje.</p>
</li>
<li><p class="first">Una <cite>imagen oficial de wordpress que incluya PHP-FPM
&lt;https://hub.docker.com/_/wordpress&gt;</cite>. Esta imagen contiene el <abbr title="PHP Hypertext Preprocessor">PHP</abbr> necesario
y la versión de <a class="reference external" href="https://wordpress.org/">Wordpress</a> en el momento de su generación, la cual acaba
dejando disponible en <code class="file docutils literal notranslate"><span class="pre">/var/www/html</span></code>.</p>
<p>Esta imagen también usa variables de entorno para conocer dónde se encuentra
la base de datos y con qué usuarios acceder a ella.</p>
</li>
<li><p class="first">Una <cite>imagen mínima de nginx &lt;https://hub.docker.com/_/ngvinx&gt;</cite> que necesitará
acceso al directorio <code class="file docutils literal notranslate"><span class="pre">/var/www/html</span></code> del contenedor anterior y alterar
su configuración predefinida para ser capaz de servir la aplicación.</p>
</li>
</ul>
<p>Dado que actúan en comandita tres contenedores, lo más juicioso es utilizar
<a class="reference internal" href="04.compose.html#docker-compose"><span class="std std-ref">docker-compose</span></a>, el cual requerirá el siguiente
<code class="file docutils literal notranslate"><span class="pre">docker-compose,yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span> <span class="s">&quot;3&quot;</span>
<span class="nt">services</span><span class="p">:</span>
   <span class="nt">mysql</span><span class="p">:</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mariadb</span>
      <span class="nt">volumes</span><span class="p">:</span>
         <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">wpmysql:/var/lib/mysql</span>
      <span class="nt">environment</span><span class="p">:</span>
         <span class="nt">MYSQL_ROOT_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${ROOT_PASS:-toor}</span>
         <span class="nt">MYSQL_DATABASE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${WP_DB:-wordpress}</span>
         <span class="nt">MYSQL_USER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${WP_USER:-wp}</span>
         <span class="nt">MYSQL_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${WP_PASS:-wp}</span>
      <span class="nt">restart</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>

   <span class="nt">wordpress</span><span class="p">:</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">wordpress:php7.4-fpm-alpine</span>
      <span class="nt">depends_on</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mysql</span>
      <span class="nt">volumes</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">wpapp:/var/www/html</span>
      <span class="nt">environment</span><span class="p">:</span>
        <span class="nt">WORDPRESS_DB_HOST</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql</span>
        <span class="nt">MYSQL_ROOT_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${ROOT_PASS:-toor}</span>
        <span class="nt">WORDPRESS_DB_NAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${WP_DB:-wordpress}</span>
        <span class="nt">WORDPRESS_DB_USER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${WP_USER:-wp}</span>
        <span class="nt">WORDPRESS_DB_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${WP_PASS:-wp}</span>
        <span class="nt">WORDPRESS_TABLE_PREFIX</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${WP_PREFIX:-wp_}</span>
      <span class="nt">restart</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>

   <span class="nt">nginx</span><span class="p">:</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx:alpine</span>
      <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;80:80&quot;</span>
      <span class="nt">volumes</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./blogs.conf:/etc/nginx/conf.d/default.conf</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">wpapp:/var/www/html</span>
      <span class="nt">depends_on</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">wordpress</span>

<span class="nt">volumes</span><span class="p">:</span>
   <span class="nt">wpmysql</span><span class="p">:</span>
   <span class="nt">wpapp</span><span class="p">:</span>
</pre></div>
</div>
<p>Si se observa el fichero, se verá que es necesario suministrar el fichero
<code class="file docutils literal notranslate"><span class="pre">blogs.conf</span></code> con la configuración para que <a class="reference internal" href="../../../07.serre/02.web/02.nginx/index.html#n-ginx"><span class="std std-ref">nginx</span></a> sea capaz
de ejecutar la aplicación:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+ workdir
    +-- blogs.conf
    +-- docker-compose.yaml
</pre></div>
</div>
<p>Su contenido puede ser este:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>
   <span class="kn">listen</span>   <span class="mi">80</span><span class="p">;</span>
   <span class="kn">root</span>     <span class="s">/var/www/html</span><span class="p">;</span>

   <span class="kn">index</span> <span class="s">index.php</span><span class="p">;</span>

   <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
      <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="nv">$uri/</span> <span class="s">/index.php</span><span class="nv">$is_args$args</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="kn">location</span> <span class="p">~</span> <span class="sr">\.php$</span> <span class="p">{</span>
      <span class="kn">fastcgi_split_path_info</span> <span class="s">^(.+\.php)(/.+)</span>$<span class="p">;</span>
      <span class="kn">fastcgi_pass</span> <span class="n">wordpress</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span>

      <span class="kn">fastcgi_index</span> <span class="s">index.php</span><span class="p">;</span>
      <span class="kn">include</span> <span class="s">fastcgi.conf</span><span class="p">;</span>

      <span class="kn">fastcgi_param</span> <span class="s">SCRIPT_FILENAME</span> <span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
      <span class="kn">fastcgi_param</span> <span class="s">SCRIPT_NAME</span> <span class="nv">$fastcgi_script_name</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">9.4.2.3.4. Ejemplos</a><ul>
<li><a class="reference internal" href="#dnsmasq">9.4.2.3.4.1. dnsmasq</a></li>
<li><a class="reference internal" href="#wordpress">9.4.2.3.4.2. Wordpress</a></li>
</ul>
</li>
</ul>

  <h4>Tema anterior</h4>
  <p class="topless"><a href="04.compose.html"
                        title="capítulo anterior">9.4.2.3.3. Composición</a></p>
  <h4>Próximo tema</h4>
  <p class="topless"><a href="../../../10.guias/index.html"
                        title="próximo capítulo">10. Guías para ciclos formativos</a></p>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/09.apendice/99.virtual/03.docker/05.ejemplos.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Búsqueda rápida</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Ir a" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="../../../10.guias/index.html" title="10. Guías para ciclos formativos"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="04.compose.html" title="9.4.2.3.3. Composición"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">documentación de Linuxnomicón - rolling</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >9. Apéndices</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" >9.4. Virtualización</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../03.docker.html" >9.4.2.3. Docker</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor CC BY 4.0, 2016-2020, José Miguel Sánchez Alés.
      Creado con <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>