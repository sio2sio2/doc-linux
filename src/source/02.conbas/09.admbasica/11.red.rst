.. _redminima:

Configuración de red
====================

Los sistemas *linux* permiten una configuración amplísima de las interfaces de
red, y profundizar en ello requeriría un tratamiento muchísimo más amplio del
que aquí se mostrará\ [#]_. Bajo este epígrafe nos limitaremos a indicar cómo
hacer una configuración simple de las interfaces, tanto con herramientas
comunes a todas las distribuciones de *linux* como con las herramientas que
provee *Debian*.

Tenga presente que el método de configuración que ofrece *Debian*
(:ref:`ifupdown <ifupdown>`) y el uso de las :ref:`herramientas generales
<net-univ>` es alternativo y **no debe mezclarse**: o configuramos con uno o con
el otro. Por ese motivo, si una interfaz está activa porque se usó la
herramienta :ref:`ifup <ifup>` de *Debian*, sólo debemos manipularña usando las
herramientas generales, si previamente la desactivamos usando :ref:`ifdown
<ifdown>`.

.. warning:: El epígrafe está referido a interfaces de cable, que son las
   habituales en servidores. Las interfaces inalámbricas son más engorrosas ya
   que es común que cambien la red a la que están conectada con todo lo que ello
   supone (cambio del :abbr:`SSID (Service Set IDentifier)`, cambio de la
   contraseña de acceso, etc.). Aunque es posible configurar estas interfaces
   a travñes de la línea de órdenes y ficheros de configuración, lo más cómodo
   (y recomendable) es usar herramientas más amigables e inmediatas como las que
   se exponen en :ref:`el epígrafe referente a otros modos de configuración
   <otros-conf-red>`.

.. note:: `Ubuntu <https://ubuntu.com/>`_, aunque basada en *Debian*, usa
   como herramienta de configuración de red, desde su versión 18, `netplan
   <https://netplan.io/>` y no :ref:`ifupdown <ifupdown>`.

Interfaces presentes
--------------------
Antes de poner a configurar interfaces es indispensable saber qué interfaces hay
presentes en nuestro sistema. Para que el sistema registre una interfaz es
necesario que tal interfaz exista, pero también que haya un driver apropiado que
nos permita usarla.

Tradicionalmente, las interfaces ethernet cableadas se han venido llamando
``ethN`` siendo ``N`` un número correlativo empezando en 0 (*eth0*, *eth1*,
etc.) y las interfaces inalámbricas ``wlanN``. Con el advenimiento de
:ref:`systemd <systemd>`, sin embargo, el nombre de las interfaces ha cambiado\
[#]_. Ahora se usa un sistema de nombres que intenta evitar el que el núcleo
cambie el nombre de las interfaces al ser cambiar su número o hacerse
sustituciones.

Para conocer cuáles son las interfaces presentes, basta con mirar dentro de
:file:`/sys/class/net`::

   $ ls /sys/class/net
   eth0  lo

También es posible obtener las interfaces a través del comando :ref:`ip <ip>`::

   # ip link show

.. _ifupdown:

Configuración en debian
-----------------------
*Debian* gestiona sus interfaces preferentemente a través de los *scripts* que
proporciona el paquete **ifupdown**, los cuales consultan el contenido del
fichero :file:`/etc/network/interfaces`\ [#]_. Por tanto, configurar las
interfaces de red mediante este método supone fundamentalmente:

- Saber cómo expresar la configuración de las interfaces dentro de
  :file:`/etc/netwoek/interfaces`.
- Utiliazar las herramientas de activación (:ref:`ifup <ifup>`)
  y desactivación (:ref:`ifdown <ifdown>`).
- Saber cómo definir los servidores |DNS| para la resolución de nombres.

.. rubric:: Herramientas

Las fundamentables son:

.. _ifup:
.. index:: ifup

:command:`ifup`
   Permite activar la interfaz suministrada (puede pasarse varias) con la
   configuración indicada en :file:`/etc/network/interfaces`::

      # ifup eth0

   Es interesante la opción ``-v`` que muestra información adicional sobre el
   proceso de activación.

.. _ifdown:
.. index:: ifdown

:command:`ifdown`
   Permite desactivar una interfaz previamente activada con :command:`ifup`::

      # ifdown eth0

   Para que esto funcione la interfaz debió ser activada con :command:`ifup`. Si
   se activó de cualquier otro modo, la interfaz no estará registrada como
   activa, de modo que :command:`ifdown` no hará nada.

   Puede también incluirse la opción ``-v`` y otra de interés es ``--force`` que
   completa el proceso de desactivación incluso aunque se hayan producido
   errores. Por ejemplo, porque se desactivara la interfaz de forma manual y,
   cuando :command:`ifdown` intente desactivarla, se encuentre con que la
   interfaz no tiene configuración.

.. _ifquery:
.. index:: ifquery

:command:`ifquery`
   Permite hacer consultas sobre las interfaces gestionadas. Lo más habitual
   es preguntar por cuál es la configuración de una interfaz::

      $ ifquery eth0
      address: 192.168.4.20/24
      gateway: 192.168.4.253
      up: iptables -t nat -A POSTROUTING -o $IFACE -j MASQUERADE
      down: iptables -t nat -D POSTROUTING -o $IFACE -j MASQUERADE

   .. warning:: La orden nos devuelve la configuración que se encuentra en
      :file:`/etc/network/interfaces`, no la que realmente tenga la interfaz,
      que pueden diferir, si se deshabilito la interfaz con :ref:`ifdown
      <ifdown>` y se volvió a configurar de modo diferente con las
      :ref:`herramientas generales <net-univ>`.

   También puede usarse::

      $ ifquery --state
      lo=lo
      eth0=eth0

   que nos devolverá la interfaces activas a través de :command:`ifup`.

.. rubric:: Fichero de confiuración

En realidad, el meollo de la configuración está en la escritura de
:file:`/etc/network/interfaces`. Mostremos un fichero con la interfaz de
*loopback*, una interfaz *eth0* configurada de forma dinámica y una interfaz
*eth1* cpmfigurada de forma estática:

.. literalinclude:: docs/interfaces
   :language: bash

La configuración es bastante elocuente. La segunda interfaz, al tener una
configuración estática, necesita algunos datos (*ip* y máscara, y puerta de
enlace). Obsérvese que no se incluyen los servidores :abbr:`DNS (Domain Name
Service)`\ [#]_, porque estos no se expresan en este fichero, sino en
:file:`/etc/resolv.conf`.

Sí es pertinente aclarar por qué algunas interfaces van acompañadas de la
palabra :kbd:`auto` y otras de la palabra :kbd:`allow-hotplug`. Incluso podría
haber otras sin ninguna de esas dos líneas. En este último caso, la interfaz
no se activará durante el arranque y tendrá que ser el usuario quien manualmente
lo haga mediante :ref:`ifup <ifup>`. En cambio, una de esas dos dos líneas,
activa automáticamente en el arranque la interfaz, pero con un matiz diferente:
:kbd:`allow-hotplug` activa la interfaz si se detecta que esta existe y, si no
existe, no ocurrirá nada, mientras que :kbd:`auto` intentará activar la interfaz
siempre y, si no existe, provocará un error visible. La regla general es que
:kbd:`allow-hotplug` se usa con interfaces físicas,  mientras que :kbd:`auto` se
usa con interfaces virtuales que no existen previamente, sino que se crear al
ser activadas y que, por tanto, no pueden existir con anterioridad.

Es posible añadir también en la configuración de cada interfaz líneas que
comiencen con :kbd:`pre-up`, :kbd:`up`, :kbd:`down` y :kbd:`post-down`. Estas
líneas permiten ejecutar comandos arbitrarios justamente antes de activar la
interfaz, tras haberlo hecho, justamente antes de desactivarla o después de
haberlo hecho. Es bastante común el caso en que queremos añadir alguna regla en
el :ref:`cortafuegos <firewall>` al levantar la interfaz y borrarla al
desactivarla::

   allow-hotplug eth0
   iface eth0 inet dhcp
      pre-up    iptables -A POSTROUTING -o $IFACE -j MASQUERADE
      post-down iptables -D POSTROUTING -o $IFACE -j MASQUERADE

.. warning:: Si pretende cambiar la configuración de una interfaz, es muy
   importante que antes de editar el fichero, la desactive con :ref:`ifdown
   <ifdown>`.  Esto es debido a que para desactivar una interfaz, este *script*
   no atiende a cómo se configuró la interfaz, sino a cual es la configuración
   escrita en el fichero en el momento de ejecutar :ref:`ifdown <ifdown>`. Por
   eso, si al activarse la interfaz, la configuración era estática, los
   *scripta* usarán internamente la orden :ref:`ip <ip>`. Si antes de
   desactivaer la interfaz, modifica el fichero y vuelve la configuración
   dinámica, al hacer :ref:`ifdown <ifdown>`. el *script* no desactivará la
   interfaz con :ref:`ip <ip>`, sino que intentará usar internamente
   :ref:`dhclient <dhclient>` y, obviamente, fallará.


.. rubric:: DNS

Queda, por último, tratar la configuración de los servidores :abbr:`DNS (Domain
Name Service)` en el fichero :file:`/etc/resolv.conf`. Si la configuración es
dinámica, el propio cliente *dhcp* se encarga de escribir este fichero y no hay
que hacer ninguna configuración. En cambio, si la configuración es estática, sí
habrá que escribirlo o al menos cerciorarse que es válido. Se explicará
su contenido :ref:`dentro del epígrafe siguiente <bas-resolv.conf>`.

.. _net-univ:

Configuración universal
-----------------------
.. warning:: Recuerde que, para utilizar estas herramientas, debe cerciorarse
   primero de que la interfaz no se activó mediante :ref:`ifup <ifup>`
   y, si lo está, utilice :ref:`ifdown <ifdown>` antes de empezar.

.. rubric:: Configuración automática

La configuración más sencilla es la automática, ya que el cliente de *dhcp* se
encargará de todo. El cliente habitual es

.. _dhclient:
.. index:: dhclient

:program:`dhclient`
   Permite obtener una configuración de red ofrecida un un servidor :abbr:`DHCP
   (Dynamic Host Configuration Protocol)`::

      # dhclient eth0

   Es necesario especificar la interfaz que se quiere configurar (en el ejemplo,
   *eth0*). Es interesante incluir la opción ``-v`` para que se nos muestre
   información adicional del proceso.

   Si se desea revocar la concesión, basta con::

      # dhclient -r

   Como se ve no se expresa la interfaz. También es posible desconfigurar la
   interfaz con la opción ``-x``, pero en este caso no se informa al servidor de
   que deseamos dejar de usar la *ip* con lo que el servidor no la liberará.

.. rubric:: Configuración manual

Si la configuración es manual, debemos realizar tres labores:

#. Configurar los parámetros de red de la interfaz.
#. Añadir una entrada a la tabla de encaminamiento para indicar cuál es la
   puerta de enlace.
#. Configurar los servidores |DNS|

Así que supongamos que queremos fijar una dirección  |IP|
:kbd:`192.168.1.10/24`, la puerta de enlace es :kbd:`192.168.1.1` y los
servidores |DNS| :kbd:`1.1.1.1` y :kbd:`1.0.0.1`.

Para las dos primeras tareas, el comando apropiado es:

.. _ip:
.. index:: ip

:command:`ip`
   Permite la configuración de distintos aspectos relacionados con la red:
   políticas de encaminamiento, parámetros de configuración de la interfaz, etc.
   Tiene un modo de funcionamiento similar a los comandos disponibles en
   sistemas *ios* de cisco.

   Para configurar la interfaz basta con::

      # ip addr add 192.168.1.10/24 dev eth0

   y para activarla con tal configuración::

      # ip link set dev eth0 up

   Esto habrá configurado la interfaz lo que puede comprobarse a través de::

      $ ip addr show
      [... Listado aquí ...]

   que muestra la configuración asignada y::

      $ ip link show
      [... Listado aquí ...]

   que muestra el estado de la interfaz. En este caso ``UP`` nos informa de que
   la interfaz está activa y ``LOWER_UP`` de que tiene el cable conectado. En el
   caso de estos últimos comandos es posible añadir :kbd:`dev eth0` para obtener
   información solamente de esta interfaz.

   No obstante, aún es necesario añadir la entrada en la tabla de encaminamiento
   para configurar la puerta predeterminada::

      # ip route add default via 192.168.1.1

   Esta última orden provocará la adición de la entrada correspondiente::

      $ ip route show
      [... Listado aquí ...]

.. warning:: En tutoriales antiguos de *Linux* podrá ver que estas órdenes se
   hacen con :manpage:`ifconfig` y :manpage:`route`. Estas herramientas, sin
   embargo, hace tiempo que se marcaron como obsoletas y, de hecho, ya no están
   disponibles en *Debian* desde hace años. a menos que se instale expresamente
   el paquete **net-tools**.

.. _bas-resolv.conf:

.. rubric:: DNS

En una configuración estática, es necesario definir los servidores |DNS|, para
lo cual basta editar el fichero :file:`/etc/resolv.conf` e incluir las
siguientes líneas::

   nameserver 1.0.0.1
   nameserver 1.1.1.1

.. _otros-conf-red:

Otros modos de configuración
----------------------------

Es posible realizar la configuración de red a través de aplicaciones gráficas,
que ahorran la manipulación manual de ficheros. Las más habituales son:

* `network-manager <https://wiki.gnome.org/Projects/NetworkManager>`_,
  disponible en el escritorio GNOME

* `wicd <http://wicd.sourceforge.net/>`_, apto para cualquier entorno gráfico
  y que dispone incluso de interfaz para la terminal no gráfica.

Ambas aplicaciones son compatibles con tener configurada alguna interfaz a
través del fichero :file:`/etc/network/interfaces`.

.. _ej-redmin:

.. include:: /99-ejercicios/081-redes.rst

.. rubric:: Notas al pie

.. [#] Para un tratamiento más profundo puede consultar `el siguiente enlace
   <http://docs.iescdl.es/~josem/redes.html>`_.

.. [#] En realidad en el contenido de todo el directorio :file:`/etc/network`.

.. [#] Puede leerse con más detalle sobre esto en `este artículo
   <https://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/>`_.

.. [#] Si se instala el paquete *resolvconf*, si pueden incluirse.
